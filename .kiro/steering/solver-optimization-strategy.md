# Solver Optimization Strategy - シフト生成最適化戦略

**作成日**: 2025-12-30
**最終更新**: 2026-02-16
**ステータス**: CP-SAT Solver完全移行完了

---

## 1. 移行の経緯

### 1.1 LLM時代の問題
- AI生成シフトのスコアが不安定（0-28の範囲でばらつき）
- バッチ処理の独立性による協調問題
- JSONパース不安定性（多数のワークアラウンド必要）
- 処理時間90-400秒（Cloud Functionsタイムアウトに近い）

### 1.2 段階的移行
1. **Phase 1（リバランス）**: LLM生成後の後処理リバランス → 違反19→2に改善
2. **Phase 2（ハイブリッド）**: LLM Phase1 + Solver Phase2の併用
3. **Phase 3（統合Solver）**: 単一CP-SATモデルで全制約を一括求解、LLM完全廃止

---

## 2. 現在のアーキテクチャ

### 2.1 CP-SAT Solverモデル

```
変数: x[staff_id, day, shift_type] = BoolVar (0/1)

ハード制約:
  - exactly-one（1日1シフト）
  - 人員充足（シフト×日の最低人数）
  - 連続勤務上限
  - 遅番→早番禁止
  - 夜勤チェーン
  - 固定休日

ソフト制約（重み付き最適化）:
  - シフト希望ボーナス（重み: 10）
  - 勤務公平性（分散最小化）（重み: 5）
  - 夜勤公平性（重み: 8）
  - 休息間隔（重み: 3）
  - 勤務日数目標（重み: 7）
  - 連勤最小化（重み: 4）
```

### 2.2 性能パラメータ

| パラメータ | 値 | 備考 |
|-----------|-----|------|
| `relative_gap_limit` | 0.05 | 最適値の5%以内で早期終了 |
| `max_time_in_seconds` | 30 | タイムアウト |
| Cloud Function timeout | 120秒 | Solver+評価に十分 |
| Cloud Function memory | 512MiB | LLM不要のためメモリ削減 |

---

## 3. A/B比較結果（LLM vs Solver）

| 指標 | LLM版 | 統合Solver | 改善 |
|------|-------|-----------|------|
| 12名処理時間 | 90-400秒 | 0.22秒 | 99.8%削減 |
| 50名処理時間 | タイムアウト | 0.89秒 | 対応不可→対応可 |
| 100名処理時間 | 対応不可 | <30秒 | 新規対応 |
| Level 1違反 | 0-5件 | 0件 | 数学的保証 |
| 評価スコア | 72-100 | 100 | 安定的最適解 |
| 決定性 | 非決定的 | 完全決定的 | 分散0 |
| LLMコスト/回 | ~$0.15 | $0.00 | 100%削減 |

---

## 4. チューニングガイドライン

### 4.1 `relative_gap_limit` の調整
- 値が小さいほど最適解に近いが計算時間増加
- 0.05（5%）が品質と速度のバランス点
- 0.01に下げると15名×4シフトで30秒→タイムアウトリスク

### 4.2 制約の追加・変更
- ハード制約: `unified_builder.py` の `_add_*_constraints()` メソッド
- ソフト制約: 目的関数への重み付き項の追加
- テスト: `solver-functions/tests/` で回帰テスト

---

## 5. コアファイル

| ファイル | 役割 |
|---------|------|
| `solver-functions/solver/unified_builder.py` | CP-SATモデル構築 |
| `functions/src/shift-generation.ts` | Cloud Functionエントリーポイント |
| `functions/src/solver-client.ts` | Solver呼び出しクライアント |

---

**詳細**: [ADR-0004: ハイブリッドアーキテクチャ採用](../../docs/adr/0004-hybrid-architecture-adoption.md)
