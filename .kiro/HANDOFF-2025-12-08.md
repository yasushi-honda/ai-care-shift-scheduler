# AI引継ぎドキュメント - Phase 46 バグ修正セッション

**作成日**: 2025-12-08
**最終更新**: 2025-12-08 13:50（検証完了）
**対象**: 次のAIセッション担当者

---

## 1. セッション概要

### 完了した作業
- BUG-008: thinkingBudget問題 → ✅ 修正完了
- BUG-009: デモユーザー権限消失問題 → ✅ 3回目の修正で解決 → ✅ **検証完了（2025-12-08 13:50）**
- BUG-010: タイムアウト問題 → ✅ 修正完了（180s → 240s）
- MoEチーム分析とポストモーテム作成

### Git状態
- ブランチ: `main`
- 最新コミット: `3965327` - docs: AI引継ぎドキュメント作成（Phase 46バグ修正セッション）

---

## 2. 重要な発見（BUG-009の教訓）

### 根本原因
Firestoreセキュリティルールは**`users.facilities`のみを参照**している。
`facilities.members`は非正規化データであり、権限判定には使われない。

```
┌─────────────────────────────────────────────────┐
│           権限データの二重管理構造                  │
├─────────────────────────────────────────────────┤
│                                                 │
│  users/{userId}          facilities/{facilityId}│
│  └─ facilities[]    ←→   └─ members[]          │
│     └─ role ◀ SoT           └─ role            │
│                                                 │
│  ⚠️ セキュリティルールはusers.facilitiesのみ参照    │
│                                                 │
└─────────────────────────────────────────────────┘
```

### セキュリティルールの該当箇所

```javascript
// firestore.rules (L14-34)
function hasRole(facilityId, requiredRole) {
  let userProfile = getUserProfile();  // users/{uid}を取得
  let facilities = userProfile.facilities;  // ← ここだけ参照！
  return checkFacilityRole(facilities, index, facilityId, requiredRole);
}
```

---

## 3. 検証結果

### デモ環境動作確認（✅ 完了 2025-12-08 13:50）

| 検証項目 | 結果 |
|---------|------|
| 権限検証スクリプト | ✅ 両方editor権限確認 |
| デモログイン | ✅ 成功 |
| AI自動シフト生成 | ✅ 成功（3回実行） |
| シフト保存 | ✅ 成功（v1確定） |
| バージョン履歴 | ✅ 作成者: demo-user-fixed-uid |

```
バージョン履歴:
v1 確定
2025/12/08 13:50 · 作成者: demo-user-fixed-uid
スタッフ数: 12名  前バージョン: v0
```

### 権限検証スクリプト

今後問題が発生した場合：

```bash
npx tsx scripts/verifyDemoPermissions.ts
```

期待される出力:
```
users.facilities[].role:      editor
facilities.members[].role:    editor
✅ 両方の権限が一致しています: editor
```

---

## 4. 関連ファイル一覧

### 修正されたファイル
| ファイル | 変更内容 |
|---------|---------|
| `scripts/seedDemoData.ts` | L670-686: users.facilities同期コード追加 |
| `CLAUDE.md` | L768-839: 権限管理ルールセクション追加 |

### ドキュメント
| ファイル | 内容 |
|---------|------|
| `.kiro/postmortem-bug009-permission-sync-2025-12-08.md` | MoEチーム分析結果 |
| `docs/postmortem-permission-sync-2025-12-08.html` | GitHub Pages版 |
| `docs/bugfix-demo-members-2025-12-08.html` | BUG-009修正詳細 |
| `docs/bugfix-timeout-extended-2025-12-08.html` | BUG-010修正詳細 |

### Serenaメモリ
- `bug009_permission_sync_postmortem_2025-12-08` - ポストモーテム
- `phase46_bug009_final_fix_2025-12-08` - 最終修正
- `phase46_bugfix_session_2025-12-08` - セッション概要
- `gemini_thinking_budget_critical_rule` - thinkingBudget設定

---

## 5. 権限エラーデバッグ手順

権限エラーが発生した場合の対処：

### Step 1: セキュリティルールを確認
```bash
cat firestore.rules | grep -A 20 "function hasRole"
```

### Step 2: 検証スクリプト実行
```bash
npx tsx scripts/verifyDemoPermissions.ts
```

### Step 3: データ不整合があれば再投入
```bash
npm run seed:demo -- --reset
```

---

## 6. 現在のプロジェクト状態

### 完了済みPhase
- Phase 41: 月次レポート機能
- Phase 42: UIデザイン改善
- Phase 43: デモ環境改善・排他制御
- Phase 44: AIシフト生成パイプライン改善
- Phase 45: AI生成進行状況表示

### 作業中
- Phase 46: デモデータ拡充（パート職員4名追加）
  - 今回のセッションでバグ修正に集中
  - パート職員追加自体は完了している模様

---

## 7. 重要な設定ルール

### Gemini 2.5 Flash設定
```typescript
// 必須設定
location: 'asia-northeast1'  // 日本リージョン必須
model: 'gemini-2.5-flash'    // -latestなし
maxOutputTokens: 65536       // 思考モード対応
thinkingConfig: { thinkingBudget: 8192 }  // BUG-008修正
```

### タイムアウト設定（BUG-010）
```typescript
// Cloud Functions
timeoutSeconds: 300  // 5分

// フロントエンド
setTimeout: 240000  // 4分（BUG-010で180s→240sに延長）
```

---

## 8. 次のステップ（推奨）

1. ~~**デモ環境テスト**~~ → ✅ 完了（2025-12-08 13:50）

2. **Phase 46完了確認**
   - パート職員4名が正しく追加されているか確認 → ✅ 12名確認済み
   - シフト生成でパート職員が含まれるか確認 → ✅ 生成確認済み

3. **AI生成品質問題の調査**（新規課題）
   - 詳細は「既知の課題」セクション参照

4. **ドキュメント整合性**
   - GitHub Pages (`docs/`) の更新を確認
   - 新しいバグが見つかった場合は同様のドキュメント形式で記録

---

## 8.1. 既知の課題：AI生成品質問題

### 症状
- AI生成シフトの人員充足率が73%〜93%でばらつき
- 30件以上の制約違反が発生

### 調査結果
```
=== Firestoreデータ（正常） ===
- スタッフ数: 12名（看護師2名含む）
- 月間供給可能: 196人日
- 月間必要人数: 130人日
→ データ上は十分に足りている

=== Cloud Functionsログ ===
- 実行1回目: fulfillmentRate: 93%, violationCount: 19
- 実行2回目: fulfillmentRate: 73%, violationCount: 33
- finishReason: 'STOP'（正常終了）
```

### 考えられる原因
1. **プロンプトの制約表現が曖昧**
2. **2段階生成（骨子→詳細）での情報損失**
3. **パート職員の制限（週2-3日勤務）の考慮不足**
4. **AIの確率的ばらつき**

### 対応方針（提案）
- Phase 47として「AI生成品質改善」を検討
- または既存のPhase 44（AIシフト生成パイプライン改善）の追加タスクとして対応

---

## 9. 問題発生時の参照先

| 問題 | 参照ドキュメント |
|-----|----------------|
| 権限エラー | `.kiro/postmortem-bug009-permission-sync-2025-12-08.md` |
| CORS | `.kiro/bugfix-cors-cloud-functions-2025-12-05.md` |
| Gemini空レスポンス | `.kiro/bugfix-gemini-empty-response-2025-12-05.md` |
| タイムアウト | `.kiro/bugfix-timeout-extended-2025-12-08.md` |
| thinkingBudget | `.kiro/bugfix-thinking-budget-2025-12-08.md` |

---

**作成者**: Claude Opus 4.5
**最終更新**: 2025-12-08
