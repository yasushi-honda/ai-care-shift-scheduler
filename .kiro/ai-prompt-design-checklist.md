# AIプロンプト設計チェックリスト

**作成日**: 2025-12-08
**目的**: 本番デプロイ前に論理的・数学的な矛盾を検出するための設計レビューガイド

---

## 概要

AIプロンプトを本番環境にデプロイする前に、以下のチェックリストを使用して論理的な矛盾がないかを確認する。
これにより、BUG-017のような「AIが論理的に達成不可能と判断して拒否する」問題を防ぐ。

---

## 1. 論理的整合性チェック

### 1.1 バッチ処理の設計検証

バッチ処理を行う場合、以下を確認：

| チェック項目 | 質問 | BUG-017の例 |
|-------------|------|-------------|
| **要件の相対性** | バッチ単位で達成可能な要件か？ | ❌「5名/日」→バッチ2名では不可能 |
| **コンテキストの明示** | バッチが全体の一部であることを明記しているか？ | ❌「各営業日に5名」→バッチ単独と誤解 |
| **責任範囲の限定** | バッチ内のスタッフのみが対象と明記しているか？ | ❌曖昧な指示 |

**思考シミュレーション例**:
```
入力: バッチサイズ=2名、全体=12名、必要人員=5名/日
質問: 「2名で5名/日を配置せよ」は可能か？
→ 答え: 不可能（論理的矛盾）
→ 修正: 「全体12名中の2名分。目安として比例配分」
```

### 1.2 数値の整合性チェック

| チェック項目 | 確認方法 |
|-------------|---------|
| **最小バッチでの達成可能性** | 最小バッチサイズで要件が満たせるか計算 |
| **除算のゼロ除算チェック** | 分母がゼロになる可能性はないか |
| **比率計算の端数処理** | 切り捨て/四捨五入で0になることはないか |

**例: バッチサイズ計算**:
```typescript
// 最小バッチでの達成可能性チェック
const minBatchSize = 2;  // 最悪ケース
const requiredPerDay = 5;

if (minBatchSize < requiredPerDay) {
  // ❌ バッチ単位で達成不可能
  // → プロンプトを相対化する必要あり
}
```

### 1.3 制約の矛盾チェック

複数の制約が同時に満たせるか確認：

| 制約A | 制約B | 矛盾チェック |
|------|-------|-------------|
| 「5名/日必須」 | 「このバッチ2名のみ」 | ❌ 矛盾（2名で5名は不可能） |
| 「連続5日まで」 | 「休日は週1日のみ」 | ✅ 両立可能 |
| 「日勤のみ」 | 「夜勤2名必須」 | ❌ 矛盾（属性フィルタ後の確認必要） |

---

## 2. プロンプト設計レビュープロセス

### 2.1 レビュー実施タイミング

1. **新規プロンプト作成時** - 必須
2. **プロンプト修正時** - 必須
3. **バッチ処理ロジック変更時** - 必須

### 2.2 思考シミュレーション手順

```
Step 1: 最悪ケースのパラメータを特定
  - 最小バッチサイズ
  - 最小勤務可能人数
  - 最大制約数

Step 2: AIの立場で要件を読む
  - 「このプロンプトを受け取ったAIは何を期待されているか？」
  - 「達成可能か？不可能か？」

Step 3: 論理的矛盾を洗い出す
  - バッチサイズ vs 必要人数
  - 時間帯制限 vs シフト種別要件
  - 曜日制限 vs 日別人員要件

Step 4: 矛盾がある場合の修正方針を決定
  - 絶対値 → 相対値（目安）に変更
  - バッチ単独 → 全体の一部と明記
  - 必須要件 → バッチスコープ外と注記
```

### 2.3 設計ドキュメントテンプレート

新しいプロンプトを作成する際は、以下のセクションを含めること：

```markdown
## プロンプト設計書

### 概要
[プロンプトの目的]

### 入力パラメータ
| パラメータ | 型 | 範囲 | 最悪ケース |
|-----------|-----|------|----------|
| batchSize | int | 1-10 | 1 |
| ...

### 出力要件
[期待するJSON形式]

### 制約一覧
| 制約 | 必須/任意 | バッチ単位で達成可能か |
|-----|----------|---------------------|
| ... | 必須 | ✅ / ❌ |

### 論理的整合性チェック結果
- [ ] 最小バッチで達成可能か確認済み
- [ ] 制約間の矛盾なし
- [ ] 数値の整合性確認済み

### 思考シミュレーション
[最悪ケースでAIがどう動作するかのシミュレーション結果]
```

---

## 3. 自動検証の推奨事項

### 3.1 単体テストで検証すべき項目

```typescript
describe('buildDetailedPrompt', () => {
  it('最小バッチサイズでも矛盾した要件を含まない', () => {
    const skeleton = { staffSchedules: Array(12).fill(mockSchedule) };
    const smallBatch = [mockStaff, mockStaff]; // 2名

    const prompt = buildDetailedPrompt(smallBatch, requirements, skeleton);

    // 「5名必須」のような絶対要件が含まれていないこと
    expect(prompt).not.toMatch(/合計[0-9]+名を配置すること/);
    // バッチコンテキストが含まれていること
    expect(prompt).toMatch(/全\d+名中の\d+名分/);
  });
});
```

### 3.2 プロンプト検証関数

```typescript
function validatePromptLogic(
  prompt: string,
  batchSize: number,
  totalStaff: number,
  requiredPerDay: number
): ValidationResult {
  const errors: string[] = [];

  // 絶対要件チェック
  const absoluteRequirement = prompt.match(/合計(\d+)名/);
  if (absoluteRequirement) {
    const required = parseInt(absoluteRequirement[1]);
    if (required > batchSize) {
      errors.push(`バッチサイズ${batchSize}で${required}名の配置は不可能`);
    }
  }

  return { valid: errors.length === 0, errors };
}
```

---

## 4. BUG-017から学んだ教訓

### 4.1 問題の本質

```
設計時の思考: 「5名/日を配置する必要がある」→プロンプトに記載
実行時の現実: バッチ2（2名）がこのプロンプトを受け取る
AIの判断: 「2名では5名/日は不可能」→拒否してエラー応答

根本原因: 設計時にバッチ処理の最悪ケースを考慮しなかった
```

### 4.2 防止策

| フェーズ | 対策 |
|---------|------|
| 設計時 | 思考シミュレーション（最悪ケース検証） |
| 実装時 | プロンプト検証関数の使用 |
| レビュー時 | このチェックリストの使用 |
| テスト時 | 最小バッチでの単体テスト |

---

## 5. 関連ドキュメント

- [BUG-017修正記録](.kiro/bugfix-batch-prompt-json-2025-12-08.md)
- [AI品質改善ガイド](.kiro/ai-quality-improvement-guide.md)
- [動的制約生成パターン](../CLAUDE.md#動的制約生成パターン重要---phase-44-48で確立)

---

**作成者**: Claude Opus 4.5
**最終更新**: 2025-12-08
