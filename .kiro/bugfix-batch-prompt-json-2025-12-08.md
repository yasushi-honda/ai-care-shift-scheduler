# BUG-017: バッチプロンプトJSONパースエラー修正

**発生日**: 2025-12-08
**解決日**: 2025-12-08
**重要度**: 高（AI生成が完全に失敗）

---

## 1. 問題の概要

### 症状
Phase 52デプロイ後、AI生成時にJSONパースエラーが発生：
```
Failed to parse Gemini JSON response: Unexpected token '提', "提供されたスタッフ（"... is not valid JSON
```

### 影響
- AI生成が完全に失敗（500エラー）
- シフト生成が不可能

---

## 2. 根本原因分析

### Cloud Functionsログから発見
```
📝 Batch 2/2: 加藤明子, 伊藤真理
```

Batch 2には2名のスタッフしかいないにもかかわらず、プロンプトには以下の要件が含まれていた：
```
# 🔴 最重要ルール（絶対に違反しないこと）
**各営業日（月〜土）に合計5名を配置すること。1人でも不足は許されません。**
```

### AIの応答
AIは「2名では5名/日を配置するのは論理的に不可能」と判断し、JSON生成を拒否：
```
提供されたスタッフ（2名）だけでは、各営業日に合計5名を配置するという「最重要ルール」を満たすことができません。
```

### 原因の本質
- `buildDetailedPrompt`がバッチサイズを考慮せずに全体の人員要件を記述
- バッチ処理の文脈をAIに伝えていなかった

---

## 3. 修正内容

### 変更ファイル
- `functions/src/phased-generation.ts`: `buildDetailedPrompt`関数

### 主な変更点

| 項目 | 修正前 | 修正後 |
|-----|--------|--------|
| コンテキスト | なし | 「全12名中の2名分」と明記 |
| 人員要件 | 絶対値（5名/日必須） | 比例配分の「目安」 |
| 責任範囲 | 曖昧 | 「このバッチのみ」と明確化 |
| 出力形式 | 暗黙的 | JSON例を明示的に記載 |

### 修正後のプロンプト構造
```
# 🔴 重要: このバッチについて
**このバッチは全12名中の2名分です。**
他のバッチと合わせて全体の人員配置を満たします。

## シフト配分の参考情報
| シフト | 必要人数（全体） | このバッチでの目安 |
| 早番 | 2名/日 | 0名程度 |
...

# 🔴 出力形式（必須）
**必ずJSON形式で出力してください。説明文は不要です。**
```

---

## 4. 教訓

### バッチ処理プロンプトの設計原則

1. **コンテキスト明示**: バッチが全体のどの部分かを明記
2. **要件の相対化**: 絶対値ではなく比例配分の「目安」を提示
3. **責任範囲限定**: バッチ内のスタッフのみが対象と明記
4. **出力形式強制**: JSON例を明示的に記載

### AIへの指示で避けるべきパターン
```
❌ 「各営業日に5名を配置すること」（バッチサイズと矛盾）
❌ 「絶対に違反しないこと」（達成不可能な場合AIが拒否）
✅ 「このバッチは全体の一部です。目安として...」
```

---

## 5. 検証

### 確認事項
- [ ] JSONパースエラーが発生しないこと
- [ ] 全バッチが正常にJSON形式で出力されること
- [ ] シフト生成が完了すること

---

## 6. 関連ドキュメント

- [Phase 52設計](.kiro/phase52-dynamic-constraints-design-2025-12-08.md)
- [AI品質改善ガイド](.kiro/ai-quality-improvement-guide.md)
- [CLAUDE.md](../CLAUDE.md) - 動的制約生成パターン

---

**作成者**: Claude Opus 4.5
**最終更新**: 2025-12-08
