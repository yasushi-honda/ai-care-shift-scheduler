# AI Care Shift Scheduler - 引き継ぎプロンプト

**作成日**: 2025-12-09
**最終更新**: 2025-12-09 18:00 JST
**作成者**: Claude Code セッション

---

## 最新ステータス（2025-12-09 18:00 JST更新）

### 本日完了した作業

| 作業 | 状態 | 詳細 |
|------|------|------|
| BUG-020解決 | ✅ | アコーディオン展開時UI重複（CSS Grid方式に修正） |
| AI評価レポート作成・承認 | ✅ | `.kiro/ai-system-evaluation-2025-12-09.md` |
| ai-shift-algorithm.html更新 | ✅ | Phase 51-53情報追加、AIアシスト位置づけ明記 |
| .kiroドキュメント整理 | ✅ | アーカイブ移行、HANDOFF更新 |
| BUG-019解決 | ✅ | Firestoreインデックスデプロイ完了 |

### AI評価結果サマリー

**総合スコア**: 4.0 / 5.0（良好）
**結論**: クライアント納品可能レベル

**重要な位置づけ**: 本システムは「完全自動シフト生成」ではなく「AIアシストによる叩き台提供」

---

## プロジェクト概要

**AI Care Shift Scheduler** - 介護施設向けAI自動シフト生成システム

- **フロントエンド**: React + TypeScript + Vite
- **バックエンド**: Firebase (Auth, Firestore, Functions, Hosting)
- **AI**: Gemini 2.5 Flash (Vertex AI)
- **本番URL**: https://ai-care-shift-scheduler.web.app

---

## 重要ドキュメント

### 必読（優先順位順）
1. **CLAUDE.md** - プロジェクト全体のルール・制約（最重要）
2. **.kiro/steering/** - プロジェクト固有の設計方針
3. **.kiro/specs/** - 機能仕様書

### 本日作成/更新されたドキュメント
- `.kiro/ai-system-evaluation-2025-12-09.md` - AI評価レポート全文
- `docs/ai-shift-algorithm.html` - AIアルゴリズム説明ページ（GitHub Pages）
- `.kiro/archive-migration-log.md` - アーカイブ移行ログ

### 最近の変更（2025-12-09）
| Phase/BUG | 内容 | ステータス |
|-----------|------|-----------|
| BUG-022 | 休暇残高パーミッションエラー（demoSignIn viewer→editor） | ✅ 解決済み |
| BUG-021 | 休暇残高詳細ボタンエラー（props名不一致） | ✅ 解決済み |
| BUG-020 | アコーディオン展開時UI重複修正 | ✅ 解決済み |
| Phase 54 | AI評価履歴・再評価機能 | ✅ 完了 |
| Phase 53 | 制約レベル別評価システム | ✅ 完了 |
| BUG-019 | Firestoreインデックス + CI/CDデプロイ漏れ | ✅ 解決済み |
| ドキュメント | AI評価レポート + GitHub Pages更新 | ✅ 完了 |

---

## 開発ワークフロー

```bash
# 1. コード変更
# 2. 型チェック
cd functions && npx tsc --noEmit

# 3. CodeRabbitレビュー
coderabbit review --plain --base-commit HEAD~1 --config CLAUDE.md

# 4. コミット & プッシュ
git add . && git commit -m "..."
git push origin main

# 5. GitHub Actions 監視
gh run list --limit 1
```

---

## 重要な教訓（最新）

### BUG-019: Firestoreインデックス（2025-12-09）

**二重の問題パターン**:
1. コード修正（インデックス定義）だけでは不十分
2. CI/CDがそのコードをデプロイしているか確認が必須

**サブコレクションのインデックス**:
```json
{
  "collectionGroup": "aiGenerationHistory",
  "queryScope": "COLLECTION_GROUP"  // ❗ COLLECTIONではなくCOLLECTION_GROUP
}
```

**CI/CDでのデプロイ**:
```bash
firebase deploy --only firestore:rules,firestore:indexes  // ❗ indexesを含める
```

詳細: `.kiro/bugfix-firestore-index-aiGenerationHistory-2025-12-09.md`

### BUG-020: アコーディオンUI重複（2025-12-09）

**問題**: スタッフ情報展開時に下部コンテンツと重複表示

**原因**: `max-h-screen`（100vh）がコンテンツ量に対応できず、`overflow:visible`で下にはみ出し

**修正**: CSS Gridベースのアニメーション（`grid-rows-[0fr]/[1fr]`）に変更

```tsx
// 修正後
<div className={`grid ${isOpen ? 'grid-rows-[1fr]' : 'grid-rows-[0fr]'}`}>
  <div className="overflow-hidden">
    {children}
  </div>
</div>
```

詳細: `.kiro/bugfix-accordion-overlap-2025-12-09.md`

---

## Gemini API 重要ルール

CLAUDE.mdの「Gemini 2.5 Flash 設定ルール」セクションを必ず参照。特に：

1. **@google/genai SDK使用必須**（@google-cloud/vertexaiは非対応）
2. **maxOutputTokens: 65536**（思考モード対応）
3. **thinkingBudget: 16384**（思考トークン制限）
4. **responseSchema/responseMimeType禁止**（thinkingBudgetと非互換）

---

## 次のタスク候補

### 優先度高
1. **Phase 45継続**: AIシフト生成進行状況表示機能（作業中）

### 中期改善（保守フェーズ）
2. EvaluationServiceのリファクタリング（1000行超→分割）
3. 評価ロジックのユニットテスト追加
4. Few-shot例のプロンプト追加

### 長期構想
5. ハイブリッドアプローチ（LLM + 制約ソルバー）調査
6. Evalシステム構築（複数テストケース自動実行）

---

## Serenaメモリ

関連メモリを`read_memory`で確認：

### 最新（2025-12-09）
- `ai_system_evaluation_2025-12-09` - AI評価サマリー
- `bug019_firestore_index_cicd_2025-12-09` - BUG-019の詳細
- `phase54_evaluation_history_reevaluate_2025-12-09` - Phase 54実装
- `phase53_constraint_level_evaluation_2025-12-09` - Phase 53実装

### 重要（常時参照推奨）
- `PROJECT_HANDOFF_LATEST` - プロジェクト引き継ぎ情報
- `project_overview` - プロジェクト概要
- `tech_stack` - 技術スタック

---

## 注意事項

- **Firebase CLI認証エラー時**: GitHub Actions経由でデプロイ（CLAUDE.md参照）
- **インデックス変更後**: 構築完了まで数分待機が必要
- **デプロイ後**: ハードリロード（Cmd+Shift+R）で確認
- **AIシステムの位置づけ**: 完全自動ではなく「叩き台提供」（評価レポート参照）

---

## セッション開始時の推奨コマンド

```bash
# 1. 最新状態を確認
git status
gh run list --limit 3

# 2. 本ファイルを読む
cat .kiro/HANDOFF-2025-12-09.md

# 3. 必要に応じてSerenaメモリ確認
# - ai_system_evaluation_2025-12-09
# - PROJECT_HANDOFF_LATEST
```
