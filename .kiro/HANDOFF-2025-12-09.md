# AI Care Shift Scheduler - 引き継ぎプロンプト

**作成日**: 2025-12-09
**最終更新**: 2025-12-09 11:30 JST
**作成者**: Claude Code セッション

---

## 最新ステータス

### BUG-019: 解決済み
**問題**: `aiGenerationHistory`インデックスがデプロイされておらず、評価履歴取得時にエラー
**解決**: 2025-12-09 11:21 JSTにCI/CDでインデックスデプロイ完了、11:25 JSTに本番環境で動作確認済み

---

## プロジェクト概要

**AI Care Shift Scheduler** - 介護施設向けAI自動シフト生成システム

- **フロントエンド**: React + TypeScript + Vite
- **バックエンド**: Firebase (Auth, Firestore, Functions, Hosting)
- **AI**: Gemini 2.5 Flash (Vertex AI)
- **本番URL**: https://ai-care-shift-scheduler.web.app

---

## 重要ドキュメント

### 必読（優先順位順）
1. **CLAUDE.md** - プロジェクト全体のルール・制約（最重要）
2. **.kiro/steering/** - プロジェクト固有の設計方針
3. **.kiro/specs/** - 機能仕様書

### 最近の変更（2025-12-09）
| Phase/BUG | 内容 | ステータス |
|-----------|------|-----------|
| Phase 54 | AI評価履歴・再評価機能 | ✅ 完了 |
| Phase 53 | 制約レベル別評価システム | ✅ 完了 |
| BUG-019 | Firestoreインデックス + CI/CDデプロイ漏れ | ✅ 解決済み |

---

## 開発ワークフロー

```bash
# 1. コード変更
# 2. 型チェック
cd functions && npx tsc --noEmit

# 3. CodeRabbitレビュー
coderabbit review --plain --base-commit HEAD~1 --config CLAUDE.md

# 4. コミット & プッシュ
git add . && git commit -m "..."
git push origin main

# 5. GitHub Actions 監視
gh run list --limit 1
```

---

## 重要な教訓（最新）

### BUG-019: Firestoreインデックス（2025-12-09）

**二重の問題パターン**:
1. コード修正（インデックス定義）だけでは不十分
2. CI/CDがそのコードをデプロイしているか確認が必須

**サブコレクションのインデックス**:
```json
{
  "collectionGroup": "aiGenerationHistory",
  "queryScope": "COLLECTION_GROUP"  // ❗ COLLECTIONではなくCOLLECTION_GROUP
}
```

**CI/CDでのデプロイ**:
```bash
firebase deploy --only firestore:rules,firestore:indexes  // ❗ indexesを含める
```

詳細: `.kiro/bugfix-firestore-index-aiGenerationHistory-2025-12-09.md`

---

## Gemini API 重要ルール

CLAUDE.mdの「Gemini 2.5 Flash 設定ルール」セクションを必ず参照。特に：

1. **@google/genai SDK使用必須**（@google-cloud/vertexaiは非対応）
2. **maxOutputTokens: 65536**（思考モード対応）
3. **thinkingBudget: 16384**（思考トークン制限）
4. **responseSchema/responseMimeType禁止**（thinkingBudgetと非互換）

---

## 次のタスク

1. **Phase 45継続**: AIシフト生成進行状況表示機能（作業中）
2. **Phase 54**: AI評価履歴・再評価機能（完了済み、動作確認OK）

---

## Serenaメモリ

関連メモリを`read_memory`で確認：

- `bug019_firestore_index_cicd_2025-12-09` - BUG-019の詳細
- `phase54_evaluation_history_reevaluate_2025-12-09` - Phase 54実装
- `phase53_constraint_level_evaluation_2025-12-09` - Phase 53実装

---

## 注意事項

- **Firebase CLI認証エラー時**: GitHub Actions経由でデプロイ（CLAUDE.md参照）
- **インデックス変更後**: 構築完了まで数分待機が必要
- **デプロイ後**: ハードリロード（Cmd+Shift+R）で確認
