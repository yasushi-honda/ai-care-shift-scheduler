# バージョン履歴保持機能 - 手動テストガイド

**更新日**: 2025-11-17
**対象機能**: AIシフト生成時のバージョン履歴保持
**修正内容**: App.tsx の handleGenerateClick, handleGenerateDemo メソッド修正

---

## 📋 テスト目的

AIシフト生成を同じ月で複数回実行しても、確定時に作成されたバージョン履歴が保持されることを検証する。

---

## 🎯 テストシナリオ

### シナリオ1: バージョン履歴の保持確認（基本フロー）

#### 前提条件
- Firebase Emulator起動済み
- 開発サーバー起動済み（http://localhost:5173）
- テスト用施設とスタッフが登録済み

#### テスト手順

##### Step 1: 初回AI生成
1. ログイン → 施設選択
2. 対象月を選択（例: 2025-01）
3. スタッフ設定タブでスタッフを1名以上登録
4. 「シフト作成実行」ボタンをクリック
5. AI生成完了を待つ

**期待結果:**
- ✅ シフト表が表示される
- ✅ ステータスが「下書き」になっている
- ✅ 「バージョン履歴」ボタンをクリック → 履歴なし（まだ確定していないため）

##### Step 2: 初回確定
1. 「確定」ボタンをクリック
2. 確定完了を確認

**期待結果:**
- ✅ ステータスが「確定済み」になる
- ✅ 「バージョン履歴」ボタンをクリック → **`version 1` が表示される**
- ✅ 履歴の内容:
  - バージョン番号: 1
  - 作成日時: 確定時の日時
  - 変更内容: 「確定」
  - スタッフスケジュール: 初回生成時の内容

##### Step 3: 2回目AI生成（同じ月）
1. 同じ対象月（2025-01）のまま
2. 「シフト作成実行」ボタンを再度クリック
3. AI生成完了を待つ

**期待結果:**
- ✅ シフト表が更新される（新しいシフト内容が表示）
- ✅ ステータスが「下書き」に戻る
- ✅ **「バージョン履歴」ボタンをクリック → `version 1` が保持されている** ← 重要！

**🔍 検証ポイント:**
```
修正前: version 1 が消える（履歴クリア）
修正後: version 1 が保持される ✅
```

##### Step 4: 再度確定
1. 「確定」ボタンをクリック
2. 確定完了を確認

**期待結果:**
- ✅ ステータスが「確定済み」になる
- ✅ 「バージョン履歴」ボタンをクリック → **`version 1` と `version 2` の両方が表示される**
- ✅ `version 2` の履歴内容:
  - バージョン番号: 2
  - 作成日時: 2回目確定時の日時
  - 変更内容: 「確定」
  - スタッフスケジュール: 2回目生成時の内容

##### Step 5: バージョン復元
1. 「バージョン履歴」ボタンをクリック
2. `version 1` の「復元」ボタンをクリック
3. 復元完了を確認

**期待結果:**
- ✅ シフト表が `version 1` の内容に戻る
- ✅ ステータスが「下書き」になる
- ✅ 「バージョン履歴」を確認 → `version 1`, `version 2`, **`version 3`（復元前のスナップショット）** が表示される

---

### シナリオ2: 異なる月のバージョン履歴独立性確認

#### テスト手順

##### Step 1: 2025-01のスケジュール作成・確定
1. 対象月を「2025-01」に設定
2. AI生成 → 確定
3. 「バージョン履歴」確認 → `version 1` が存在

##### Step 2: 2025-02のスケジュール作成・確定
1. 対象月を「**2025-02**」に変更
2. AI生成 → 確定
3. 「バージョン履歴」確認 → `version 1` が存在（2025-02の履歴）

##### Step 3: 2025-01に戻って確認
1. 対象月を「**2025-01**」に戻す
2. 「バージョン履歴」確認

**期待結果:**
- ✅ 2025-01の `version 1` が表示される
- ✅ 2025-02の履歴は表示されない（月ごとに独立）

##### Step 4: 2025-02に戻って確認
1. 対象月を「2025-02」に変更
2. 「バージョン履歴」確認

**期待結果:**
- ✅ 2025-02の `version 1` が表示される
- ✅ 2025-01の履歴は表示されない

**🔍 検証ポイント:**
- 各月のバージョン履歴は完全に独立
- 月を切り替えても、それぞれの履歴が保持される

---

### シナリオ3: デモシフト生成での履歴保持

#### テスト手順

##### Step 1: デモシフト生成
1. 対象月を「2025-03」に設定
2. 「デモシフト生成」ボタンをクリック
3. 確定

**期待結果:**
- ✅ デモシフトが生成・確定される
- ✅ `version 1` が作成される

##### Step 2: デモシフト再生成
1. 同じ対象月（2025-03）で「デモシフト生成」を再度クリック

**期待結果:**
- ✅ シフト表が更新される
- ✅ **`version 1` が保持される** ← handleGenerateDemo も修正済み

---

## 🐛 既知のエラーと対処法

### エラー1: 「バージョン履歴を表示できません」
**原因:** currentScheduleId が null（スケジュールが未作成）

**対処法:**
1. 先にAI生成を実行
2. スケジュールが保存されてから「バージョン履歴」ボタンを押下

### エラー2: 「施設またはユーザー情報が取得できません」
**原因:** ログインしていない、または施設未選択

**対処法:**
1. ログインを確認
2. 施設を選択

---

## 📊 テスト結果記録テンプレート

```markdown
## テスト実施記録

**実施日時:** YYYY-MM-DD HH:MM
**実施者:** [名前]
**環境:** ローカル開発環境 / Emulator

### シナリオ1: バージョン履歴の保持確認
- [ ] Step 1: 初回AI生成 - 成功/失敗
- [ ] Step 2: 初回確定 - 成功/失敗
- [ ] Step 3: 2回目AI生成（version 1保持確認） - 成功/失敗 ← 重要！
- [ ] Step 4: 再度確定 - 成功/失敗
- [ ] Step 5: バージョン復元 - 成功/失敗

### シナリオ2: 異なる月の独立性
- [ ] Step 1-4: 月ごとの履歴独立性確認 - 成功/失敗

### シナリオ3: デモシフト生成
- [ ] Step 1-2: デモシフトでの履歴保持 - 成功/失敗

### 総合評価
- [ ] すべてのシナリオが成功
- [ ] 一部失敗（詳細を記載）

### 備考
[気づいた点、問題点などを記載]
```

---

## 🔧 Firestore直接確認（デバッグ用）

Firebase Emulator UIで直接データを確認する方法:

1. http://localhost:4000 にアクセス
2. Firestore タブを選択
3. 以下のパスを確認:

```
/facilities/{facilityId}/schedules/{scheduleId}
  ├── targetMonth: "2025-01"
  ├── version: 2
  ├── status: "confirmed"
  └── /versions/  ← サブコレクション
      ├── 1  ← version 1の履歴
      │   ├── versionNumber: 1
      │   ├── staffSchedules: [...]
      │   ├── changeDescription: "確定"
      │   └── createdAt: Timestamp
      └── 2  ← version 2の履歴
          └── ...
```

---

## ✅ テスト完了の定義

以下をすべて満たすこと:
- ✅ シナリオ1のStep 3で `version 1` が保持される
- ✅ シナリオ2で月ごとの履歴が独立している
- ✅ シナリオ3でデモシフトでも履歴が保持される
- ✅ Firestore上で versions サブコレクションが正しく作成されている

---

## 📝 関連ドキュメント

- [scheduleService.ts](../../src/services/scheduleService.ts) - バージョン履歴API実装
- [App.tsx](../../App.tsx) - handleGenerateClick, handleGenerateDemo の修正箇所
- [types.ts](../../types.ts) - Schedule, ScheduleVersion の型定義
