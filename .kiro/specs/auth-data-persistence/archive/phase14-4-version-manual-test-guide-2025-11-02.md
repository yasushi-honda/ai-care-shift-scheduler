# Phase 14.4手動テストガイド：バージョン管理機能検証

**作成日**: 2025年11月2日
**仕様ID**: auth-data-persistence
**Phase**: Phase 14.4（バージョン管理機能E2Eテスト）
**対象環境**: 本番環境（https://ai-care-shift-scheduler.web.app）
**言語**: 日本語

---

## 📋 はじめに

本ガイドは、Phase 14.4で実装されたシフトのバージョン管理機能が正しく動作していることを手動で検証するための手順書です。

### 検証の目的

- 下書き保存機能が正常に動作すること
- シフト確定機能が正常に動作すること
- バージョン履歴の作成と表示が正常に動作すること
- 過去バージョンへの復元機能が正常に動作すること
- バージョン履歴の不変性が保証されること（Firestore Security Rules）

### 前提条件

- 本番環境にアクセス可能なGoogleアカウントを持っていること
- テスト用の施設にadmin権限以上でアクセスできること
- Firebase Consoleにアクセスできること（Firestoreデータ確認用）

### 使用するツール

- Webブラウザ（Chrome推奨）
- Firebase Console（Firestoreデータ確認用）

---

## 🧪 Section 1: 下書き保存と確定の検証

### 1.1 シフト生成（初期状態: status='draft', version=1）

#### 検証手順

1. **本番環境にアクセス**
   - URL: https://ai-care-shift-scheduler.web.app
   - Googleアカウントでログイン

2. **シフト生成ボタンをクリック**
   - メイン画面上部の「シフト作成実行」ボタンまたは「デモシフト生成」ボタンをクリック
   - ローディングインジケーターが表示されることを確認（AIシフトの場合）

3. **シフト生成完了を待つ**
   - シフト生成が完了するまで待つ（通常5-10秒）
   - トーストメッセージ「シフトを生成しました」が表示されることを確認

4. **カレンダーに表示されることを確認**
   - カレンダーに各スタッフのシフトが表示されることを確認

5. **Firestoreで初期状態を確認**
   - Firebase Console（https://console.firebase.google.com/）にアクセス
   - プロジェクト: ai-care-shift-scheduler
   - Firestore Database → `/facilities/{facilityId}/schedules` コレクション
   - 新規作成されたschedulesドキュメントを開く
   - **フィールド確認**:
     - status = "draft" ← 下書き状態
     - version = 1 ← 初期バージョン
     - generatedAt, generatedBy, targetMonth, staffSchedules が存在すること

#### 期待結果

- ✅ シフトが生成される
- ✅ カレンダーに表示される
- ✅ Firestoreにstatus='draft', version=1が保存される

---

### 1.2 シフト編集と下書き保存

#### 検証手順

1. **シフトセルをダブルクリックして編集**
   - カレンダー上の任意のシフトセル（例: 11月5日の田中太郎）をダブルクリック
   - ドロップダウンメニューが表示されることを確認

2. **シフトを変更**
   - 別の時間帯（例: 早番 → 日勤）を選択
   - セルの表示が即座に変更されることを確認

3. **さらに数箇所のシフトを編集**
   - 11月7日の佐藤花子: 日勤 → 遅番
   - 11月10日の鈴木美咲: 遅番 → 早番
   - （合計3-5箇所程度編集する）

4. **下書き保存ボタンをクリック**
   - 画面上部の「下書き保存」ボタンをクリック
   - トーストメッセージ「下書きを保存しました」が表示されることを確認

5. **Firestoreで下書き保存を確認**
   - Firebase Consoleで該当scheduleドキュメントを確認
   - **フィールド確認**:
     - status = "draft" ← 引き続き下書き状態
     - version = 1 ← バージョン番号は変わらない
     - staffSchedules配列が更新されていることを確認（編集した箇所が反映されている）
     - updatedAtタイムスタンプが更新されていることを確認

6. **ページリロードして復元されることを確認**
   - ブラウザのリロードボタン（Cmd+R / Ctrl+R）を押す
   - 編集したシフトが復元されることを確認

#### 期待結果

- ✅ シフトセルをダブルクリックでドロップダウンが表示される
- ✅ シフト変更が即座にUIに反映される
- ✅ 下書き保存ボタンをクリックできる
- ✅ トーストメッセージが表示される
- ✅ Firestoreにstatus='draft', version=1（変わらず）が保存される
- ✅ ページリロード後も編集内容が復元される

---

### 1.3 シフト確定（status='confirmed', バージョン履歴作成）

#### 検証手順

1. **確定ボタンをクリック**
   - 画面上部の「確定」ボタンをクリック
   - トーストメッセージ「シフトを確定しました」が表示されることを確認

2. **確定ボタンが無効化されることを確認**
   - 「確定」ボタンが無効化（グレーアウト）されることを確認
   - ボタンをクリックしても反応しないことを確認

3. **Firestoreでstatus='confirmed'を確認**
   - Firebase Consoleで該当scheduleドキュメントを確認
   - **フィールド確認**:
     - status = "confirmed" ← 確定状態に変更
     - version = 2 ← バージョン番号がインクリメント
     - updatedAtタイムスタンプが更新されていることを確認

4. **versionsサブコレクションにバージョン履歴が作成されたことを確認**
   - Firebase Consoleで該当scheduleドキュメントを開く
   - サブコレクション「versions」をクリック
   - **ドキュメント確認**:
     - versionNumber = 1のドキュメントが存在することを確認
     - **フィールド確認**:
       - versionNumber = 1
       - targetMonth = （確定前の対象月）
       - staffSchedules = （確定前のシフトデータ配列）
       - createdAt, createdBy = （確定を実行したユーザー）
       - changeDescription = "確定"
       - previousVersion = 0

#### 期待結果

- ✅ 確定ボタンをクリックできる
- ✅ トーストメッセージが表示される
- ✅ 確定ボタンが無効化される
- ✅ Firestoreにstatus='confirmed', version=2が保存される
- ✅ versionsサブコレクションにversionNumber=1が作成される

---

## 🧪 Section 2: バージョン履歴の表示検証

### 2.1 バージョン履歴モーダルの表示

#### 検証手順

1. **バージョン履歴ボタンをクリック**
   - 画面上部の「バージョン履歴」ボタン（紫色、時計アイコン）をクリック
   - 「バージョン履歴」モーダルが表示されることを確認

2. **バージョン一覧の確認**
   - versionNumber = 1のエントリが表示されることを確認
   - **表示内容確認**:
     - バージョン番号: 「Version 1」
     - 確定日時: （確定した日時が表示される）
     - 確定者: （自分のメールアドレスまたは名前）
     - 変更説明: 「確定」
     - 「復元」ボタンが表示されることを確認

3. **モーダルを閉じる**
   - 「閉じる」ボタンをクリック
   - モーダルが閉じることを確認

#### 期待結果

- ✅ バージョン履歴ボタンをクリックできる
- ✅ バージョン履歴モーダルが表示される
- ✅ バージョン一覧が正しく表示される（versionNumber=1）
- ✅ 確定日時、確定者、変更説明が表示される

---

## 🧪 Section 3: 過去バージョンへの復元検証

### 3.1 シフトを再度編集（復元テスト準備）

#### 検証手順

1. **シフトセルを数箇所編集**
   - カレンダー上の任意のシフトセルをダブルクリックして編集
   - 11月12日の田中太郎: 早番 → 夜勤
   - 11月15日の佐藤花子: 日勤 → 休み
   - 11月18日の鈴木美咲: 遅番 → 日勤
   - （合計3-5箇所程度編集する）

2. **下書き保存ボタンをクリック**
   - 「下書き保存」ボタンをクリック
   - トーストメッセージ「下書きを保存しました」が表示されることを確認

3. **Firestoreでstatus='draft'を確認**
   - Firebase Consoleで該当scheduleドキュメントを確認
   - status = "draft"（確定状態から下書き状態に戻る）
   - version = 2（バージョン番号は変わらない、確定時のversionのまま）
   - staffSchedules配列が更新されていることを確認

#### 期待結果

- ✅ 確定後のシフトを再度編集できる
- ✅ 下書き保存が正常に動作する
- ✅ Firestoreにstatus='draft', version=2が保存される

---

### 3.2 過去バージョンへの復元実行

#### 検証手順

1. **バージョン履歴モーダルを開く**
   - 「バージョン履歴」ボタンをクリック

2. **過去バージョンを選択**
   - versionNumber = 1の「復元」ボタンをクリック
   - 確認ダイアログが表示されることを確認
   - 確認ダイアログの内容:
     - 「Version 1に復元しますか？」
     - 「現在の変更は新しいバージョンとして保存されます」

3. **復元を確認**
   - 確認ダイアログの「復元」ボタンをクリック
   - トーストメッセージ「バージョンを復元しました」が表示されることを確認
   - モーダルが閉じることを確認

4. **カレンダーに反映されることを確認**
   - カレンダーが過去バージョン（versionNumber=1の内容）に戻ることを確認
   - 先ほど編集した箇所（11月12日の田中太郎、11月15日の佐藤花子、11月18日の鈴木美咲）が元に戻ることを確認

5. **Firestoreでschedulesドキュメントを確認**
   - Firebase Consoleで該当scheduleドキュメントを確認
   - **フィールド確認**:
     - status = "draft" ← 復元後は下書き状態
     - version = 3 ← バージョン番号がインクリメント
     - staffSchedules = （versionNumber=1の内容）
     - updatedAtタイムスタンプが更新されていることを確認

6. **versionsサブコレクションに新しいバージョンが作成されたことを確認**
   - Firebase Consoleで該当scheduleドキュメントのversionsサブコレクションを確認
   - **ドキュメント確認**:
     - versionNumber = 2のドキュメントが新規作成されていることを確認
     - **フィールド確認**:
       - versionNumber = 2
       - targetMonth = （対象月）
       - staffSchedules = （復元前の編集内容、11月12日・15日・18日の編集が含まれる）
       - createdAt, createdBy = （復元を実行したユーザー）
       - changeDescription = "バージョン1から復元"
       - previousVersion = 1

#### 期待結果

- ✅ 過去バージョンを選択できる
- ✅ 復元確認ダイアログが表示される
- ✅ トーストメッセージが表示される
- ✅ カレンダーが過去バージョンの内容に戻る
- ✅ Firestoreにstatus='draft', version=3が保存される
- ✅ versionsサブコレクションに復元前の状態（versionNumber=2）が保存される

---

### 3.3 複数バージョンの確認

#### 検証手順

1. **バージョン履歴モーダルを再度開く**
   - 「バージョン履歴」ボタンをクリック

2. **2つのバージョンが表示されることを確認**
   - versionNumber = 1のエントリが表示される
     - 確定日時: （最初に確定した日時）
     - 確定者: （自分のメールアドレス）
     - 変更説明: 「確定」
   - versionNumber = 2のエントリが表示される
     - 確定日時: （復元を実行した日時）
     - 確定者: （自分のメールアドレス）
     - 変更説明: 「バージョン1から復元」

3. **バージョンが時系列順に並んでいることを確認**
   - 新しいバージョン（versionNumber=2）が上に表示される
   - 古いバージョン（versionNumber=1）が下に表示される

#### 期待結果

- ✅ バージョン履歴モーダルに2つのバージョンが表示される
- ✅ 時系列順に並んでいる

---

## 🧪 Section 4: バージョン履歴の不変性検証

### 4.1 バージョン履歴の更新試行（失敗することを確認）

#### 検証手順

1. **Firebase Consoleでversionsサブコレクションを開く**
   - Firebase Console → Firestore Database
   - `/facilities/{facilityId}/schedules/{scheduleId}/versions` サブコレクションを開く
   - versionNumber = 1のドキュメントを選択

2. **フィールドを手動更新しようとする**
   - 「フィールドを編集」をクリック
   - 例: changeDescriptionフィールドを "確定" → "手動変更テスト" に変更しようとする
   - 「保存」ボタンをクリック

3. **エラーメッセージを確認**
   - Firestore Security Rulesにより更新が拒否されることを確認
   - エラーメッセージ:
     - 「PERMISSION_DENIED: Missing or insufficient permissions」
     - または「アクセスが拒否されました」

#### 期待結果

- ✅ versionsサブコレクションのドキュメントを手動更新できない
- ✅ Firestore Security Rulesにより拒否される
- ✅ エラーメッセージが表示される

---

### 4.2 バージョン履歴の削除試行（失敗することを確認）

#### 検証手順

1. **Firebase Consoleでversionsサブコレクションを開く**
   - Firebase Console → Firestore Database
   - `/facilities/{facilityId}/schedules/{scheduleId}/versions` サブコレクションを開く
   - versionNumber = 1のドキュメントを選択

2. **ドキュメントを削除しようとする**
   - 「ドキュメントを削除」ボタン（ゴミ箱アイコン）をクリック
   - 確認ダイアログで「削除」をクリック

3. **エラーメッセージを確認**
   - Firestore Security Rulesにより削除が拒否されることを確認
   - エラーメッセージ:
     - 「PERMISSION_DENIED: Missing or insufficient permissions」
     - または「アクセスが拒否されました」

4. **versionsサブコレクションにドキュメントが残っていることを確認**
   - versionsサブコレクションを更新
   - versionNumber = 1のドキュメントが引き続き存在することを確認

#### 期待結果

- ✅ versionsサブコレクションのドキュメントを削除できない
- ✅ Firestore Security Rulesにより拒否される
- ✅ エラーメッセージが表示される
- ✅ ドキュメントが引き続き存在する

---

## 📊 検証結果チェックリスト

### Section 1: 下書き保存と確定

- [ ] シフト生成が成功する（status='draft', version=1）
- [ ] シフト編集と下書き保存が成功する
- [ ] 下書き保存後もstatus='draft', version=1のまま
- [ ] シフト確定が成功する（status='confirmed', version=2）
- [ ] versionsサブコレクションにversionNumber=1が作成される
- [ ] 確定ボタンが無効化される

### Section 2: バージョン履歴の表示

- [ ] バージョン履歴モーダルが表示される
- [ ] バージョン一覧が正しく表示される（versionNumber=1）
- [ ] 確定日時、確定者、変更説明が表示される

### Section 3: 過去バージョンへの復元

- [ ] 確定後のシフトを再度編集できる
- [ ] 過去バージョンの復元が成功する
- [ ] カレンダーが過去バージョンの内容に戻る
- [ ] Firestoreにstatus='draft', version=3が保存される
- [ ] versionsサブコレクションに復元前の状態（versionNumber=2）が保存される
- [ ] バージョン履歴モーダルに2つのバージョンが表示される

### Section 4: バージョン履歴の不変性

- [ ] versionsサブコレクションのドキュメントを更新できない（Security Rules）
- [ ] versionsサブコレクションのドキュメントを削除できない（Security Rules）
- [ ] エラーメッセージが表示される

---

## 🐛 トラブルシューティング

### 問題: 確定ボタンが無効化されている

**症状**: シフト生成直後から確定ボタンがグレーアウトしている

**原因**:
1. シフトがすでに確定済み（status='confirmed'）
2. 表示バグ

**対処方法**:
1. Firebase Consoleでstatus='draft'であることを確認
2. ページリロードを試みる
3. 別のシフトを生成してテストする

---

### 問題: バージョン履歴モーダルが空

**症状**: バージョン履歴モーダルを開いても何も表示されない

**原因**:
1. まだシフトを確定していない（versionsサブコレクションが空）
2. Firestoreからのデータ取得エラー

**対処方法**:
1. 先にシフトを確定する（Section 1.3）
2. Firebase Consoleでversionsサブコレクションが存在することを確認
3. ブラウザのコンソールでエラーメッセージを確認

---

### 問題: 復元後にカレンダーが更新されない

**症状**: 復元ボタンをクリックしてもカレンダーの表示が変わらない

**原因**:
1. フロントエンドの再レンダリング失敗
2. Firestoreへの保存失敗

**対処方法**:
1. ページリロードを試みる
2. Firebase ConsoleでschedulesドキュメントのstaffSchedulesが過去バージョンの内容になっているか確認
3. ブラウザのコンソールでエラーメッセージを確認

---

### 問題: Firebase ConsoleでSecurity Rulesエラーが出ない

**症状**: versionsサブコレクションのドキュメントを手動更新・削除しても成功してしまう

**原因**:
1. Firebase Consoleのユーザーがsuper-admin権限を持っている（Firestore Security Rulesは管理者には適用されない）
2. Security Rulesが正しくデプロイされていない

**対処方法**:
1. Firebase Consoleではなく、アプリケーション内（または別のテストユーザー）から試みる
2. Security Rulesを再デプロイする（`firebase deploy --only firestore:rules`）
3. Security Rulesのテストシミュレーターを使用する（Firebase Console → Rulesタブ → Test rules）

---

## 📝 検証完了報告

### 検証実施情報

- **検証日時**: ____年____月____日 ____時____分
- **検証者**: _________________________
- **本番環境URL**: https://ai-care-shift-scheduler.web.app
- **テスト施設ID**: _________________________
- **テストシフトID**: _________________________

### 検証結果サマリー

| Section | 実施状況 | 成功 | 失敗 | 備考 |
|---------|---------|------|------|------|
| Section 1: 下書き保存と確定 | ✅ / ❌ | __/6 | __/6 | |
| Section 2: バージョン履歴表示 | ✅ / ❌ | __/3 | __/3 | |
| Section 3: 過去バージョン復元 | ✅ / ❌ | __/6 | __/6 | |
| Section 4: バージョン履歴不変性 | ✅ / ❌ | __/2 | __/2 | |

### 検証完了判定

- [ ] すべてのテストケースが成功した
- [ ] 一部のテストケースが失敗したが、重大な問題ではない
- [ ] 重大な問題が発見された（詳細を以下に記載）

### 発見された問題

（問題があれば記載）

---

**作成日**: 2025年11月2日
**Phase 14.4ステータス**: 🟡 **手動テストガイド完成**
**次のアクション**: 本番環境での手動テストまたは自動E2Eテストの実装
