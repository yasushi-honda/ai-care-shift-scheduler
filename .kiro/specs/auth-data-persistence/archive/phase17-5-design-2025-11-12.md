# Phase 17.5: Permission Errorä¿®æ­£ï¼ˆversionsã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼‰ - æŠ€è¡“è¨­è¨ˆ

**æ›´æ–°æ—¥**: 2025-11-12
**ä»•æ§˜ID**: auth-data-persistence
**Phase**: 17.5
**ç¨®åˆ¥**: ãƒã‚°ä¿®æ­£ï¼ˆé‡å¤§ï¼‰

---

## ç›®æ¬¡

1. [ä¿®æ­£æ¦‚è¦](#ä¿®æ­£æ¦‚è¦)
2. [Security Rulesè¨­è¨ˆ](#security-rulesè¨­è¨ˆ)
3. [ãƒ‡ãƒ—ãƒ­ã‚¤æˆ¦ç•¥](#ãƒ‡ãƒ—ãƒ­ã‚¤æˆ¦ç•¥)
4. [ãƒ†ã‚¹ãƒˆæˆ¦ç•¥](#ãƒ†ã‚¹ãƒˆæˆ¦ç•¥)
5. [ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨ˆç”»](#ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨ˆç”»)

---

## ä¿®æ­£æ¦‚è¦

### å•é¡Œ

Firestore Security Rulesã«`versions`ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒ«ãƒ¼ãƒ«ãŒæœªå®šç¾©ã®ãŸã‚ã€ã™ã¹ã¦ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¦ã„ã‚‹ã€‚

### è§£æ±ºç­–

`firestore.rules`ã®`schedules/{scheduleId}`é…ä¸‹ã«`versions/{versionId}`ã®ãƒ«ãƒ¼ãƒ«ã‚’è¿½åŠ ã™ã‚‹ã€‚

### å½±éŸ¿

- ãƒãƒ¼ã‚¸ãƒ§ãƒ³å±¥æ­´ã®èª­ã¿å–ã‚ŠãŒå¯èƒ½ã«ãªã‚‹
- ãƒãƒ¼ã‚¸ãƒ§ãƒ³å¾©å…ƒæ©Ÿèƒ½ãŒä½¿ç”¨å¯èƒ½ã«ãªã‚‹
- Phase 6ã§å®Ÿè£…ã—ãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†æ©Ÿèƒ½ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹

---

## Security Rulesè¨­è¨ˆ

### ç¾çŠ¶

```javascript
// facilities collection
match /facilities/{facilityId} {
  // ...

  // schedules subcollection
  match /schedules/{scheduleId} {
    // super-adminã¾ãŸã¯viewerä»¥ä¸Šã§èª­ã¿å–ã‚Šã€editorä»¥ä¸Šã§æ›¸ãè¾¼ã¿
    allow read: if isAuthenticated() && (isSuperAdmin() || hasRole(facilityId, 'viewer'));
    allow write: if isAuthenticated() && hasRole(facilityId, 'editor');
  }

  // âš ï¸ versions ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒ«ãƒ¼ãƒ«ãŒå­˜åœ¨ã—ãªã„
}
```

### ä¿®æ­£å¾Œ

```javascript
// facilities collection
match /facilities/{facilityId} {
  // ...

  // schedules subcollection
  match /schedules/{scheduleId} {
    // super-adminã¾ãŸã¯viewerä»¥ä¸Šã§èª­ã¿å–ã‚Šã€editorä»¥ä¸Šã§æ›¸ãè¾¼ã¿
    allow read: if isAuthenticated() && (isSuperAdmin() || hasRole(facilityId, 'viewer'));
    allow write: if isAuthenticated() && hasRole(facilityId, 'editor');

    // ğŸ†• versions ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
    match /versions/{versionId} {
      // viewerä»¥ä¸Šã§èª­ã¿å–ã‚Šã€editorä»¥ä¸Šã§æ›¸ãè¾¼ã¿ï¼ˆscheduleã¨åŒã˜æ¨©é™ï¼‰
      allow read: if isAuthenticated() && (isSuperAdmin() || hasRole(facilityId, 'viewer'));
      allow write: if isAuthenticated() && hasRole(facilityId, 'editor');
    }
  }
}
```

### æ¨©é™è¨­è¨ˆ

#### èª­ã¿å–ã‚Šæ¨©é™ï¼ˆallow readï¼‰

**å¯¾è±¡ãƒ­ãƒ¼ãƒ«**: viewer, editor, admin, super-admin

**ç†ç”±**:
- ãƒãƒ¼ã‚¸ãƒ§ãƒ³å±¥æ­´ã¯ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä¸€éƒ¨ã§ã‚ã‚Šã€viewerã§ã‚‚é–²è¦§å¯èƒ½ã§ã‚ã‚‹ã¹ã
- éå»ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç¢ºèªã™ã‚‹ã“ã¨ã¯ã€ç›£æŸ»ã‚„ç¢ºèªä½œæ¥­ã«å¿…è¦

**å®Ÿè£…**:
```javascript
allow read: if isAuthenticated() && (isSuperAdmin() || hasRole(facilityId, 'viewer'));
```

#### æ›¸ãè¾¼ã¿æ¨©é™ï¼ˆallow writeï¼‰

**å¯¾è±¡ãƒ­ãƒ¼ãƒ«**: editor, admin, super-admin

**ç†ç”±**:
- ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ä½œæˆã¯ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç·¨é›†ã®ä¸€éƒ¨ã§ã‚ã‚Šã€editorã®ã¿ãŒå®Ÿè¡Œå¯èƒ½ã§ã‚ã‚‹ã¹ã
- viewerã¯ãƒãƒ¼ã‚¸ãƒ§ãƒ³å±¥æ­´ã®é–²è¦§ã®ã¿å¯èƒ½

**å®Ÿè£…**:
```javascript
allow write: if isAuthenticated() && hasRole(facilityId, 'editor');
```

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …

1. **èªè¨¼å¿…é ˆ**: ã™ã¹ã¦ã®ã‚¢ã‚¯ã‚»ã‚¹ã«`isAuthenticated()`ãƒã‚§ãƒƒã‚¯
2. **ãƒ­ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹**: `hasRole()`ã§facilityIdã”ã¨ã®ãƒ­ãƒ¼ãƒ«ã‚’ç¢ºèª
3. **super-adminç‰¹æ¨©**: super-adminã¯ã™ã¹ã¦ã®æ–½è¨­ã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
4. **è¦ªã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã¨ã®æ•´åˆæ€§**: schedulesã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã¨åŒã˜æ¨©é™ä½“ç³»

---

## ãƒ‡ãƒ—ãƒ­ã‚¤æˆ¦ç•¥

### ãƒ•ã‚§ãƒ¼ã‚º1: Security Rulesä¿®æ­£

**æ‰‹é †**:

```bash
# 1. firestore.rules ã‚’ä¿®æ­£
# versions ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒ«ãƒ¼ãƒ«ã‚’è¿½åŠ 

# 2. ã‚³ãƒŸãƒƒãƒˆ
git add firestore.rules
git commit -m "fix: add Security Rules for versions subcollection

- Add read/write rules for facilities/{facilityId}/schedules/{scheduleId}/versions
- Viewer+ can read version history
- Editor+ can create/restore versions
- Fixes Permission denied error in getVersionHistory()

ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>"

# 3. CodeRabbitãƒ¬ãƒ“ãƒ¥ãƒ¼
coderabbit review --plain --base-commit HEAD~1 --config CLAUDE.md

# 4. Push
git push origin main

# 5. GitHub Actionsè‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤
# GitHub Actions ãŒ firebase deploy --only firestore:rules ã‚’å®Ÿè¡Œ
```

### ãƒ•ã‚§ãƒ¼ã‚º2: æœ¬ç•ªç’°å¢ƒã§ã®ç¢ºèª

**ç¢ºèªé …ç›®**:

1. **Firebase Consoleç¢ºèª**:
   - Firebase Console â†’ Firestore Database â†’ Rules
   - æœ€æ–°ã®RulesãŒãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

2. **ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç¢ºèª**:
   - æœ¬ç•ªç’°å¢ƒã§ãƒ­ã‚°ã‚¤ãƒ³
   - ãƒãƒ¼ã‚¸ãƒ§ãƒ³å±¥æ­´ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‹ç¢ºèª
   - ãƒ–ãƒ©ã‚¦ã‚¶ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§Permission errorãŒãªã„ã‹ç¢ºèª

---

## ãƒ†ã‚¹ãƒˆæˆ¦ç•¥

### 1. Manual Tests

#### ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ª1: ãƒãƒ¼ã‚¸ãƒ§ãƒ³å±¥æ­´ã®è¡¨ç¤º

**å‰ææ¡ä»¶**:
- super-adminã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³
- ã‚·ãƒ•ãƒˆãŒä½œæˆæ¸ˆã¿

**æ‰‹é †**:
1. ã‚·ãƒ•ãƒˆä½œæˆç”»é¢ã‚’é–‹ã
2. ã€Œãƒãƒ¼ã‚¸ãƒ§ãƒ³å±¥æ­´ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
3. ãƒãƒ¼ã‚¸ãƒ§ãƒ³å±¥æ­´ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

**æœŸå¾…çµæœ**:
- âœ… ãƒãƒ¼ã‚¸ãƒ§ãƒ³å±¥æ­´ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- âœ… Permission errorãŒç™ºç”Ÿã—ãªã„

---

#### ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ª2: ãƒãƒ¼ã‚¸ãƒ§ãƒ³å¾©å…ƒ

**å‰ææ¡ä»¶**:
- super-adminã¾ãŸã¯editorã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³
- ã‚·ãƒ•ãƒˆãŒä½œæˆæ¸ˆã¿
- ãƒãƒ¼ã‚¸ãƒ§ãƒ³å±¥æ­´ãŒ2ã¤ä»¥ä¸Šå­˜åœ¨

**æ‰‹é †**:
1. ãƒãƒ¼ã‚¸ãƒ§ãƒ³å±¥æ­´ã‚’é–‹ã
2. éå»ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’é¸æŠ
3. ã€Œã“ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«å¾©å…ƒã€ã‚’ã‚¯ãƒªãƒƒã‚¯
4. å¾©å…ƒç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã§ã€Œã¯ã„ã€ã‚’ã‚¯ãƒªãƒƒã‚¯

**æœŸå¾…çµæœ**:
- âœ… ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒå¾©å…ƒã•ã‚Œã‚‹
- âœ… ãƒãƒ¼ã‚¸ãƒ§ãƒ³å±¥æ­´ãŒæ›´æ–°ã•ã‚Œã‚‹
- âœ… Permission errorãŒç™ºç”Ÿã—ãªã„

---

#### ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ª3: vieweræ¨©é™ã§ã®ç¢ºèª

**å‰ææ¡ä»¶**:
- viewerãƒ­ãƒ¼ãƒ«ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³

**æ‰‹é †**:
1. ã‚·ãƒ•ãƒˆè¡¨ç¤ºç”»é¢ã‚’é–‹ã
2. ãƒãƒ¼ã‚¸ãƒ§ãƒ³å±¥æ­´ã‚’ç¢ºèª

**æœŸå¾…çµæœ**:
- âœ… ãƒãƒ¼ã‚¸ãƒ§ãƒ³å±¥æ­´ãŒé–²è¦§å¯èƒ½
- âœ… å¾©å…ƒãƒœã‚¿ãƒ³ã¯éè¡¨ç¤ºã¾ãŸã¯ç„¡åŠ¹

---

### 2. Firestore Security Rules Simulator

Firebase Consoleã®ã€ŒRulesã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ã€ã§ãƒ†ã‚¹ãƒˆ:

**ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1: viewerèª­ã¿å–ã‚Š**
```javascript
// Location: facilities/demo-facility-001/schedules/test-schedule-001/versions/v1
// Operation: get
// Authentication: uid=test-viewer-001, email=viewer@example.com
// Expected: allow
```

**ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹2: vieweræ›¸ãè¾¼ã¿**
```javascript
// Location: facilities/demo-facility-001/schedules/test-schedule-001/versions/v2
// Operation: create
// Authentication: uid=test-viewer-001, email=viewer@example.com
// Expected: deny
```

**ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹3: editoræ›¸ãè¾¼ã¿**
```javascript
// Location: facilities/demo-facility-001/schedules/test-schedule-001/versions/v2
// Operation: create
// Authentication: uid=test-editor-001, email=editor@example.com
// Expected: allow
```

---

## ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨ˆç”»

### ã‚·ãƒŠãƒªã‚ª: Security Rulesä¿®æ­£ã§å•é¡ŒãŒç™ºç”Ÿ

**ç—‡çŠ¶**: ä¿®æ­£å¾Œã€æ„å›³ã—ãªã„ã‚¢ã‚¯ã‚»ã‚¹ãŒè¨±å¯/æ‹’å¦ã•ã‚Œã‚‹

**ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †**:

```bash
# 1. å‰ã®ã‚³ãƒŸãƒƒãƒˆã«ãƒªãƒãƒ¼ãƒˆ
git revert HEAD

# 2. Push
git push origin main

# 3. GitHub Actionsè‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤
# è‡ªå‹•çš„ã«ä»¥å‰ã®Security RulesãŒãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã‚‹
```

**ã¾ãŸã¯ã€Firebase Consoleæ‰‹å‹•ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯**:

1. Firebase Console â†’ Firestore Database â†’ Rules
2. ã€Œãƒãƒ¼ã‚¸ãƒ§ãƒ³å±¥æ­´ã€ã‚¿ãƒ–ã‚’é–‹ã
3. ä»¥å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’é¸æŠ
4. ã€Œã“ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å…¬é–‹ã€ã‚’ã‚¯ãƒªãƒƒã‚¯

---

## æ‰¿èª

ã“ã®æŠ€è¡“è¨­è¨ˆã¯ä»¥ä¸‹ã®ç‚¹ã‚’è€ƒæ…®ã—ã¦ä½œæˆã•ã‚Œã¾ã—ãŸï¼š

- âœ… Permission errorã®æ ¹æœ¬åŸå› ã‚’è§£æ±º
- âœ… ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†æ©Ÿèƒ½ã‚’æ­£å¸¸ã«å‹•ä½œã•ã›ã‚‹
- âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’ç¶­æŒï¼ˆãƒ­ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ï¼‰
- âœ… ãƒ†ã‚¹ãƒˆæˆ¦ç•¥ã‚’æ˜ç¢ºåŒ–
- âœ… ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨ˆç”»ã‚’ç­–å®š

---

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. âœ… ã“ã®æŠ€è¡“è¨­è¨ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æ‰¿èª
2. ğŸ› ï¸ firestore.rulesã‚’ä¿®æ­£
3. ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆGitHub Actions CI/CDï¼‰
4. âœ… æœ¬ç•ªç’°å¢ƒã§ç¢ºèª
5. ğŸ“ Phase 17.5æ¤œè¨¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆ

---

## é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- `phase17-5-bug-analysis-2025-11-12.md` - ãƒã‚°åˆ†æ
- `firestore.rules` - Firestore Security Rules
- `src/services/scheduleService.ts` - ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚µãƒ¼ãƒ“ã‚¹
- `design.md` - å…¨ä½“è¨­è¨ˆæ›¸ï¼ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ï¼‰
