# Phase 14.5: データ復元とリロード対応E2Eテスト設計

**作成日**: 2025-11-02
**Phase**: Phase 14.5 - データ復元とリロード対応のE2Eテスト
**関連仕様**: auth-data-persistence

---

## 📋 目的

Phase 14.5でページリロード後のデータ復元機能をE2Eテストで検証する。特に、認証状態の復元、施設データの自動復元、ローディング状態とエラーハンドリングが正しく機能することを確認する。

**検証対象**:
- ページリロード後の認証状態復元
- 施設とデータの自動復元
- ローディング状態の表示
- エラーハンドリング（ネットワークエラー、権限エラーなど）

---

## 🎯 実施方針

### ハイブリッドアプローチの採用

Phase 14.1-14.4と同様に、**手動テストガイド + 自動E2Eテスト**のハイブリッドアプローチを採用する。

**理由**:
1. **Firebase認証の制約**: Google OAuth認証フローの完全自動化は困難
2. **開発効率**: 手動テストガイドで詳細な検証手順を提供し、開発速度を維持
3. **将来への備え**: test.skipでPhase 17以降のFirebase Auth Emulator対応を準備

**手動テストの範囲**:
- 実際のGoogle OAuth認証を使用したページリロード後の復元テスト
- 施設データとスタッフ・シフトデータの自動復元テスト
- エラー発生時の挙動確認（ネットワークエラー、権限エラー）

**自動E2Eテストの範囲**:
- ローディング状態のUI要素表示確認（認証不要）
- test.skipで将来の完全自動化テストを記述

---

## 🏗️ 実装内容

### 1. データ復元とリロード対応のE2Eテスト

#### 1.1 ページリロード後の認証状態復元

**検証項目**:
1. ログイン状態でページリロード
2. Firebase Authentication `onAuthStateChanged`が自動的に認証状態を復元
3. ユーザー情報（displayName、email、photoURL）が表示される
4. ローディング中は適切なローディング表示

**期待される動作**:
- リロード後もログイン状態が維持される
- AuthContext内の`currentUser`が正しく復元される
- ローディング中は「読み込み中...」または適切なローディングスピナーが表示
- ローディング完了後、ユーザー情報が表示される

**関連コンポーネント**:
- `src/contexts/AuthContext.tsx` - `onAuthStateChanged`による認証状態の監視
- `src/App.tsx` - ローディング状態の管理

#### 1.2 施設とデータの自動復元

**検証項目**:
1. 特定の施設を選択した状態でページリロード
2. `localStorage`から選択施設IDを復元
3. Firestoreから施設データを自動取得
4. スタッフ・シフト・休暇・要件データが自動復元される
5. ローディング中は適切なローディング表示

**期待される動作**:
- `localStorage.getItem('selectedFacilityId')`で施設IDを復元
- AuthContext内の`waitForFacilities()`が施設一覧を取得
- 選択施設が自動的に復元され、`selectedFacility`が設定される
- 各コンテキスト（Staff、Schedule、Vacation、Requirements）がデータを自動取得
- ローディング中は「施設データを読み込み中...」などの表示
- ローディング完了後、カレンダーやスタッフリストが表示される

**関連コンポーネント**:
- `src/contexts/AuthContext.tsx` - `selectedFacility`の管理、`waitForFacilities()`
- `src/contexts/StaffContext.tsx` - スタッフデータの自動取得
- `src/contexts/ScheduleContext.tsx` - シフトデータの自動取得
- `src/contexts/VacationContext.tsx` - 休暇データの自動取得
- `src/contexts/RequirementsContext.tsx` - 要件データの自動取得
- `src/App.tsx` - 全体のローディング状態管理

#### 1.3 ローディング状態の表示

**検証項目**:
1. ページリロード直後のローディング状態
2. 認証状態確認中のローディング表示
3. 施設データ取得中のローディング表示
4. データ取得完了後の画面遷移

**期待される動作**:
- ローディング中は適切なUI要素が表示される
  - 「読み込み中...」テキスト
  - ローディングスピナー（該当する場合）
  - スケルトンスクリーン（該当する場合）
- ローディング完了後、適切なコンテンツが表示される
- ローディング状態が階層的に管理される
  1. 認証状態の確認（最初）
  2. 施設データの取得（認証後）
  3. 各種データの取得（施設選択後）

**関連コンポーネント**:
- `src/App.tsx` - `loading`状態の管理
- 各Context - 個別のローディング状態管理

#### 1.4 エラーハンドリング

**検証項目**:
1. ネットワークエラー時の挙動
2. Firestore読み取り権限エラー時の挙動
3. 施設が削除されている場合の挙動
4. エラーメッセージの表示

**期待される動作**:
- ネットワークエラー時:
  - 適切なエラーメッセージ表示
  - リトライボタンまたは再読み込みの案内
- 権限エラー時:
  - 「アクセス権限がありません」などのエラー表示
  - 管理者への問い合わせ案内
- 施設削除時:
  - 施設選択画面へリダイレクト
  - 「選択した施設が見つかりません」メッセージ
- エラー後の復旧:
  - 再読み込みでエラーが解消されることを確認

**関連コンポーネント**:
- 各Context - エラー状態の管理
- `src/App.tsx` - グローバルエラーハンドリング

---

## 📊 テストカバレッジ

### 手動テスト（phase14-5-reload-manual-test-guide-2025-11-02.md）

**セクション1: ページリロード後の認証状態復元**
1. ログイン後のページリロード
2. 認証状態の自動復元確認
3. ユーザー情報の表示確認

**セクション2: 施設とデータの自動復元**
1. 施設選択後のページリロード
2. 施設データの自動復元確認
3. スタッフ・シフト・休暇・要件データの復元確認

**セクション3: ローディング状態の表示**
1. リロード直後のローディング表示
2. データ取得中のローディング表示
3. ローディング完了後の画面確認

**セクション4: エラーハンドリング**
1. ネットワークエラーのシミュレーション（オフライン）
2. Firestoreエラーの確認（DevTools Network Throttling）
3. エラーメッセージの確認

### 自動E2Eテスト（e2e/data-restoration.spec.ts）

**UI要素表示テスト**（認証不要、test.skip）:
- ローディング中のUI要素確認
- エラー表示のUI要素確認

**完全自動化テスト**（Firebase Auth Emulator必要、test.skip）:
1. ページリロード後の認証状態復元テスト
2. 施設とデータの自動復元テスト
3. ローディング状態の表示テスト
4. エラーハンドリングテスト

---

## 🚀 実装手順

### Step 1: 手動テストガイドの作成

**ファイル**: `phase14-5-reload-manual-test-guide-2025-11-02.md`

**内容**:
- 4つの検証セクション（詳細な手順付き）
- ブラウザ開発者ツールの使い方
- エラーシミュレーション方法（オフライン、Network Throttling）
- トラブルシューティングガイド

### Step 2: 自動E2Eテストの実装

**ファイル**: `e2e/data-restoration.spec.ts`

**実装内容**:
1. test.skipでUI要素表示テスト（3テスト）
2. test.skipで完全自動化テスト（4テスト）
3. 詳細なコメントでPhase 17以降の実装予定を記述

### Step 3: Firebase Auth Emulator連携（Phase 17以降）

**将来の拡張**:
- Firebase Auth Emulatorのセットアップ
- test.skipを削除して実際のテストを実装
- CI/CD環境でのEmulator統合

---

## 🐛 既知の制限事項

### Google OAuth認証の自動化

**問題**: PlaywrightでGoogle OAuthフローを完全自動化することは困難

**理由**:
1. Googleのログイン画面がreCAPTCHAで保護されている
2. Googleアカウントのセキュリティチェックが自動化を検出
3. 2FAが有効な場合、自動化が不可能

**対応策**:
- Phase 14.5では手動テストガイドを提供
- Phase 17以降でFirebase Auth Emulatorを導入
- Emulator環境では実際のGoogle OAuthを使わずにテスト

### エラーシミュレーションの制約

**問題**: 特定のエラー（Firestore権限エラーなど）をE2Eで再現することが困難

**対応策**:
- 手動テストガイドでDevToolsを使用したエラーシミュレーション方法を提供
- ネットワークエラー: ブラウザをオフラインモードに設定
- Firestoreエラー: Network ThrottlingまたはSecurity Rulesの一時変更

---

## 📝 関連ドキュメント

- [tasks.md](./tasks.md) - Phase 14.5タスク定義
- [design.md](./design.md) - データ復元とリロード対応の実装詳細
- [phase14-1-auth-e2e-design-2025-11-02.md](./phase14-1-auth-e2e-design-2025-11-02.md) - 認証フローE2Eテスト設計
- [phase14-2-crud-e2e-design-2025-11-02.md](./phase14-2-crud-e2e-design-2025-11-02.md) - データCRUD E2Eテスト設計
- [phase14-3-rbac-e2e-design-2025-11-02.md](./phase14-3-rbac-e2e-design-2025-11-02.md) - RBAC権限チェックE2Eテスト設計
- [phase14-4-version-e2e-design-2025-11-02.md](./phase14-4-version-e2e-design-2025-11-02.md) - バージョン管理E2Eテスト設計

---

## ✅ 成功基準

Phase 14.5の実装は、以下の条件を満たす場合に完了とする：

1. **手動テストガイド作成**: 4つの検証セクションが詳細な手順付きで記述されている
2. **自動E2Eテスト実装**: `e2e/data-restoration.spec.ts`が作成され、test.skipが適切に記述されている
3. **TypeScriptチェック**: エラーなくコンパイルできる
4. **Git管理**: コミット、CodeRabbitレビュー、Pushが完了している
5. **ドキュメント更新**: tasks.mdとメモリが更新されている

---

**次のステップ**: Phase 14.5手動テストガイドの作成
