# Phase 17.11: Security Alerts Permission Errorä¿®æ­£ - ãƒã‚°åˆ†æ

**ä½œæˆæ—¥**: 2025-11-12
**ä»•æ§˜ID**: auth-data-persistence
**Phase**: 17.11
**ç¨®åˆ¥**: ãƒã‚°ä¿®æ­£ï¼ˆé‡å¤§ï¼‰
**å„ªå…ˆåº¦**: ğŸ”´ ç·Šæ€¥

---

## ç›®æ¬¡

1. [ãƒã‚°æ¦‚è¦](#ãƒã‚°æ¦‚è¦)
2. [ã‚¨ãƒ©ãƒ¼è©³ç´°](#ã‚¨ãƒ©ãƒ¼è©³ç´°)
3. [æ ¹æœ¬åŸå› åˆ†æ](#æ ¹æœ¬åŸå› åˆ†æ)
4. [å½±éŸ¿ç¯„å›²](#å½±éŸ¿ç¯„å›²)
5. [è§£æ±ºç­–ã®æ–¹å‘æ€§](#è§£æ±ºç­–ã®æ–¹å‘æ€§)

---

## ãƒã‚°æ¦‚è¦

### ç—‡çŠ¶

ç®¡ç†ç”»é¢ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ©ãƒ¼ãƒˆãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã€Permission errorãŒç™ºç”Ÿã—ã¦ã‚¢ãƒ©ãƒ¼ãƒˆãŒè¡¨ç¤ºã•ã‚Œãªã„ã€‚

**ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸**:
```
Failed to get security alerts: FirebaseError: Missing or insufficient permissions.
```

**ç™ºç”Ÿå ´æ‰€**:
- URL: `/admin/security-alerts`
- ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ: `src/pages/admin/SecurityAlerts.tsx`
- ã‚µãƒ¼ãƒ“ã‚¹: `src/services/securityAlertService.ts` â†’ `getAlerts()`

### ç™ºè¦‹çµŒç·¯

Phase 17.10å®Œäº†å¾Œã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæœ¬ç•ªç’°å¢ƒã§ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªä¸­ã«ç™ºè¦‹ã€‚

### ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ¡ä»¶

- ãƒ¦ãƒ¼ã‚¶ãƒ¼: super-adminæ¨©é™ã‚’æŒã¤ãƒ¦ãƒ¼ã‚¶ãƒ¼
- æ“ä½œ: ç®¡ç†ç”»é¢ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ©ãƒ¼ãƒˆãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹
- æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œ: ã‚¢ãƒ©ãƒ¼ãƒˆä¸€è¦§ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- å®Ÿéš›ã®å‹•ä½œ: Permission errorãŒç™ºç”Ÿ

---

## ã‚¨ãƒ©ãƒ¼è©³ç´°

### ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°

```
index-Dlns4hQi.js:3247 âœ… Firestore auth token refreshed
index-Dlns4hQi.js:3247 âœ… Restored facility from localStorage: facility-o3BZBx5EEPbFqiIaHYRYQKraAut1
index-Dlns4hQi.js:3259 Failed to get security alerts: FirebaseError: Missing or insufficient permissions.
getAlerts @ index-Dlns4hQi.js:3259
```

### ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿç®‡æ‰€

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/services/securityAlertService.ts`
**é–¢æ•°**: `getAlerts()`
**è¡Œ**: ç´„172è¡Œç›®

```typescript
async getAlerts(filters: {
  status?: SecurityAlertStatus;
  severity?: SecurityAlertSeverity;
  facilityId?: string | null;
  limit?: number;
}): Promise<Result<SecurityAlert[], SecurityAlertError>> {
  try {
    // ...
    const q = query(collection(db, 'securityAlerts'), ...constraints);
    const querySnapshot = await getDocs(q); // â† Permission errorç™ºç”Ÿ
    // ...
  }
}
```

---

## æ ¹æœ¬åŸå› åˆ†æ

### Firestore Security Rulesã®ç¢ºèª

**ãƒ•ã‚¡ã‚¤ãƒ«**: `firestore.rules`

#### ç¾åœ¨ã®çŠ¶æ…‹

`securityAlerts`ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®Security RulesãŒ**å…¨ãå®šç¾©ã•ã‚Œã¦ã„ãªã„**ã€‚

**å•é¡Œã®ãƒ«ãƒ¼ãƒ«ï¼ˆ184-187è¡Œç›®ï¼‰**:
```javascript
// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ«ãƒ¼ãƒ«: ä¸Šè¨˜ä»¥å¤–ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã¯ã‚¢ã‚¯ã‚»ã‚¹æ‹’å¦
match /{document=**} {
  allow read, write: if false;
}
```

ã“ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ«ãƒ¼ãƒ«ã«ã‚ˆã‚Šã€æ˜ç¤ºçš„ã«ãƒ«ãƒ¼ãƒ«ãŒå®šç¾©ã•ã‚Œã¦ã„ãªã„ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã¯å…¨ã¦ã‚¢ã‚¯ã‚»ã‚¹æ‹’å¦ã•ã‚Œã‚‹ã€‚

### ãªãœã“ã®ãƒã‚°ãŒè¦‹é€ƒã•ã‚ŒãŸã‹

1. **Security Ruleså®Ÿè£…ã®æŠœã‘**:
   - Phase 13ã§securityAlertsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã¨ã‚µãƒ¼ãƒ“ã‚¹ã‚’å®Ÿè£…
   - ã—ã‹ã—ã€Firestore Security Rulesã®è¿½åŠ ã‚’å¿˜ã‚ŒãŸ
   - `auditLogs`ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã¯æ­£ã—ãRuleså®šç¾©æ¸ˆã¿ï¼ˆ164-182è¡Œç›®ï¼‰

2. **ãƒ†ã‚¹ãƒˆä¸è¶³**:
   - E2Eãƒ†ã‚¹ãƒˆã§ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ©ãƒ¼ãƒˆãƒšãƒ¼ã‚¸ã®å‹•ä½œç¢ºèªãŒä¸è¶³
   - æœ¬ç•ªç’°å¢ƒã§åˆã‚ã¦ç™ºè¦‹

3. **é¡ä¼¼ã®Permission errorå¯¾å¿œæ™‚ã®è¦‹è½ã¨ã—**:
   - Phase 17.5: `versions`ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
   - Phase 17.8: User Fetch Permission Error
   - Phase 17.9: Admin User Detail Permission Error
   - ã“ã‚Œã‚‰ã®å¯¾å¿œæ™‚ã«ä»–ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚‚ç¢ºèªã™ã¹ãã ã£ãŸ

---

### è¨­è¨ˆæ„å›³ã®ç¢ºèª

#### securityAlertsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®å½¹å‰²

**Phase 13.3ã§å®Ÿè£…**:
- ä¸å¯©ãªã‚¢ã‚¯ã‚»ã‚¹ãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ¤œå‡ºæ™‚ã«ã‚¢ãƒ©ãƒ¼ãƒˆã‚’è‡ªå‹•ç”Ÿæˆ
- ç®¡ç†è€…ã«ã‚ˆã‚‹ã‚¢ãƒ©ãƒ¼ãƒˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç®¡ç†ï¼ˆç¢ºèªã€èª¿æŸ»ä¸­ã€è§£æ±ºã€èª¤æ¤œçŸ¥ï¼‰
- ã‚¢ãƒ©ãƒ¼ãƒˆä¸€è¦§ã®å–å¾—ã¨ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°

**Firestoreãƒ‘ã‚¹**: `/securityAlerts/{alertId}`

#### å¿…è¦ãªæ¨©é™è¨­è¨ˆ

**é¡ä¼¼ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³**: `auditLogs`ï¼ˆ164-182è¡Œç›®ï¼‰ã‚’å‚è€ƒ

```javascript
// auditLogs collection (Phase 13ã§å®Ÿè£…)
match /auditLogs/{logId} {
  // super-adminã®ã¿èª­ã¿å–ã‚Šå¯èƒ½
  allow read: if isAuthenticated() && isSuperAdmin();

  // èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè‡ªåˆ†ã®ãƒ­ã‚°ã®ã¿ä½œæˆå¯èƒ½
  allow create: if isAuthenticated() && ...

  // æ›´æ–°ãƒ»å‰Šé™¤ã¯ç¦æ­¢ï¼ˆä¸å¤‰ãƒ­ã‚°ï¼‰
  allow update, delete: if false;
}
```

**securityAlertsã«å¿…è¦ãªæ¨©é™**:
- **èª­ã¿å–ã‚Šï¼ˆreadï¼‰**: super-adminã®ã¿
- **ä½œæˆï¼ˆcreateï¼‰**: èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä½œæˆå¯èƒ½ï¼ˆä¸å¯©ãªã‚¢ã‚¯ã‚»ã‚¹æ¤œå‡ºæ™‚ï¼‰
- **æ›´æ–°ï¼ˆupdateï¼‰**: super-adminã®ã¿ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ã€ç¢ºèªã€è§£æ±ºï¼‰
- **å‰Šé™¤ï¼ˆdeleteï¼‰**: ç¦æ­¢ï¼ˆä¸å¤‰ï¼‰

---

## å½±éŸ¿ç¯„å›²

### å½±éŸ¿ã‚’å—ã‘ã‚‹æ©Ÿèƒ½

1. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ©ãƒ¼ãƒˆãƒšãƒ¼ã‚¸ï¼ˆç®¡ç†ç”»é¢ï¼‰**:
   - URL: `/admin/security-alerts`
   - ã‚¢ãƒ©ãƒ¼ãƒˆä¸€è¦§ãŒè¡¨ç¤ºã•ã‚Œãªã„
   - Permission errorãŒè¡¨ç¤ºã•ã‚Œã‚‹
   - super-adminãŒã‚¢ãƒ©ãƒ¼ãƒˆã‚’ç¢ºèªã§ããªã„

2. **ã‚¢ãƒ©ãƒ¼ãƒˆä½œæˆæ©Ÿèƒ½**:
   - `SecurityAlertService.createAlert()`ã‚‚å¤±æ•—ã™ã‚‹å¯èƒ½æ€§
   - ä¸å¯©ãªã‚¢ã‚¯ã‚»ã‚¹æ¤œå‡ºæ™‚ã®ã‚¢ãƒ©ãƒ¼ãƒˆç”ŸæˆãŒã§ããªã„

3. **ã‚¢ãƒ©ãƒ¼ãƒˆç®¡ç†æ©Ÿèƒ½**:
   - `updateAlertStatus()`, `acknowledgeAlert()`, `resolveAlert()`ã‚‚å¤±æ•—
   - ã‚¢ãƒ©ãƒ¼ãƒˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®å¤‰æ›´ãŒã§ããªã„

### å½±éŸ¿ã‚’å—ã‘ãªã„ã‚‚ã®

- âœ… ãã®ä»–ã®ç®¡ç†ç”»é¢æ©Ÿèƒ½
- âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†
- âœ… æ–½è¨­ç®¡ç†
- âœ… ç›£æŸ»ãƒ­ã‚°ï¼ˆauditLogsã¯æ­£ã—ãRuleså®šç¾©æ¸ˆã¿ï¼‰

---

## è§£æ±ºç­–ã®æ–¹å‘æ€§

### ææ¡ˆã™ã‚‹ä¿®æ­£

**firestore.rulesã«`securityAlerts`ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®Security Rulesã‚’è¿½åŠ **

#### ä¿®æ­£å†…å®¹

**è¿½åŠ ä½ç½®**: `auditLogs`ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆ164-182è¡Œç›®ï¼‰ã®å¾Œ

**è¿½åŠ ã™ã‚‹ãƒ«ãƒ¼ãƒ«**:
```javascript
// securityAlerts collection (Phase 13.3ã§å®Ÿè£…)
match /securityAlerts/{alertId} {
  // super-adminã®ã¿èª­ã¿å–ã‚Šå¯èƒ½
  allow read: if isAuthenticated() && isSuperAdmin();

  // èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ãƒ©ãƒ¼ãƒˆã‚’ä½œæˆå¯èƒ½ï¼ˆä¸å¯©ãªã‚¢ã‚¯ã‚»ã‚¹æ¤œå‡ºæ™‚ï¼‰
  // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
  allow create: if isAuthenticated()
    && request.resource.data.type is string
    && request.resource.data.severity is string
    && request.resource.data.status is string
    && request.resource.data.title is string;

  // super-adminã®ã¿æ›´æ–°å¯èƒ½ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ã€ç¢ºèªã€è§£æ±ºï¼‰
  allow update: if isAuthenticated() && isSuperAdmin();

  // å‰Šé™¤ã¯ç¦æ­¢ï¼ˆä¸å¤‰ï¼‰
  allow delete: if false;
}
```

### ä¿®æ­£ã®æ ¹æ‹ 

1. **super-adminã®ã¿èª­ã¿å–ã‚Šå¯èƒ½**:
   - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ©ãƒ¼ãƒˆã¯æ©Ÿå¯†æƒ…å ±
   - auditLogsã¨åŒæ§˜ã€super-adminã®ã¿ãŒã‚¢ã‚¯ã‚»ã‚¹ã™ã¹ã

2. **èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä½œæˆå¯èƒ½**:
   - ä¸å¯©ãªã‚¢ã‚¯ã‚»ã‚¹æ¤œå‡ºæ™‚ã«è‡ªå‹•ç”Ÿæˆã™ã‚‹å¿…è¦ãŒã‚ã‚‹
   - ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã§æœ€ä½é™ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒã‚§ãƒƒã‚¯

3. **super-adminã®ã¿æ›´æ–°å¯èƒ½**:
   - ã‚¢ãƒ©ãƒ¼ãƒˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®å¤‰æ›´ã¯ç®¡ç†è€…ã®ã¿

4. **å‰Šé™¤ã¯ç¦æ­¢**:
   - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ©ãƒ¼ãƒˆã¯ä¸å¤‰ï¼ˆç›£æŸ»è¨¼è·¡ã¨ã—ã¦ä¿æŒï¼‰

---

## ãƒ†ã‚¹ãƒˆæˆ¦ç•¥

### ä¿®æ­£å¾Œã®ãƒ†ã‚¹ãƒˆ

1. **Firestore Rulesã®ãƒ‡ãƒ—ãƒ­ã‚¤ç¢ºèª**:
   ```bash
   # GitHub Actions CI/CD
   git push origin main

   # ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸç¢ºèª
   gh run list --limit 1
   ```

2. **æœ¬ç•ªç’°å¢ƒã§ã®å‹•ä½œç¢ºèª**:
   - ç®¡ç†ç”»é¢ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ©ãƒ¼ãƒˆãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹
   - Permission errorãŒè¡¨ç¤ºã•ã‚Œãªã„ã“ã¨ã‚’ç¢ºèª
   - ã‚¢ãƒ©ãƒ¼ãƒˆä¸€è¦§ãŒæ­£å¸¸ã«è¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

3. **ã‚¢ãƒ©ãƒ¼ãƒˆä½œæˆãƒ†ã‚¹ãƒˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰**:
   - ãƒ†ã‚¹ãƒˆã‚¢ãƒ©ãƒ¼ãƒˆã‚’ä½œæˆ
   - Firestoreã§ç¢ºèª

---

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. âœ… ãƒã‚°åˆ†æãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆï¼ˆæœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼‰
2. ğŸ“ æŠ€è¡“è¨­è¨ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆ
3. ğŸ”§ firestore.rulesä¿®æ­£
4. ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆGitHub Actions CI/CDï¼‰
5. âœ… æœ¬ç•ªç’°å¢ƒã§æ¤œè¨¼
6. ğŸ“ Phase 17.11æ¤œè¨¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆ

---

## é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- `firestore.rules` - ä¿®æ­£å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«
- `src/services/securityAlertService.ts` - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ©ãƒ¼ãƒˆã‚µãƒ¼ãƒ“ã‚¹
- `src/pages/admin/SecurityAlerts.tsx` - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ©ãƒ¼ãƒˆãƒšãƒ¼ã‚¸
- `phase17-summary-2025-11-12.md` - Phase 17ç·æ‹¬ãƒ¬ãƒãƒ¼ãƒˆ

---

**ãƒ¬ãƒãƒ¼ãƒˆä½œæˆæ—¥**: 2025-11-12
**ä½œæˆè€…**: AIï¼ˆClaude Codeï¼‰
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: åˆ†æå®Œäº†ãƒ»æŠ€è¡“è¨­è¨ˆã¸
