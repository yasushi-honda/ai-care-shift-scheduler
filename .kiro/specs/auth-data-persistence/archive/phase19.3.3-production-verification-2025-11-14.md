# Phase 19.3.3: 使用状況レポート機能 - 本番環境動作確認手順書

**作成日**: 2025-11-14
**仕様ID**: auth-data-persistence
**Phase**: 19.3.3
**対象環境**: 本番環境（https://ai-care-shift-scheduler.web.app）

---

## 目次

1. [概要](#1-概要)
2. [前提条件](#2-前提条件)
3. [フロントエンド動作確認](#3-フロントエンド動作確認)
4. [バックエンド動作確認](#4-バックエンド動作確認)
5. [セキュリティ動作確認](#5-セキュリティ動作確認)
6. [パフォーマンス確認](#6-パフォーマンス確認)
7. [トラブルシューティング](#7-トラブルシューティング)
8. [完了チェックリスト](#8-完了チェックリスト)

---

## 1. 概要

Phase 19.3.3で実装した使用状況レポート機能の本番環境動作確認を行います。

### 実装内容

- **フロントエンド**: UsageReports.tsx、UsageChart.tsx
- **バックエンド**: generateMonthlyReport.ts（scheduledMonthlyReport、generateMonthlyReport）
- **インフラ**: Firestore Rules（reports collection）、Cloud Scheduler

---

## 2. 前提条件

### 2.1 必要なアカウント

- **super-admin権限のGoogleアカウント**
  - 使用状況レポートページへのアクセスに必要
  - 手動レポート生成の実行に必要

### 2.2 事前確認

#### CI/CDパイプライン成功確認

```bash
gh run list --limit 5
```

**期待結果**:
```
completed  success  docs(phase19): Phase 19完了宣言作成  CI/CD Pipeline  main  push  ...
completed  success  docs(phase19): Phase 19完了宣言作成  Lighthouse CI  main  push  ...
```

#### デプロイ完了確認

GitHub ActionsのCI/CDパイプラインが成功していることを確認済み（2025-11-14 16:42）。

---

## 3. フロントエンド動作確認

### 3.1 ページアクセス

#### 手順

1. ブラウザで本番環境を開く
   ```
   URL: https://ai-care-shift-scheduler.web.app
   ```

2. super-adminアカウントでログイン

3. 左サイドバーの「使用状況レポート」（📊アイコン）をクリック

**期待結果**:
- `/admin/usage-reports` ページが表示される
- ページタイトル「使用状況レポート」が表示される
- ローディング表示後、レポート内容が表示される

**確認ポイント**:
- [ ] ページが正常に表示される
- [ ] ローディングインジケーターが表示される
- [ ] レポートデータが読み込まれる

---

### 3.2 期間選択機能

#### 手順

1. 期間選択ドロップダウンをクリック

2. 以下の各オプションを選択して動作確認
   - 「今月」
   - 「先月」
   - 「過去3ヶ月」
   - 「カスタム期間」

**期待結果**:
- 期間選択後、データが自動的に再読み込みされる
- 選択した期間のデータが表示される
- カスタム期間選択時、日付ピッカーが表示される

**確認ポイント**:
- [ ] 期間選択ドロップダウンが動作する
- [ ] 各期間オプションが正常に機能する
- [ ] カスタム期間の日付ピッカーが動作する
- [ ] 期間変更後、データが更新される

---

### 3.3 シフト生成統計カード

#### 確認内容

ページ上部の4つの統計カードを確認：

1. **総シフト生成数**
   - 数値が表示される
   - 前期比が表示される（該当する場合）

2. **成功数**
   - 成功したシフト生成数が表示される
   - 緑色で強調表示される

3. **成功率**
   - パーセンテージで表示される
   - 100%に近い値が表示される（通常）

4. **平均生成時間**
   - 秒単位で表示される
   - 妥当な時間（例: 2-5秒）が表示される

**確認ポイント**:
- [ ] 4つのカードが正常に表示される
- [ ] 数値が正しく表示される
- [ ] 色分け（成功=緑、失敗=赤）が正しい
- [ ] 前期比の矢印アイコンが表示される

---

### 3.4 グラフ表示

#### 3.4.1 日別アクション数推移グラフ（折れ線グラフ）

**確認内容**:
- X軸: 日付
- Y軸: アクション数
- 青色の折れ線グラフ

**確認ポイント**:
- [ ] グラフが描画される
- [ ] X軸の日付ラベルが表示される
- [ ] Y軸のアクション数が表示される
- [ ] ツールチップ（マウスホバー時）が動作する
- [ ] グラフが見やすい色で表示される

#### 3.4.2 アクション種別分布グラフ（円グラフ）

**確認内容**:
- CREATE、UPDATE、DELETE、LOGIN、LOGOUT等のアクション種別ごとの分布
- 各セクターに色が付いている
- 凡例が表示される

**確認ポイント**:
- [ ] 円グラフが描画される
- [ ] 各アクション種別が色分けされている
- [ ] 凡例が表示される
- [ ] ツールチップ（マウスホバー時）が動作する
- [ ] パーセンテージが表示される

---

### 3.5 施設別利用統計テーブル

#### 確認内容

テーブル列：
- 施設ID
- 施設名
- 総アクション数
- ユニークユーザー数

**確認ポイント**:
- [ ] テーブルが表示される
- [ ] 全列が正しく表示される
- [ ] データが正確に表示される
- [ ] ソート機能が動作する（該当する場合）
- [ ] スクロールが動作する（多数の施設がある場合）

---

### 3.6 ユーザー別活動ログテーブル

#### 確認内容

テーブル列：
- ユーザーID
- ユーザー名（メールアドレス）
- 総アクション数
- 最終アクティブ日時

**確認ポイント**:
- [ ] テーブルが表示される
- [ ] 全列が正しく表示される
- [ ] 最終アクティブ日時が日本語形式で表示される
- [ ] ソート機能が動作する（該当する場合）
- [ ] スクロールが動作する（多数のユーザーがいる場合）

---

### 3.7 エクスポート機能

#### 3.7.1 CSVエクスポート

**手順**:
1. 「CSVエクスポート」ボタンをクリック

**期待結果**:
- CSVファイルがダウンロードされる
- ファイル名: `usage-report-YYYY-MM-DD.csv`
- Excelで開いて日本語が正しく表示される（BOM付きUTF-8）

**確認ポイント**:
- [ ] CSVファイルがダウンロードされる
- [ ] ファイル名が正しい形式である
- [ ] Excelで開いて文字化けしない
- [ ] データが正確に出力されている

#### 3.7.2 PDFエクスポート（印刷）

**手順**:
1. 「PDFエクスポート」ボタンまたはブラウザの印刷機能をクリック

**期待結果**:
- ブラウザの印刷ダイアログが表示される
- 「PDFに保存」オプションでPDFファイルを作成できる

**確認ポイント**:
- [ ] 印刷ダイアログが表示される
- [ ] PDFプレビューが正しく表示される
- [ ] PDFに保存できる
- [ ] PDF内の日本語が正しく表示される

---

### 3.8 レスポンシブデザイン

#### 手順

1. ブラウザの開発者ツールを開く（F12）

2. デバイスツールバーを有効化（Ctrl+Shift+M / Cmd+Shift+M）

3. 以下のデバイスで表示確認
   - iPhone 12 Pro（390x844）
   - iPad（768x1024）
   - デスクトップ（1920x1080）

**確認ポイント**:
- [ ] モバイルでレイアウトが崩れない
- [ ] グラフがモバイルで見やすい
- [ ] テーブルがモバイルでスクロール可能
- [ ] ボタンがタッチしやすいサイズ

---

## 4. バックエンド動作確認

### 4.1 Cloud Functions デプロイ確認

#### 方法1: Firebase Console

1. Firebase Console（https://console.firebase.google.com/）にアクセス

2. プロジェクト「ai-care-shift-scheduler」を選択

3. 左メニュー「Functions」をクリック

4. 以下の関数が表示されることを確認
   - `generateMonthlyReport`（gen2）
   - `scheduledMonthlyReport`（gen2）

**確認ポイント**:
- [ ] 両方の関数が表示される
- [ ] ステータスが「Active」である
- [ ] リージョンが「us-central1」である
- [ ] 最終デプロイ日時が最新である（2025-11-14）

#### 方法2: GitHub ActionsログX

**手順**:
1. GitHub Actionsの最新のCI/CD Pipelineを開く

2. 「Deploy to Firebase」ステップを確認

3. ログに以下が含まれることを確認
   ```
   ✔  functions[generateMonthlyReport(...)] Successful update operation.
   ✔  functions[scheduledMonthlyReport(...)] Successful update operation.
   ```

**確認ポイント**:
- [ ] デプロイログに成功メッセージがある
- [ ] エラーメッセージがない

---

### 4.2 手動レポート生成テスト（オプション）

**注意**: この確認は本番環境のFirestoreにデータを書き込むため、慎重に実施してください。

#### 手順

1. Firebase ConsoleでCloud Functionsを開く

2. `generateMonthlyReport`関数を選択

3. 「テスト」タブを開く

4. 以下のJSONをリクエストボディに入力
   ```json
   {
     "data": {
       "year": 2025,
       "month": 11
     }
   }
   ```

5. 「テストを実行」をクリック

**期待結果**:
```json
{
  "result": {
    "reportId": "2025-11",
    "period": {
      "start": "2025-11-01T00:00:00.000Z",
      "end": "2025-11-30T23:59:59.000Z"
    },
    "summary": {
      "totalLogs": ...,
      "facilities": ...,
      "users": ...,
      "shiftTotal": ...
    }
  }
}
```

**確認ポイント**:
- [ ] 関数が正常に実行される
- [ ] レポートIDが返される
- [ ] サマリーデータが返される
- [ ] Firestoreに `/reports/monthly/data/2025-11` が作成される

---

### 4.3 定期実行確認（Cloud Scheduler）

#### 手順

1. Google Cloud Console（https://console.cloud.google.com/）にアクセス

2. プロジェクト「ai-care-shift-scheduler」を選択

3. 左メニュー「Cloud Scheduler」をクリック

4. ジョブ一覧で以下を確認
   - ジョブ名: `firebase-schedule-scheduledMonthlyReport-...`
   - スケジュール: `0 9 1 * *`（毎月1日午前9時JST）
   - タイムゾーン: `Asia/Tokyo`
   - ステータス: `ENABLED`

**確認ポイント**:
- [ ] Cloud Schedulerジョブが存在する
- [ ] スケジュールが正しい（毎月1日午前9時JST）
- [ ] ステータスがENABLEDである
- [ ] 次回実行日時が表示される

---

## 5. セキュリティ動作確認

### 5.1 Firestore Rules検証

#### 5.1.1 super-admin以外のアクセス拒否

**手順**:

1. 別のブラウザまたはシークレットモードで本番環境を開く

2. admin以外のユーザー（editorやviewer）でログイン

3. `/admin/usage-reports` にアクセス

**期待結果**:
- アクセスが拒否される
- 403 Forbiddenエラーまたはリダイレクトが発生する

**確認ポイント**:
- [ ] super-admin以外はアクセスできない
- [ ] 適切なエラーメッセージが表示される

#### 5.1.2 未認証ユーザーのアクセス拒否

**手順**:

1. シークレットモードで本番環境を開く

2. ログインせずに `/admin/usage-reports` にアクセス

**期待結果**:
- ログインページにリダイレクトされる

**確認ポイント**:
- [ ] 未認証ユーザーはアクセスできない
- [ ] ログインページにリダイレクトされる

---

### 5.2 Cloud Function認証確認

#### 手順

1. ブラウザの開発者ツール（F12）を開く

2. Networkタブを開く

3. UsageReportsページで期間を変更して、Firestoreクエリを発生させる

4. Networkタブでリクエストを確認

**確認ポイント**:
- [ ] Firestoreへのリクエストに認証トークンが含まれている
- [ ] 401 Unauthorizedエラーが発生しない
- [ ] 403 Forbiddenエラーが発生しない

---

## 6. パフォーマンス確認

### 6.1 ページ読み込み時間

#### 手順

1. ブラウザの開発者ツール（F12）を開く

2. Networkタブを開く

3. `/admin/usage-reports` ページにアクセス

4. ページ読み込み完了までの時間を確認

**期待結果**:
- 初回ロード: 2-3秒以内
- Code Splittingにより、UsageReportsチャンクのみが読み込まれる

**確認ポイント**:
- [ ] ページ読み込み時間が3秒以内
- [ ] UsageReports.jsが動的に読み込まれる
- [ ] chart.jsが動的に読み込まれる

---

### 6.2 グラフ描画時間

#### 手順

1. ブラウザの開発者ツール（F12）を開く

2. Performanceタブを開く

3. 記録を開始して、期間を変更

4. グラフ描画完了までの時間を確認

**期待結果**:
- グラフ描画時間: 1秒以内

**確認ポイント**:
- [ ] グラフ描画が1秒以内に完了する
- [ ] スムーズなアニメーションが表示される

---

### 6.3 データ取得時間

#### 手順

1. ブラウザの開発者ツール（F12）を開く

2. Networkタブを開く

3. 期間を変更して、Firestoreクエリを発生させる

4. クエリ完了までの時間を確認

**期待結果**:
- データ取得時間: 1-2秒以内（監査ログ数により変動）

**確認ポイント**:
- [ ] データ取得が2秒以内に完了する
- [ ] タイムアウトエラーが発生しない

---

## 7. トラブルシューティング

### 7.1 ページが表示されない

**症状**: `/admin/usage-reports` にアクセスしても白い画面が表示される

**原因候補**:
1. Code Splittingエラー（チャンクロード失敗）
2. React Errorによるクラッシュ
3. 認証エラー

**対処方法**:
1. ブラウザのコンソールを開いてエラーメッセージを確認
2. ハードリロード（Cmd+Shift+R / Ctrl+Shift+R）を試す
3. ブラウザのキャッシュをクリア
4. シークレットモードで再試行

---

### 7.2 グラフが表示されない

**症状**: 統計カードは表示されるが、グラフが表示されない

**原因候補**:
1. Chart.jsのロード失敗
2. データが空（監査ログが存在しない）
3. グラフコンポーネントのエラー

**対処方法**:
1. ブラウザのコンソールでエラーメッセージを確認
2. Networkタブで chart.js の読み込みを確認
3. 期間を変更してデータがある期間を選択
4. ページをリロード

---

### 7.3 データが表示されない

**症状**: 「データがありません」というメッセージが表示される

**原因候補**:
1. 選択した期間に監査ログが存在しない
2. Firestoreクエリエラー
3. 認証エラー

**対処方法**:
1. 期間を「過去3ヶ月」に変更
2. ブラウザのコンソールでエラーメッセージを確認
3. Networkタブでリクエストステータスを確認
4. super-adminでログインしているか確認

---

### 7.4 CSVエクスポートが文字化けする

**症状**: CSVファイルをExcelで開くと日本語が文字化けする

**原因候補**:
1. BOM（Byte Order Mark）が付いていない
2. エンコーディングがUTF-8ではない

**対処方法**:
1. 実装を確認（`src/pages/admin/UsageReports.tsx` の `handleExportCSV` 関数）
2. BOM（`\uFEFF`）が先頭に付いているか確認
3. ブラウザのバージョンを確認（古いブラウザではBlobサポートに問題がある可能性）

---

### 7.5 Cloud Functionが実行されない

**症状**: 手動レポート生成が失敗する、または定期実行が動作しない

**原因候補**:
1. Cloud Functionがデプロイされていない
2. 権限エラー
3. Firestore Rulesエラー

**対処方法**:
1. Firebase Consoleで関数のデプロイ状況を確認
2. 関数のログを確認（Firebase Console > Functions > ログ）
3. Cloud Schedulerのジョブが有効になっているか確認
4. Firestore Rulesで `/reports/monthly/data/{reportId}` への書き込みが許可されているか確認

---

## 8. 完了チェックリスト

### 8.1 フロントエンド

- [ ] /admin/usage-reports にアクセス可能
- [ ] 期間選択が動作（今月、先月、過去3ヶ月、カスタム）
- [ ] シフト生成統計カードが表示
- [ ] 日別アクション数推移グラフが描画
- [ ] アクション種別分布グラフが描画
- [ ] 施設別利用統計テーブルが表示
- [ ] ユーザー別活動ログテーブルが表示
- [ ] CSVエクスポートが動作
- [ ] PDFエクスポート（印刷）が動作
- [ ] モバイルデバイスでレスポンシブ表示

### 8.2 バックエンド

- [ ] generateMonthlyReport 関数がデプロイ済み
- [ ] scheduledMonthlyReport 関数がデプロイ済み
- [ ] Cloud Schedulerジョブが有効
- [ ] 手動レポート生成が動作（オプション）
- [ ] Firestore `/reports/monthly/data/` にデータが保存される

### 8.3 セキュリティ

- [ ] super-admin以外はアクセス不可
- [ ] 未認証ユーザーはリダイレクトされる
- [ ] Cloud Function認証が動作

### 8.4 パフォーマンス

- [ ] ページ読み込み時間が3秒以内
- [ ] グラフ描画時間が1秒以内
- [ ] データ取得時間が2秒以内

---

## 完了

全てのチェックリストが完了したら、Phase 19.3.3の本番環境動作確認は完了です。

**次のステップ**:
- Phase 19完了宣言の最終確認
- 本番環境動作確認結果のドキュメント化（オプション）
- Phase 20の計画開始（推奨）

---

**🤖 Generated with [Claude Code](https://claude.com/claude-code)**

**Co-Authored-By: Claude <noreply@anthropic.com>**
