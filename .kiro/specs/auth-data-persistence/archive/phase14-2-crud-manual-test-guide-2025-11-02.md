# Phase 14.2手動テストガイド：データCRUD操作検証

**作成日**: 2025年11月2日
**仕様ID**: auth-data-persistence
**Phase**: Phase 14.2（データCRUD操作E2Eテスト）
**対象環境**: 本番環境（https://ai-care-shift-scheduler.web.app）
**言語**: 日本語

---

## 📋 はじめに

本ガイドは、Phase 14.2で実装されたデータCRUD操作（スタッフ、シフト、休暇申請、要件設定）が正しく機能していることを手動で検証するための手順書です。

### 検証の目的

- スタッフ情報のCRUD操作が正常に動作すること
- シフトデータのCRUD操作とバージョン管理が正常に動作すること
- 休暇申請のCRUD操作が正常に動作すること
- 要件設定の保存・読込が正常に動作すること
- Firestoreへのデータ永続化が正しく行われること

### 前提条件

- 本番環境にアクセス可能なGoogleアカウントを持っていること
- テスト用の施設にadmin権限以上でアクセスできること
- Firebase Consoleにアクセスできること（Firestore直接確認用）

### 使用するツール

- Webブラウザ（Chrome推奨）
- Firebase Console（Firestoreデータ確認用）

---

## 🧪 Section 1: スタッフ情報のCRUD操作検証

### 1.1 スタッフ作成（Create）

#### 検証手順

1. **本番環境にアクセス**
   - URL: https://ai-care-shift-scheduler.web.app
   - Googleアカウントでログイン

2. **スタッフ追加ボタンをクリック**
   - メイン画面左側の「スタッフ追加」ボタンをクリック
   - 「新規スタッフ追加」モーダルが表示されることを確認

3. **スタッフ情報を入力**
   - 名前: `テストスタッフ_[現在時刻]`（例: テストスタッフ_1102_1430）
   - 役職: 「介護士」を選択
   - 資格: 「介護福祉士」にチェック
   - 週間勤務回数: 5
   - 最大連続勤務日数: 5
   - 勤務可能曜日: 「月」「火」「水」「木」「金」にチェック
   - 時間帯の希望: 「早番」を選択

4. **保存ボタンをクリック**
   - 「保存」ボタンをクリック
   - モーダルが閉じることを確認
   - トーストメッセージ「スタッフを追加しました」が表示されることを確認

5. **スタッフリストに表示されることを確認**
   - 左側のスタッフリストに新規スタッフが表示されることを確認
   - 名前、役職、資格が正しく表示されることを確認

6. **Firestoreに保存されていることを確認**
   - Firebase Console（https://console.firebase.google.com/）にアクセス
   - プロジェクト: ai-care-shift-scheduler
   - Firestore Database → `/facilities/{facilityId}/staff` コレクション
   - 新規作成したスタッフのドキュメントが存在することを確認
   - フィールド値（name, role, qualifications等）が正しいことを確認

#### 期待結果

- ✅ スタッフ追加モーダルが表示される
- ✅ スタッフ情報を入力・保存できる
- ✅ トーストメッセージが表示される
- ✅ スタッフリストに即座に表示される
- ✅ Firestoreに正しく保存される

---

### 1.2 スタッフ読取（Read）

#### 検証手順

1. **ページリロード**
   - ブラウザのリロードボタン（Cmd+R / Ctrl+R）を押す
   - ログイン状態が維持されることを確認

2. **スタッフリストの確認**
   - 先ほど追加したスタッフが引き続き表示されることを確認
   - すべてのスタッフ情報が表示されることを確認

3. **Firestoreからの読取確認**
   - Firebase Consoleで `/facilities/{facilityId}/staff` コレクションを確認
   - アプリ上で表示されているスタッフ数とFirestore上のドキュメント数が一致することを確認

#### 期待結果

- ✅ ページリロード後もスタッフリストが表示される
- ✅ Firestoreから全スタッフ情報が取得される

---

### 1.3 スタッフ更新（Update）

#### 検証手順

1. **スタッフ編集ボタンをクリック**
   - 先ほど作成したスタッフの「編集」ボタン（鉛筆アイコン）をクリック
   - 「スタッフ編集」モーダルが表示されることを確認
   - 既存の情報がフォームに反映されていることを確認

2. **スタッフ情報を変更**
   - 役職: 「看護師」に変更
   - 資格: 「看護師」にチェック、「介護福祉士」のチェックを外す
   - 週間勤務回数: 4に変更

3. **保存ボタンをクリック**
   - 「保存」ボタンをクリック
   - モーダルが閉じることを確認
   - トーストメッセージ「スタッフを更新しました」が表示されることを確認

4. **スタッフリストに反映されることを確認**
   - スタッフリストで役職が「看護師」に変更されていることを確認
   - 資格が「看護師」に変更されていることを確認

5. **Firestoreに更新されていることを確認**
   - Firebase Consoleで該当スタッフのドキュメントを確認
   - role = "看護師"、qualifications = ["看護師"]に更新されていることを確認
   - updatedAtタイムスタンプが更新されていることを確認

#### 期待結果

- ✅ スタッフ編集モーダルが表示される
- ✅ 既存情報がフォームに反映される
- ✅ スタッフ情報を変更・保存できる
- ✅ トーストメッセージが表示される
- ✅ スタッフリストに即座に反映される
- ✅ Firestoreに正しく更新される

---

### 1.4 スタッフ削除（Delete）

#### 検証手順

1. **スタッフ削除ボタンをクリック**
   - 先ほど作成・編集したスタッフの「削除」ボタン（ゴミ箱アイコン）をクリック
   - 確認ダイアログが表示されることを確認

2. **削除を確認**
   - 「削除」ボタンをクリック
   - トーストメッセージ「スタッフを削除しました」が表示されることを確認

3. **スタッフリストから削除されることを確認**
   - スタッフリストから該当スタッフが消えることを確認

4. **Firestoreから削除されていることを確認**
   - Firebase Consoleで `/facilities/{facilityId}/staff` コレクションを確認
   - 該当スタッフのドキュメントが存在しないことを確認

#### 期待結果

- ✅ 削除確認ダイアログが表示される
- ✅ トーストメッセージが表示される
- ✅ スタッフリストから即座に削除される
- ✅ Firestoreから削除される

---

## 🧪 Section 2: シフトデータのCRUD操作検証

### 2.1 シフト生成（Create）

#### 検証手順（AIシフト生成）

1. **シフト生成ボタンをクリック**
   - メイン画面上部の「シフト作成実行」ボタンをクリック
   - ローディングインジケーターが表示されることを確認

2. **生成完了を待つ**
   - シフト生成が完了するまで待つ（通常5-10秒）
   - トーストメッセージ「シフトを生成しました」が表示されることを確認

3. **シフトカレンダーに表示されることを確認**
   - カレンダーに各スタッフのシフトが表示されることを確認
   - 早番、日勤、遅番、夜勤の配置が適切に表示されることを確認

4. **Firestoreに保存されていることを確認**
   - Firebase Consoleで `/facilities/{facilityId}/schedules` コレクションを確認
   - 新規作成されたschedulesドキュメントが存在することを確認
   - フィールド値（targetMonth, staffSchedules, generatedAt, generatedBy, version, status）が正しいことを確認
   - status = "draft"であることを確認

#### 検証手順（デモシフト生成）

1. **デモシフト生成ボタンをクリック**
   - メイン画面上部の「デモシフト生成」ボタンをクリック

2. **即座に生成されることを確認**
   - デモシフトが即座にカレンダーに表示されることを確認
   - トーストメッセージ「デモシフトを生成しました」が表示されることを確認

3. **Firestoreに保存されていることを確認**
   - Firebase Consoleで `/facilities/{facilityId}/schedules` コレクションを確認
   - デモシフトのドキュメントが存在することを確認

#### 期待結果

- ✅ シフト生成ボタンをクリックできる
- ✅ ローディングインジケーターが表示される（AIシフトの場合）
- ✅ シフトがカレンダーに表示される
- ✅ トーストメッセージが表示される
- ✅ Firestoreに正しく保存される

---

### 2.2 シフト読取（Read）

#### 検証手順

1. **対象月を変更**
   - カレンダー上部の対象月選択ドロップダウンで次月を選択
   - 空のカレンダーまたは既存のシフトが表示されることを確認

2. **対象月を元に戻す**
   - 対象月選択ドロップダウンで現在月に戻す
   - 先ほど生成したシフトが表示されることを確認

3. **ページリロード**
   - ブラウザのリロードボタンを押す
   - シフトが引き続き表示されることを確認

4. **Firestoreからの読取確認**
   - Firebase Consoleで `/facilities/{facilityId}/schedules` コレクションを確認
   - アプリ上で表示されているシフトとFirestore上のドキュメントが一致することを確認

#### 期待結果

- ✅ 対象月変更時にシフトが正しく切り替わる
- ✅ ページリロード後もシフトが表示される
- ✅ Firestoreから正しく読み取られる

---

### 2.3 シフト編集・下書き保存（Update - Draft）

#### 検証手順

1. **シフトセルをダブルクリック**
   - カレンダー上の任意のシフトセルをダブルクリック
   - ドロップダウンメニューが表示されることを確認

2. **シフトを変更**
   - 別の時間帯（例: 早番 → 日勤）を選択
   - セルの表示が即座に変更されることを確認

3. **下書き保存ボタンをクリック**
   - 画面上部の「下書き保存」ボタンをクリック
   - トーストメッセージ「下書きを保存しました」が表示されることを確認

4. **Firestoreに保存されていることを確認**
   - Firebase Consoleで該当scheduleドキュメントを確認
   - staffSchedules配列が更新されていることを確認
   - status = "draft"のままであることを確認
   - updatedAtタイムスタンプが更新されていることを確認

5. **ページリロードして復元されることを確認**
   - ブラウザのリロードボタンを押す
   - 編集したシフトが復元されることを確認

#### 期待結果

- ✅ シフトセルをダブルクリックでドロップダウンが表示される
- ✅ シフト変更が即座にUIに反映される
- ✅ 下書き保存ボタンをクリックできる
- ✅ トーストメッセージが表示される
- ✅ Firestoreに正しく保存される（status="draft"）
- ✅ ページリロード後も編集内容が復元される

---

### 2.4 シフト確定（Update - Confirmed）

#### 検証手順

1. **確定ボタンをクリック**
   - 画面上部の「確定」ボタンをクリック
   - トーストメッセージ「シフトを確定しました」が表示されることを確認

2. **確定ボタンが無効化されることを確認**
   - 「確定」ボタンが無効化（グレーアウト）されることを確認

3. **Firestoreに保存されていることを確認**
   - Firebase Consoleで該当scheduleドキュメントを確認
   - status = "confirmed"に変更されていることを確認

4. **バージョン履歴が作成されていることを確認**
   - Firebase Consoleで `/facilities/{facilityId}/schedules/{scheduleId}/versions` サブコレクションを確認
   - versionNumber = 1のドキュメントが作成されていることを確認
   - 確定前のシフトデータ（staffSchedules）が保存されていることを確認

#### 期待結果

- ✅ 確定ボタンをクリックできる
- ✅ トーストメッセージが表示される
- ✅ 確定ボタンが無効化される
- ✅ Firestoreにstatus="confirmed"が保存される
- ✅ バージョン履歴が作成される

---

### 2.5 バージョン履歴の表示

#### 検証手順

1. **バージョン履歴ボタンをクリック**
   - 画面上部の「バージョン履歴」ボタン（紫色、時計アイコン）をクリック
   - 「バージョン履歴」モーダルが表示されることを確認

2. **バージョン一覧の確認**
   - versionNumber = 1のエントリが表示されることを確認
   - 確定日時が表示されることを確認
   - 確定者（自分のメールアドレス）が表示されることを確認

3. **モーダルを閉じる**
   - 「閉じる」ボタンをクリック
   - モーダルが閉じることを確認

#### 期待結果

- ✅ バージョン履歴ボタンをクリックできる
- ✅ バージョン履歴モーダルが表示される
- ✅ バージョン一覧が正しく表示される

---

### 2.6 過去バージョンへの復元

#### 検証手順

1. **シフトを再度編集**
   - シフトセルを数箇所ダブルクリックして変更
   - 下書き保存ボタンをクリック

2. **バージョン履歴モーダルを開く**
   - 「バージョン履歴」ボタンをクリック

3. **過去バージョンを選択**
   - versionNumber = 1の「復元」ボタンをクリック
   - 確認ダイアログが表示されることを確認

4. **復元を確認**
   - 「復元」ボタンをクリック
   - トーストメッセージ「バージョンを復元しました」が表示されることを確認
   - モーダルが閉じることを確認

5. **カレンダーに反映されることを確認**
   - カレンダーが過去バージョンの内容に戻ることを確認
   - 先ほど編集した箇所が元に戻ることを確認

6. **Firestoreに保存されていることを確認**
   - Firebase Consoleで該当scheduleドキュメントを確認
   - staffSchedulesが過去バージョンの内容になっていることを確認
   - version番号がインクリメントされていることを確認（例: version = 2）

7. **復元前の状態がバージョン履歴に保存されていることを確認**
   - Firebase Consoleで `/facilities/{facilityId}/schedules/{scheduleId}/versions` サブコレクションを確認
   - 新しいバージョン（例: versionNumber = 2）が作成されていることを確認

#### 期待結果

- ✅ 過去バージョンを選択できる
- ✅ 復元確認ダイアログが表示される
- ✅ トーストメッセージが表示される
- ✅ カレンダーが過去バージョンの内容に戻る
- ✅ Firestoreに正しく保存される
- ✅ 復元前の状態がバージョン履歴に保存される

---

## 🧪 Section 3: 休暇申請のCRUD操作検証

### 3.1 休暇申請作成（Create）

#### 検証手順

1. **カレンダー上でスタッフの日付セルをクリック**
   - カレンダー上の任意のスタッフの日付セル（空白）をクリック
   - 「休暇登録」ボタンまたはメニューが表示されることを確認

2. **休暇登録ダイアログの確認**
   - 「休暇登録」を選択
   - スタッフ名と日付が正しく表示されることを確認

3. **休暇タイプを選択**
   - 休暇タイプ（例: 有給休暇）を選択
   - 「登録」ボタンをクリック

4. **トーストメッセージの確認**
   - トーストメッセージ「休暇申請を登録しました」が表示されることを確認

5. **カレンダーに表示されることを確認**
   - 該当日付セルに休暇マーカー（例: 「有休」）が表示されることを確認

6. **Firestoreに保存されていることを確認**
   - Firebase Consoleで `/facilities/{facilityId}/leaveRequests` コレクションを確認
   - 新規作成された休暇申請ドキュメントが存在することを確認
   - フィールド値（staffId, staffName, date, leaveType）が正しいことを確認

#### 期待結果

- ✅ 日付セルをクリックで休暇登録メニューが表示される
- ✅ 休暇タイプを選択・登録できる
- ✅ トーストメッセージが表示される
- ✅ カレンダーに休暇マーカーが表示される
- ✅ Firestoreに正しく保存される

---

### 3.2 休暇申請読取（Read）

#### 検証手順

1. **対象月を変更**
   - カレンダー上部の対象月選択ドロップダウンで次月を選択
   - 休暇マーカーが消えることを確認

2. **対象月を元に戻す**
   - 対象月選択ドロップダウンで現在月に戻す
   - 先ほど登録した休暇マーカーが表示されることを確認

3. **ページリロード**
   - ブラウザのリロードボタンを押す
   - 休暇マーカーが引き続き表示されることを確認

#### 期待結果

- ✅ 対象月変更時に休暇が正しく切り替わる
- ✅ ページリロード後も休暇が表示される

---

### 3.3 休暇申請削除（Delete）

#### 検証手順

1. **休暇マーカーをクリック**
   - カレンダー上の先ほど登録した休暇マーカーをクリック
   - 「休暇削除」ボタンまたはメニューが表示されることを確認

2. **削除を確認**
   - 「休暇削除」を選択
   - 確認ダイアログが表示されることを確認
   - 「削除」ボタンをクリック

3. **トーストメッセージの確認**
   - トーストメッセージ「休暇申請を削除しました」が表示されることを確認

4. **カレンダーから削除されることを確認**
   - 該当日付セルから休暇マーカーが消えることを確認

5. **Firestoreから削除されていることを確認**
   - Firebase Consoleで `/facilities/{facilityId}/leaveRequests` コレクションを確認
   - 該当休暇申請ドキュメントが存在しないことを確認

#### 期待結果

- ✅ 休暇マーカーをクリックで削除メニューが表示される
- ✅ 削除確認ダイアログが表示される
- ✅ トーストメッセージが表示される
- ✅ カレンダーから休暇マーカーが削除される
- ✅ Firestoreから削除される

---

## 🧪 Section 4: 要件設定の保存・読込検証

### 4.1 要件設定の変更と保存

#### 検証手順

1. **要件設定フォームにアクセス**
   - メイン画面上部の「シフト要件」セクションを確認
   - 早番、日勤、遅番、夜勤の各時間帯の要件が表示されることを確認

2. **要件を変更**
   - 早番の「必要人数」を現在値から+1増やす（例: 2 → 3）
   - 1秒待機（自動保存のdebounce）

3. **トーストメッセージの確認**
   - トーストメッセージ「要件を保存しました」が表示されることを確認

4. **Firestoreに保存されていることを確認**
   - Firebase Consoleで `/facilities/{facilityId}/requirements/default` ドキュメントを確認
   - 早番のtotalが+1増えていることを確認

5. **ページリロード**
   - ブラウザのリロードボタンを押す
   - 先ほど変更した要件が復元されることを確認（早番の必要人数が+1のまま）

#### 期待結果

- ✅ 要件設定フォームが表示される
- ✅ 要件を変更できる
- ✅ 1秒後にトーストメッセージが表示される（自動保存）
- ✅ Firestoreに正しく保存される
- ✅ ページリロード後も要件が復元される

---

### 4.2 デフォルト設定のフォールバック

#### 検証手順

1. **Firebase Consoleで要件ドキュメントを削除**
   - Firebase Consoleで `/facilities/{facilityId}/requirements/default` ドキュメントを削除
   - （注意: この手順はテスト施設でのみ実施すること）

2. **ページリロード**
   - ブラウザのリロードボタンを押す

3. **デフォルト設定が表示されることを確認**
   - 要件設定フォームにデフォルト値（早番: 2, 日勤: 3, 遅番: 2, 夜勤: 2）が表示されることを確認

4. **要件を変更**
   - 早番の「必要人数」を3に変更
   - 1秒待機

5. **Firestoreに保存されることを確認**
   - Firebase Consoleで `/facilities/{facilityId}/requirements/default` ドキュメントが再作成されることを確認

#### 期待結果

- ✅ 要件ドキュメントが存在しない場合、デフォルト設定が使用される
- ✅ 要件変更後にFirestoreに新規作成される

---

## 📊 検証結果チェックリスト

### Section 1: スタッフ情報のCRUD操作

- [ ] スタッフ作成が成功する
- [ ] スタッフ読取（ページリロード後）が成功する
- [ ] スタッフ更新が成功する
- [ ] スタッフ削除が成功する
- [ ] Firestore に正しく保存・更新・削除される

### Section 2: シフトデータのCRUD操作

- [ ] シフト生成（AI）が成功する
- [ ] シフト生成（デモ）が成功する
- [ ] シフト読取（対象月変更・ページリロード後）が成功する
- [ ] シフト編集・下書き保存が成功する
- [ ] シフト確定が成功する
- [ ] バージョン履歴の表示が成功する
- [ ] 過去バージョンへの復元が成功する
- [ ] Firestore に正しく保存・更新される
- [ ] バージョン履歴がFirestoreに正しく作成される

### Section 3: 休暇申請のCRUD操作

- [ ] 休暇申請作成が成功する
- [ ] 休暇申請読取（対象月変更・ページリロード後）が成功する
- [ ] 休暇申請削除が成功する
- [ ] Firestore に正しく保存・削除される

### Section 4: 要件設定の保存・読込

- [ ] 要件設定の変更と自動保存が成功する
- [ ] ページリロード後の要件復元が成功する
- [ ] デフォルト設定のフォールバックが成功する
- [ ] Firestore に正しく保存される

---

## 🐛 トラブルシューティング

### 問題: スタッフが保存されない

**症状**: スタッフ追加後、スタッフリストに表示されない

**原因**:
1. 権限不足（editor以下の権限）
2. ネットワークエラー
3. Firestore Security Rulesエラー

**対処方法**:
1. Firebase Consoleでユーザーの権限を確認（admin以上が必要）
2. ブラウザのコンソールでエラーメッセージを確認
3. ネットワーク接続を確認

---

### 問題: シフトが生成されない

**症状**: シフト生成ボタンをクリックしてもカレンダーにシフトが表示されない

**原因**:
1. スタッフが不足している（最低5名必要）
2. Cloud Function エラー
3. ネットワークエラー

**対処方法**:
1. スタッフ数を確認（最低5名以上）
2. ブラウザのコンソールでエラーメッセージを確認
3. Firebase Consoleの Functionsログ を確認

---

### 問題: ページリロード後にデータが消える

**症状**: ページリロード後、スタッフやシフトが表示されない

**原因**:
1. Firestore への保存が失敗していた
2. ログアウトしている
3. 施設選択が解除されている

**対処方法**:
1. Firebase Consoleで Firestore データを確認
2. 再度ログインする
3. 施設を再選択する

---

## 📝 検証完了報告

### 検証実施情報

- **検証日時**: ____年____月____日 ____時____分
- **検証者**: _________________________
- **本番環境URL**: https://ai-care-shift-scheduler.web.app
- **テスト施設ID**: _________________________

### 検証結果サマリー

| Section | 実施状況 | 成功 | 失敗 | 備考 |
|---------|---------|------|------|------|
| Section 1: スタッフCRUD | ✅ / ❌ | __/4 | __/4 | |
| Section 2: シフトCRUD | ✅ / ❌ | __/7 | __/7 | |
| Section 3: 休暇申請CRUD | ✅ / ❌ | __/3 | __/3 | |
| Section 4: 要件設定 | ✅ / ❌ | __/2 | __/2 | |

### 検証完了判定

- [ ] すべてのテストケースが成功した
- [ ] 一部のテストケースが失敗したが、重大な問題ではない
- [ ] 重大な問題が発見された（詳細を以下に記載）

### 発見された問題

（問題があれば記載）

---

**作成日**: 2025年11月2日
**Phase 14.2ステータス**: 🟡 **手動テストガイド完成**
**次のアクション**: 本番環境での手動テスト実施と自動E2Eテストの実装
