# 既存E2Eテスト動作確認レポート

**検証日**: 2025-11-01
**仕様ID**: auth-data-persistence
**Phase**: Phase 14準備作業

---

## 概要

Phase 14（E2Eテスト実装）の準備として、既存E2Eテスト（27テスト）の動作確認を実施しました。

**結果**: E2Eテスト環境は正常に動作するが、認証なしで実行されているため多くのテストが失敗。Phase 14.1（認証フローテスト）で解決すべき予想通りの状況です。

---

## 環境セットアップ

### Playwright環境
- ✅ **インストール済み**: `@playwright/test` v1.56.1
- ✅ **設定ファイル**: `playwright.config.ts` 充実
- ✅ **テストスクリプト**: `npm run test:e2e` 実行可能

### 開発サーバー
- **問題発見**: ポート競合（ポート3000がGoogle Chromeに使用されている）
- **回避策**: 開発サーバーがポート3001で起動
- **playwright設定**: 一時的にポート3001に変更してテスト実行（検証後に元に戻した）

---

## テスト実行結果

### 実行テスト数
- **合計**: 27テスト
- **スキップ**: 3テスト（test.skip指定）
- **実行**: 24テスト

### 結果サマリー
- ✅ **成功**: 1テスト
  - `AI シフト生成 E2E テスト › CI環境ではAI生成テストがスキップされる`
- ❌ **失敗**: 23テスト

### 失敗の主な理由

#### 1. 認証なしでの実行（最も一般的）

**エラーパターン**:
```text
Error: expect(locator).toBeVisible() failed

Locator: getByRole('button', { name: 'シフト作成実行' })
Expected: visible
Timeout: 5000ms
Error: element(s) not found
```

**原因**:
- アプリケーションが認証ページにリダイレクト
- 期待する要素（ボタン、テーブルなど）がログイン後のページに存在
- 認証なしでは表示されない

**影響テスト**:
- `e2e/app.spec.ts`: 5テスト中5テスト失敗
- `e2e/staff-management.spec.ts`: 6テスト中6テスト失敗
- `e2e/shift-creation.spec.ts`: 4テスト中4テスト失敗（1テストは成功）
- `e2e/leave-request.spec.ts`: 6テスト中6テスト失敗
- `e2e/ai-shift-generation.spec.ts`: 4テスト中3テスト失敗

#### 2. タイムアウト（30秒）

**エラーパターン**:
```text
Test timeout of 30000ms exceeded.
Error: locator.click: Test timeout of 30000ms exceeded.
```

**原因**:
- 認証リダイレクトにより、期待する要素が表示されない
- 要素を30秒待ち続けてタイムアウト

**影響**: 失敗テストの約半数

---

## 主な発見

### ✅ 正常動作
1. **Playwright環境**: 正常にセットアップされている
2. **開発サーバー起動**: Viteが正常に起動（ポート3001）
3. **テスト実行基盤**: テストランナーは正常に動作
4. **CI環境判定**: 環境変数による条件分岐が正しく機能

### ❌ 課題（Phase 14で解決）
1. **認証フローなし**: 既存テストは認証なしで実行
2. **認証状態の復元なし**: ページリロード後の状態復元未確認
3. **RBAC未考慮**: 権限による制御が未テスト
4. **データ永続化未確認**: Firestoreとの統合が欠如

---

## Phase 14要件との関係

### Phase 14.1: 認証フローテスト（未実装） → **最優先**

**必要な実装**:
- Google OAuthログインフローのテスト
- ログイン後の状態保持
- テスト用アカウントの準備

**影響**: すべての既存テストが認証後に実行できるようになる

### Phase 14.2: データCRUD操作テスト（部分実装）

**既存**: UIレベルのテスト（認証なし）
**不足**: データ永続化の確認

### Phase 14.3: RBAC権限チェック（未実装）

**必要な実装**: 権限別の画面アクセステスト

### Phase 14.4-14.5: バージョン管理・データ復元（未実装）

**必要な実装**: 新規テストケース作成

---

## 技術的発見

### 1. ポート競合問題

**問題**:
- デフォルトポート3000がGoogle Chromeに使用されている
- ViteがPORT環境変数を無視してポート3001で起動

**一時的対処**:
```bash
# playwright.config.tsを一時変更（検証後に元に戻した）
baseURL: 'http://localhost:3001'
webServer.url: 'http://localhost:3001'
```

**恒久的対策（Phase 14実装時）**:
- Vite設定で固定ポート（5173）を明示的に指定
- または、環境変数`PLAYWRIGHT_BASE_URL`でポートを動的に指定

### 2. 既存テストのセレクター戦略

**良い点**:
- `getByRole()`を優先使用（アクセシビリティ重視）
- テキスト内容による検索（`getByText()`）

**改善点**:
- CSSセレクター（`.bg-white`など）に依存している箇所がある
- `data-testid`の使用が少ない（UIの変更に弱い）

### 3. 待機戦略

**問題**:
- `page.waitForTimeout(500)`の多用（固定時間待機）

**推奨**:
- `toBeVisible({ timeout: ... })`による動的待機
- `waitForLoadState()`などの状態待機

---

## 次のステップ

### 推奨実装順序

#### 1. Phase 14.1実装（最優先・2-3時間）
- ファイル: `e2e/auth-flow.spec.ts`
- 内容:
  - テスト用Firebaseアカウントの準備
  - ログインフローのテスト
  - ログアウト・再ログインのテスト
  - セッション永続化の確認

#### 2. 既存テストの改善（2-3時間）
- 認証状態の共通セットアップ
- `beforeAll`でログイン処理を共通化
- データクリーンアップの実装

#### 3. Phase 14.3実装（3-4時間）
- ファイル: `e2e/rbac-permissions.spec.ts`
- RBAC権限チェックテスト

#### 4. CI/CD再有効化（1時間）
- `.github/workflows/ci.yml`のE2Eテストコメント解除
- CI環境でのFirebase設定確認

---

## 関連ドキュメント

- [phase14-status-2025-11-01.md](./phase14-status-2025-11-01.md) - Phase 14実装状況
- [existing-e2e-test-patterns-2025-11-01.md](./existing-e2e-test-patterns-2025-11-01.md) - 既存テストパターン分析
- [playwright.config.ts](../../playwright.config.ts) - Playwright設定
- [package.json](../../package.json) - テストスクリプト

---

## 結論

**E2Eテスト環境は正常に動作** ✅

既存テストの失敗は、Phase 14.1（認証フローテスト）で解決すべき予想通りの課題です。認証フローを実装すれば、既存テストの多くが正常に動作すると期待されます。

**次のアクション**: Phase 14.1（認証フローテスト）の実装開始を推奨

---

**ステータス**: E2Eテスト動作確認 - ✅ **完了**
**主な発見**: 認証なしで実行されているため失敗（予想通り）
**次フェーズ**: Phase 14.1（認証フローテスト）実装開始
