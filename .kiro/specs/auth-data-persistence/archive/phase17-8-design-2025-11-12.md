# Phase 17.8: User Fetch Permission Error修正 - 技術設計

**更新日**: 2025-11-12
**仕様ID**: auth-data-persistence
**Phase**: 17.8
**種別**: バグ修正（重大）

---

## 目次

1. [修正概要](#修正概要)
2. [実装設計](#実装設計)
3. [テスト戦略](#テスト戦略)
4. [デプロイ戦略](#デプロイ戦略)
5. [ロールバック計画](#ロールバック計画)

---

## 修正概要

### 目的

Firestore認証トークンの初期化タイミング問題により発生する「Missing or insufficient permissions」エラーを修正します。

### 根本原因

`onAuthStateChanged`が呼ばれた時点で、Firestoreの`request.auth`がまだ完全に初期化されていないため、`getDoc()`実行時にPermission deniedが発生します。

### 解決策

**認証トークンの強制更新**:
`getDoc()`実行前に、`user.getIdToken(true)`で認証トークンを強制的に更新します。

---

## 実装設計

### 修正対象ファイル

**ファイル**: `src/contexts/AuthContext.tsx`

**関数**: `AuthProvider` - `useEffect`内の`onAuthStateChanged`コールバック

### コード設計

#### 現在のコード（Line 86-97）

```typescript
// authReady が完了するまで待機してから認証状態を監視
authReady.then(() => {
  unsubscribe = onAuthStateChanged(auth, async (user) => {
    setCurrentUser(user);

    if (user) {
      // Firestoreからユーザープロファイルを取得
      try {
        const userDoc = await getDoc(doc(db, 'users', user.uid));
        // ↑ ここでPermission deniedが発生
```

#### 修正後のコード

```typescript
// authReady が完了するまで待機してから認証状態を監視
authReady.then(() => {
  unsubscribe = onAuthStateChanged(auth, async (user) => {
    setCurrentUser(user);

    if (user) {
      // Firestoreの認証トークンを強制的に更新
      // これにより、Firestoreの request.auth が完全に初期化される
      try {
        await user.getIdToken(true);
        console.log('✅ Firestore auth token refreshed');
      } catch (tokenError) {
        console.error('❌ Failed to refresh auth token:', tokenError);
        // トークン更新失敗時は続行（既存の動作を維持）
      }

      // Firestoreからユーザープロファイルを取得
      try {
        const userDoc = await getDoc(doc(db, 'users', user.uid));
```

### 変更内容

**追加行数**: 9行

**追加箇所**: `if (user) {`の直後、`getDoc()`の直前

**変更理由**:
1. Firestoreの認証トークンを確実に初期化
2. `request.auth`が完全に有効な状態でSecurity Rulesを評価
3. Permission deniedエラーを防止

---

## 詳細設計

### 認証トークン強制更新の仕組み

#### `user.getIdToken(true)`の動作

**引数 `true`**:
- サーバーから最新のトークンを取得
- キャッシュされたトークンを使用しない
- Firestoreの認証状態を確実に同期

**実行時間**:
- 通常: 100-500ms
- ネットワーク遅延時: 最大2-3秒

**エラーハンドリング**:
- トークン更新失敗時も、既存の動作を維持（続行）
- エラーログを出力して問題を追跡可能に

---

### パフォーマンス影響分析

#### トークン更新のコスト

**発生タイミング**:
- ログイン時の1回のみ
- ページリロード時の1回のみ

**影響**:
- ログイン完了まで: +100-500ms
- ユーザー体験への影響: ほぼなし（ローディング中に完了）

#### ネットワークリクエスト

**追加リクエスト**:
- Firebase Authenticationサーバーへの1リクエスト

**並列処理**:
- `getDoc()`とは独立して実行可能
- ただし、`getDoc()`の前に完了する必要がある

---

### エラーハンドリング設計

#### トークン更新失敗時

```typescript
try {
  await user.getIdToken(true);
  console.log('✅ Firestore auth token refreshed');
} catch (tokenError) {
  console.error('❌ Failed to refresh auth token:', tokenError);
  // トークン更新失敗時は続行（既存の動作を維持）
}
```

**方針**:
- トークン更新失敗時は、エラーログを出力して続行
- `getDoc()`は実行される（既存の動作を維持）
- Permission deniedが発生する可能性はあるが、既存のエラーハンドリングで対応

---

## テスト戦略

### 手動テスト

#### テストシナリオ1: 新規ユーザーログイン

**前提条件**:
- まだログインしたことがない新しいGoogleアカウント

**手順**:
1. 本番環境を開く
2. ブラウザコンソールを開く
3. 「Googleでログイン」をクリック
4. 新規Googleアカウントで認証
5. コンソールを確認

**期待される結果**:
- ✅ 「✅ Firestore auth token refreshed」ログが表示される
- ✅ Permission errorが表示されない
- ✅ ユーザープロファイルが正常に取得される
- ✅ アプリケーションが正常に動作する

---

#### テストシナリオ2: 既存ユーザーログイン

**前提条件**:
- すでにログインしたことがあるGoogleアカウント

**手順**:
1. ログアウト
2. ブラウザコンソールを開く
3. 「Googleでログイン」をクリック
4. 既存Googleアカウントで認証
5. コンソールを確認

**期待される結果**:
- ✅ 「✅ Firestore auth token refreshed」ログが表示される
- ✅ Permission errorが表示されない
- ✅ ユーザープロファイルが正常に取得される
- ✅ 施設選択が復元される（LocalStorage）

---

#### テストシナリオ3: ページリロード

**前提条件**:
- ログイン済み

**手順**:
1. ブラウザコンソールを開く
2. ページをリロード（F5）
3. コンソールを確認

**期待される結果**:
- ✅ 「✅ Firestore auth token refreshed」ログが表示される
- ✅ Permission errorが表示されない
- ✅ ユーザープロファイルが正常に取得される
- ✅ ログイン状態が維持される

---

### パフォーマンステスト

#### ログイン時間測定

**手順**:
1. ブラウザコンソールを開く
2. Performance APIで時間を測定
3. 「Googleでログイン」をクリック
4. ログイン完了までの時間を測定

**期待される結果**:
- ✅ ログイン完了まで: 修正前と比較して+500ms以内
- ✅ ユーザー体験への影響: ほぼなし

---

### ブラウザ互換性テスト

**対象ブラウザ**:
- Chrome（最新版）
- Firefox（最新版）
- Safari（最新版）
- Edge（最新版）

**確認項目**:
- ✅ すべてのブラウザでPermission errorが発生しない
- ✅ すべてのブラウザで認証が正常動作

---

## デプロイ戦略

### フェーズ1: コード修正

**手順**:

```bash
# 1. src/contexts/AuthContext.tsx を修正
# onAuthStateChanged コールバックに認証トークン強制更新を追加

# 2. TypeScript型チェック
npx tsc --noEmit

# 3. コミット
git add src/contexts/AuthContext.tsx .kiro/specs/auth-data-persistence/phase17-8-*.md
git commit -m "fix: Phase 17.8 User Fetch Permission Error修正

- getDoc()実行前に認証トークンを強制更新
- Firestoreの request.auth を確実に初期化
- Permission deniedエラーを防止

🤖 Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>"

# 4. CodeRabbitレビュー
coderabbit review --plain --base-commit HEAD~1 --config CLAUDE.md

# 5. Push
git push origin main

# 6. GitHub Actions自動デプロイ
# GitHub Actions が firebase deploy --only hosting を実行
```

---

### フェーズ2: 本番環境での確認

**確認項目**:

1. **新規ユーザーログイン確認**:
   - 新しいGoogleアカウントでログイン
   - Permission errorが発生しないことを確認

2. **既存ユーザーログイン確認**:
   - 既存Googleアカウントでログイン
   - Permission errorが発生しないことを確認

3. **既存機能の確認**:
   - すべての機能が正常動作することを確認

---

## ロールバック計画

### シナリオ: 修正で新たな問題が発生

**症状**: 認証が動作しない、またはパフォーマンスが大幅に低下

**ロールバック手順**:

```bash
# 1. 前のコミットにリバート
git revert HEAD

# 2. Push
git push origin main

# 3. GitHub Actions自動デプロイ
# 自動的に以前のコードがデプロイされる
```

**または、手動修正**:

1. `src/contexts/AuthContext.tsx`から追加した9行を削除
2. コミット & Push
3. GitHub Actions自動デプロイ

---

## 影響分析

### 正の影響

1. **Permission error解消**:
   - 新規ユーザーログイン時のエラーが解消
   - ユーザー体験の大幅改善

2. **安定性向上**:
   - 認証トークンの初期化を確実に待つ
   - タイミング問題によるエラーを防止

3. **デバッグ容易性**:
   - トークン更新ログにより、問題追跡が容易

### 負の影響

1. **パフォーマンス**:
   - ログイン時に+100-500ms
   - ユーザー体験への影響: ほぼなし（許容範囲）

2. **ネットワークリクエスト**:
   - Firebase Authenticationサーバーへの追加リクエスト1回
   - 影響: 軽微

---

## 承認

この技術設計は以下の点を考慮して作成されました：

- ✅ Permission errorの根本原因を解決
- ✅ シンプルで実装が容易
- ✅ 既存コードへの影響が最小限
- ✅ パフォーマンス影響は許容範囲
- ✅ テスト戦略を明確化
- ✅ ロールバック計画を策定

---

## 次のステップ

1. ✅ この技術設計ドキュメントを承認
2. 🛠️ `src/contexts/AuthContext.tsx`を修正
3. 🚀 デプロイ（GitHub Actions CI/CD）
4. ✅ 本番環境で確認
5. 📝 Phase 17.8検証ドキュメント作成

---

## 関連ドキュメント

- `phase17-8-bug-analysis-2025-11-12.md` - バグ分析
- `src/contexts/AuthContext.tsx` - 認証コンテキスト
- `firestore.rules` - Firestore Security Rules
- `functions/src/auth-onCreate.ts` - Cloud Function

---

**レポート作成日**: 2025-11-12
**作成者**: AI（Claude Code）
**推定工数**: 15分
