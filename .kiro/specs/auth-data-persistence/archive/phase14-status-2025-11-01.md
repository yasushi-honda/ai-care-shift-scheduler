# Phase 14 実装状況レポート - E2Eテストと統合テスト

**調査日**: 2025-11-01
**仕様ID**: auth-data-persistence
**Phase**: Phase 14 - 統合テストとE2Eテスト

---

## 概要

Phase 14（統合テストとE2Eテスト）の実装状況を調査した結果、**E2Eテスト環境は整っているが、Phase 14要件のテストは未実装**であることが判明しました。

---

## 現状分析

### ✅ 既に整っている環境

1. **Playwright環境**
   - `@playwright/test` v1.56.1インストール済み
   - `playwright.config.ts` 充実した設定
   - E2Eテストスクリプト定義済み：
     - `npm run test:e2e`
     - `npm run test:e2e:ui`
     - `npm run test:e2e:headed`
     - `npm run test:e2e:debug`
     - `npm run test:e2e:report`

2. **既存E2Eテストファイル** (合計529行)
   - `e2e/app.spec.ts` (65行) - アプリケーション基本動作
   - `e2e/staff-management.spec.ts` (103行) - スタッフ管理機能
   - `e2e/shift-creation.spec.ts` (100行) - シフト作成機能
   - `e2e/leave-request.spec.ts` (102行) - 休暇希望入力機能
   - `e2e/ai-shift-generation.spec.ts` (159行) - AIシフト生成

### ⚠️ 課題

1. **CI/CDでE2Eテストが無効化されている**
   ```yaml
   # .github/workflows/ci.yml (line 63-84)
   # E2Eテストは一時的に無効化（UIが頻繁に変更されるため）
   # - name: Playwrightブラウザをインストール
   #   run: npx playwright install --with-deps chromium

   # - name: E2Eテスト実行
   #   run: npm test
   ```
   **理由**: UIが頻繁に変更されるため

2. **Phase 14要件のテストが未実装**
   - Phase 14.1: 認証フローの統合テスト ❌
   - Phase 14.2: データCRUD操作の統合テスト ⚠️ (部分的)
   - Phase 14.3: RBAC権限チェックの統合テスト ❌
   - Phase 14.4: バージョン管理機能のE2Eテスト ❌
   - Phase 14.5: データ復元とリロード対応のE2Eテスト ❌

---

## Phase 14要件とのギャップ分析

### Phase 14.1: 認証フローの統合テスト ❌ **未実装**

**要件**:
- Google OAuthログインフローのテスト
- 初回ユーザー登録とsuper-admin付与のテスト
- 2人目以降のユーザー登録とアクセス権限なし画面のテスト
- ログアウトと再ログインのテスト

**現状**: 該当テストなし

**実装が必要**:
- `e2e/auth-flow.spec.ts` (新規作成)

### Phase 14.2: データCRUD操作の統合テスト ⚠️ **部分的実装**

**要件**:
- スタッフ情報のCRUD操作テスト
- シフトデータのCRUD操作テスト
- 休暇申請のCRUD操作テスト
- 要件設定の保存・読込テスト

**現状**:
- ✅ スタッフ管理: `e2e/staff-management.spec.ts` (103行)
- ✅ シフト作成: `e2e/shift-creation.spec.ts` (100行)
- ✅ 休暇申請: `e2e/leave-request.spec.ts` (102行)
- ❌ 要件設定: テストなし

**実装が必要**:
- 要件設定のCRUDテスト追加
- 既存テストのメンテナンスと更新

### Phase 14.3: RBAC権限チェックの統合テスト ❌ **未実装**

**要件**:
- super-adminの全権限テスト
- admin権限の施設管理とメンバー招待テスト
- editor権限のシフト作成・編集テスト
- viewer権限の閲覧のみテスト
- 権限なし操作の拒否テスト

**現状**: 該当テストなし

**実装が必要**:
- `e2e/rbac-permissions.spec.ts` (新規作成)

### Phase 14.4: バージョン管理機能のE2Eテスト ❌ **未実装**

**要件**:
- 下書き保存と確定のE2Eテスト
- バージョン履歴の作成と表示のテスト
- 過去バージョンへの復元のテスト
- バージョン履歴の不変性テスト

**現状**: 該当テストなし

**実装が必要**:
- `e2e/version-management.spec.ts` (新規作成)

### Phase 14.5: データ復元とリロード対応のE2Eテスト ❌ **未実装**

**要件**:
- ページリロード後の認証状態復元テスト
- 施設とデータの自動復元テスト
- ローディング状態とエラーハンドリングのテスト

**現状**: 該当テストなし

**実装が必要**:
- `e2e/data-restoration.spec.ts` (新規作成)

---

## 実装優先度

### 優先度1（高）: 認証とRBAC ✅ 推奨

**理由**: セキュリティの根幹、全機能の前提条件

**実装内容**:
1. **Phase 14.1**: 認証フローテスト
   - ファイル: `e2e/auth-flow.spec.ts`
   - テストケース: 5-8ケース
   - 推定工数: 2-3時間

2. **Phase 14.3**: RBAC権限チェックテスト
   - ファイル: `e2e/rbac-permissions.spec.ts`
   - テストケース: 10-15ケース
   - 推定工数: 3-4時間

### 優先度2（中）: データ復元とバージョン管理

**実装内容**:
3. **Phase 14.5**: データ復元テスト
   - ファイル: `e2e/data-restoration.spec.ts`
   - テストケース: 5-7ケース
   - 推定工数: 2-3時間

4. **Phase 14.4**: バージョン管理テスト
   - ファイル: `e2e/version-management.spec.ts`
   - テストケース: 5-8ケース
   - 推定工数: 2-3時間

### 優先度3（低）: 既存テストのメンテナンス

**実装内容**:
5. **Phase 14.2完了**: 既存テストの更新
   - 要件設定テスト追加
   - 既存テストのリファクタリング
   - 推定工数: 2-3時間

6. **CI/CD再有効化**: E2Eテストの安定化後
   - `.github/workflows/ci.yml` 更新
   - E2Eテストステップのコメント解除
   - 推定工数: 1時間

---

## 推奨実装計画

### Step 1: 既存E2Eテストの動作確認（1時間）

```bash
# ローカルで既存E2Eテストを実行
npm run test:e2e
```

**目的**: 現在のテストの状態を把握

### Step 2: 認証フローテスト実装（2-3時間）

**ファイル**: `e2e/auth-flow.spec.ts`

**テストケース**:
1. 未認証状態でログインページにリダイレクト
2. Googleログインボタンが表示される
3. ログイン成功後、ダッシュボードに遷移
4. ログアウト後、ログインページに戻る
5. 初回ユーザーに`super-admin`権限が付与される

### Step 3: RBACテスト実装（3-4時間）

**ファイル**: `e2e/rbac-permissions.spec.ts`

**テストケース**:
1. super-admin: 全画面アクセス可能
2. admin: 施設管理とメンバー招待が可能
3. editor: シフト作成・編集が可能
4. viewer: 閲覧のみで編集不可
5. 権限なしユーザー: Forbidden画面表示

### Step 4: データ復元テスト実装（2-3時間）

**ファイル**: `e2e/data-restoration.spec.ts`

**テストケース**:
1. ページリロード後もログイン状態維持
2. 選択中の施設データが復元される
3. シフトデータが正しく表示される

### Step 5: バージョン管理テスト実装（2-3時間）

**ファイル**: `e2e/version-management.spec.ts`

**テストケース**:
1. 下書き保存が正常に動作
2. シフト確定でバージョン履歴が作成される
3. 過去バージョンへの復元が可能

### Step 6: CI/CD再有効化（1時間）

**ファイル**: `.github/workflows/ci.yml`

**変更内容**:
- E2Eテストステップのコメント解除
- Playwrightブラウザインストール有効化

---

## 推定総工数

| Phase | 内容 | 工数 |
|-------|------|------|
| 準備 | 既存テスト動作確認 | 1時間 |
| 14.1 | 認証フローテスト | 2-3時間 |
| 14.3 | RBACテスト | 3-4時間 |
| 14.5 | データ復元テスト | 2-3時間 |
| 14.4 | バージョン管理テスト | 2-3時間 |
| 14.2 | 既存テスト更新 | 2-3時間 |
| CI/CD | E2E再有効化 | 1時間 |
| **合計** | | **13-18時間** |

---

## 次のステップ

### 推奨アクション

1. **既存E2Eテストの動作確認** - まず現状を把握
2. **Phase 14.1実装開始** - 認証フローテスト（最優先）
3. **段階的にテスト追加** - Phase 14.3 → 14.5 → 14.4 → 14.2
4. **CI/CD再有効化** - 全テスト安定化後

### 実装時の注意事項

1. **Firebase Authentication依存**:
   - E2Eテストは実際のFirebase Authenticationを使用
   - テスト用アカウントの準備が必要

2. **テストデータ管理**:
   - 各テストで独立したテストデータを使用
   - テスト終了後のクリーンアップが重要

3. **CI/CD環境**:
   - CI環境では本番環境に対してテスト実行
   - 破壊的操作は避ける

4. **安定性の確保**:
   - UIの変更に強いセレクター使用（data-testid推奨）
   - 適切な待機処理（waitForなど）

---

## 関連ドキュメント

- [tasks.md](./../tasks.md) - Phase 14タスク詳細
- [playwright.config.ts](./../../playwright.config.ts) - Playwright設定
- [package.json](./../../package.json) - E2Eテストスクリプト
- [.github/workflows/ci.yml](./../../.github/workflows/ci.yml) - CI/CD設定

---

**ステータス**: Phase 14 - ⚠️ **部分的実装**
**実装率**: 約20%（既存E2Eテストのみ、Phase 14要件は未実装）
**次フェーズ**: Phase 14.1（認証フローテスト）実装開始を推奨
