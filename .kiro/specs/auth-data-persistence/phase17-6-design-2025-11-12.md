# Phase 17.6: COOP警告の解消 - 技術設計

**更新日**: 2025-11-12
**仕様ID**: auth-data-persistence
**Phase**: 17.6
**種別**: 警告解消（軽微）

---

## 目次

1. [修正概要](#修正概要)
2. [firebase.json設計](#firebasejson設計)
3. [セキュリティ考慮事項](#セキュリティ考慮事項)
4. [デプロイ戦略](#デプロイ戦略)
5. [テスト戦略](#テスト戦略)
6. [ロールバック計画](#ロールバック計画)

---

## 修正概要

### 問題

Google OAuth認証のポップアップウィンドウを開く際に、COOP警告が繰り返し表示される。

### 解決策

`firebase.json`の`hosting.headers`にCOOPヘッダーを追加し、`same-origin-allow-popups`に設定する。

### 影響

- COOP警告が消える
- Firebase Authenticationの動作に影響なし
- 既存のCache-Control設定は維持

---

## firebase.json設計

### 現状

```json
{
  "hosting": {
    "public": "dist",
    "ignore": [...],
    "rewrites": [...],
    "headers": [
      {
        "source": "/index.html",
        "headers": [
          {
            "key": "Cache-Control",
            "value": "no-cache, no-store, must-revalidate"
          }
        ]
      },
      {
        "source": "**/*.@(js|css|png|jpg|jpeg|gif|svg|woff|woff2|ttf|eot)",
        "headers": [
          {
            "key": "Cache-Control",
            "value": "public, max-age=31536000, immutable"
          }
        ]
      }
    ]
  }
}
```

**問題**:
- COOPヘッダーが設定されていない
- デフォルト（`unsafe-none`）が適用される

---

### 修正後

```json
{
  "hosting": {
    "public": "dist",
    "ignore": [...],
    "rewrites": [...],
    "headers": [
      {
        "source": "**",
        "headers": [
          {
            "key": "Cross-Origin-Opener-Policy",
            "value": "same-origin-allow-popups"
          }
        ]
      },
      {
        "source": "/index.html",
        "headers": [
          {
            "key": "Cache-Control",
            "value": "no-cache, no-store, must-revalidate"
          }
        ]
      },
      {
        "source": "**/*.@(js|css|png|jpg|jpeg|gif|svg|woff|woff2|ttf|eot)",
        "headers": [
          {
            "key": "Cache-Control",
            "value": "public, max-age=31536000, immutable"
          }
        ]
      }
    ]
  }
}
```

**変更点**:
- ✅ すべてのファイル（`**`）にCOOPヘッダーを追加
- ✅ 値: `same-origin-allow-popups`
- ✅ 既存のCache-Control設定は維持

---

### ヘッダー設計の詳細

#### COOP（Cross-Origin-Opener-Policy）

**設定値**: `same-origin-allow-popups`

**意味**:
- **同一オリジンのウィンドウ**: 相互にアクセス可能
- **ポップアップウィンドウ**: 異なるオリジンでも開設可能
- **セキュリティ**: Spectre攻撃からの保護を維持

**Firebase Authenticationとの互換性**:
- ✅ `signInWithPopup()`が正常動作
- ✅ Googleの認証ページ（`accounts.google.com`）をポップアップで開ける
- ✅ 認証完了後のコールバックが正常動作

#### Cache-Control（既存設定維持）

**index.html**:
```
Cache-Control: no-cache, no-store, must-revalidate
```
- 常に最新版を取得
- デプロイ後すぐに反映

**静的ファイル（JS, CSS, 画像）**:
```
Cache-Control: public, max-age=31536000, immutable
```
- 1年間キャッシュ
- ファイル名にハッシュが含まれるため、変更時は新しいファイル名になる

---

## セキュリティ考慮事項

### COOP設定の選択肢

| 設定値 | 同一オリジン | ポップアップ | セキュリティ | Firebase Auth |
|--------|--------------|--------------|--------------|---------------|
| `unsafe-none` | ✅ | ✅ | ❌ 低 | ✅ 動作 |
| `same-origin-allow-popups` | ✅ | ✅ | ✅ 中 | ✅ 動作 |
| `same-origin` | ✅ | ❌ | ✅ 高 | ❌ 動作不可 |

**選択理由**: `same-origin-allow-popups`
- Firebase Authenticationのポップアップ認証が必要
- セキュリティも維持（Spectre攻撃からの保護）
- ベストプラクティスに準拠

### 影響分析

#### ✅ 正の影響

1. **セキュリティ向上**:
   - Spectre攻撃からの保護
   - クロスオリジン情報漏洩の防止

2. **UX向上**:
   - ブラウザコンソールがクリーンになる
   - 開発者体験の向上

3. **ベストプラクティス準拠**:
   - Googleのセキュリティガイドラインに準拠
   - Firebaseの推奨設定

#### ⚠️ 負の影響

- **なし**: Firebase Authenticationの動作に影響なし

---

## デプロイ戦略

### フェーズ1: firebase.json修正

**手順**:

```bash
# 1. firebase.json を修正
# COOPヘッダーを追加

# 2. コミット
git add firebase.json
git commit -m "fix: add COOP header to resolve auth popup warning

- Add Cross-Origin-Opener-Policy: same-origin-allow-popups
- Resolves COOP warning during Google OAuth popup
- Maintains existing Cache-Control settings

🤖 Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>"

# 3. CodeRabbitレビュー
coderabbit review --plain --base-commit HEAD~1 --config CLAUDE.md

# 4. Push
git push origin main

# 5. GitHub Actions自動デプロイ
# GitHub Actions が firebase deploy --only hosting を実行
```

### フェーズ2: 本番環境での確認

**確認項目**:

1. **ログイン時の警告確認**:
   - ログアウト
   - ブラウザコンソールを開く
   - 「Googleでログイン」をクリック
   - COOP警告が表示されないことを確認

2. **既存機能の確認**:
   - すべての機能が正常動作することを確認

---

## テスト戦略

### 1. Manual Tests

#### テストシナリオ1: ログイン時の警告確認

**前提条件**:
- 本番環境でログアウト済み

**手順**:
1. ブラウザコンソールを開く（F12）
2. コンソールをクリア
3. 「Googleでログイン」をクリック
4. Google認証ポップアップで認証
5. コンソールを確認

**期待結果**:
- ✅ COOP警告が表示されない
- ✅ 「Cross-Origin-Opener-Policy policy would block the window.closed call.」が表示されない
- ✅ 認証が正常に完了する

---

#### テストシナリオ2: キャッシュ動作の確認

**手順**:
1. ページをリロード（通常リロード）
2. index.htmlが更新される（no-cache設定）
3. JS/CSSファイルはキャッシュから取得される

**期待結果**:
- ✅ Cache-Control設定が正常動作
- ✅ 既存のキャッシュ動作に変更なし

---

### 2. Browser Compatibility Tests

**対象ブラウザ**:
- Chrome（最新版）
- Firefox（最新版）
- Safari（最新版）
- Edge（最新版）

**確認項目**:
- ✅ COOP警告が表示されない（全ブラウザ）
- ✅ 認証が正常動作（全ブラウザ）

---

## ロールバック計画

### シナリオ: COOP設定で認証が動作しなくなる

**症状**: ポップアップ認証が失敗する

**ロールバック手順**:

```bash
# 1. 前のコミットにリバート
git revert HEAD

# 2. Push
git push origin main

# 3. GitHub Actions自動デプロイ
# 自動的に以前のfirebase.jsonがデプロイされる
```

**または、firebase.jsonを手動修正**:

1. COOPヘッダーを削除
2. コミット & Push
3. GitHub Actions自動デプロイ

---

## 承認

この技術設計は以下の点を考慮して作成されました：

- ✅ COOP警告の根本原因を解決
- ✅ Firebase Authenticationの動作を維持
- ✅ セキュリティベストプラクティスに準拠
- ✅ 既存のCache-Control設定を維持
- ✅ テスト戦略を明確化
- ✅ ロールバック計画を策定

---

## 次のステップ

1. ✅ この技術設計ドキュメントを承認
2. 🛠️ firebase.jsonを修正
3. 🚀 デプロイ（GitHub Actions CI/CD）
4. ✅ 本番環境で確認
5. 📝 Phase 17.6検証ドキュメント作成

---

## 関連ドキュメント

- `phase17-6-bug-analysis-2025-11-12.md` - バグ分析
- `firebase.json` - Firebase Hosting設定
- `src/contexts/AuthContext.tsx` - 認証コンテキスト
- Firebase公式ドキュメント: [Hosting Headers](https://firebase.google.com/docs/hosting/full-config#headers)
