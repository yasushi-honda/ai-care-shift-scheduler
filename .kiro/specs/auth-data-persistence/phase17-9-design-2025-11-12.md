# Phase 17.9: Admin User Detail Permission Error修正 - 技術設計

**更新日**: 2025-11-12
**仕様ID**: auth-data-persistence
**Phase**: 17.9
**種別**: バグ修正（重大）

---

## 目次

1. [修正概要](#修正概要)
2. [実装設計](#実装設計)
3. [セキュリティ影響分析](#セキュリティ影響分析)
4. [テスト戦略](#テスト戦略)
5. [デプロイ戦略](#デプロイ戦略)
6. [ロールバック計画](#ロールバック計画)

---

## 修正概要

### 目的

Firestore Security Rulesの`users`コレクションの`allow get`ルールを修正し、super-adminが全ユーザーの個別詳細情報を取得できるようにします。

### 根本原因

現在の`allow get`ルールでは、自分のドキュメントのみ読み取り可能になっており、super-adminでも別のユーザーの個別詳細を取得できません。

### 解決策

**修正内容**: `allow get`ルールにsuper-admin権限チェックを追加

```javascript
// 修正前（現在）:
allow get: if isAuthenticated() && request.auth.uid == userId;

// 修正後（正しい）:
allow get: if isAuthenticated() && (request.auth.uid == userId || isSuperAdmin());
```

---

## 実装設計

### 修正対象ファイル

**ファイル**: `firestore.rules`

**修正箇所**: users collection (Line 78-82)

### コード設計

#### 現在のコード（Line 78-82）

```javascript
// users collection
match /users/{userId} {
  // super-adminは全ユーザーをリスト可能（getAllUsers用）
  allow list: if isAuthenticated() && isSuperAdmin();
  // 自分のドキュメントのみ個別読み取り可能
  allow get: if isAuthenticated() && request.auth.uid == userId;
```

**問題点**:
- `allow list`: super-adminは全ユーザーリスト可能 ✅
- `allow get`: 自分のドキュメントのみ ❌ **矛盾している**

---

#### 修正後のコード

```javascript
// users collection
match /users/{userId} {
  // super-adminは全ユーザーをリスト可能（getAllUsers用）
  allow list: if isAuthenticated() && isSuperAdmin();
  // 自分のドキュメント または super-adminは個別読み取り可能
  allow get: if isAuthenticated() && (request.auth.uid == userId || isSuperAdmin());

  // 初回作成: 認証済みユーザーが自分のドキュメントのみ作成可能（facilitiesは空配列のみ許可）
  allow create: if isAuthenticated()
    && request.auth.uid == userId
    && request.resource.data.userId == userId
    && request.resource.data.email == request.auth.token.email
    && request.resource.data.provider == 'google'
    && request.resource.data.facilities is list
    && request.resource.data.facilities.size() == 0; // facilitiesは空配列のみ（Cloud Functionが後で設定）

  // 更新: lastLoginAtのみ更新可能（facilitiesの変更は禁止）、またはCloud Functionからの更新
  allow update: if isAuthenticated()
    && request.auth.uid == userId
    && (
      // ケース1: ユーザー自身がlastLoginAtのみ更新
      request.resource.data.diff(resource.data).affectedKeys().hasOnly(['lastLoginAt'])
      // ケース2: facilitiesフィールドのみ変更（Cloud Functionによる権限付与）
      || request.resource.data.diff(resource.data).affectedKeys().hasOnly(['facilities'])
    );
}
```

### 変更内容

**修正行数**: 1行

**修正箇所**: Line 81

**Before**:
```javascript
allow get: if isAuthenticated() && request.auth.uid == userId;
```

**After**:
```javascript
allow get: if isAuthenticated() && (request.auth.uid == userId || isSuperAdmin());
```

**変更理由**:
1. super-adminが全ユーザーの個別詳細を取得可能にする
2. `allow list`との一貫性を確保
3. 管理画面のユーザー詳細ページを機能させる

---

## 詳細設計

### 権限評価ロジック

#### パターン1: 自分のドキュメント取得

**ユーザー**: 一般ユーザー（viewer, editor, admin）
**アクション**: 自分のユーザー情報を取得

```javascript
request.auth.uid == userId  // true
→ allow get: true ✅
```

**例**:
- ユーザーID: `abc123`
- 取得対象: `/users/abc123`
- 評価: `request.auth.uid == 'abc123'` → **true** → 許可

---

#### パターン2: super-adminが別のユーザーを取得

**ユーザー**: super-admin
**アクション**: 別のユーザーの情報を取得

```javascript
request.auth.uid == userId  // false
isSuperAdmin()              // true
→ allow get: true ✅
```

**例**:
- ユーザーID: `super-admin-001`
- 取得対象: `/users/user-002`
- 評価:
  - `request.auth.uid == 'user-002'` → **false**
  - `isSuperAdmin()` → **true**
  - `false || true` → **true** → 許可

---

#### パターン3: 一般ユーザーが別のユーザーを取得（拒否）

**ユーザー**: 一般ユーザー（viewer, editor, admin）
**アクション**: 別のユーザーの情報を取得

```javascript
request.auth.uid == userId  // false
isSuperAdmin()              // false
→ allow get: false ❌
```

**例**:
- ユーザーID: `user-001`
- 取得対象: `/users/user-002`
- 評価:
  - `request.auth.uid == 'user-002'` → **false**
  - `isSuperAdmin()` → **false**
  - `false || false` → **false** → 拒否

---

### isSuperAdmin()関数の動作

**定義箇所**: `firestore.rules` (Line 52-67)

```javascript
function isSuperAdmin() {
  let userProfile = getUserProfile();
  let facilities = userProfile.facilities;

  // 最大10施設までサポート
  return (facilities.size() > 0 && facilities[0].role == 'super-admin') ||
         (facilities.size() > 1 && facilities[1].role == 'super-admin') ||
         (facilities.size() > 2 && facilities[2].role == 'super-admin') ||
         (facilities.size() > 3 && facilities[3].role == 'super-admin') ||
         (facilities.size() > 4 && facilities[4].role == 'super-admin') ||
         (facilities.size() > 5 && facilities[5].role == 'super-admin') ||
         (facilities.size() > 6 && facilities[6].role == 'super-admin') ||
         (facilities.size() > 7 && facilities[7].role == 'super-admin') ||
         (facilities.size() > 8 && facilities[8].role == 'super-admin') ||
         (facilities.size() > 9 && facilities[9].role == 'super-admin');
}
```

**動作**:
1. 認証済みユーザーのプロファイルを取得
2. `facilities`配列の最大10要素をチェック
3. いずれかに`role == 'super-admin'`があれば`true`

---

## セキュリティ影響分析

### 修正による影響

#### 正の影響

1. **管理機能の実現** ✅
   - super-adminがユーザー詳細ページにアクセス可能
   - アクセス権限付与・剥奪が機能する

2. **一貫性の確保** ✅
   - `allow list`と`allow get`で一貫した権限設計
   - super-adminの全権限を正しく実装

3. **セキュリティの維持** ✅
   - 一般ユーザーは自分の情報のみアクセス可能（既存の動作を維持）
   - super-admin権限チェックにより保護

#### 負の影響

**なし**

この修正により、セキュリティが緩くなることはありません。むしろ、設計上の矛盾を解消し、意図通りの権限制御を実現します。

---

### セキュリティチェックリスト

- ✅ 一般ユーザーは自分の情報のみアクセス可能
- ✅ super-adminは全ユーザーの情報にアクセス可能
- ✅ 未認証ユーザーはアクセス不可
- ✅ `isSuperAdmin()`関数による権限チェック
- ✅ 既存のcreate, update, deleteルールに影響なし

---

## テスト戦略

### 手動テスト

#### テストシナリオ1: super-adminが別のユーザー詳細を表示

**前提条件**:
- super-admin権限を持つユーザーでログイン
- 本番環境（https://ai-care-shift-scheduler.web.app/）

**手順**:
1. 管理画面にアクセス（`/admin/users`）
2. ユーザー一覧を表示
3. 任意のユーザーの「詳細」リンクをクリック
4. ユーザー詳細ページ（`/admin/users/{userId}`）を表示
5. ブラウザコンソールを確認

**期待される結果**:
- ✅ Permission errorが表示されない
- ✅ ユーザー詳細情報が正常に表示される
- ✅ 所属施設とロール一覧が表示される
- ✅ アクセス権限付与フォームが表示される

---

#### テストシナリオ2: 一般ユーザーが自分の情報を取得

**前提条件**:
- 一般ユーザー（viewer, editor, admin）でログイン

**手順**:
1. アプリケーションにログイン
2. AuthContextで自分のユーザー情報が取得される
3. ブラウザコンソールを確認

**期待される結果**:
- ✅ Permission errorが表示されない
- ✅ 自分のユーザー情報が正常に取得される
- ✅ 施設選択が正常に動作する

---

#### テストシナリオ3: 一般ユーザーが別のユーザーを取得（拒否）

**前提条件**:
- 一般ユーザー（viewer, editor, admin）でログイン
- 開発環境またはテスト環境

**手順**:
1. ブラウザコンソールで以下を実行:
```javascript
const db = firebase.firestore();
const userDoc = await db.collection('users').doc('other-user-id').get();
```

**期待される結果**:
- ❌ Permission deniedエラーが発生する
- ✅ 別のユーザーの情報は取得できない

---

## デプロイ戦略

### フェーズ1: firestore.rules修正

**手順**:

```bash
# 1. firestore.rulesを修正
# allow getルールにsuper-admin権限チェックを追加

# 2. コミット
git add firestore.rules .kiro/specs/auth-data-persistence/phase17-9-*.md
git commit -m "fix: Phase 17.9 Admin User Detail Permission Error修正

- allow getルールにsuper-admin権限チェックを追加
- super-adminが全ユーザーの個別詳細を取得可能に
- allow listとallow getの一貫性を確保

🤖 Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>"

# 3. CodeRabbitレビュー
coderabbit review --plain --base-commit HEAD~1 --config CLAUDE.md

# 4. Push
git push origin main

# 5. GitHub Actions自動デプロイ
# GitHub Actions が firebase deploy --only firestore:rules を実行
```

---

### フェーズ2: 本番環境での確認

**確認項目**:

1. **super-adminがユーザー詳細を表示できることを確認**:
   - `/admin/users/{userId}` にアクセス
   - Permission errorが発生しないことを確認
   - ユーザー詳細情報が表示されることを確認

2. **一般ユーザーが自分の情報を取得できることを確認**:
   - 一般ユーザーでログイン
   - Permission errorが発生しないことを確認
   - アプリケーションが正常に動作することを確認

---

## ロールバック計画

### シナリオ: 修正で新たな問題が発生

**症状**: 一般ユーザーが自分の情報を取得できない、または別のセキュリティ問題が発生

**ロールバック手順**:

```bash
# 1. 前のコミットにリバート
git revert HEAD

# 2. Push
git push origin main

# 3. GitHub Actions自動デプロイ
# 自動的に以前のRulesがデプロイされる
```

**または、Firebase Consoleで手動ロールバック**:

1. Firebase Console → Firestore Database → Rules タブ
2. 「履歴」から前のバージョンを選択
3. 「公開」をクリック

---

## 影響分析

### 正の影響

1. **管理機能の完全動作** ✅
   - ユーザー詳細ページが正常に動作
   - アクセス権限付与・剥奪が可能

2. **設計の一貫性** ✅
   - `allow list`と`allow get`で一貫した権限設計
   - super-adminの全権限を正しく実装

3. **ユーザー体験の向上** ✅
   - Permission errorが解消
   - 管理画面がスムーズに動作

### 負の影響

**なし**

この修正により、セキュリティが緩くなることはありません。

---

## 承認

この技術設計は以下の点を考慮して作成されました：

- ✅ Permission errorの根本原因を解決
- ✅ シンプルで実装が容易（1行修正）
- ✅ 既存コードへの影響が最小限
- ✅ セキュリティを維持
- ✅ テスト戦略を明確化
- ✅ ロールバック計画を策定

---

## 次のステップ

1. ✅ この技術設計ドキュメントを承認
2. 🛠️ `firestore.rules`を修正
3. 🚀 デプロイ（GitHub Actions CI/CD）
4. ✅ 本番環境で確認
5. 📝 Phase 17.9検証ドキュメント作成

---

## 関連ドキュメント

- `phase17-9-bug-analysis-2025-11-12.md` - バグ分析
- `firestore.rules` - Firestore Security Rules
- `src/services/userService.ts` - getUserById関数
- `src/pages/admin/UserDetail.tsx` - ユーザー詳細ページ

---

**レポート作成日**: 2025-11-12
**作成者**: AI（Claude Code）
**推定工数**: 10分
