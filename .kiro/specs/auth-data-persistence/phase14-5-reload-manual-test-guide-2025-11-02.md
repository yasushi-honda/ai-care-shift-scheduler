# Phase 14.5: データ復元とリロード対応 - 手動テストガイド

**作成日**: 2025-11-02
**Phase**: Phase 14.5 - データ復元とリロード対応のE2Eテスト
**対象者**: 開発者、QAエンジニア

---

## 📋 概要

このガイドは、Phase 14.5「データ復元とリロード対応のE2Eテスト」の手動検証手順を提供します。ページリロード後の認証状態復元、施設とデータの自動復元、ローディング状態の表示、エラーハンドリングを検証します。

**前提条件**:
- 本番環境（https://ai-care-shift-scheduler.web.app/）にアクセス可能
- Googleアカウントでログイン済み
- 少なくとも1つの施設に所属している
- ブラウザ開発者ツール（DevTools）の基本的な使用方法を理解している

**所要時間**: 約30-40分

---

## セクション1: ページリロード後の認証状態復元

### 1.1 ログイン後のページリロード

**目的**: ページリロード後も認証状態が維持されることを確認

**手順**:

1. **ログイン**:
   - 本番環境にアクセス: https://ai-care-shift-scheduler.web.app/
   - Googleアカウントでログイン
   - ダッシュボードが表示されることを確認

2. **ページリロード**:
   - ブラウザの再読み込みボタンをクリック（または`Cmd+R` / `Ctrl+R`）
   - ページが再読み込みされる

3. **認証状態の確認**:
   - ✅ **期待される動作**:
     - ログイン画面に戻らず、ダッシュボードが表示される
     - ヘッダーにユーザー名とプロフィール画像が表示される
     - ログアウトボタンが表示される
   - ❌ **失敗ケース**:
     - ログイン画面にリダイレクトされる
     - 「ログインしてください」メッセージが表示される

4. **ローディング状態の確認**:
   - リロード直後、一瞬「読み込み中...」または類似のローディング表示が表示される
   - その後、ダッシュボードが表示される

**検証項目**:
- [ ] リロード後もログイン状態が維持される
- [ ] ユーザー名が表示される
- [ ] プロフィール画像が表示される
- [ ] ローディング中の表示が適切

### 1.2 複数回のリロード

**目的**: 繰り返しリロードしても認証状態が安定していることを確認

**手順**:

1. **5回連続リロード**:
   - ブラウザの再読み込みボタンを5回クリック
   - 各リロード後、ダッシュボードが表示されることを確認

2. **ハードリロード**:
   - `Cmd+Shift+R`（Mac）または`Ctrl+Shift+R`（Windows）でハードリロード
   - キャッシュをクリアしてページを再読み込み

3. **認証状態の確認**:
   - ✅ **期待される動作**:
     - すべてのリロードでログイン状態が維持される
     - ハードリロード後もログイン状態が維持される

**検証項目**:
- [ ] 5回連続リロードでログイン状態が維持される
- [ ] ハードリロード後もログイン状態が維持される

---

## セクション2: 施設とデータの自動復元

### 2.1 施設選択後のページリロード

**目的**: ページリロード後、選択していた施設が自動的に復元されることを確認

**手順**:

1. **施設を選択**:
   - ヘッダーまたはサイドバーの施設選択ドロップダウンから特定の施設を選択
   - 選択した施設名をメモする（例: 「テスト介護施設」）

2. **ページリロード**:
   - ブラウザの再読み込みボタンをクリック

3. **施設の復元確認**:
   - ✅ **期待される動作**:
     - リロード後、同じ施設が選択されている
     - 施設選択ドロップダウンに同じ施設名が表示される
   - ❌ **失敗ケース**:
     - 施設が選択されていない（「施設を選択してください」など）
     - 異なる施設が選択されている

4. **ローカルストレージの確認**:
   - ブラウザ開発者ツール（DevTools）を開く: `F12`
   - **Application**タブ → **Local Storage** → ドメインを選択
   - `selectedFacilityId`キーが存在し、値が設定されていることを確認

**検証項目**:
- [ ] リロード後、選択した施設が復元される
- [ ] `localStorage.selectedFacilityId`が正しく保存されている

### 2.2 スタッフデータの自動復元

**目的**: ページリロード後、スタッフデータが自動的に復元されることを確認

**手順**:

1. **スタッフリストの確認**:
   - リロード前にスタッフリストに表示されているスタッフ数をメモする（例: 5名）

2. **ページリロード**:
   - ブラウザの再読み込みボタンをクリック

3. **スタッフデータの復元確認**:
   - ✅ **期待される動作**:
     - リロード後、同じ数のスタッフが表示される
     - スタッフ名、役職などが正しく表示される
   - ❌ **失敗ケース**:
     - スタッフリストが空になる
     - スタッフ数が異なる

4. **Firestore読み取りの確認**（オプション）:
   - DevTools → **Network**タブ
   - `firestore.googleapis.com`へのリクエストを確認
   - スタッフデータの取得リクエストが成功していることを確認（Status 200）

**検証項目**:
- [ ] リロード後、スタッフデータが復元される
- [ ] スタッフ数が一致する
- [ ] Firestoreからデータが正しく取得される

### 2.3 シフトデータの自動復元

**目的**: ページリロード後、シフトデータが自動的に復元されることを確認

**手順**:

1. **シフトデータの確認**:
   - カレンダーに表示されているシフトをメモする
   - 特定の日付のシフト割り当てを記録する（例: 「2025年11月3日: 山田太郎 - 早番」）

2. **ページリロード**:
   - ブラウザの再読み込みボタンをクリック

3. **シフトデータの復元確認**:
   - ✅ **期待される動作**:
     - リロード後、カレンダーに同じシフトが表示される
     - 特定の日付のシフト割り当てが一致する
   - ❌ **失敗ケース**:
     - カレンダーが空になる
     - シフト割り当てが異なる

**検証項目**:
- [ ] リロード後、シフトデータが復元される
- [ ] カレンダー表示が一致する

### 2.4 休暇申請と要件設定の復元

**目的**: ページリロード後、休暇申請と要件設定が復元されることを確認

**手順**:

1. **休暇申請の確認**:
   - カレンダーに休暇マーカーが表示されている場合、その日付をメモする

2. **要件設定の確認**:
   - 要件設定フォームの値をメモする（例: 最小スタッフ数: 5名）

3. **ページリロード**:
   - ブラウザの再読み込みボタンをクリック

4. **復元確認**:
   - ✅ **期待される動作**:
     - 休暇マーカーが同じ日付に表示される
     - 要件設定フォームの値が一致する

**検証項目**:
- [ ] リロード後、休暇申請が復元される
- [ ] リロード後、要件設定が復元される

---

## セクション3: ローディング状態の表示

### 3.1 リロード直後のローディング表示

**目的**: ページリロード直後に適切なローディング表示がされることを確認

**手順**:

1. **DevToolsでネットワークスロットリング設定**:
   - DevTools → **Network**タブ
   - **Throttling**ドロップダウンから**Slow 3G**を選択
   - これにより、ローディング状態を観察しやすくする

2. **ページリロード**:
   - ブラウザの再読み込みボタンをクリック

3. **ローディング表示の確認**:
   - ✅ **期待される動作**:
     - リロード直後、「読み込み中...」またはローディングスピナーが表示される
     - 認証状態確認中の表示（例: 「認証状態を確認しています...」）
     - 施設データ取得中の表示（例: 「施設データを読み込み中...」）
     - ローディング完了後、ダッシュボードが表示される
   - ❌ **失敗ケース**:
     - ローディング表示がない（白い画面のまま）
     - ローディング表示が終わらない

4. **スロットリング解除**:
   - DevTools → **Network**タブ
   - **Throttling**ドロップダウンから**No throttling**を選択

**検証項目**:
- [ ] ローディング中の表示が適切
- [ ] 認証状態確認中の表示が見える
- [ ] 施設データ取得中の表示が見える
- [ ] ローディング完了後、ダッシュボードが表示される

### 3.2 データ取得中のローディング順序

**目的**: ローディング状態が階層的に管理されていることを確認

**手順**:

1. **DevToolsでネットワークスロットリング設定**:
   - **Slow 3G**を選択

2. **ページリロード**:
   - ブラウザの再読み込みボタンをクリック

3. **ローディング順序の確認**:
   - ✅ **期待される順序**:
     1. 認証状態の確認（最初）
     2. 施設データの取得（認証後）
     3. スタッフ・シフト・休暇・要件データの取得（施設選択後）
     4. ダッシュボード表示（すべて完了後）

4. **スロットリング解除**:
   - **No throttling**を選択

**検証項目**:
- [ ] ローディング順序が正しい
- [ ] 各段階でローディング表示が更新される

---

## セクション4: エラーハンドリング

### 4.1 ネットワークエラーのシミュレーション

**目的**: ネットワークエラー時に適切なエラーメッセージが表示されることを確認

**手順**:

1. **ブラウザをオフラインモードに設定**:
   - DevTools → **Network**タブ
   - **Throttling**ドロップダウンから**Offline**を選択

2. **ページリロード**:
   - ブラウザの再読み込みボタンをクリック

3. **エラー表示の確認**:
   - ✅ **期待される動作**:
     - ネットワークエラーメッセージが表示される
     - 「接続エラー」「ネットワークに接続できません」などのメッセージ
     - リトライボタンまたは再読み込みの案内
   - ❌ **失敗ケース**:
     - エラーメッセージが表示されない
     - ローディング表示が永遠に続く

4. **オンラインモードに戻す**:
   - **Throttling**ドロップダウンから**No throttling**を選択
   - ページを再読み込み
   - ✅ **期待される動作**:
     - エラーが解消され、ダッシュボードが表示される

**検証項目**:
- [ ] オフライン時にエラーメッセージが表示される
- [ ] エラーメッセージが分かりやすい
- [ ] オンラインに戻すとエラーが解消される

### 4.2 Firestore読み取りエラーのシミュレーション

**目的**: Firestore読み取りエラー時の挙動を確認

**手順**:

1. **Network ThrottlingでFirestoreリクエストをブロック**:
   - DevTools → **Network**タブ
   - **Request blocking**を有効化（設定アイコン → Enable request blocking）
   - `*firestore.googleapis.com*`をブロックリストに追加

2. **ページリロード**:
   - ブラウザの再読み込みボタンをクリック

3. **エラー表示の確認**:
   - ✅ **期待される動作**:
     - Firestoreデータ取得エラーメッセージが表示される
     - 「データの読み込みに失敗しました」などのメッセージ
     - リトライボタンまたは再読み込みの案内

4. **Request blockingを解除**:
   - ブロックリストから`*firestore.googleapis.com*`を削除
   - ページを再読み込み
   - ✅ **期待される動作**:
     - エラーが解消され、データが正常に表示される

**検証項目**:
- [ ] Firestoreエラー時にエラーメッセージが表示される
- [ ] エラーメッセージが分かりやすい
- [ ] ブロック解除後、エラーが解消される

### 4.3 施設が削除されている場合の挙動

**目的**: 選択していた施設が削除された場合の挙動を確認

**注意**: この検証は実際に施設を削除するため、テスト用施設で実施してください。

**手順**:

1. **テスト用施設を作成**:
   - 管理画面で新しい施設「テスト削除用施設」を作成

2. **施設を選択**:
   - 「テスト削除用施設」を選択
   - ページをリロードして施設が復元されることを確認

3. **別のブラウザタブで施設を削除**:
   - 新しいブラウザタブで管理画面を開く
   - 「テスト削除用施設」を削除

4. **元のタブでページリロード**:
   - 元のブラウザタブに戻る
   - ページを再読み込み

5. **エラー表示の確認**:
   - ✅ **期待される動作**:
     - 施設が見つからないエラーメッセージが表示される
     - 「選択した施設が見つかりません」などのメッセージ
     - 施設選択画面へリダイレクトされる

**検証項目**:
- [ ] 施設削除時にエラーメッセージが表示される
- [ ] 施設選択画面へリダイレクトされる

### 4.4 権限エラーのシミュレーション

**目的**: Firestore読み取り権限エラー時の挙動を確認

**注意**: この検証はFirestore Security Rulesを一時的に変更するため、慎重に実施してください。本番環境では実施しないでください。

**手順**:

1. **Firebase Consoleでセキュリティルールを一時変更**:
   - Firebase Console → Firestore Database → ルール
   - 以下のルールを一時的に追加（すべての読み取りを拒否）:
   ```
   match /facilities/{facilityId} {
     allow read: if false;
   }
   ```
   - 「公開」ボタンをクリック

2. **ページリロード**:
   - アプリケーションのページを再読み込み

3. **エラー表示の確認**:
   - ✅ **期待される動作**:
     - 権限エラーメッセージが表示される
     - 「アクセス権限がありません」などのメッセージ
     - 管理者への問い合わせ案内

4. **セキュリティルールを元に戻す**:
   - Firebase Console → Firestore Database → ルール
   - 一時的に追加したルールを削除
   - 「公開」ボタンをクリック

5. **ページリロード**:
   - アプリケーションのページを再読み込み
   - ✅ **期待される動作**:
     - エラーが解消され、データが正常に表示される

**検証項目**:
- [ ] 権限エラー時にエラーメッセージが表示される
- [ ] エラーメッセージが分かりやすい
- [ ] ルール復元後、エラーが解消される

---

## トラブルシューティング

### 問題1: リロード後にログイン画面に戻る

**症状**: ページリロード後、ログイン画面にリダイレクトされる

**原因**:
- Firebase Authentication Sessionが切れている
- ブラウザのCookieが無効化されている

**対処方法**:
1. ブラウザのCookie設定を確認（Cookieが有効になっているか）
2. シークレットモードでない通常のブラウザウィンドウで確認
3. 再度ログインして、リロードを試す

### 問題2: 施設が復元されない

**症状**: リロード後、施設が選択されていない

**原因**:
- `localStorage`が無効化されている
- `selectedFacilityId`が保存されていない

**対処方法**:
1. DevTools → Application → Local Storage → ドメインを確認
2. `selectedFacilityId`キーが存在するか確認
3. ブラウザの設定でLocal Storageが有効になっているか確認

### 問題3: ローディング表示が終わらない

**症状**: ローディング表示が永遠に続く

**原因**:
- Firestoreリクエストがタイムアウトしている
- ネットワークエラー

**対処方法**:
1. DevTools → Network タブでエラーを確認
2. ブラウザをハードリロード（`Cmd+Shift+R` / `Ctrl+Shift+R`）
3. ブラウザのキャッシュをクリア

### 問題4: データが復元されない

**症状**: リロード後、スタッフやシフトデータが表示されない

**原因**:
- Firestoreからのデータ取得に失敗している
- Firestore Security Rulesでブロックされている

**対処方法**:
1. DevTools → Network タブで`firestore.googleapis.com`へのリクエストを確認
2. エラーレスポンス（Status 403など）を確認
3. Firebase Console → Firestore Database → ルールを確認

---

## まとめ

以上の手順で、Phase 14.5「データ復元とリロード対応」の手動検証が完了します。

**確認項目のチェックリスト**:

**セクション1: 認証状態復元**
- [ ] リロード後もログイン状態が維持される
- [ ] ユーザー情報が表示される
- [ ] 複数回リロードでも安定している

**セクション2: 施設とデータの復元**
- [ ] 施設が復元される
- [ ] スタッフデータが復元される
- [ ] シフトデータが復元される
- [ ] 休暇申請と要件設定が復元される

**セクション3: ローディング状態**
- [ ] ローディング表示が適切
- [ ] ローディング順序が正しい

**セクション4: エラーハンドリング**
- [ ] ネットワークエラー時のメッセージが適切
- [ ] Firestoreエラー時のメッセージが適切
- [ ] 施設削除時のメッセージが適切
- [ ] 権限エラー時のメッセージが適切

すべての項目にチェックが入れば、Phase 14.5の手動検証は完了です。

---

**関連ドキュメント**:
- [phase14-5-reload-e2e-design-2025-11-02.md](./phase14-5-reload-e2e-design-2025-11-02.md) - Phase 14.5設計書
