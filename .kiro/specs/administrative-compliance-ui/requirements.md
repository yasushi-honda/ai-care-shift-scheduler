# Requirements Document

## Introduction

Phase 61: 運営指導モード・月別書類管理 (administrative-compliance-ui)

介護事業所が行政対応（運営指導・監査）を円滑に行えるよう、以下3つの機能を追加する。

1. **月別書類管理**: Excel出力時に書類メタデータをFirestoreに記録し、月別一覧・再ダウンロード・複数月一括DLを提供する
2. **運営指導モード**: 専用トグルで「当月・過去月の実績シフト」と「コンプライアンス状況」をワンクリックで表示する監査対応UI
3. **電子申請フロー案内**: Excel出力後のGビズIDポータルへの提出手順をUI内ステップ形式で案内する

**ビジネス価値**: 行政担当者が施設を訪問する運営指導当日に、スタッフ配置実績と法令遵守状況を即座に提示できるようにする。紙・Excelファイルの手探りを不要にし、指導対応時間を短縮する。

---

## Requirements

### Requirement 1: 月別書類アーカイブ（Excel出力時の自動記録）

**Objective:** 管理者として、Excel書類を出力するたびにFirestoreへメタデータを自動保存し、後から月単位で書類を検索・再ダウンロードしたい。これにより、運営指導時に過去の書類を即座に取り出せる。

#### Acceptance Criteria

1. WHEN 管理者が標準様式第1号または予実2段書きExcelをエクスポートする THEN 行政対応UIシステム（以下「本システム」）SHALL 対象月（YYYY-MM）・書類種別・生成日時・生成者IDをFirestoreの `facilities/{facilityId}/documentArchive/{yearMonth}` コレクションに記録する
2. WHEN Firestoreへの記録に失敗する THEN 本システム SHALL Excelダウンロード自体は継続し、エラートーストで記録失敗を通知する（ダウンロードをブロックしない）
3. WHEN 同一月・同一書類種別のレコードが既に存在する THEN 本システム SHALL 既存レコードを上書き更新する（重複を作らない）
4. IF 管理者が「書類アーカイブ」タブを開く THEN 本システム SHALL 施設の書類を年月降順（新しい月が上）で一覧表示する
5. WHEN 一覧に書類が表示されている THEN 本システム SHALL 各行に「対象月」「書類種別」「生成日時」「再ダウンロードボタン」を表示する
6. WHEN 管理者が再ダウンロードボタンを押す THEN 本システム SHALL 同じパラメータで当該月のExcelを再生成してダウンロードする

---

### Requirement 2: 複数月一括ダウンロード

**Objective:** 管理者として、複数月分の書類をまとめてZIPファイルでダウンロードしたい。運営指導では過去3〜12ヶ月分の書類提出を求められることが多く、個別DLの繰り返しを省きたい。

#### Acceptance Criteria

1. WHEN 書類アーカイブ一覧が表示されている THEN 本システム SHALL 各行にチェックボックスを表示し、複数選択を可能にする
2. WHEN 1件以上チェックされている THEN 本システム SHALL 「選択した月を一括ダウンロード」ボタンを有効化する
3. WHEN 管理者が一括ダウンロードを実行する THEN 本システム SHALL 選択された各月のExcelファイルを生成し、`{施設名}_{YYYY-MM}_documents.zip` という名称のZIPファイルとしてダウンロードさせる
4. WHILE ZIPファイルを生成中 THE 本システム SHALL プログレス表示（X/N件生成中）を行い、完了後にダウンロードを開始する
5. IF 選択月の中に当該月のシフトデータが存在しない月が含まれる THEN 本システム SHALL その月をスキップし、スキップ理由をダウンロード完了後のサマリーに表示する

---

### Requirement 3: 運営指導モード（専用ダッシュボード表示）

**Objective:** 管理者として、運営指導当日に「運営指導モード」ボタン一つで行政担当者に見せるための実績ビューに切り替えたい。通常の編集UIを非表示にして、実績確認に特化した視認性の高い画面にすることで、指導対応をスムーズにしたい。

#### Acceptance Criteria

1. WHEN 管理者がシフト管理画面のヘッダーにある「運営指導モード」トグルをオンにする THEN 本システム SHALL 通常のシフト編集UIを非表示にし、運営指導ダッシュボードを全画面で表示する
2. WHERE 運営指導ダッシュボードが表示されている THEN 本システム SHALL 以下のセクションをこの順番で表示する：①施設情報サマリー（施設名・対象月・常勤換算値）、②コンプライアンスチェック結果（Phase 25の結果を再表示）、③当月実績シフト一覧（スタッフ×日付グリッド）、④過去12ヶ月月別概要テーブル
3. WHEN 運営指導ダッシュボードの月別概要テーブルを表示する THEN 本システム SHALL 各月に対して「対象月」「常勤換算値」「人員配置充足状況（○/×）」「書類アーカイブ有無」を表示する
4. WHEN コンプライアンスチェック結果を表示する THEN 本システム SHALL Level1（労基法違反）を赤、Level2（人員不足）をオレンジ、問題なしを緑で色分けして表示する
5. WHEN 管理者が「運営指導モード」トグルをオフにする THEN 本システム SHALL 通常のシフト編集UIに戻す
6. IF 運営指導モード中に選択月を変更する THEN 本システム SHALL 選択月のデータをリアルタイムで再読み込みして表示を更新する

---

### Requirement 4: 常勤換算値・人員配置基準ダッシュボード

**Objective:** 管理者として、運営指導モード内で常勤換算値と人員配置基準の充足状況を一目で確認したい。数値が基準を満たしているか行政担当者とともに確認できる形式が必要。

#### Acceptance Criteria

1. WHEN 常勤換算ダッシュボードを表示する THEN 本システム SHALL 職種別（介護職員・看護職員・その他）の常勤換算値を数値で表示する
2. WHEN 常勤換算値が法定基準（事業所設定値）を満たす THEN 本システム SHALL 当該職種の行を緑でハイライトする
3. WHEN 常勤換算値が法定基準を下回る THEN 本システム SHALL 当該職種の行を赤でハイライトし、不足値（例: 「あと0.5必要」）を表示する
4. WHILE 運営指導モードが有効 THE 本システム SHALL 「印刷」ボタンを表示し、クリック時にブラウザの印刷ダイアログを開く（印刷用CSSで編集UIを除外）

---

### Requirement 5: 電子申請フロー案内

**Objective:** 管理者として、Excel書類を出力した後にGビズIDを使った電子申請の手順をアプリ内で確認したい。外部サイトを調べる手間を省き、行政への提出ミスを防ぎたい。

#### Acceptance Criteria

1. WHEN 管理者がExcelエクスポートを実行する THEN 本システム SHALL エクスポート完了後に「電子申請の手順を確認する」リンクをトースト通知内に表示する
2. WHEN 管理者が「電子申請の手順を確認する」リンクをクリックする THEN 本システム SHALL 電子申請フロー案内モーダルを開く
3. WHERE 電子申請フロー案内モーダルが表示されている THEN 本システム SHALL 以下の4ステップをステップ形式で表示する：
   - ステップ1: ダウンロードしたExcelファイルを確認する
   - ステップ2: GビズIDでログイン（介護サービス情報公表システム or 各都道府県電子申請システム）
   - ステップ3: 「変更届出」または「加算届出」フォームを選択してExcelをアップロード
   - ステップ4: 受付番号を控えて提出完了
4. IF 管理者が案内モーダルを閉じる THEN 本システム SHALL 次回Excelエクスポート時に再度「電子申請の手順を確認する」リンクを表示する（毎回表示、非表示設定は不要）
5. WHERE 電子申請フロー案内モーダル内 THE 本システム SHALL 「この案内を印刷する」ボタンを提供する

---

### Requirement 6: アクセス制御とデータ範囲

**Objective:** 管理者として、自施設のデータのみを閲覧・操作できるようにしたい。他施設のデータが見えないことを保証する。

#### Acceptance Criteria

1. WHEN 書類アーカイブや運営指導モードのデータを取得する THEN 本システム SHALL 認証済みユーザーが所属する施設IDをスコープとしてFirestoreクエリを発行する
2. IF 認証されていないユーザーが書類アーカイブにアクセスする THEN 本システム SHALL データ取得を拒否し、ログイン画面へリダイレクトする
3. WHEN 施設管理者ロール（admin）がアクセスする THEN 本システム SHALL 書類アーカイブの閲覧・一括DL・運営指導モードの全機能を利用可能にする
4. WHEN 一般スタッフロール（member）がアクセスする THEN 本システム SHALL 書類アーカイブおよび運営指導モードを表示しない
