# Implementation Plan: Phase 61 行政対応UI（administrative-compliance-ui）

**作成日**: 2026-02-19
**仕様**: `.kiro/specs/administrative-compliance-ui/`

---

- [ ] 1. 書類アーカイブのデータ基盤を構築する
- [ ] 1.1 書類アーカイブに必要な型定義を追加する
  - `DocumentArchiveMeta`（書類種別・生成日時・生成者ID・施設名）の型を定義する
  - `DocumentArchiveRecord`（年月ごとにstandard_form/actual_vs_planを持つ構造）の型を定義する
  - `BulkDownloadProgress`・`BulkDownloadResult`（一括DL進捗・スキップ情報）の型を定義する
  - `DocType`（'standard_form' | 'actual_vs_plan'）のユニオン型を定義する
  - 型定義は既存の `types.ts` に追記する
  - _Requirements: 1.1, 2.3_

- [ ] 1.2 Firestoreに書類メタデータを保存・取得する機能を実装する
  - 施設IDと年月をキーにして書類メタデータを Firestore に保存する（同月同種別は上書き更新）
  - 施設の全書類アーカイブを年月降順で取得する機能を実装する
  - 保存は `setDoc(merge: true)` でフィールドレベルの上書きとし、他種別のデータは保持する
  - 全操作に認証済み施設IDのスコープを適用する
  - _Requirements: 1.1, 1.3, 1.4, 6.1_

- [ ] 1.3 Firestoreセキュリティルールに書類アーカイブのアクセス制御を追加する
  - `facilities/{facilityId}/documentArchive/{yearMonth}` コレクションに管理者（admin）のみ読み書きを許可するルールを追加する
  - 認証されていないユーザーはアクセス拒否とする
  - 既存のロール判定関数を流用してルールを記述する
  - _Requirements: 6.1, 6.2, 6.3, 6.4_

- [ ] 2. Excelエクスポート後に書類アーカイブを自動記録する
- [ ] 2.1 既存のExcelエクスポートUIにアーカイブ記録処理を組み込む
  - 標準様式・予実2段書きのいずれのエクスポート完了後も書類メタデータをFirestoreに保存する
  - Firestore への記録失敗時はExcelダウンロード自体をブロックせず、警告トーストを表示する
  - エクスポート成功時は「ダウンロード完了。電子申請の手順を確認する」リンク付きトーストを表示する
  - エクスポートは既存の `ExportMenu.tsx` を拡張して実装する
  - _Requirements: 1.1, 1.2, 5.1_

- [ ] 3. 書類アーカイブ一覧UIと再ダウンロード機能を実装する
- [ ] 3.1 書類アーカイブ一覧パネルを作成する
  - 施設の書類アーカイブを年月降順で表示する一覧UIを作成する
  - 各行に「対象月」「書類種別」「生成日時」「再ダウンロードボタン」を表示する
  - 一覧は「書類アーカイブ」タブとして既存のタブ構造に追加する
  - 管理者ロール以外にはタブを表示しない
  - _Requirements: 1.4, 1.5, 6.3, 6.4_

- [ ] 3.2 書類の再ダウンロード機能を実装する
  - 一覧の各行の「再ダウンロード」ボタンを押すと、保存時と同じパラメータでExcelを再生成してダウンロードする
  - 再ダウンロード時に対象月のシフトデータが存在しない場合はエラートーストを表示する
  - 再ダウンロード中はボタンをローディング表示にする
  - _Requirements: 1.6_

- [ ] 4. 複数月一括ダウンロード機能を実装する
- [ ] 4.1 一覧にチェックボックスと一括ダウンロードボタンを追加する
  - 書類アーカイブ一覧の各行にチェックボックスを表示する
  - 1件以上チェックされた場合に「選択した月を一括ダウンロード」ボタンを有効化する
  - ボタンが無効な場合（0件選択時）はグレーアウト表示する
  - _Requirements: 2.1, 2.2_

- [ ] 4.2 選択した月のExcelをZIPファイルでまとめてダウンロードする機能を実装する
  - jszip ライブラリを依存関係に追加する（`npm install jszip`）
  - 選択された各月のExcelファイルを順次生成し、ZIPに追加する
  - ZIP生成中はプログレス表示（「X/N件生成中」）を行い、完了後にダウンロードを開始する
  - ZIPファイル名は「{施設名}_{最初の年月}_{最後の年月}_documents.zip」形式とする
  - 対象月のシフトデータが存在しない場合はその月をスキップし、完了後のサマリーにスキップ理由を表示する
  - _Requirements: 2.3, 2.4, 2.5_

- [ ] 5. 運営指導モードのトグルとダッシュボード基盤を実装する
- [ ] 5.1 シフト管理画面のヘッダーに運営指導モードトグルを追加する
  - ヘッダーに「運営指導モード」トグルボタンを追加する（管理者のみ表示）
  - トグルONで通常のシフト編集UIを非表示にし、運営指導ダッシュボードを全画面表示に切り替える
  - トグルOFFで通常のシフト編集UIに戻す
  - トグル状態は `App.tsx` のstateで管理する
  - _Requirements: 3.1, 3.5_

- [ ] 5.2 運営指導ダッシュボードの基本レイアウトと施設情報サマリーを実装する
  - 施設名・対象月・常勤換算値の合計を表示する施設情報サマリーセクションを作成する
  - ダッシュボードに「印刷」ボタンを表示し、クリック時にブラウザの印刷ダイアログを開く
  - 印刷用CSSで編集UIを除外し、ダッシュボードのみが印刷されるようにする
  - _Requirements: 3.2, 4.4_

- [ ] 5.3 コンプライアンスチェック結果をダッシュボードに表示する
  - 既存の `complianceService.ts` のチェック結果を運営指導ダッシュボード内に表示する
  - Level1（労基法違反）を赤、Level2（人員不足）をオレンジ、問題なしを緑で色分け表示する
  - _Requirements: 3.2, 3.4_

- [ ] 5.4 当月実績シフト一覧（スタッフ×日付グリッド）をダッシュボードに表示する
  - 運営指導ダッシュボード内に当月の実績シフトをスタッフ×日付のグリッド形式で表示する
  - 実績シフトタイプを各セルに表示する（シフトタイプの色設定を流用する）
  - _Requirements: 3.2_

- [ ] 5.5 過去12ヶ月の月別概要テーブルをダッシュボードに表示する
  - 過去12ヶ月分の月別概要テーブルを表示する
  - 各月の「対象月」「常勤換算値」「人員配置充足状況（○/×）」「書類アーカイブ有無」を表示する
  - schedules コレクションと documentArchive コレクションから集計して表示する
  - _Requirements: 3.3_

- [ ] 5.6 運営指導モード中の月変更でリアルタイム更新する
  - 運営指導モード中に対象月を変更すると、コンプライアンス結果・シフトグリッド・常勤換算値が即時再計算・再表示される
  - 月変更は既存の月ナビゲーターを運営指導モード内でも機能させる形で実装する
  - _Requirements: 3.6_

- [ ] 6. 常勤換算値・人員配置基準ダッシュボードを実装する
- [ ] 6.1 職種別常勤換算値を法定基準と比較して色分け表示する
  - 職種別（介護職員・看護職員・その他）の常勤換算値を数値で表示するダッシュボードを作成する
  - 常勤換算値が法定基準（事業所設定値）以上の場合は緑でハイライトする
  - 法定基準を下回る場合は赤でハイライトし、不足値（例:「あと0.5必要」）を表示する
  - 既存の `complianceService.ts` の `calculateFullTimeEquivalent()` 結果を再利用する
  - _Requirements: 4.1, 4.2, 4.3_

- [ ] 7. 電子申請フロー案内モーダルを実装する
- [ ] 7.1 電子申請の4ステップ案内モーダルを作成する
  - 「Step1: ダウンロードしたExcelファイルを確認する」「Step2: GビズIDでログイン」「Step3: フォームを選択してExcelをアップロード」「Step4: 受付番号を控えて提出完了」の4ステップをステップ形式で表示するモーダルを作成する
  - モーダル内に「この案内を印刷する」ボタンを設け、クリックで印刷ダイアログを開く
  - _Requirements: 5.3, 5.5_

- [ ] 7.2 エクスポート完了トーストからモーダルを開く導線を実装する
  - Excelエクスポート完了トーストに「電子申請の手順を確認する」リンクを表示する
  - リンクをクリックすると電子申請フロー案内モーダルが開く
  - モーダルを閉じた後、次回エクスポート時にも再度リンクが表示される（非表示設定なし）
  - _Requirements: 5.1, 5.2, 5.4_

- [ ] 8. 全機能を App.tsx に統合して管理者アクセス制御を完成させる
- [ ] 8.1 書類アーカイブタブを既存のUI構造に組み込む
  - 書類アーカイブパネルを管理者ロール専用のタブとして既存のタブ・アコーディオン構造に追加する
  - 一般スタッフロールではタブそのものを非表示にする
  - 施設ID・スタッフ一覧・シフト設定など必要なstateを書類アーカイブパネルに渡す
  - _Requirements: 6.3, 6.4_

- [ ] 8.2 運営指導モードトグルをApp.tsxのstate管理に接続する
  - `isInspectionMode` stateをApp.tsxに追加し、トグルのON/OFFで全画面ダッシュボードと通常UIを切り替える
  - 認証されていないユーザーが書類アーカイブや運営指導モードにアクセスした場合、ログイン画面へリダイレクトする既存の `ProtectedRoute` が機能することを確認する
  - _Requirements: 3.1, 3.5, 6.2_

- [ ] 9. TypeScriptの型チェックを通してビルドを確認する
- [ ] 9.1 全実装コードのTypeScriptエラーをゼロにする
  - `npx tsc --noEmit` でフロントエンドの型チェックを実施し、エラーをすべて解消する
  - `any` 型の使用がないことを確認する
  - 既存のコードへの変更による型エラーが発生していないことを確認する
  - _Requirements: すべての要件の品質基準_

---

## 要件カバレッジ確認

| 要件ID | カバータスク |
|--------|-------------|
| 1.1 | 1.1, 1.2, 2.1 |
| 1.2 | 2.1 |
| 1.3 | 1.2 |
| 1.4 | 3.1 |
| 1.5 | 3.1 |
| 1.6 | 3.2 |
| 2.1 | 4.1 |
| 2.2 | 4.1 |
| 2.3 | 4.2 |
| 2.4 | 4.2 |
| 2.5 | 4.2 |
| 3.1 | 5.1 |
| 3.2 | 5.2, 5.3, 5.4 |
| 3.3 | 5.5 |
| 3.4 | 5.3 |
| 3.5 | 5.1 |
| 3.6 | 5.6 |
| 4.1 | 6.1 |
| 4.2 | 6.1 |
| 4.3 | 6.1 |
| 4.4 | 5.2 |
| 5.1 | 2.1, 7.2 |
| 5.2 | 7.2 |
| 5.3 | 7.1 |
| 5.4 | 7.2 |
| 5.5 | 7.1 |
| 6.1 | 1.2, 1.3 |
| 6.2 | 8.2 |
| 6.3 | 3.1, 8.1 |
| 6.4 | 3.1, 8.1 |

**全26要件: カバー済み ✅**

---

## タスク依存関係

```
1.1 → 1.2 → 1.3
           ↓
1.2 → 2.1 → 3.1 → 3.2
                 → 4.1 → 4.2
2.1 → 7.2 → 7.1
1.2 → 5.1 → 5.2 → 5.3 → 5.4 → 5.5 → 5.6
               → 6.1
全タスク完了 → 8.1 → 8.2 → 9.1
```
