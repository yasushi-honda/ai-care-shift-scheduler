# Implementation Plan: AI Shift Integration Test

## 実装タスク一覧

本タスクリストは、TDD（テスト駆動開発）アプローチでAIシフト生成機能の統合テストを実装するための詳細な手順を定義しています。各タスクは、設計ドキュメントの6つのフェーズに沿って構成され、全9つの要件をカバーします。

---

- [ ] 1. 統合テスト基盤を構築する
- [ ] 1.1 テストフレームワークをセットアップする
  - Node.js向けテストフレームワークとHTTP APIテストライブラリをインストールする
  - TypeScriptコードを直接テスト実行できるようにプリセットを設定する
  - テストスクリプトとJUnit XMLレポート出力を設定する
  - CI/CD環境でテストが自動実行されることを確認する
  - _Requirements: 1.1, 1.2, 1.4_

- [ ] 1.2 標準テストデータとフィクスチャを作成する
  - 5名のスタッフリストを含む標準テストデータを定義する
  - 4つの時間帯（早番、日勤、遅番、夜勤）の標準シフト要件を定義する
  - サンプル休暇申請データを定義する
  - 20名と50名のスタッフリストをパフォーマンステスト用に準備する
  - モックVertex AIレスポンスのデータ構造を定義する
  - _Requirements: 9.1, 9.2, 9.3, 9.6_

- [ ] 1.3 条件付きモック機能を実装する
  - 環境変数に基づきVertex AI呼び出しをモックに切り替える仕組みを実装する
  - モックレスポンスが実際のAPIレスポンス形式と一致することを確認する
  - CI/CD環境でモックが自動的に有効化されることをテストする
  - ローカル環境で実Vertex AIとモックを切り替えられることを確認する
  - _Requirements: 1.3, 9.4, 9.5_

---

- [ ] 2. AIシフト生成の正常系動作を検証する
- [ ] 2.1 基本的なシフト生成機能をテストする
  - 5名のスタッフで正常にシフト生成リクエストを送信できることをテストする
  - HTTPステータス200とsuccess: trueが返ることを検証する
  - レスポンスにschedule配列が含まれることを検証する
  - 各スタッフが対象月の全日数分のシフトを持つことを検証する
  - 各シフトにstaffId、staffName、monthlyShiftsが含まれることを検証する
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5_

- [ ] 2.2 Firestoreへのデータ保存を検証する
  - シフト生成後にFirestoreにスケジュールが保存されることをテストする
  - レスポンスにscheduleIdが含まれることを検証する
  - 保存されたデータに冪等性ハッシュが含まれることを確認する
  - 保存されたデータ構造が正しいことを検証する
  - _Requirements: 2.6, 2.7_

- [ ] 2.3 レスポンス形式とメタデータを検証する
  - AIモデル名（gemini-2.5-flash-lite）がメタデータに記録されることをテストする
  - トークン使用量がmetadata.tokensUsedに記録されることを検証する
  - 生成日時がISO 8601形式で記録されることを確認する
  - 応答時間が60秒以内であることを検証する
  - _Requirements: 2.8, 7.5_

---

- [ ] 3. 入力バリデーションとエラーハンドリングを検証する
- [ ] 3.1 不正な入力に対するバリデーションをテストする
  - 空のstaffListでHTTP 400エラーが返ることをテストする
  - 未定義のstaffListで"staffList is required"エラーメッセージが返ることを検証する
  - 未定義のrequirementsで"requirements with targetMonth is required"エラーが返ることをテストする
  - 未定義のtargetMonthで適切なエラーメッセージが返ることを検証する
  - _Requirements: 3.1, 3.2, 3.4, 3.5_

- [ ] 3.2 サイズ制限とリソース保護をテストする
  - 201名のスタッフでHTTP 400エラーが返ることをテストする
  - エラーメッセージにスタッフ数上限（200名）が含まれることを検証する
  - 200KBを超えるリクエストでHTTP 413エラーが返ることをテストする
  - エラーメッセージにサイズ制限情報が含まれることを検証する
  - _Requirements: 3.3, 3.6_

- [ ] 3.3 エラーレスポンス形式を検証する
  - バリデーションエラー時にsuccess: falseが返ることをテストする
  - エラーレスポンスにスタックトレースが含まれないことを検証する
  - Vertex AIエラー時にHTTP 500とsuccess: falseが返ることをテストする
  - エラーログがCloud Loggingに記録されることを確認する
  - _Requirements: 3.7, 3.8, 5.1, 5.2, 5.7_

---

- [ ] 4. キャッシュ機能（冪等性）を検証する
- [ ] 4.1 同一入力での冪等性をテストする
  - 同じstaffList、requirements、leaveRequestsで2回リクエストを送信する
  - 2回目のレスポンスにmetadata.cached: trueが含まれることを検証する
  - 2回目のレスポンスにmetadata.cacheHit: trueが含まれることを検証する
  - 1回目と2回目のscheduleデータが完全に一致することを確認する
  - _Requirements: 4.1, 4.2, 4.3_

- [ ] 4.2 入力差分でのキャッシュ無効化をテストする
  - 同じstaffListとrequirementsだが異なるleaveRequestsでリクエストを送信する
  - 新しいシフトが生成され、キャッシュが使用されないことを検証する
  - 同じstaffListとleaveRequestsだが異なるrequirementsでリクエストを送信する
  - 新しいシフトが生成され、キャッシュが使用されないことを検証する
  - キャッシュミス時にVertex AI呼び出しが実行されることを確認する
  - _Requirements: 4.4, 4.5, 4.6_

- [ ] 4.3 キャッシュヒット時の応答時間を検証する
  - キャッシュヒット時の応答時間を計測する
  - 応答時間が5秒以内であることを検証する
  - キャッシュヒット時にVertex AI呼び出しがスキップされることを確認する
  - _Requirements: 4.7_

---

- [ ] 5. UIからAI生成までのエンドツーエンドフローを検証する
- [ ] 5.1 AI生成の正常系UIフローをテストする
  - 本番環境または開発サーバーをブラウザで開く
  - 「シフト作成実行」ボタンをクリックする
  - ローディング表示が表示されることを検証する
  - 「AIがシフトを作成中...」メッセージが表示されることを確認する
  - シフトカレンダーにシフトが表示されることをテストする
  - 全スタッフ・全日数分のシフトセルが存在することを検証する
  - _Requirements: 6.2, 6.3, 6.4, 6.5, 6.6_

- [ ] 5.2 エラーケースのUI表示をテストする
  - HTTPエラー（400/500）発生時にエラーメッセージが表示されることをテストする
  - エラーメッセージが赤色で表示されることを検証する
  - レスポンスからエラーメッセージが抽出されて表示されることを確認する
  - ネットワークエラー時に接続エラーメッセージが表示されることをテストする
  - _Requirements: 5.5, 5.6, 6.7_

- [ ] 5.3 タイムアウト処理をテストする
  - 60秒のタイムアウト後にAbortErrorが発生することをテストする
  - タイムアウト時に「タイムアウトしました」メッセージが表示されることを検証する
  - CI/CD環境ではE2Eテストがスキップされることを確認する
  - _Requirements: 5.3, 5.4, 6.9_

---

- [ ] 6. パフォーマンスと応答時間を検証する
- [ ] 6.1 スタッフ数別の応答時間をテストする
  - 5名のスタッフで応答時間を計測し、15秒以内であることを検証する
  - 20名のスタッフで応答時間を計測し、30秒以内であることを検証する
  - 50名のスタッフで応答時間を計測し、60秒以内であることを検証する
  - 各テストケースでHTTP 200とsuccess: trueが返ることを確認する
  - _Requirements: 7.1, 7.2, 7.3_

- [ ] 6.2 コールドスタートとキャッシュの影響を検証する
  - キャッシュヒット時の応答時間が5秒以内であることを検証する
  - コールドスタート時に初回応答時間が5秒以内の追加遅延を許容することをテストする
  - トークン使用量がmetadata.tokensUsedに記録されることを確認する
  - _Requirements: 7.4, 7.5, 7.6_

---

- [ ] 7. テストドキュメントとトラブルシューティングガイドを整備する
- [ ] 7.1 統合テスト実行手順を文書化する
  - 統合テストの実行方法（ローカル環境）をREADMEに記載する
  - 環境変数（SKIP_AI_TESTS、CLOUD_FUNCTION_URL）の設定方法を説明する
  - モック使用時と実Vertex AI使用時の違いを明記する
  - CI/CD環境でのテスト自動実行設定を記載する
  - _Requirements: 8.1, 8.3_

- [ ] 7.2 E2Eテスト実行手順を文書化する
  - E2Eテストの実行方法（ローカル環境）をREADMEに記載する
  - ローカル実行とCI/CD実行の違いを説明する
  - 本番環境での手動テスト実施手順を記載する
  - テストデータの準備方法を説明する
  - _Requirements: 8.4, 8.5_

- [ ] 7.3 トラブルシューティングガイドを作成する
  - 一般的なエラーとその解決方法をリストアップする
  - Vertex AIエラーのデバッグ方法を記載する
  - タイムアウトエラーの原因と対処法を説明する
  - Firestoreアクセスエラーの対処法を記載する
  - CI/CD環境でのテスト失敗時の対応手順を説明する
  - _Requirements: 8.2_

---

## 実装の進め方

### TDDサイクル
各タスクは以下のTDDサイクルで実装してください：

1. **Red（失敗するテストを書く）**:
   - 要件に基づいてテストケースを記述
   - テストを実行して失敗を確認

2. **Green（テストをパスさせる）**:
   - 最小限のコードでテストをパス
   - 実装コードを追加（モック実装含む）

3. **Refactor（リファクタリング）**:
   - コード品質を向上
   - 重複を削除、可読性を改善

### 実装順序
タスクは**1 → 2 → 3 → 4 → 5 → 6 → 7の順**で実装してください。各Major Taskが完了したら、次のTaskに進みます。

### 検証チェックポイント
- [ ] Task 1完了: `npm run test:integration`でJest実行成功
- [ ] Task 2完了: 正常系テスト全てパス、Firestoreにスケジュール保存確認
- [ ] Task 3完了: 異常系テスト全てパス、エラーメッセージ検証
- [ ] Task 4完了: 冪等性テスト全てパス、キャッシュ動作確認
- [ ] Task 5完了: E2Eテスト全てパス、本番環境でシフト表示確認
- [ ] Task 6完了: パフォーマンステスト全てパス、応答時間目標達成
- [ ] Task 7完了: ドキュメント査読完了

### コミット戦略
- 各Major Task完了時にコミット
- コミットメッセージ: `test: Task X完了 - [タスク概要]`
- 例: `test: Task 1完了 - 統合テスト基盤構築`

---

## 要件カバレッジマトリックス

| Requirement | 対応タスク | 説明 |
|-------------|----------|------|
| 1. 統合テストフレームワーク | 1.1, 1.3 | Jest + Supertest セットアップ、モック機能 |
| 2. 正常系テスト | 2.1, 2.2, 2.3 | シフト生成、Firestore保存、メタデータ検証 |
| 3. バリデーションテスト | 3.1, 3.2, 3.3 | 不正入力、サイズ制限、エラーレスポンス |
| 4. 冪等性検証 | 4.1, 4.2, 4.3 | キャッシュヒット、無効化、応答時間 |
| 5. エラーハンドリング | 3.3, 5.2, 5.3 | サーバーエラー、UIエラー表示、タイムアウト |
| 6. E2Eテスト | 5.1, 5.2, 5.3 | UI操作、エラー表示、タイムアウト |
| 7. パフォーマンステスト | 6.1, 6.2 | スタッフ数別応答時間、キャッシュ影響 |
| 8. ドキュメント | 7.1, 7.2, 7.3 | 実行手順、トラブルシューティング |
| 9. テストデータとモック | 1.2, 1.3 | フィクスチャ、モックレスポンス |

---

**実装準備完了**: 全要件がタスクに紐付けられ、TDDアプローチで段階的に実装できる状態です。Task 1から順に進めてください。
