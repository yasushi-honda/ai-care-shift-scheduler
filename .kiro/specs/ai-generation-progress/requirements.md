# Requirements Document

## はじめに

本ドキュメントは、Phase 45「AIシフト生成進行状況表示機能」の要件を定義します。

現在、AIシフト生成には2〜3分の処理時間がかかりますが、ユーザーには単純なローディング表示のみが表示されており、処理が正常に進行しているかどうかが分かりにくい状態です。本機能では、処理の進行状況を可視化することで、ユーザー体験を向上させます。

### 技術的制約

- **Cloud Functionの制約**: 現在の実装は単一のHTTP POST/レスポンス方式であり、途中経過をリアルタイムで返すことはできない
- **処理時間**: Gemini 2.5 Flash思考モードにより、10名規模で約2〜3分（最大180秒）
- **タイムアウト**: Cloud Function 300秒、フロントエンド 180秒

### ビジネス価値

- ユーザーの不安解消: 処理が正常に進行していることを明示
- 離脱率の低減: 待ち時間中にユーザーがページを離れることを防止
- 透明性の向上: AI処理のプロセスをユーザーに分かりやすく伝達

---

## Requirements

### Requirement 1: プログレス表示インジケーター

**Objective:** 管理者として、AIシフト生成の処理中に進行状況が視覚的に分かるようにしたい。これにより、処理が正常に進行していることを確認でき、安心して待つことができる。

#### Acceptance Criteria

1. WHEN ユーザーが「シフト作成実行」ボタンをクリックした THEN シフト生成画面 SHALL プログレスインジケーターを表示する

2. WHILE AI生成処理が進行中である THE シフト生成画面 SHALL 現在の処理ステップを段階的に表示する

3. WHEN AI生成処理が完了した THEN シフト生成画面 SHALL プログレスインジケーターを非表示にし、完了メッセージを表示する

4. IF AI生成処理がエラーで終了した THEN シフト生成画面 SHALL エラー状態を明示し、エラーメッセージを表示する

---

### Requirement 2: 段階的ステップ表示

**Objective:** 管理者として、AI処理が現在どの段階にあるかを把握したい。これにより、処理の進捗を具体的に理解でき、残り時間の目安を得られる。

#### Acceptance Criteria

1. WHEN AI生成処理が開始された THEN シフト生成画面 SHALL 処理ステップを以下の段階で表示する:
   - ステップ1: リクエスト送信中
   - ステップ2: AIがシフトを分析中
   - ステップ3: シフト案を生成中
   - ステップ4: 評価・最適化中
   - ステップ5: 結果を保存中

2. WHILE 各処理ステップが進行中である THE シフト生成画面 SHALL 現在のステップをハイライト表示する

3. WHEN 処理ステップが完了した THEN シフト生成画面 SHALL 完了したステップにチェックマークを表示する

---

### Requirement 3: 経過時間と予測時間の表示

**Objective:** 管理者として、処理にどれくらいの時間がかかるかを事前に知りたい。これにより、待ち時間を有効活用でき、処理完了の目安を把握できる。

#### Acceptance Criteria

1. WHEN AI生成処理が開始された THEN シフト生成画面 SHALL 処理の予測時間を表示する（例: 「約2〜3分かかります」）

2. WHILE AI生成処理が進行中である THE シフト生成画面 SHALL 経過時間をリアルタイムで表示する

3. IF 経過時間が予測時間の50%を超えた THEN シフト生成画面 SHALL 残り時間の目安を更新表示する

4. IF 経過時間が予測時間を超過した THEN シフト生成画面 SHALL 「もう少しお待ちください」のメッセージを表示する

---

### Requirement 4: アニメーションとビジュアルフィードバック

**Objective:** 管理者として、処理が停止していないことを視覚的に確認したい。これにより、システムがフリーズしていないことを安心して確認できる。

#### Acceptance Criteria

1. WHILE AI生成処理が進行中である THE シフト生成画面 SHALL アニメーション付きのプログレスバーまたはスピナーを表示する

2. WHEN 処理ステップが切り替わった THEN シフト生成画面 SHALL スムーズなトランジションアニメーションでステップを更新する

3. WHILE AI生成処理が進行中である THE プログレスインジケーター SHALL 継続的な動きを示すアニメーションを表示する

---

### Requirement 5: ユーザー操作の制限と復帰

**Objective:** 管理者として、処理中に誤って画面を離れたり、二重実行したりすることを防ぎたい。これにより、データの整合性を保ち、安全に処理を完了できる。

#### Acceptance Criteria

1. WHILE AI生成処理が進行中である THE シフト生成画面 SHALL 「シフト作成実行」ボタンを無効化する

2. WHILE AI生成処理が進行中である THE シフト生成画面 SHALL 他の主要なアクションボタン（保存、確定など）を無効化する

3. IF ユーザーがブラウザの戻るボタンをクリックした AND AI生成処理が進行中である THEN シフト生成画面 SHALL 確認ダイアログを表示する

4. WHEN AI生成処理が完了またはエラーで終了した THEN シフト生成画面 SHALL すべてのボタンを有効化する

---

### Requirement 6: キャンセル機能

**Objective:** 管理者として、処理を途中でキャンセルしたい場合がある。これにより、誤って開始した処理を中断できる。

#### Acceptance Criteria

1. WHILE AI生成処理が進行中である THE シフト生成画面 SHALL キャンセルボタンを表示する

2. WHEN ユーザーがキャンセルボタンをクリックした THEN シフト生成画面 SHALL 確認ダイアログを表示する

3. IF ユーザーがキャンセルを確認した THEN シフト生成画面 SHALL 処理をキャンセルし、元の状態に戻る

4. WHEN 処理がキャンセルされた THEN シフト生成画面 SHALL 「処理がキャンセルされました」のメッセージを表示する

---

## 技術的考慮事項

### 実装アプローチの選択肢

現在のCloud Function（単一HTTP POST/レスポンス）の制約を考慮し、以下のアプローチが考えられます：

1. **クライアントサイド疑似プログレス（推奨）**
   - フロントエンドで時間ベースの疑似的な進行状況を表示
   - 実際のCloud Function処理とは非同期で、ステップを段階的に表示
   - 実装が簡単で、既存のアーキテクチャを変更不要

2. **Firestoreリアルタイム更新（将来検討）**
   - Cloud FunctionがFirestoreに進行状況を書き込み
   - フロントエンドがFirestoreをリッスンして更新
   - リアルな進行状況を表示できるが、実装コストが高い

3. **Server-Sent Events（将来検討）**
   - Cloud Functionからストリーミングでイベントを送信
   - リアルタイム更新が可能だが、アーキテクチャ変更が必要

### 推奨アプローチ

Phase 45では、**クライアントサイド疑似プログレス**を採用することを推奨します。これにより：
- 既存のCloud Function実装を変更せずに済む
- 迅速に実装・デプロイ可能
- ユーザー体験を大幅に改善できる

---

## 非機能要件

- **パフォーマンス**: プログレス表示によるUI遅延は50ms以内
- **アクセシビリティ**: スクリーンリーダー対応（aria-live属性使用）
- **レスポンシブ**: モバイル・タブレットでも適切に表示

---

## 用語集

| 用語 | 説明 |
|------|------|
| プログレスインジケーター | 処理の進行状況を視覚的に表示するUI要素 |
| 疑似プログレス | 実際の処理進捗ではなく、時間ベースで推定した進行状況 |
| Cloud Function | Firebase/GCP上で実行されるサーバーレス関数 |
