# Implementation Plan

## Phase 45: AIシフト生成進行状況表示機能

---

- [ ] 1. 進行状況管理の基盤を構築する
- [ ] 1.1 ステップ定義とデータ型を作成する
  - AI生成処理の5段階ステップを定義する（リクエスト送信、分析、生成、評価・最適化、保存）
  - 各ステップの開始時間、ラベル、説明文を設定する
  - 進行状況の状態（idle、generating、completed、error、cancelled）を定義する
  - 経過時間、予測時間、現在のステップを管理するデータ構造を作成する
  - _Requirements: 2.1_

- [ ] 1.2 進行状況管理のカスタムフックを実装する
  - 生成処理の開始、完了、エラー、キャンセルを制御する機能を実装する
  - 1秒ごとに経過時間を更新するタイマー機能を実装する
  - 経過時間に基づいて現在のステップを自動的に進める計算ロジックを実装する
  - 状態リセット機能を実装し、処理終了後に初期状態に戻せるようにする
  - _Requirements: 1.1, 1.2, 3.2_

---

- [ ] 2. プログレス表示コンポーネントを実装する
- [ ] 2.1 ステップ表示コンポーネントを作成する
  - 5つの処理ステップを縦または横に並べて表示する
  - 現在進行中のステップをハイライト表示する（背景色、アイコン変更など）
  - 完了したステップにチェックマークアイコンを表示する
  - 未到達のステップをグレーアウト表示する
  - 各ステップのラベルと説明文を表示する
  - _Requirements: 2.1, 2.2, 2.3_

- [ ] 2.2 時間表示コンポーネントを作成する
  - 処理開始からの経過時間をリアルタイムで表示する（mm:ss形式）
  - 予測される処理時間を表示する（「約2〜3分」など）
  - 経過時間が予測時間の50%を超えたら残り時間の目安を表示する
  - 予測時間を超過した場合に「もう少しお待ちください」メッセージを表示する
  - _Requirements: 3.1, 3.2, 3.3, 3.4_

- [ ] 2.3 プログレスバーコンポーネントを作成する
  - 経過時間に基づいてプログレスバーの進捗を表示する
  - 継続的なアニメーション（パルス、ストライプなど）で処理が進行中であることを示す
  - ステップ切り替わり時にスムーズなトランジションアニメーションを適用する
  - _Requirements: 4.1, 4.2, 4.3_

- [ ] 2.4 メインのプログレス表示コンポーネントを作成する
  - ステップ表示、時間表示、プログレスバーを統合したUIを構築する
  - キャンセルボタンを配置し、クリック時にキャンセル確認を行う
  - 処理完了時に完了メッセージを表示する
  - エラー発生時にエラーメッセージと再試行ボタンを表示する
  - モーダルまたはオーバーレイ形式で表示する
  - _Requirements: 1.1, 1.3, 1.4, 6.1, 6.2, 6.4_

---

- [ ] 3. アプリケーションにプログレス表示を統合する
- [ ] 3.1 シフト生成処理にプログレス管理を組み込む
  - シフト作成実行ボタンクリック時にプログレス表示を開始する
  - Cloud Functionからのレスポンス受信時にプログレスを完了状態に更新する
  - エラー発生時にプログレスをエラー状態に更新し、エラーメッセージを表示する
  - _Requirements: 1.1, 1.3, 1.4_

- [ ] 3.2 ボタンの無効化・有効化を実装する
  - AI生成処理中はシフト作成実行ボタンを無効化する
  - 処理中は保存、確定などの主要アクションボタンも無効化する
  - 処理完了またはエラー終了時にすべてのボタンを有効化する
  - _Requirements: 5.1, 5.2, 5.4_

- [ ] 3.3 キャンセル機能を実装する
  - キャンセルボタンクリック時に確認ダイアログを表示する
  - ユーザーがキャンセルを確認したらAPI呼び出しを中断する（AbortController使用）
  - キャンセル完了後にプログレス表示を閉じ、元の状態に復帰する
  - キャンセルメッセージを表示する
  - _Requirements: 6.1, 6.2, 6.3, 6.4_

- [ ] 3.4 ブラウザ離脱時の警告を実装する
  - AI生成処理中にブラウザの戻るボタンやタブを閉じようとした際に確認を表示する
  - beforeunloadイベントを使用して警告ダイアログを出す
  - _Requirements: 5.3_

---

- [ ] 4. アクセシビリティとレスポンシブ対応を実装する
- [ ] 4.1 アクセシビリティ対応を実装する
  - プログレス表示にaria-live属性を追加してスクリーンリーダーに状態変化を通知する
  - プログレスバーにaria-valuenow、aria-valuemin、aria-valuemaxを設定する
  - キャンセルボタンにフォーカスが適切に移動するようにする
  - _Requirements: 非機能要件（アクセシビリティ）_

- [ ] 4.2 レスポンシブデザインを実装する
  - モバイル画面（幅768px以下）でステップ説明を省略し、ラベルのみ表示する
  - タブレット・デスクトップでは完全な表示にする
  - プログレスモーダルのサイズを画面に応じて調整する
  - _Requirements: 非機能要件（レスポンシブ）_

---

- [ ] 5. テストを実装する
- [ ] 5.1 カスタムフックのユニットテストを作成する
  - 初期状態がidle状態であることを検証する
  - startGeneration呼び出し後にgenerating状態になることを検証する
  - 時間経過によってステップが正しく進行することを検証する
  - completeGeneration、failGeneration、cancelGenerationの動作を検証する
  - _Requirements: 1.1, 1.2, 1.3, 1.4_

- [ ] 5.2 コンポーネントのユニットテストを作成する
  - 各状態（generating、completed、error、cancelled）で正しい表示になることを検証する
  - キャンセルボタンのクリックでonCancelが呼ばれることを検証する
  - ステップのハイライト、チェックマーク表示が正しいことを検証する
  - _Requirements: 2.2, 2.3, 6.1, 6.2_

- [ ] 5.3 統合テストを作成する
  - シフト作成実行からプログレス表示開始までの一連の流れを検証する
  - 処理完了時にプログレスが正しく非表示になることを検証する
  - エラー発生時に適切なエラー表示になることを検証する
  - _Requirements: 1.1, 1.3, 1.4_
