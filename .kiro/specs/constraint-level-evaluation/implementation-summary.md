# Phase 53: 制約レベル別評価システム - 実装サマリー

**更新日**: 2025-12-09
**仕様ID**: constraint-level-evaluation
**Phase**: 53
**提案者**: 本田
**ステータス**: ✅ 実装完了・本番検証済み

---

## 概要

各制約条件に4段階の必須レベルを導入し、レベル別の重み付け評価を行うことで、90%充足でも「使えるシフト」として提示できるようにするシステム改善。

### 解決した課題

**変更前**:
- 制約違反が11件以上でスコア0点 → 「実現不可能」と表示
- 人員充足率90%でも0点になってしまう
- 軽微な違反（希望休未反映など）も重大な違反と同等に扱われていた

**変更後**:
- レベル1違反（労基法）がない限り、0点にはならない
- レベル2（運営必須）は1件12点減点、レベル3（努力目標）は1件4点減点
- Lv2×19件でスコア0点でも「運営上の課題がありますが、手直しで対応可能です」と表示

---

## 設計判断の経緯

### 1. 4段階レベルの採用理由

| レベル | 名称 | 対象 | 減点 |
|-------|------|------|------|
| 1 | 絶対必須 | 労基法違反（夜勤後休息不足等） | 即0点 |
| 2 | 運営必須 | 人員不足、資格要件未充足 | -12点/件 |
| 3 | 努力目標 | 希望休未反映、連勤超過 | -4点/件 |
| 4 | 推奨 | 将来拡張用（相性考慮等） | 0点 |

**判断根拠**:
- 介護現場では「完璧なシフト」より「使えるシフト」が求められる
- 労基法違反は絶対に許容できない（レベル1 → 即0点）
- 軽微な違反が多くても、手直しで運用可能なら価値がある

### 2. スコア計算式の決定

```
スコア = 100 - (Lv2件数 × 12) - (Lv3件数 × 4)
※ Lv1が1件以上あれば即0点
※ 最小0点、最大100点に正規化
```

**例**: Lv2×3件 + Lv3×15件 = 100 - 36 - 60 = **4点**（以前は0点）

### 3. 「実現不可能」表示の条件変更

**変更前**: スコア0点で表示
**変更後**: レベル1違反がある場合のみ表示

これにより、スコア0点でもLv1違反がなければ「手直しで対応可能」と案内できる。

---

## 現在の運用状態

### 本番環境

- **URL**: https://ai-care-shift-scheduler.web.app/
- **デプロイ日時**: 2025-12-09 00:11 JST
- **ステータス**: 正常稼働

### 検証済み項目

| 項目 | 結果 |
|------|------|
| レベル別バッジ表示（Lv1-4） | ✅ 動作確認 |
| レベル別色分け | ✅ 動作確認 |
| 必須条件バッジ（Lv1=0時） | ✅ 動作確認 |
| 警告メッセージ切り替え | ✅ 動作確認 |
| スコア計算（レベル別重み付け） | ✅ 動作確認 |
| 後方互換性（既存データ） | ✅ 動作確認 |

### 既知の軽微な改善点

- AIコメント部分に「すべての制約を満たすシフトを作成できません」が残っている
  - 影響度: 低（表示上の一貫性のみ）
  - 対応: 将来のPhaseで対応予定

---

## 実装済みコンポーネント一覧

### バックエンド（Cloud Functions）

| ファイル | 役割 | 主要な変更 |
|----------|------|-----------|
| `functions/src/types.ts` | 型定義 | `ConstraintLevel`型追加、`level`フィールド追加 |
| `functions/src/evaluation/constraintLevelMapping.ts` | レベルマッピング | **新規作成** |
| `functions/src/evaluation/evaluationLogic.ts` | 評価ロジック | スコア計算、コメント生成をレベルベースに変更 |

#### constraintLevelMapping.ts の構成

```typescript
// 定数
CONSTRAINT_LEVEL_MAPPING  // 制約タイプ → レベルのマッピング
LEVEL_DEDUCTIONS          // レベル別減点設定
LEVEL_UI_CONFIG           // UI表示設定（色、ラベル）

// 関数
getConstraintLevel()        // 制約タイプからレベル取得
getViolationLevel()         // 違反オブジェクトからレベル取得
getDefaultLevelFromSeverity() // severity→レベル変換（後方互換）
groupViolationsByLevel()    // 違反をレベル別にグループ化
generateLevelBasedComment() // レベルベースのAIコメント生成
generatePositiveSummary()   // ポジティブサマリー生成
validateConstraintLevel()   // レベル値バリデーション
```

### フロントエンド

| ファイル | 役割 | 主要な変更 |
|----------|------|-----------|
| `types.ts` | 型定義 | `ConstraintLevel`型追加 |
| `src/components/EvaluationPanel.tsx` | 評価表示 | レベル別表示、色分け、警告メッセージ改善 |

#### EvaluationPanel.tsx の主要変更

1. **getWarningLevel関数**: スコアベース → レベルベースに変更
2. **LevelSummary**: レベル別カウント表示
3. **ViolationItem**: レベルバッジ、色分け表示
4. **WARNING_MESSAGES**: Lv1違反有無で切り替え

### テスト

| ファイル | テスト数 | 状態 |
|----------|---------|------|
| `functions/__tests__/unit/evaluationLogic.test.ts` | 28件 | ✅ 全パス |

---

## 将来の拡張ポイント

### Phase X: UI上でのレベル編集機能

**概要**: 条件設定画面で各制約のレベルを変更可能にする

**必要な実装**:
1. 施設ごとの`constraintLevelOverrides`コレクション追加
2. 設定UIコンポーネント作成
3. 評価ロジックでオーバーライドを参照

**工数見積もり**: 3-5日

### Phase Y: レベル4（推奨）の活用

**概要**: 相性考慮、通勤負担軽減などの推奨項目を追加

**必要な実装**:
1. 新しい制約タイプの定義
2. AI生成プロンプトへの組み込み
3. UI表示（青色バッジ）

**工数見積もり**: 2-3日

### Phase Z: AIコメントの完全レベルベース化

**概要**: 現在残っているAIコメントの「実現不可能」表現を完全に除去

**必要な実装**:
1. `generateCriticalComment`のリファクタリング
2. レベル別メッセージテンプレートの整備

**工数見積もり**: 1日

---

## 有効化の工数見積もり

### 既に有効化済み

Phase 53の全機能は**本番環境で有効**です。追加の有効化作業は不要。

### 設定変更のみで可能な調整

| 調整項目 | 変更箇所 | 工数 |
|----------|----------|------|
| 減点値の調整 | `LEVEL_DEDUCTIONS` | 5分 |
| レベルマッピング変更 | `CONSTRAINT_LEVEL_MAPPING` | 5分 |
| UI色変更 | `LEVEL_UI_CONFIG` | 5分 |

### コード変更が必要な拡張

| 機能 | 工数 |
|------|------|
| 新しい制約タイプ追加 | 1時間 |
| 施設別オーバーライド | 3-5日 |
| レポート機能連携 | 2-3日 |

---

## 関連ドキュメント

- [要件定義書](./requirements.md)
- [技術設計書](./design.md)
- [タスク一覧](./tasks.md)
- [GitHub Pages - Phase 53](../../docs/phase53-constraint-level-evaluation.html)

---

## コミット履歴

| コミットID | 日時 | 内容 |
|-----------|------|------|
| (初期実装) | 2025-12-08 | feat(Phase53): 制約レベル別評価システム実装 |
| (デバッグ) | 2025-12-08 | debug(Phase53): レベル別違反件数のデバッグログ追加 |
| 8c32dca | 2025-12-09 | fix(Phase53): 警告メッセージをレベルベース判定に修正 |
