# Requirements Document

## Introduction

Phase 53「制約レベル別評価システム」は、シフト生成AIの評価ロジックを改善し、介護現場の実態に即した「使えるシフト」を提供することを目的とする。

現在の評価システムでは、制約違反が11件以上でスコア0点となり「実現不可能」と表示される。しかし人員充足率90%であっても0点になってしまい、実運用で使えるシフトが生成されにくい状況にある。

本機能では、各制約条件に「必須レベル」（4段階）を導入し、レベル別の重み付け評価を行うことで、「100%完璧」ではなく「必須は守り、努力目標は柔軟に」という現実的なアプローチを実現する。

**提案者**: 本田

---

## Requirements

### Requirement 1: 制約レベルの定義とデータモデル

**Objective:** システム管理者として、各制約条件に必須レベルを設定できるようにしたい。それにより、制約の重要度を明確に区別できる。

#### Acceptance Criteria

1. WHEN シフト評価システムが制約違反を検出する THEN 評価サービスは各違反に対してレベル1〜4のいずれかを付与するものとする
2. WHERE 制約レベルの定義において THE 評価サービスは以下の4段階を使用するものとする：
   - レベル1（絶対必須）：労基法違反となる配置（72時間ルール等）
   - レベル2（運営必須）：資格者配置基準、最低人員基準
   - レベル3（努力目標）：希望休、連勤制限、時間帯希望
   - レベル4（推奨）：相性考慮、通勤負担軽減
3. WHEN 新しい制約タイプが追加される THEN 評価サービスはデフォルトのレベル値を持つものとする

---

### Requirement 2: レベル別重み付け評価ロジック

**Objective:** シフト管理者として、90%充足のシフトでも「使える」と判断できる評価結果を得たい。それにより、手直しで対応可能なシフトを活用できる。

#### Acceptance Criteria

1. WHEN レベル1違反が検出される THEN 評価サービスはシフト生成を失敗とし、スコアを0点とするものとする
2. WHEN レベル2違反が検出される THEN 評価サービスは1件あたり10〜15点を減点するものとする
3. WHEN レベル3違反が検出される THEN 評価サービスは1件あたり3〜5点を減点するものとする
4. WHEN レベル4違反が検出される THEN 評価サービスは減点せず情報として記録するものとする
5. IF レベル1違反が0件 AND 総合スコアが計算される THEN 評価サービスはスコアを0以上の値で返すものとする（11件以上の軽微な違反でも0点にならない）
6. WHILE 評価計算中 THE 評価サービスはスコアを0〜100の範囲に正規化するものとする

---

### Requirement 3: AIコメント生成の改善

**Objective:** シフト管理者として、評価結果に対してポジティブで建設的なフィードバックを得たい。それにより、シフトの改善方針を明確に把握できる。

#### Acceptance Criteria

1. IF レベル1違反が0件 AND レベル2違反が5件以下 THEN 評価サービスは「必須条件を満たしています。手直しで対応可能です」というポジティブなメッセージを生成するものとする
2. IF レベル1違反が0件 AND スコアが60点以上 THEN 評価サービスは「このシフトは運用可能です」というメッセージを含めるものとする
3. WHEN AIコメントを生成する THEN 評価サービスは「実現不可能」という表現をレベル1違反がある場合のみ使用するものとする
4. WHERE 違反詳細を表示する際 THE 評価サービスは具体的な改善提案を各違反に対して提示するものとする

---

### Requirement 4: UI表示の改善（評価パネル）

**Objective:** シフト管理者として、違反の重要度を視覚的に区別したい。それにより、優先的に対応すべき問題を即座に把握できる。

#### Acceptance Criteria

1. WHEN 評価結果が表示される THEN 評価パネルは違反をレベル別に色分け表示するものとする：
   - レベル1: 赤色（#DC2626）背景
   - レベル2: オレンジ色（#EA580C）背景
   - レベル3: 黄色（#CA8A04）背景
   - レベル4: 青色（#2563EB）背景（情報）
2. WHEN 違反リストが表示される THEN 評価パネルはレベル順（重要度高い順）にソートするものとする
3. WHERE 違反サマリーを表示する際 THE 評価パネルは「✅ 必須条件（Lv1-2）: X件」「⚠️ 努力目標（Lv3）: Y件」「ℹ️ 推奨（Lv4）: Z件」の形式で表示するものとする
4. IF レベル1違反が0件 THEN 評価パネルは「必須条件をすべて満たしています」という緑色のバッジを表示するものとする

---

### Requirement 5: 既存制約タイプのレベル分類

**Objective:** システムとして、既存の制約違反タイプに適切なデフォルトレベルを設定したい。それにより、導入直後から適切な評価が行われる。

#### Acceptance Criteria

1. WHERE 人員不足（staffShortage）違反が検出される際 THE 評価サービスはレベル2（運営必須）として分類するものとする
2. WHERE 資格要件不足（qualificationMissing）違反が検出される際 THE 評価サービスはレベル2（運営必須）として分類するものとする
3. WHERE 連続勤務超過（consecutiveWork）違反が検出される際 THE 評価サービスはレベル3（努力目標）として分類するものとする
4. WHERE 夜勤後休息不足（nightRestViolation）違反が検出される際 THE 評価サービスはレベル1（絶対必須）として分類するものとする
5. WHERE 休暇申請無視（leaveRequestIgnored）違反が検出される際 THE 評価サービスはレベル3（努力目標）として分類するものとする
6. WHERE 時間帯希望違反（timeSlotPreference）違反が検出される際 THE 評価サービスはレベル3（努力目標）として分類するものとする

---

### Requirement 6: 後方互換性の維持

**Objective:** システム管理者として、既存のシフト評価履歴との互換性を維持したい。それにより、過去のデータと比較可能な状態を保てる。

#### Acceptance Criteria

1. IF 既存の評価データにレベル情報がない THEN 評価サービスはデフォルトレベル（severity='error'→レベル2、severity='warning'→レベル3）を適用するものとする
2. WHEN 評価結果をFirestoreに保存する THEN 評価サービスは従来のseverityフィールドに加えてlevelフィールドも保存するものとする
3. WHERE 既存のAPIレスポンスを返す際 THE 評価サービスは従来のフィールド（overallScore, fulfillmentRate, constraintViolations）を維持するものとする

---

## Non-Functional Requirements

### パフォーマンス
- 評価計算の追加処理時間: 50ms以内
- UIレンダリングへの影響: 100ms以内

### 保守性
- 新しいレベル定義の追加が容易であること
- 制約タイプとレベルのマッピングが設定ファイルで管理可能であること

---

## Out of Scope（将来実装）

以下の機能は本Phaseのスコープ外とし、将来のPhaseで検討する：

1. **UI上での必須レベル編集機能**: 条件設定画面でのレベル選択UI
2. **施設ごとのレベルカスタマイズ**: デフォルトレベルの施設別上書き
3. **評価履歴のレベル別集計レポート**: ダッシュボード機能

---

## 関連ドキュメント

- [本田さん提案書](../../docs/phase53-proposal-honda.md)
- [現在の評価ロジック](../../functions/src/evaluation/evaluationLogic.ts)
- [EvaluationPanel](../../src/components/EvaluationPanel.tsx)
