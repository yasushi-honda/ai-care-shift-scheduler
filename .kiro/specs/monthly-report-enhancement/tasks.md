# Implementation Plan

## Phase 41: 月次レポート機能強化

---

- [ ] 1. 型定義とデータモデルの構築
- [ ] 1.1 レポート関連の型定義を作成する
  - 月次レポートデータの構造体を定義する
  - サマリー指標（総勤務時間、充足率、有給消化率など）の型を定義する
  - 勤務時間集計データの型を定義する（スタッフ別、日別詳細含む）
  - シフト種別集計データの型を定義する（全体集計、スタッフ別内訳）
  - スタッフ稼働統計データの型を定義する
  - 警告フラグの型を定義する（残業超過、連勤警告など）
  - _Requirements: 1.3, 2.2, 3.2, 4.2_

- [ ] 1.2 経営分析・個人レポート用の型定義を作成する
  - 経営分析レポートデータの構造体を定義する
  - 時間帯別充足率データの型を定義する
  - 資格別配置状況データの型を定義する
  - コスト推計データの型を定義する
  - 月次比較データの型を定義する
  - 個人勤務実績レポートデータの型を定義する
  - 個人用休暇残高データの型を定義する
  - _Requirements: 5.1, 6.2_

- [ ] 1.3 エラー型とResult型の拡張
  - レポート固有のエラー型を定義する（データなし、権限エラー、PDF生成エラーなど）
  - 既存のResult型パターンに準拠した型を定義する
  - _Requirements: 7.5, 非機能要件（セキュリティ）_

---

- [ ] 2. 集計サービスの実装
- [ ] 2.1 勤務時間集計ロジックを実装する
  - シフトデータから各スタッフの月間勤務時間を計算する
  - 通常勤務時間と夜勤時間を分離して計算する
  - 推定残業時間を計算する（月160時間基準）
  - 日別の勤務詳細データを生成する
  - 160時間超過の警告フラグを設定する
  - _Requirements: 2.1, 2.2, 2.3_

- [ ] 2.2 シフト種別集計ロジックを実装する
  - 全体のシフト種別ごとの回数と割合を計算する
  - スタッフ別のシフト種別内訳を計算する
  - シフト種別ごとの色情報を設定する
  - 夜勤8回以上の負荷偏り警告を検出する
  - _Requirements: 3.1, 3.2, 3.3, 3.4_

- [ ] 2.3 スタッフ稼働統計ロジックを実装する
  - 各スタッフの出勤日数・休日数を計算する
  - 公休・有給・その他の休日を分類してカウントする
  - 連続勤務最大日数を計算する
  - 平均週間勤務時間を計算する
  - 月間カレンダーの日別ステータスを生成する
  - _Requirements: 4.1, 4.2_

- [ ] 2.4 充足率計算ロジックを実装する
  - 日別の必要人数と実績人数を比較する
  - 時間帯別の充足率を計算する
  - 全体の人員充足率を算出する
  - 充足率80%未満の日を検出する
  - _Requirements: 1.3, 5.1, 5.3_

- [ ] 2.5 経営分析用の集計ロジックを実装する
  - 資格別の配置状況を集計する
  - 推定人件費を計算する（通常勤務、残業、夜勤手当）
  - 前月との比較データを生成する
  - 改善提案メッセージを生成する
  - _Requirements: 5.1, 5.2, 5.3_

---

- [ ] 3. レポートサービスの実装
- [ ] 3.1 月次レポートデータ取得機能を実装する
  - 施設IDと対象月を指定してFirestoreからデータを取得する
  - スケジュール、スタッフ、休暇残高データを並列で取得する
  - 集計サービスを呼び出してデータを加工する
  - 結果をResult型で返却する
  - _Requirements: 1.1, 1.2, 9.1_

- [ ] 3.2 キャッシュ機能を実装する
  - 集計結果を5分間メモリにキャッシュする
  - キャッシュキーは施設IDと対象月の組み合わせとする
  - 強制リフレッシュオプションを実装する
  - キャッシュクリア機能を実装する
  - _Requirements: 9.2, 9.3_

- [ ] 3.3 経営分析レポート取得機能を実装する
  - 管理者向けの詳細分析データを取得する
  - 前月データも取得して比較データを生成する
  - 改善提案を含むレポートを返却する
  - _Requirements: 5.1, 5.2, 5.3, 5.4_

- [ ] 3.4 個人勤務実績レポート取得機能を実装する
  - スタッフIDを指定して本人のデータのみ取得する
  - 勤務サマリー、シフト内訳、休暇残高を含むレポートを返却する
  - 他スタッフのデータへのアクセスを防止する
  - _Requirements: 6.1, 6.2, 6.3_

---

- [ ] 4. PDF生成サービスの実装
- [ ] 4.1 PDF基盤機能を実装する
  - jsPDFを使用したPDF生成の基本設定を行う
  - 日本語フォント対応を設定する
  - A4縦向きフォーマットを設定する
  - ヘッダー（施設名、レポート種別、対象期間）を追加する
  - フッター（生成日時、ページ番号）を追加する
  - _Requirements: 7.2_

- [ ] 4.2 ダッシュボードPDF出力機能を実装する
  - サマリー指標をテーブル形式で出力する
  - グラフ画像をPDFに埋め込む
  - 適切なページレイアウトを設定する
  - _Requirements: 7.1, 7.3_

- [ ] 4.3 経営分析レポートPDF出力機能を実装する
  - 人員配置サマリーセクションを出力する
  - 時間帯別充足率をテーブルで出力する
  - 資格別配置状況をテーブルで出力する
  - コスト推計セクションを出力する
  - 前月比較データを出力する
  - _Requirements: 5.4, 7.1, 7.2_

- [ ] 4.4 個人レポートPDF出力機能を実装する
  - 個人の勤務サマリーを出力する
  - シフト種別内訳を出力する
  - 休暇残高を出力する
  - 月間カレンダーを出力する
  - _Requirements: 6.4, 7.1, 7.2_

---

- [ ] 5. UIコンポーネントの実装（ダッシュボード）
- [ ] 5.1 レポートページのルートコンポーネントを実装する
  - タブナビゲーション（ダッシュボード、勤務時間、シフト種別、スタッフ稼働、経営分析、個人）を実装する
  - 月選択機能を実装する
  - データ読み込み状態の管理を実装する
  - エラー表示を実装する
  - _Requirements: 1.1, 1.2, 1.4_

- [ ] 5.2 レポートダッシュボードコンポーネントを実装する
  - サマリーカード（総勤務時間、スタッフ数、充足率、有給消化率）を表示する
  - ローディングインジケーターを実装する
  - PDFダウンロードボタンを配置する
  - _Requirements: 1.1, 1.3, 1.4_

- [ ] 5.3 共通グラフコンポーネントを実装する
  - Chart.jsを使用した円グラフコンポーネントを作成する
  - 棒グラフコンポーネントを作成する
  - グラフからBase64画像を取得する機能を実装する
  - _Requirements: 3.2, 3.3, 7.3_

---

- [ ] 6. UIコンポーネントの実装（各種レポート）
- [ ] 6.1 勤務時間レポートコンポーネントを実装する
  - スタッフ別の勤務時間一覧テーブルを表示する
  - 160時間超過の警告アイコンを表示する
  - 行クリックで日別詳細を展開表示する
  - _Requirements: 2.1, 2.2, 2.3, 2.4_

- [ ] 6.2 シフト種別レポートコンポーネントを実装する
  - 全体のシフト種別割合を円グラフで表示する
  - スタッフ別のシフト種別内訳を棒グラフで表示する
  - 夜勤集中警告を表示する
  - _Requirements: 3.1, 3.2, 3.3, 3.4_

- [ ] 6.3 スタッフ稼働レポートコンポーネントを実装する
  - 全スタッフの稼働統計一覧を表示する
  - スタッフ選択で個人詳細を表示する
  - 月間カレンダービューを表示する
  - _Requirements: 4.1, 4.2, 4.3, 4.4_

- [ ] 6.4 経営分析レポートコンポーネントを実装する
  - 人員配置サマリーを表示する
  - 時間帯別充足率を表示する
  - 資格別配置状況を表示する
  - コスト推計を表示する
  - 前月比較データを表示する
  - 改善提案を表示する
  - _Requirements: 5.1, 5.2, 5.3_

- [ ] 6.5 個人勤務実績レポートコンポーネントを実装する
  - 本人の勤務サマリーを表示する
  - シフト種別内訳を表示する
  - 休暇残高を表示する
  - PDFダウンロードボタンを配置する
  - _Requirements: 6.1, 6.2, 6.3, 6.4_

---

- [ ] 7. PDFダウンロード機能とUI統合
- [ ] 7.1 PDFダウンロードボタンコンポーネントを実装する
  - ダウンロードボタンのUIを実装する
  - 生成中の進捗インジケーターを表示する
  - エラー時の再試行ボタンを表示する
  - _Requirements: 7.1, 7.4, 7.5_

- [ ] 7.2 レポートページとPDFサービスを統合する
  - 各レポートタブにPDFダウンロード機能を追加する
  - グラフ画像をPDFサービスに渡す処理を実装する
  - _Requirements: 5.4, 6.4, 7.1_

---

- [ ] 8. レスポンシブ対応
- [ ] 8.1 デスクトップレイアウトを最適化する
  - 幅1024px以上でフルレイアウト表示する
  - サイドバーとメインコンテンツの配置を調整する
  - _Requirements: 8.1_

- [ ] 8.2 タブレットレイアウトを実装する
  - 幅768px-1023pxでサイドバーを折りたたみ可能にする
  - レスポンシブなテーブル表示を実装する
  - _Requirements: 8.2_

- [ ] 8.3 モバイルレイアウトを実装する
  - 幅767px以下でカード形式のシンプルレイアウトを表示する
  - タッチフレンドリーな操作を実装する
  - モバイル対応のPDFダウンロードフローを実装する
  - _Requirements: 8.3, 8.4_

---

- [ ] 9. ルーティングとアクセス制御の統合
- [ ] 9.1 レポートページのルーティングを設定する
  - アプリケーションのルーターにレポートページを追加する
  - ナビゲーションメニューにレポートリンクを追加する
  - _Requirements: 1.1_

- [ ] 9.2 アクセス制御を実装する
  - 管理者のみが経営分析レポートにアクセスできるようにする
  - スタッフは個人レポートのみにアクセスできるようにする
  - 権限不足時のエラーハンドリングを実装する
  - _Requirements: 6.3, 非機能要件（セキュリティ）_

---

- [ ] 10. テストの実装
- [ ] 10.1 集計サービスのユニットテストを作成する
  - 勤務時間集計のテストケースを作成する
  - シフト種別集計のテストケースを作成する
  - スタッフ稼働統計のテストケースを作成する
  - 充足率計算のテストケースを作成する
  - 警告フラグ判定のテストケースを作成する
  - _Requirements: 2.3, 3.4, 非機能要件（パフォーマンス）_

- [ ] 10.2 レポートサービスのユニットテストを作成する
  - データ取得のテストケースを作成する
  - キャッシュ動作のテストケースを作成する
  - エラーハンドリングのテストケースを作成する
  - _Requirements: 9.2, 9.3_

- [ ] 10.3 E2Eテストを作成する
  - レポートページアクセスとダッシュボード表示のテストを作成する
  - 月選択とデータ更新のテストを作成する
  - PDFダウンロードのテストを作成する
  - レスポンシブ表示のテストを作成する
  - _Requirements: 1.1, 1.2, 7.1, 8.1, 8.2, 8.3_
