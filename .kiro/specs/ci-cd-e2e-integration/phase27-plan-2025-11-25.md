# Phase 27: CI/CD E2Eテスト統合計画

**作成日**: 2025-11-25
**仕様ID**: ci-cd-e2e-integration
**Phase**: 27
**ステータス**: 🔄 実装中

---

## エグゼクティブサマリー

GitHub ActionsでE2Eテストを自動実行し、品質保証体制を強化します。Firebase Emulatorを活用し、本番環境に影響を与えずにテストを実行します。

### 目標
- ✅ PR時にE2Eテスト自動実行
- ✅ mainブランチマージ前に品質ゲート確保
- ✅ テスト失敗時のレポート自動生成
- ✅ Firebase Emulator統合による安定したテスト環境

### 推定工数

- **計画・設計**: 1時間
- **実装**: 3-4時間
- **検証・調整**: 1-2時間
- **ドキュメント**: 1時間
- **合計**: 6-8時間

※タイムライン詳細と整合性を確認済み（現在のテストスイート複雑度を考慮）

---

## 現状分析

### CI/CD設定（.github/workflows/ci.yml）
- ✅ Node.js 20セットアップ済み
- ✅ TypeScript型チェック済み
- ✅ プロダクションビルド済み
- ❌ **E2Eテストコメントアウト中**（Lines 62-84）
- ✅ Firebase Hosting/Functions/Rulesデプロイ済み

### Playwright設定（playwright.config.ts）
- ✅ グローバルセットアップ設定済み
- ✅ Chromiumのみ実行（CI環境）
- ✅ 並列実行無効化（Firebase Emulator対応）
- ✅ 失敗時リトライ2回（CI環境）
- ✅ レポート設定済み（GitHub + HTML）

### E2Eテスト状況
- **17テストファイル**存在
- **主要テスト**: 認証、RBAC、シフト管理、一括コピーなど
- **懸念**: Firebase Emulator依存によるCI環境での安定性

---

## 実装計画

### Phase 27.1: GitHub Actions E2Eワークフロー追加

**目標**: PRおよびmainブランチへのpush時にE2Eテストを実行

**実装内容**:
1. Playwright Chromiumインストール
2. Firebase Emulatorセットアップ
3. E2Eテスト実行
4. テストレポートアーティファクト保存

### Phase 27.2: Firebase Emulator統合

**目標**: CI環境でFirebase Emulatorを安定稼働

**実装内容**:
1. Firebase Emulator起動スクリプト
2. Emulator Ready待機ロジック
3. テストデータ初期化

### Phase 27.3: テスト安定化

**目標**: Flaky Test対策、タイムアウト調整

**実装内容**:
1. タイムアウト値の最適化
2. リトライ戦略の調整
3. テストケースの安定化修正

---

## 技術設計

### GitHub Actions E2Eジョブ構成

```yaml
e2e-test:
  name: E2Eテスト
  runs-on: ubuntu-latest
  needs: build-and-test
  permissions:
    contents: read
  steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    - uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
    - run: npm ci
    - run: npx playwright install --with-deps chromium
    - run: npm install -g firebase-tools
    - name: E2Eテスト実行
      run: |
        # Firebase Emulator起動（バックグラウンド）
        firebase emulators:start --only auth,firestore &
        EMULATOR_PID=$!
        # Emulator起動待機（ヘルスチェック付き）
        for i in {1..60}; do
          if ! kill -0 $EMULATOR_PID 2>/dev/null; then exit 1; fi
          curl -s http://localhost:9099/ && break
          sleep 1
        done
        # 開発サーバー起動（バックグラウンド）
        npm run dev &
        DEV_PID=$!
        # 開発サーバー起動待機
        for i in {1..60}; do
          curl -s http://localhost:5173/ && break
          sleep 1
        done
        # テスト実行
        PLAYWRIGHT_BASE_URL=http://localhost:5173 npx playwright test || EXIT=$?
        # クリーンアップ
        kill $DEV_PID $EMULATOR_PID 2>/dev/null || true
        exit ${EXIT:-0}
      env:
        FIREBASE_AUTH_EMULATOR_HOST: localhost:9099
        FIRESTORE_EMULATOR_HOST: localhost:8080
    - if: always()
      uses: actions/upload-artifact@v4
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 7
```

**注**: 実際のci.ymlでは、より詳細なエラーハンドリング（プロセス生存チェック、タイムアウト検出）を実装しています。

### Firebase Emulator構成

- **auth**: 認証エミュレータ（ポート9099）
- **firestore**: Firestoreエミュレータ（ポート8080）
- **起動待機**: 最大60秒

### 環境変数

| 変数名 | 値 | 用途 |
|--------|-----|------|
| CI | true | CI環境判定 |
| PLAYWRIGHT_BASE_URL | http://localhost:5173 | テスト対象URL |
| FIREBASE_AUTH_EMULATOR_HOST | localhost:9099 | Auth Emulator |
| FIRESTORE_EMULATOR_HOST | localhost:8080 | Firestore Emulator |

---

## リスク管理

| リスク | 影響度 | 発生確率 | 対策 |
|--------|--------|----------|------|
| Emulator起動失敗 | 高 | 中 | ヘルスチェック＋リトライ |
| テストFlaky | 中 | 高 | タイムアウト増加、リトライ2回 |
| CI時間増加 | 低 | 高 | キャッシュ活用、並列化検討 |
| メモリ不足 | 中 | 低 | Chromiumのみ実行 |

---

## 成功基準

### 機能要件
- [ ] PR作成時にE2Eテスト自動実行
- [ ] mainマージ時にE2Eテスト自動実行
- [ ] テスト失敗時にPRにコメント通知
- [ ] テストレポートのアーティファクト保存

### 非機能要件
- [ ] E2Eテスト実行時間 < 10分
- [ ] テスト成功率 > 95%
- [ ] CI全体時間 < 15分

---

## タイムライン

| タスク | 推定時間 | 実績時間 | ステータス |
|--------|----------|----------|------------|
| 計画・WBS作成 | 1h | - | 🔄 進行中 |
| GitHub Actions修正 | 2h | - | ⏳ 待機 |
| Firebase Emulator設定 | 1h | - | ⏳ 待機 |
| テスト安定化 | 2h | - | ⏳ 待機 |
| 検証・調整 | 1h | - | ⏳ 待機 |
| ドキュメント整備 | 1h | - | ⏳ 待機 |

---

## 関連ドキュメント

- [Phase 26.2完了記録](../github-pages-optimization/phase26.2-completion-2025-11-24.md)
- [E2Eテストパターン](../../.serena/memories/phase14_e2e_test_patterns.md)
- [CI/CD設定](.github/workflows/ci.yml)
- [Playwright設定](playwright.config.ts)
