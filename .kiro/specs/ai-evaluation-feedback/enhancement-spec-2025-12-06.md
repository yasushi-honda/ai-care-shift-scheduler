# AI評価機能改善仕様書

**作成日**: 2025-12-06
**ステータス**: 実装中
**関連Phase**: Phase 40拡張

---

## 1. 概要

Phase 40で実装されたAI評価機能を改善し、ユーザビリティと実用性を向上させる。

### 1.1 改善の背景

現状の課題:
| 課題 | 現状 | 影響 |
|------|------|------|
| 総合コメントがない | 構造化データのみ表示 | AIの判断理由が分かりにくい |
| 「無理」の明示が弱い | スコア0として表示 | 制約不可能な場合の認識が困難 |
| 視認性 | 折りたたみで見逃しやすい | 重要な警告を見落とす |

### 1.2 改善目標

1. **短期**: パネル自動展開・警告メッセージ追加（工数: 小）
2. **中期**: AI総合コメント機能（工数: 中）

---

## 2. 短期改善: パネル自動展開・警告メッセージ

### 2.1 機能要件

#### FR-1: 低スコア時の自動展開
- スコアが60未満の場合、EvaluationPanelを自動展開する
- エラー件数が5件以上の場合も自動展開する
- 初回表示時のみ自動展開（ユーザーが手動で閉じた後は維持）

#### FR-2: 警告メッセージ表示
- スコア0の場合:「この要件では実現不可能です」警告を表示
- スコア1-30の場合:「重大な制約違反があります。手動調整が必要です」
- スコア31-59の場合:「複数の問題があります。確認してください」

### 2.2 UI設計

```
┌────────────────────────────────────────────────────────┐
│ ⚠️ 警告: この要件では実現不可能です                      │
│ 人員数が不足しているため、すべての制約を満たせません。      │
│ スタッフの追加または要件の緩和を検討してください。         │
└────────────────────────────────────────────────────────┘
┌────────────────────────────────────────────────────────┐
│ AI評価  [0点] [エラー 218] [▼]  ← 自動展開済み          │
├────────────────────────────────────────────────────────┤
│ サマリー、制約違反、改善提案、シミュレーション...         │
└────────────────────────────────────────────────────────┘
```

### 2.3 実装詳細

#### 変更ファイル
- `src/components/EvaluationPanel.tsx`

#### 変更内容

```typescript
// 自動展開のしきい値定数
const AUTO_EXPAND_SCORE_THRESHOLD = 60;
const AUTO_EXPAND_ERROR_THRESHOLD = 5;

// 警告レベル判定
type WarningLevel = 'critical' | 'severe' | 'warning' | 'none';

function getWarningLevel(score: number): WarningLevel {
  if (score === 0) return 'critical';
  if (score <= 30) return 'severe';
  if (score < 60) return 'warning';
  return 'none';
}
```

---

## 3. 中期改善: AI総合コメント機能

### 3.1 機能要件

#### FR-3: AI総合コメント生成
- シフト生成時にGeminiが自然言語で総合コメントを生成
- 評価結果の要約、主要な問題点、推奨アクションを含む
- 200文字程度の簡潔なコメント

#### FR-4: コメント表示
- EvaluationPanelのヘッダー直下に表示
- 展開状態に関わらず常に表示
- コピー可能

### 3.2 データモデル

#### AIEvaluationResult 拡張

```typescript
interface AIEvaluationResult {
  // 既存フィールド
  overallScore: number;
  fulfillmentRate: number;
  constraintViolations: ConstraintViolation[];
  recommendations: Recommendation[];
  simulation: SimulationResult;
  generatedAt: Timestamp;

  // 新規フィールド
  aiComment?: string;  // AI総合コメント（200文字以内）
}
```

### 3.3 Cloud Functions修正

#### shift-generation.ts 変更

```typescript
// プロンプトに総合コメント生成を追加
const evaluationPrompt = `
生成したシフトの評価として、以下を200文字以内で簡潔にコメントしてください:
1. 全体的な評価（良い点・問題点）
2. 主要な制約違反の概要
3. 推奨される対応

制約違反データ: ${JSON.stringify(violations)}
`;

// スキーマにaiCommentを追加
const responseSchema = {
  type: 'object',
  properties: {
    // ...既存プロパティ
    aiComment: {
      type: 'string',
      description: 'AI総合コメント（200文字以内）'
    }
  },
  propertyOrdering: [...existingOrder, 'aiComment']
};
```

### 3.4 UI設計

```
┌────────────────────────────────────────────────────────┐
│ AI評価  [45点] [エラー 12] [警告 8] [▼]                 │
├────────────────────────────────────────────────────────┤
│ 💬 AIコメント                                          │
│ 「人員配置は概ね適切ですが、早番で3日間の人員不足が      │
│ 発生しています。特に12/15、12/22、12/25は対応が         │
│ 必要です。連勤については概ね許容範囲内です。」          │
│                                           [コピー]     │
├────────────────────────────────────────────────────────┤
│ サマリー、制約違反、改善提案...                         │
└────────────────────────────────────────────────────────┘
```

---

## 4. 実装計画

### 4.1 短期改善（本日実装）

| ステップ | 内容 | 工数 |
|---------|------|------|
| 1 | EvaluationPanel.tsx 修正（自動展開） | 15分 |
| 2 | 警告メッセージコンポーネント追加 | 20分 |
| 3 | ユニットテスト | 15分 |
| 4 | E2Eテスト追加 | 15分 |

### 4.2 中期改善（本日実装）

| ステップ | 内容 | 工数 |
|---------|------|------|
| 1 | types.ts 型定義拡張 | 5分 |
| 2 | shift-generation.ts 修正 | 30分 |
| 3 | evaluationLogic.ts 修正 | 15分 |
| 4 | EvaluationPanel.tsx AIコメント表示 | 20分 |
| 5 | Cloud Functionsテスト | 15分 |
| 6 | E2Eテスト追加 | 15分 |

---

## 5. テスト計画

### 5.1 ユニットテスト

```typescript
describe('EvaluationPanel', () => {
  it('スコア60未満で自動展開', () => {...});
  it('エラー5件以上で自動展開', () => {...});
  it('スコア0で「実現不可能」警告表示', () => {...});
  it('AIコメントが表示される', () => {...});
});
```

### 5.2 E2Eテスト

```typescript
test('低スコア時に警告が表示される', async () => {
  // AIシフト生成を実行
  // 警告メッセージの存在を確認
  // パネルが展開状態であることを確認
});
```

---

## 6. 影響範囲

### 6.1 変更ファイル

| ファイル | 変更内容 |
|---------|---------|
| `src/components/EvaluationPanel.tsx` | 自動展開、警告、AIコメント |
| `types.ts` (フロントエンド) | AIEvaluationResult拡張 |
| `functions/src/types.ts` | AIEvaluationResult拡張 |
| `functions/src/shift-generation.ts` | AIコメント生成 |

### 6.2 ドキュメント更新

| ドキュメント | 更新内容 |
|-------------|---------|
| CLAUDE.md | 変更なし（既存ルール維持） |
| docs/phase40-evaluation.html | 機能追加の記載 |
| GitHub Pages | 機能更新の反映 |

---

## 7. リスクと対策

| リスク | 影響 | 対策 |
|--------|------|------|
| AIコメント生成でトークン増加 | コスト増・遅延 | 200文字制限、キャッシュ検討 |
| 自動展開のUX影響 | ユーザー混乱 | 初回のみ、設定で無効化可能に |
| 警告の過剰表示 | 見慣れて無視される | 重要度に応じた表示制御 |

---

## 8. 完了基準

- [ ] 短期改善: 自動展開が正常動作
- [ ] 短期改善: 警告メッセージが適切に表示
- [ ] 中期改善: AIコメントが生成・表示される
- [ ] E2Eテストがパス
- [ ] CodeRabbitレビュー完了
- [ ] 本番デプロイ完了
- [ ] ドキュメント更新完了
