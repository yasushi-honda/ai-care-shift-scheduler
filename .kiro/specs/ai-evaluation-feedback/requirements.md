# Phase 40: AI評価・フィードバック機能 - 要件定義書

**作成日**: 2025-11-26
**仕様ID**: ai-evaluation-feedback
**Phase**: 40
**ステータス**: 計画中
**優先度**: 高

---

## 1. 背景と目的

### 1.1 現状の課題

現在のAIシフト生成機能には以下の課題があります：

- **ブラックボックス化**: AIが生成したシフトの理由が不明
- **問題検出の遅れ**: 制約違反や人員不足に気づきにくい
- **改善方法が不明**: 何を変更すれば良いシフトになるか分からない
- **リスク予測なし**: 生成されたシフトで運用した場合の問題が予測できない

### 1.2 プロジェクトの目的

本機能（Phase 40）では、以下を実現します：

1. **AI評価サマリー**: 生成結果の品質スコアと充足率を表示
2. **制約違反検出**: 問題点を明確に警告表示
3. **改善提案**: 具体的なネクストアクションを提示
4. **シミュレーション**: 運用時の予測情報を提供

---

## 2. ステークホルダー

| 役割 | 説明 | 関心事 |
|------|------|--------|
| **施設管理者** | シフト作成責任者 | 問題の早期発見、改善方法の明確化 |
| **スタッフ** | シフト勤務者 | 公平性、無理のないシフト |
| **経営者** | 事業所運営責任者 | コスト、労務リスク |

---

## 3. 機能要件

### FR-40.1: AI評価サマリー表示

**説明**: AI生成結果の品質を数値化して表示する。

**詳細要件**:
- 総合スコア（0-100点）
- 充足率（必要人員に対する配置率）
- 制約違反件数
- 警告/エラーの区分

**受け入れ基準**:
- [ ] 生成完了時に評価サマリーが表示される
- [ ] スコアが視覚的に分かりやすい（色分け等）
- [ ] 詳細を展開できる

---

### FR-40.2: 制約違反検出・警告

**説明**: シフト生成時の制約違反を検出し警告表示する。

**検出する制約違反**:
| 種別 | 説明 | 重要度 |
|------|------|--------|
| 人員不足 | 必要人員に対して配置が足りない | エラー |
| 連勤超過 | 連続勤務日数が上限を超える | 警告 |
| 夜勤後休息不足 | 夜勤後に適切な休息がない | 警告 |
| 資格要件未充足 | 必要資格者が配置されていない | エラー |
| 休暇希望未反映 | 休暇希望が反映されていない | 警告 |

**受け入れ基準**:
- [ ] 各違反が明確に表示される
- [ ] 影響を受けるスタッフ・日付が特定される
- [ ] 重要度に応じた色分け表示

---

### FR-40.3: 改善提案

**説明**: 検出された問題に対する具体的な改善提案を表示する。

**詳細要件**:
- 問題ごとに1つ以上の改善案を提示
- 優先度（高/中/低）を明示
- 実行可能な具体的アクションを記載

**例**:
```
問題: 11/28(木) 夜勤 人員不足
提案:
  - 高優先: 山田さんを夜勤に変更（現在：日勤）
  - 中優先: パートスタッフの追加シフトを検討
```

**受け入れ基準**:
- [ ] 各問題に対して改善提案が表示される
- [ ] 提案が具体的で実行可能

---

### FR-40.4: シミュレーション情報

**説明**: 生成されたシフトで運用した場合の予測情報を表示する。

**表示項目**:
- 予想残業時間（月間合計）
- 負荷バランス（スタッフ間の偏り）
- 有給消化率予測
- リスク要因（注意すべき点）

**受け入れ基準**:
- [ ] シミュレーション結果が表示される
- [ ] リスク要因が明確に提示される

---

### FR-40.5: 評価履歴保存

**説明**: AI評価結果をFirestoreに保存し、履歴として参照できる。

**詳細要件**:
- 生成ごとに評価結果を保存
- 過去の評価と比較可能
- 改善傾向の可視化

**受け入れ基準**:
- [ ] 評価結果がFirestoreに保存される
- [ ] 過去の生成履歴から評価を参照できる

---

## 4. 非機能要件

### NFR-40.1: パフォーマンス
- 評価生成: シフト生成と同時（追加時間なし）
- UI表示: 1秒以内

### NFR-40.2: ユーザビリティ
- 評価結果は折りたたみ可能（デフォルト: サマリーのみ表示）
- モバイル対応

### NFR-40.3: 拡張性
- 新しい制約タイプの追加が容易
- 評価ロジックのカスタマイズ可能

---

## 5. データモデル

### 5.1 AIEvaluationResult

```typescript
interface AIEvaluationResult {
  overallScore: number;           // 0-100
  fulfillmentRate: number;        // 0-100（充足率%）

  constraintViolations: {
    type: 'staffShortage' | 'consecutiveWork' | 'nightRestViolation' |
          'qualificationMissing' | 'leaveRequestIgnored';
    severity: 'error' | 'warning';
    description: string;
    affectedStaff?: string[];     // スタッフID
    affectedDates?: string[];     // YYYY-MM-DD
    suggestion?: string;
  }[];

  recommendations: {
    priority: 'high' | 'medium' | 'low';
    category: string;
    description: string;
    action: string;
  }[];

  simulation: {
    estimatedOvertimeHours: number;
    workloadBalance: 'good' | 'fair' | 'poor';
    paidLeaveUsageRate: number;   // 0-100%
    risks: string[];
  };

  generatedAt: Timestamp;
}
```

### 5.2 Firestoreコレクション

```
/facilities/{facilityId}/aiGenerationHistory/{historyId}
  ├─ schedule: [...]           // 既存
  ├─ evaluation: AIEvaluationResult  // 新規追加
  └─ createdAt: Timestamp
```

---

## 6. 実装フェーズ

| サブフェーズ | 内容 | 工数目安 |
|-------------|------|----------|
| 40.1 | Geminiスキーマ拡張・評価生成 | 1日 |
| 40.2 | 制約違反検出ロジック | 1日 |
| 40.3 | 改善提案生成 | 1日 |
| 40.4 | 評価UI（ダッシュボード） | 1-2日 |
| 40.5 | シミュレーション機能 | 1-2日 |
| 40.6 | Firestore保存・履歴表示 | 0.5日 |

**合計**: 5.5-7.5日

---

## 7. 制約事項

1. **Gemini APIリージョン**: us-central1のみ使用
2. **レスポンスサイズ**: 評価情報追加によるサイズ増加に注意
3. **後方互換性**: 既存の生成履歴との互換性を維持

---

## 8. 関連ドキュメント

- [設計書](./design.md)（作成予定）
- [タスク一覧](./tasks.md)（作成予定）
- Phase 13-17: AI統合（既存実装）

---

## 9. 承認

- [ ] 要件レビュー完了
- [ ] ステークホルダー承認
