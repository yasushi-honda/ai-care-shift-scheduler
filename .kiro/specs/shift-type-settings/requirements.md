# Phase 38: シフトタイプ設定UI - 要件定義書

**作成日**: 2025-11-26
**仕様ID**: shift-type-settings
**Phase**: 38
**ステータス**: 承認済み
**優先度**: 高

---

## 1. 背景と目的

### 1.1 現状の課題

現在のシステムでは、シフト種別（早番・日勤・遅番・夜勤など）が以下のようにハードコードされています：

- `constants.ts`: `DEFAULT_TIME_SLOTS`で固定定義
- `ShiftTable.tsx`: `SHIFT_CYCLE`と`getShiftColor()`がハードコード
- 事業所ごとのカスタマイズが不可能

**影響**:
- 異なる勤務体系を持つ事業所に対応できない
- シフトの開始・終了時間を変更できない
- 休憩時間の事業所ルールを反映できない

### 1.2 プロジェクトの目的

本機能（Phase 38）では、以下を実現します：

1. **シフト種別のカスタマイズUI**
   - シフト名、開始時間、終了時間、休憩時間を編集可能に
   - 新しいシフト種別の追加・削除
   - 表示色のカスタマイズ

2. **事業所単位での設定保存**
   - Firestoreに事業所ごとの設定を永続化
   - 設定変更はリアルタイムに反映

3. **既存機能との統合**
   - ShiftTableで動的にシフトサイクル・色を取得
   - AI生成で動的なシフト種別を使用

---

## 2. ステークホルダー

### 2.1 主要ステークホルダー

| 役割 | 説明 | 関心事 |
|------|------|--------|
| **管理者** | 事業所の設定を管理 | シフト種別の柔軟な設定 |
| **スタッフ** | シフト表を確認・編集 | わかりやすい表示 |
| **開発者** | 機能実装・保守 | 拡張性、保守性 |

---

## 3. 機能要件

### FR-38.1: シフト種別一覧表示

**説明**: 現在設定されているシフト種別の一覧を表示する。

**詳細要件**:
- シフト名、開始時間、終了時間、休憩時間を表示
- 各シフトの表示色をプレビュー
- 有効/無効状態を表示
- 並び順（sortOrder）順にソート

**受け入れ基準**:
- [ ] 一覧が正しく表示される
- [ ] 色のプレビューが表示される
- [ ] 並び順が反映される

---

### FR-38.2: シフト種別の追加

**説明**: 新しいシフト種別を追加できる。

**詳細要件**:
- 必須項目: シフト名、開始時間、終了時間
- オプション項目: 休憩時間（デフォルト: 1時間）、表示色
- 重複チェック: 同名のシフトは追加不可
- 追加後は末尾に追加（sortOrder自動設定）

**受け入れ基準**:
- [ ] 新しいシフト種別を追加できる
- [ ] 必須項目のバリデーションが機能する
- [ ] 重複名でエラーが表示される

---

### FR-38.3: シフト種別の編集

**説明**: 既存のシフト種別を編集できる。

**詳細要件**:
- シフト名、開始時間、終了時間、休憩時間、表示色を変更可能
- 変更は即座にFirestoreに保存
- 既存のシフトデータとの整合性を維持

**受け入れ基準**:
- [ ] 各項目を編集できる
- [ ] 変更が保存される
- [ ] ShiftTableに変更が反映される

---

### FR-38.4: シフト種別の削除/無効化

**説明**: 不要なシフト種別を削除または無効化できる。

**詳細要件**:
- 削除前に確認モーダルを表示
- 既存シフトで使用中の種別は削除不可（警告表示）
- 無効化（isActive=false）オプションを提供

**受け入れ基準**:
- [ ] 確認モーダルが表示される
- [ ] 使用中の種別は削除できない（警告あり）
- [ ] 無効化が機能する

---

### FR-38.5: シフトサイクル順序の設定

**説明**: ダブルクリック時のシフトサイクル順序を設定できる。

**詳細要件**:
- デフォルト: ["早番", "日勤", "遅番", "夜勤", "休", "明け休み"]
- ドラッグ&ドロップまたは上下ボタンで順序変更
- 「休」「明け休み」は常に含める

**受け入れ基準**:
- [ ] 順序を変更できる
- [ ] 変更がShiftTableに反映される

---

### FR-38.6: 表示色のカスタマイズ

**説明**: 各シフト種別の表示色を設定できる。

**詳細要件**:
- プリセット色から選択（sky, emerald, amber, indigo, slate等）
- 背景色と文字色のペアで設定
- プレビュー表示

**受け入れ基準**:
- [ ] 色を選択できる
- [ ] プレビューが表示される
- [ ] ShiftTableに色が反映される

---

## 4. 非機能要件

### NFR-38.1: パフォーマンス
- 設定画面の初期ロード: 2秒以内
- 保存処理: 1秒以内

### NFR-38.2: セキュリティ
- admin権限のみ設定変更可能
- viewer/editorは閲覧のみ

### NFR-38.3: ユーザビリティ
- 既存UIパターン（Accordion）に準拠
- 直感的な操作性

---

## 5. データモデル

### 5.1 ShiftTypeConfig

```typescript
interface ShiftTypeConfig {
  id: string;           // UUID
  name: string;         // "早番"
  start: string;        // "07:00"
  end: string;          // "16:00"
  restHours: number;    // 1
  color: {
    background: string; // "bg-sky-100"
    text: string;       // "text-sky-800"
  };
  isActive: boolean;
  sortOrder: number;
}
```

### 5.2 FacilityShiftSettings

```typescript
interface FacilityShiftSettings {
  facilityId: string;
  shiftTypes: ShiftTypeConfig[];
  defaultShiftCycle: string[];
  updatedAt: Timestamp;
  updatedBy: string;
}
```

---

## 6. 制約事項

1. **後方互換性**: 既存のスケジュールデータは維持
2. **デフォルト設定**: 初回アクセス時にDEFAULT_TIME_SLOTSから自動生成
3. **AI生成**: 動的なシフト種別をAI生成に渡す

---

## 7. 関連ドキュメント

- [設計書](./design.md)
- [タスク一覧](./tasks.md)
- [Phase 38 計画](./../../../.claude/plans/silly-fluttering-lighthouse.md)
