# Technical Design Document

## Overview

æœ¬æ©Ÿèƒ½ã¯ã€AIã‚·ãƒ•ãƒˆç”Ÿæˆã®å‰å¾Œã§ãƒ‡ãƒ¼ã‚¿è¨­å®šã®å•é¡Œã‚’æ¤œå‡ºã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å…·ä½“çš„ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’æä¾›ã™ã‚‹ã€‚æ—¢å­˜ã®`EvaluationService.analyzeStaffConstraints()`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æ‹¡å¼µã—ã€æ–°ã—ã„`DiagnosisService`ã¨`DiagnosisPanel`ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’è¿½åŠ ã™ã‚‹ã€‚

### è¨­è¨ˆæ–¹é‡

1. **æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã®æ´»ç”¨**: `StaffConstraintAnalysis`ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã¨`analyzeStaffConstraints()`ãƒ­ã‚¸ãƒƒã‚¯ã‚’å†åˆ©ç”¨
2. **ç–çµåˆ**: è¨ºæ–­æ©Ÿèƒ½ã‚’ç‹¬ç«‹ã—ãŸã‚µãƒ¼ãƒ“ã‚¹/ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨ã—ã¦å®Ÿè£…ã—ã€æ—¢å­˜æ©Ÿèƒ½ã¸ã®å½±éŸ¿ã‚’æœ€å°åŒ–
3. **æ®µéšçš„å®Ÿè£…**: äº‹å‰è¨ºæ–­ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ï¼‰â†’ æ ¹æœ¬åŸå› åˆ†æï¼ˆã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ï¼‰ã®é †ã§å®Ÿè£…

## Architecture

### ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆå›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Frontend (React)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ DiagnosisPanel  â”‚    â”‚      ShiftScheduleView         â”‚ â”‚
â”‚  â”‚  (æ–°è¦ä½œæˆ)      â”‚    â”‚   (æ—¢å­˜: è¨ºæ–­çµæœè¡¨ç¤ºã‚’è¿½åŠ )    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚           â”‚                             â”‚                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚              useDiagnosisService (æ–°è¦Hook)              â”‚â”‚
â”‚  â”‚  - runPreDiagnosis(): äº‹å‰è¨ºæ–­å®Ÿè¡Œ                       â”‚â”‚
â”‚  â”‚  - parseDiagnosisFromEvaluation(): è©•ä¾¡çµæœã‹ã‚‰è¨ºæ–­æŠ½å‡º  â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Backend (Cloud Functions)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚              DiagnosisService (æ–°è¦)                     â”‚â”‚
â”‚  â”‚  - diagnose(): äº‹å‰è¨ºæ–­å®Ÿè¡Œ                             â”‚â”‚
â”‚  â”‚  - analyzeRootCause(): æ ¹æœ¬åŸå› åˆ†æ                     â”‚â”‚
â”‚  â”‚  - generateSuggestions(): æ”¹å–„ææ¡ˆç”Ÿæˆ                  â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                             â”‚ extends                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚           EvaluationService (æ—¢å­˜)                       â”‚â”‚
â”‚  â”‚  - analyzeStaffConstraints(): ä¾›çµ¦/éœ€è¦åˆ†æ             â”‚â”‚
â”‚  â”‚  - generateRecommendations(): æ”¹å–„ææ¡ˆ                   â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å‡¦ç†ãƒ•ãƒ­ãƒ¼

#### äº‹å‰è¨ºæ–­ãƒ•ãƒ­ãƒ¼ï¼ˆç”Ÿæˆå‰ï¼‰

```
User opens ShiftScheduleView
        â”‚
        â–¼
useDiagnosisService.runPreDiagnosis()
        â”‚
        â–¼
DiagnosisService.diagnose(staffList, requirements)
        â”‚
        â”œâ”€â”€ analyzeSupplyDemand(): ä¾›çµ¦/éœ€è¦ãƒãƒ©ãƒ³ã‚¹è¨ˆç®—
        â”‚
        â”œâ”€â”€ analyzeTimeSlotConstraints(): æ™‚é–“å¸¯åˆ¶ç´„åˆ†æ
        â”‚
        â””â”€â”€ generateSuggestions(): æ”¹å–„ææ¡ˆç”Ÿæˆ
        â”‚
        â–¼
DiagnosisPanel displays results
        â”‚
        â–¼
User clicks "ã‚·ãƒ•ãƒˆä½œæˆå®Ÿè¡Œ" (warning acknowledged)
```

#### æ ¹æœ¬åŸå› åˆ†æãƒ•ãƒ­ãƒ¼ï¼ˆç”Ÿæˆå¾Œï¼‰

```
AI Generation completes with violations
        â”‚
        â–¼
EvaluationService.evaluateSchedule() returns violations
        â”‚
        â–¼
DiagnosisService.analyzeRootCause(violations, staffList, requirements)
        â”‚
        â”œâ”€â”€ categorizeViolations(): é•åã‚’åŸå› åˆ¥ã«åˆ†é¡
        â”‚
        â”œâ”€â”€ identifyDataConfigIssues(): ãƒ‡ãƒ¼ã‚¿è¨­å®šå•é¡Œã‚’ç‰¹å®š
        â”‚
        â””â”€â”€ generateDetailedExplanation(): å…·ä½“çš„ãªèª¬æ˜ç”Ÿæˆ
        â”‚
        â–¼
EvaluationPanel displays root cause + suggestions
```

## Components

### 1. DiagnosisService (Backend)

**ãƒ•ã‚¡ã‚¤ãƒ«**: `functions/src/diagnosis/diagnosisService.ts`

```typescript
interface DiagnosisResult {
  status: 'ok' | 'warning' | 'error';
  summary: string;
  supplyDemandBalance: SupplyDemandBalance;
  issues: DiagnosisIssue[];
  suggestions: DiagnosisSuggestion[];
  executedAt: string;
}

interface SupplyDemandBalance {
  totalSupply: number;        // ç·ä¾›çµ¦äººæ—¥æ•°
  totalDemand: number;        // ç·å¿…è¦äººæ—¥æ•°
  balance: number;            // éä¸è¶³ï¼ˆæ­£=ä½™å‰°ã€è² =ä¸è¶³ï¼‰
  byTimeSlot: {
    [slotName: string]: {
      supply: number;
      demand: number;
      balance: number;
    };
  };
}

interface DiagnosisIssue {
  id: string;
  severity: 'high' | 'medium' | 'low';
  category: 'supply' | 'timeSlot' | 'leave' | 'other';
  title: string;
  description: string;
  affectedStaff?: string[];   // é–¢é€£ã‚¹ã‚¿ãƒƒãƒ•å
  affectedDates?: string[];   // é–¢é€£æ—¥ä»˜
}

interface DiagnosisSuggestion {
  priority: 'high' | 'medium' | 'low';
  action: string;
  impact: string;             // å®Ÿè¡Œæ™‚ã®åŠ¹æœ
  targetStaff?: string;       // å¯¾è±¡ã‚¹ã‚¿ãƒƒãƒ•ï¼ˆã„ã‚Œã°ï¼‰
}
```

**ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰**:

| ãƒ¡ã‚½ãƒƒãƒ‰ | èª¬æ˜ | å…¥åŠ› | å‡ºåŠ› |
|---------|------|------|------|
| `diagnose()` | äº‹å‰è¨ºæ–­ã‚’å®Ÿè¡Œ | staffList, requirements | DiagnosisResult |
| `analyzeRootCause()` | é•åã®æ ¹æœ¬åŸå› ã‚’åˆ†æ | violations, staffList, requirements | RootCauseAnalysis |
| `generateSuggestions()` | æ”¹å–„ææ¡ˆã‚’ç”Ÿæˆ | issues | DiagnosisSuggestion[] |

### 2. DiagnosisPanel (Frontend)

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/components/DiagnosisPanel.tsx`

**Props**:
```typescript
interface DiagnosisPanelProps {
  diagnosis: DiagnosisResult | null;
  isLoading: boolean;
  onRefresh: () => void;
  onDismiss: () => void;
}
```

**UIæ§‹æˆ**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“Š ãƒ‡ãƒ¼ã‚¿è¨­å®šè¨ºæ–­                              [æ›´æ–°] [Ã—]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  âš ï¸ è­¦å‘Š: æ—©ç•ªãƒ»é…ç•ªã®äººå“¡ãŒä¸è¶³ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™        â”‚
â”‚                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ“ˆ éœ€çµ¦ãƒãƒ©ãƒ³ã‚¹                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ å…¨ä½“: ä¾›çµ¦ 180äººæ—¥ / éœ€è¦ 200äººæ—¥ (â–¼20äººæ—¥ä¸è¶³)        â”‚â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
â”‚  â”‚ æ—©ç•ª:   45äººæ—¥ /  60äººæ—¥ (â–¼15äººæ—¥)  [â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘] 75%    â”‚â”‚
â”‚  â”‚ æ—¥å‹¤:   90äººæ—¥ /  60äººæ—¥ (â–²30äººæ—¥)  [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ] 150%   â”‚â”‚
â”‚  â”‚ é…ç•ª:   45äººæ—¥ /  60äººæ—¥ (â–¼15äººæ—¥)  [â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘] 75%    â”‚â”‚
â”‚  â”‚ å¤œå‹¤:   -- äººæ—¥ /  20äººæ—¥                              â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âš¡ æ¤œå‡ºã•ã‚ŒãŸå•é¡Œ (2ä»¶)                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ ğŸ”´ é«˜: ã€Œæ—¥å‹¤ã®ã¿ã€ã‚¹ã‚¿ãƒƒãƒ•ãŒæ—¥å‹¤æ ã‚’å æœ‰               â”‚â”‚
â”‚  â”‚    ç”°ä¸­å¤ªéƒã€å±±ç”°èŠ±å­ã®2åãŒã€Œæ—¥å‹¤ã®ã¿ã€è¨­å®šã§          â”‚â”‚
â”‚  â”‚    æ—¥å‹¤å¿…è¦æ•°ã®70%ã‚’æ¶ˆè²»ã—ã¦ã„ã¾ã™                      â”‚â”‚
â”‚  â”‚    â†’ ã‚¹ã‚¿ãƒƒãƒ•è¨­å®šç”»é¢ã¸                                 â”‚â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
â”‚  â”‚ ğŸŸ¡ ä¸­: 12/25ã«ä¼‘æš‡ç”³è«‹ãŒé›†ä¸­                            â”‚â”‚
â”‚  â”‚    ä½è—¤ã€éˆ´æœ¨ã€é«˜æ©‹ã®3åãŒä¼‘æš‡ç”³è«‹                      â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ’¡ æ”¹å–„ææ¡ˆ                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ â˜…â˜…â˜… å±±ç”°èŠ±å­ã®æ™‚é–“å¸¯è¨­å®šã‚’ã€Œã„ã¤ã§ã‚‚å¯ã€ã«å¤‰æ›´        â”‚â”‚
â”‚  â”‚      â†’ æ—©ç•ªãƒ»é…ç•ªã®æŸ”è»Ÿæ€§ãŒå‘ä¸Šã—ã¾ã™                  â”‚â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
â”‚  â”‚ â˜…â˜…â˜† æ—©ç•ªãƒ»é…ç•ªå¯¾å¿œå¯èƒ½ãªã‚¹ã‚¿ãƒƒãƒ•ã‚’1åè¿½åŠ             â”‚â”‚
â”‚  â”‚      â†’ 15äººæ—¥ã®ä¸è¶³ãŒè§£æ¶ˆã•ã‚Œã¾ã™                      â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â„¹ï¸ è­¦å‘ŠãŒã‚ã£ã¦ã‚‚ã‚·ãƒ•ãƒˆä½œæˆã¯å®Ÿè¡Œå¯èƒ½ã§ã™                  â”‚
â”‚                                     [ã‚·ãƒ•ãƒˆä½œæˆå®Ÿè¡Œ â†’]      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. useDiagnosisService (Frontend Hook)

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/hooks/useDiagnosisService.ts`

```typescript
interface UseDiagnosisServiceReturn {
  diagnosis: DiagnosisResult | null;
  isLoading: boolean;
  error: string | null;
  runDiagnosis: (staffList: Staff[], requirements: ShiftRequirement) => Promise<void>;
  clearDiagnosis: () => void;
}

function useDiagnosisService(): UseDiagnosisServiceReturn;
```

**æ©Ÿèƒ½**:
- è¨ºæ–­å®Ÿè¡Œã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã§è¨ˆç®—ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¦ä»¶: 1ç§’ä»¥å†…ï¼‰
- çµæœã‚’ãƒ­ãƒ¼ã‚«ãƒ«çŠ¶æ…‹ã§ç®¡ç†
- ã‚·ãƒ•ãƒˆè¦ä»¶ã¾ãŸã¯ã‚¹ã‚¿ãƒƒãƒ•è¨­å®šå¤‰æ›´æ™‚ã«è‡ªå‹•å†å®Ÿè¡Œ

### 4. EvaluationPanelæ‹¡å¼µ (Frontend)

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/components/EvaluationPanel.tsx` (æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ä¿®æ­£)

**è¿½åŠ æ©Ÿèƒ½**:
- æ ¹æœ¬åŸå› ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆ`RootCauseSection`ï¼‰ã‚’è¿½åŠ 
- æ—¢å­˜ã®`RecommendationsSection`ã«æ”¹å–„ææ¡ˆã‚’çµ±åˆ

```typescript
// æ–°è¦è¿½åŠ : æ ¹æœ¬åŸå› è¡¨ç¤ºã‚»ã‚¯ã‚·ãƒ§ãƒ³
function RootCauseSection({ rootCause }: { rootCause: RootCauseAnalysis }) {
  return (
    <section>
      <h4>ğŸ“‹ æ ¹æœ¬åŸå› åˆ†æ</h4>
      {rootCause.causes.map(cause => (
        <div key={cause.id}>
          <span>{cause.description}</span>
          {cause.affectedStaff && (
            <span>é–¢é€£: {cause.affectedStaff.join('ã€')}</span>
          )}
        </div>
      ))}
    </section>
  );
}
```

## Data Models

### DiagnosisResult

```typescript
interface DiagnosisResult {
  /** è¨ºæ–­ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ */
  status: 'ok' | 'warning' | 'error';

  /** ã‚µãƒãƒªãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
  summary: string;

  /** éœ€çµ¦ãƒãƒ©ãƒ³ã‚¹ */
  supplyDemandBalance: SupplyDemandBalance;

  /** æ¤œå‡ºã•ã‚ŒãŸå•é¡Œãƒªã‚¹ãƒˆ */
  issues: DiagnosisIssue[];

  /** æ”¹å–„ææ¡ˆãƒªã‚¹ãƒˆ */
  suggestions: DiagnosisSuggestion[];

  /** è¨ºæ–­å®Ÿè¡Œæ—¥æ™‚ */
  executedAt: string;
}
```

### SupplyDemandBalance

```typescript
interface SupplyDemandBalance {
  /** ç·ä¾›çµ¦äººæ—¥æ•° */
  totalSupply: number;

  /** ç·å¿…è¦äººæ—¥æ•° */
  totalDemand: number;

  /** éä¸è¶³ï¼ˆæ­£=ä½™å‰°ã€è² =ä¸è¶³ï¼‰ */
  balance: number;

  /** æ™‚é–“å¸¯åˆ¥ãƒãƒ©ãƒ³ã‚¹ */
  byTimeSlot: {
    [slotName: string]: {
      supply: number;
      demand: number;
      balance: number;
      fulfillmentRate: number; // 0-100%
    };
  };
}
```

### DiagnosisIssue

```typescript
interface DiagnosisIssue {
  /** ä¸€æ„è­˜åˆ¥å­ */
  id: string;

  /** é‡è¦åº¦ */
  severity: 'high' | 'medium' | 'low';

  /** ã‚«ãƒ†ã‚´ãƒª */
  category: 'supply' | 'timeSlot' | 'leave' | 'other';

  /** ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆçŸ­ã„èª¬æ˜ï¼‰ */
  title: string;

  /** è©³ç´°èª¬æ˜ */
  description: string;

  /** å½±éŸ¿ã‚’å—ã‘ã‚‹ã‚¹ã‚¿ãƒƒãƒ•å */
  affectedStaff?: string[];

  /** å½±éŸ¿ã‚’å—ã‘ã‚‹æ—¥ä»˜ */
  affectedDates?: string[];

  /** é–¢é€£ã™ã‚‹è¨­å®šç”»é¢ã¸ã®ãƒªãƒ³ã‚¯ãƒ‘ã‚¹ */
  settingsLink?: string;
}
```

### DiagnosisSuggestion

```typescript
interface DiagnosisSuggestion {
  /** å„ªå…ˆåº¦ï¼ˆâ˜…ã®æ•°ã§è¡¨ç¤ºï¼‰ */
  priority: 'high' | 'medium' | 'low';

  /** ææ¡ˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³ */
  action: string;

  /** å®Ÿè¡Œæ™‚ã®åŠ¹æœ */
  impact: string;

  /** å¯¾è±¡ã‚¹ã‚¿ãƒƒãƒ•ï¼ˆç‰¹å®šã®å ´åˆï¼‰ */
  targetStaff?: string;

  /** é–¢é€£ã™ã‚‹è¨­å®šç”»é¢ã¸ã®ãƒªãƒ³ã‚¯ãƒ‘ã‚¹ */
  settingsLink?: string;
}
```

### RootCauseAnalysis (ç”Ÿæˆå¾Œè©•ä¾¡ç”¨)

```typescript
interface RootCauseAnalysis {
  /** é•åã®æ ¹æœ¬åŸå› ãƒªã‚¹ãƒˆ */
  causes: RootCause[];

  /** AIã‚³ãƒ¡ãƒ³ãƒˆã«è¿½åŠ ã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆ */
  aiCommentAddition: string;
}

interface RootCause {
  /** åŸå› ID */
  id: string;

  /** é–¢é€£ã™ã‚‹é•åã‚¿ã‚¤ãƒ— */
  violationType: ConstraintViolationType;

  /** åŸå› ã®ç¨®é¡ */
  causeType: 'staffShortage' | 'timeSlotConstraint' | 'leaveConflict' | 'other';

  /** èª¬æ˜ */
  description: string;

  /** å½±éŸ¿ã‚’å—ã‘ã‚‹ã‚¹ã‚¿ãƒƒãƒ• */
  affectedStaff?: string[];

  /** ãƒ‡ãƒ¼ã‚¿ã§è¨¼æ˜å¯èƒ½ãªæ•°å€¤ */
  evidence?: {
    required: number;
    available: number;
    shortage: number;
  };
}
```

## Implementation Strategy

### Phase 1: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰è¨ºæ–­ã‚µãƒ¼ãƒ“ã‚¹

1. `functions/src/diagnosis/diagnosisService.ts` ä½œæˆ
2. `DiagnosisService` ã‚¯ãƒ©ã‚¹å®Ÿè£…
   - æ—¢å­˜ã®`analyzeStaffConstraints()`ãƒ­ã‚¸ãƒƒã‚¯ã‚’æ´»ç”¨
   - æ™‚é–“å¸¯åˆ¥ã®éœ€çµ¦è¨ˆç®—ã‚’è¿½åŠ 
3. å˜ä½“ãƒ†ã‚¹ãƒˆä½œæˆ

### Phase 2: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰è¨ºæ–­UI

1. `src/types/diagnosis.ts` - å‹å®šç¾©
2. `src/hooks/useDiagnosisService.ts` - è¨ºæ–­ãƒ•ãƒƒã‚¯
3. `src/components/DiagnosisPanel.tsx` - è¨ºæ–­UI
4. ã‚·ãƒ•ãƒˆä½œæˆç”»é¢ã¸ã®çµ±åˆ

### Phase 3: æ ¹æœ¬åŸå› åˆ†æ

1. `DiagnosisService.analyzeRootCause()` å®Ÿè£…
2. `EvaluationPanel` æ‹¡å¼µï¼ˆRootCauseSectionè¿½åŠ ï¼‰
3. è©•ä¾¡APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«æ ¹æœ¬åŸå› ã‚’è¿½åŠ 

### Phase 4: æ”¹å–„ææ¡ˆå¼·åŒ–

1. å„ªå…ˆåº¦ä»˜ãæ”¹å–„ææ¡ˆãƒ­ã‚¸ãƒƒã‚¯å®Ÿè£…
2. è¨­å®šç”»é¢ã¸ã®ãƒªãƒ³ã‚¯è¿½åŠ 
3. çµ±åˆãƒ†ã‚¹ãƒˆ

## Testing Strategy

### ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ

| ãƒ†ã‚¹ãƒˆå¯¾è±¡ | ãƒ•ã‚¡ã‚¤ãƒ« | ã‚«ãƒãƒ¬ãƒƒã‚¸ç›®æ¨™ |
|-----------|---------|---------------|
| DiagnosisService | `functions/__tests__/unit/diagnosisService.test.ts` | 90% |
| useDiagnosisService | `src/hooks/__tests__/useDiagnosisService.test.ts` | 85% |
| DiagnosisPanel | `src/components/__tests__/DiagnosisPanel.test.tsx` | 80% |

### çµ±åˆãƒ†ã‚¹ãƒˆ

| ã‚·ãƒŠãƒªã‚ª | æœŸå¾…çµæœ |
|---------|---------|
| æ­£å¸¸ãƒ‡ãƒ¼ã‚¿ï¼ˆååˆ†ãªã‚¹ã‚¿ãƒƒãƒ•ï¼‰ | status: 'ok', issues: [] |
| äººå“¡ä¸è¶³ï¼ˆç·æ•°ä¸è¶³ï¼‰ | status: 'error', issueså«ã‚€ä¾›çµ¦ä¸è¶³ |
| æ™‚é–“å¸¯åˆ¶ç´„å•é¡Œ | status: 'warning', å…·ä½“çš„ãªã‚¹ã‚¿ãƒƒãƒ•åå«ã‚€ |
| ä¼‘æš‡é›†ä¸­æ—¥ | status: 'warning', æ—¥ä»˜ã¨ç”³è«‹è€…åå«ã‚€ |

### E2Eãƒ†ã‚¹ãƒˆ

1. ã‚·ãƒ•ãƒˆä½œæˆç”»é¢ã§è¨ºæ–­ãƒ‘ãƒãƒ«è¡¨ç¤ºç¢ºèª
2. è­¦å‘Šã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°å±•é–‹ç¢ºèª
3. ã‚·ãƒ•ãƒˆç”Ÿæˆå¾Œã®æ ¹æœ¬åŸå› è¡¨ç¤ºç¢ºèª

## Non-Functional Requirements

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹

- äº‹å‰è¨ºæ–­: 1ç§’ä»¥å†…å®Œäº†ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰è¨ˆç®—ï¼‰
- UIãƒ–ãƒ­ãƒƒã‚¯ç¦æ­¢ï¼ˆãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å®Ÿè¡Œï¼‰
- ã‚¹ã‚¿ãƒƒãƒ•50åä»¥ä¸Šã§ã‚‚é…å»¶ãªã—

### ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£

- è­¦å‘Šã‚¢ã‚¤ã‚³ãƒ³ã«aria-labelè¨­å®š
- ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œ
- ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒªãƒ¼ãƒ€ãƒ¼å¯¾å¿œï¼ˆaria-liveï¼‰

### ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³

- ãƒ¢ãƒã‚¤ãƒ«: ç°¡ç•¥åŒ–è¡¨ç¤ºï¼ˆã‚°ãƒ©ãƒ•çœç•¥ï¼‰
- ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆ/ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—: å®Œå…¨è¡¨ç¤º

## Dependencies

### æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã¸ã®ä¾å­˜

| ä¾å­˜å…ˆ | ç”¨é€” |
|-------|------|
| `EvaluationService` | `analyzeStaffConstraints()`ãƒ­ã‚¸ãƒƒã‚¯æµç”¨ |
| `StaffConstraintAnalysis` | ãƒ‡ãƒ¼ã‚¿å‹ã®åŸºç›¤ |
| `CONSTRAINT_LEVEL_MAPPING` | é•åãƒ¬ãƒ™ãƒ«åˆ¤å®š |
| `EvaluationPanel` | UIãƒ‘ã‚¿ãƒ¼ãƒ³å‚è€ƒ |

### æ–°è¦ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸

ãªã—ï¼ˆæ—¢å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§å®Ÿè£…å¯èƒ½ï¼‰

## Security Considerations

- ã‚¹ã‚¿ãƒƒãƒ•åã¯æ–½è¨­å†…ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã®ã¿è¡¨ç¤ºï¼ˆæ—¢å­˜ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã«æº–æ‹ ï¼‰
- è¨ºæ–­çµæœã¯Firestoreã«ä¿å­˜ã—ãªã„ï¼ˆä¸€æ™‚çš„ãªã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆçŠ¶æ…‹ã®ã¿ï¼‰

## Rollback Plan

æ©Ÿèƒ½ãƒ•ãƒ©ã‚°ã‚’ä½¿ç”¨ã—ã¦æ®µéšçš„ã«ãƒªãƒªãƒ¼ã‚¹:

```typescript
const FEATURE_FLAGS = {
  ENABLE_PRE_DIAGNOSIS: true,    // Phase 2å®Œäº†å¾ŒON
  ENABLE_ROOT_CAUSE: false,      // Phase 3å®Œäº†å¾ŒON
  ENABLE_SUGGESTIONS: false,     // Phase 4å®Œäº†å¾ŒON
};
```
