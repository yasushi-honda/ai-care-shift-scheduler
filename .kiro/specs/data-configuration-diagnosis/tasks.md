# Implementation Plan

## Phase 55: データ設定診断機能

---

- [x] 1. 診断機能の型定義と基盤を構築する
- [x] 1.1 診断関連の型定義を作成する
  - 診断結果の状態（正常/警告/エラー）を表す型を定義する
  - 需給バランスの計算結果を格納する型を定義する（総供給、総需要、時間帯別バランス）
  - 検出された問題を表す型を定義する（重要度、カテゴリ、説明、関連スタッフ）
  - 改善提案を表す型を定義する（優先度、アクション、効果）
  - 根本原因分析の結果を格納する型を定義する
  - _Requirements: 2.1, 2.2, 2.4, 3.1, 4.5_

---

- [x] 2. バックエンド診断サービスを実装する
- [x] 2.1 需給バランス計算ロジックを実装する
  - 営業日数を計算する機能を実装する（曜日、夜勤有無を考慮）
  - 各時間帯の必要人日数を計算する（必要人員 × 営業日数）
  - 各スタッフの供給可能人日数を計算する（週希望勤務日数 × 月の週数）
  - 時間帯制約（「日勤のみ」等）を考慮した時間帯別供給量を計算する
  - 全体および時間帯別の需給バランス（過不足）を算出する
  - _Requirements: 2.1, 2.2, 2.3, 2.4_

- [x] 2.2 問題検出ロジックを実装する
  - 総供給人日数が総需要人日数を下回る場合の問題を検出する
  - 特定時間帯の供給不足を検出する（早番・遅番など）
  - 「日勤のみ」スタッフが日勤枠を占有している問題を検出する
  - 特定日に休暇申請が集中している問題を検出する
  - 検出した問題に重要度（高/中/低）を付与する
  - _Requirements: 1.3, 1.4, 3.2, 4.4_

- [x] 2.3 改善提案生成ロジックを実装する
  - 時間帯制約が原因の場合、具体的なスタッフ名と変更提案を生成する
  - スタッフ数不足の場合、必要な追加人数と担当時間帯を提案する
  - 休暇集中の場合、該当日と申請者一覧を表示する提案を生成する
  - 各提案に優先度を付与し、効果の説明を追加する
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5_

- [x] 2.4 診断サービスの単体テストを作成する
  - 十分なスタッフがいる場合に正常ステータスを返すことを検証する
  - 人員不足の場合にエラーステータスと具体的な不足数を返すことを検証する
  - 時間帯制約問題がある場合に警告と該当スタッフ名を返すことを検証する
  - 改善提案が優先度順にソートされていることを検証する
  - _Requirements: 6.1, 6.3_

---

- [x] 3. フロントエンド診断フックを実装する
- [x] 3.1 診断実行フックを作成する
  - 診断結果の状態管理機能を実装する（結果、ローディング、エラー）
  - スタッフリストとシフト要件を受け取り診断を実行する機能を実装する
  - 診断結果をクリアする機能を実装する
  - 診断処理を1秒以内に完了させる（クライアントサイド計算）
  - _Requirements: 1.1, 6.1, 6.2_

- [x] 3.2 自動診断トリガーを実装する
  - シフト作成画面を開いた時に自動的に診断を実行する
  - スタッフ設定またはシフト要件が変更された時に再診断を実行する
  - バックグラウンドで実行し、UIをブロックしない
  - _Requirements: 1.1, 6.2_

- [x] 3.3 診断フックの単体テストを作成する
  - 初期状態が正しいことを検証する
  - 診断実行後に結果が正しく設定されることを検証する
  - エラー発生時に適切なエラー状態になることを検証する
  - _Requirements: 6.1_

---

- [x] 4. 診断パネルUIを実装する
- [x] 4.1 サマリーセクションを実装する
  - 全体の状態（正常/警告/エラー）をアイコンと色で表示する
  - サマリーメッセージを画面上部に表示する
  - 警告アイコンをクリック可能にし、詳細展開のトリガーとする
  - _Requirements: 1.2, 5.1_

- [x] 4.2 需給バランスセクションを実装する
  - 全体の供給/需要/過不足を数値で表示する
  - 時間帯別（早番・日勤・遅番・夜勤）のバランスを表形式で表示する
  - 充足率をプログレスバーで視覚化する
  - 不足している時間帯を赤色でハイライト表示する
  - _Requirements: 2.2, 2.4, 5.1_

- [x] 4.3 問題リストセクションを実装する
  - 検出された問題を重要度順にソートして表示する
  - 各問題の重要度をアイコン（赤/黄/青）で表示する
  - 関連するスタッフ名と影響を具体的に表示する
  - 問題項目をクリックすると関連設定画面へのリンクを表示する
  - _Requirements: 1.4, 3.4, 5.1, 5.2, 5.4_

- [x] 4.4 改善提案セクションを実装する
  - 改善提案を優先度順に表示する（★マークで優先度を視覚化）
  - 各提案のアクション内容と期待される効果を表示する
  - 対象スタッフがいる場合は名前を表示する
  - _Requirements: 4.1, 4.5, 5.1_

- [x] 4.5 診断パネル全体の統合とスタイリングを行う
  - 更新ボタンと閉じるボタンを実装する
  - 「警告があってもシフト作成は実行可能」のメッセージを表示する
  - レスポンシブデザインを実装する（モバイルでは簡略化表示）
  - アクセシビリティ対応を実装する（aria-label、キーボードナビゲーション）
  - _Requirements: 5.3, 6.4_

- [x] 4.6 診断パネルのコンポーネントテストを作成する
  - 各状態（正常/警告/エラー）で正しい表示になることを検証する
  - 問題リストが重要度順にソートされていることを検証する
  - 更新ボタンクリックでonRefreshが呼ばれることを検証する
  - _Requirements: 5.2_

---

- [x] 5. シフト作成画面に診断パネルを統合する
- [x] 5.1 シフト作成画面に診断パネルを配置する
  - 画面上部に警告サマリーを表示する領域を追加する
  - 診断パネルの展開/折りたたみ機能を実装する
  - シフト作成実行ボタンは警告があっても有効のまま維持する
  - _Requirements: 1.2, 1.5, 5.3_

- [x] 5.2 統合テストを作成する
  - シフト作成画面を開いた時に診断が自動実行されることを検証する
  - 警告がある状態でもシフト作成実行ができることを検証する
  - 診断パネルの展開/折りたたみが正しく動作することを検証する
  - _Requirements: 1.1, 5.3_

---

- [x] 6. 根本原因分析機能を実装する
- [x] 6.1 違反の根本原因分析ロジックを実装する
  - 人員不足違反が発生した時間帯を特定する
  - 不足の原因を分類する（スタッフ数不足/時間帯制約/休暇申請）
  - 時間帯制約が原因の場合、具体的なスタッフ名と制約内容を特定する
  - 数値的な根拠（必要数、利用可能数、不足数）を算出する
  - _Requirements: 3.1, 3.2, 3.4_

- [x] 6.2 AIコメントに根本原因説明を追加する
  - 違反の根本原因をわかりやすい文章で生成する
  - 具体的なスタッフ名と制約内容を含める
  - 既存のAIコメント生成ロジックに統合する
  - _Requirements: 3.3, 3.4_

- [x] 6.3 評価パネルに根本原因セクションを追加する
  - 根本原因分析結果を表示するセクションを追加する
  - 原因ごとに関連スタッフと数値的根拠を表示する
  - 既存の評価パネルUIパターンに合わせたデザインにする
  - _Requirements: 3.3, 5.1_

- [x] 6.4 根本原因分析の単体テストを作成する
  - 人員不足違反の原因が正しく特定されることを検証する
  - 時間帯制約が原因の場合に該当スタッフ名が含まれることを検証する
  - AIコメントに根本原因説明が追加されることを検証する
  - _Requirements: 3.1, 3.2, 3.3_

---

- [x] 7. E2Eテストと最終統合を行う
- [x] 7.1 診断機能のE2Eテストを作成する
  - シフト作成画面で診断パネルが表示されることを検証する
  - 警告クリックで詳細が展開されることを検証する
  - シフト生成後に根本原因が表示されることを検証する
  - _Requirements: 1.2, 1.5, 3.3_

- [x] 7.2 パフォーマンステストを実施する
  - 診断処理が1秒以内に完了することを検証する
  - スタッフ50名以上のデータでも遅延なく動作することを検証する
  - UIがブロックされないことを検証する
  - _Requirements: 6.1, 6.2, 6.3_
