# Requirements Document

## Introduction

本機能は、AIシフト生成の前後でデータ設定の問題を検出し、ユーザーに具体的なフィードバックを提供する。現状のシステムは生成結果（「人員不足17件」など）のみを表示するが、**なぜそうなるのか**（根本原因）を説明していない。本機能により、ユーザーはデータ設定の問題を理解し、適切な対策を取れるようになる。

### 背景

本番テスト（2025-12-30）で発覚した問題：
- AIシフト生成は正常動作（Lv1違反0件）
- Lv2違反が62件発生（人員不足17件など）
- 根本原因：スタッフ設定とシフト要件のミスマッチ
  - 「日勤のみ」設定のスタッフがいるため早番・遅番に配置不可
  - 結果、早番・遅番の人員が不足

## Requirements

### Requirement 1: 事前診断（生成前チェック）

**Objective:** 管理者として、AIシフト生成を実行する前にデータ設定の問題を把握したい。これにより、生成失敗や大量の違反を未然に防げる。

#### Acceptance Criteria

1. WHEN ユーザーがシフト作成画面を開いた THEN データ設定診断サービスは スタッフ数とシフト要件の整合性を自動的にチェックする
2. WHEN 診断で問題が検出された THEN データ設定診断サービスは 警告アイコンとサマリーメッセージを画面上部に表示する
3. IF スタッフの週希望勤務日数の合計が必要人日数を下回る THEN データ設定診断サービスは 「スタッフの勤務日数が不足しています」と警告を表示する
4. IF 特定の時間帯に配置可能なスタッフ数が要件を満たせない THEN データ設定診断サービスは 該当する時間帯と不足数を具体的に表示する
5. WHEN ユーザーが警告アイコンをクリックした THEN データ設定診断サービスは 詳細な診断結果と改善提案を表示する

### Requirement 2: 人員供給量の計算と表示

**Objective:** 管理者として、スタッフの勤務可能日数と必要人日数のバランスを視覚的に把握したい。これにより、人員計画の判断材料を得られる。

#### Acceptance Criteria

1. WHEN 診断を実行した THEN データ設定診断サービスは 以下の計算を行う：
   - 需要：各時間帯の必要人員 × 営業日数
   - 供給：各スタッフの週希望勤務日数 × 月の週数
2. WHEN 供給量が需要量を下回る THEN データ設定診断サービスは 不足量を数値で表示する（例：「15人日不足」）
3. IF スタッフに時間帯制約（「日勤のみ」等）がある THEN データ設定診断サービスは その制約を考慮して時間帯別の供給量を計算する
4. WHEN 時間帯別の需給バランスを計算した THEN データ設定診断サービスは 早番・日勤・遅番・夜勤ごとの過不足を表示する

### Requirement 3: 根本原因分析（生成後フィードバック強化）

**Objective:** 管理者として、生成後の評価結果を見たとき、なぜ違反が発生したのかを理解したい。これにより、適切な対策を取れる。

#### Acceptance Criteria

1. WHEN AIシフト生成が完了した THEN 評価サービスは 違反の根本原因を分析する
2. IF 人員不足違反が発生した THEN 評価サービスは 以下を特定する：
   - どの時間帯で不足が発生したか
   - 不足の原因（スタッフ数不足 / 時間帯制約 / 休暇申請 など）
3. WHEN 根本原因が特定された THEN 評価サービスは AIコメント欄に原因の説明を含める
4. IF 時間帯制約が原因の場合 THEN 評価サービスは 具体的なスタッフ名と制約内容を表示する（例：「田中太郎は『日勤のみ』設定のため早番・遅番に配置できません」）

### Requirement 4: 改善提案の表示

**Objective:** 管理者として、問題を解決するための具体的なアクションを知りたい。これにより、試行錯誤なく設定を改善できる。

#### Acceptance Criteria

1. WHEN データ設定の問題が検出された THEN データ設定診断サービスは 具体的な改善提案を生成する
2. IF スタッフの時間帯制約が原因 THEN データ設定診断サービスは 「○○さんの時間帯設定を『いつでも可』に変更」を提案する
3. IF スタッフ数が根本的に不足 THEN データ設定診断サービスは 「早番・遅番対応可能なスタッフを○名追加」を提案する
4. IF 特定日に休暇申請が集中 THEN データ設定診断サービスは 該当日と休暇申請者を表示する
5. WHEN 改善提案を表示した THEN データ設定診断サービスは 各提案の優先度（高/中/低）を付与する

### Requirement 5: 診断結果の詳細表示UI

**Objective:** 管理者として、診断結果を分かりやすい形式で確認したい。これにより、問題の全体像を把握できる。

#### Acceptance Criteria

1. WHEN 診断結果を表示する THEN UIは 以下のセクションを含む：
   - サマリー（全体の状態：正常/警告/エラー）
   - 需給バランス（時間帯別の棒グラフまたは表）
   - 問題リスト（検出された問題の一覧）
   - 改善提案（具体的なアクション一覧）
2. IF 問題が複数ある THEN UIは 重要度順にソートして表示する
3. WHILE 診断結果を表示中 THE UIは 「シフト作成実行」ボタンを有効のまま維持する（警告があっても生成は可能）
4. WHEN ユーザーが問題項目をクリックした THEN UIは 関連するスタッフまたはシフト要件設定画面へのリンクを表示する

### Requirement 6: 非機能要件

**Objective:** システムとして、診断機能がユーザー体験を損なわないようにしたい。

#### Acceptance Criteria

1. WHEN 診断を実行した THEN 診断処理は 1秒以内に完了する
2. WHILE シフト作成画面を表示中 THE 診断は バックグラウンドで実行され、UIをブロックしない
3. IF スタッフ数が50名を超える THEN 診断サービスは パフォーマンスを維持しながら処理を完了する
4. WHEN 診断結果を表示する THEN UIは レスポンシブデザインに対応し、モバイル・タブレットでも閲覧可能である
