# Phase 43: ãƒ‡ãƒ¢ç’°å¢ƒæ”¹å–„ãƒ»æ’ä»–åˆ¶å¾¡ - æŠ€è¡“è¨­è¨ˆ

**ä½œæˆæ—¥**: 2025-12-07
**æœ€çµ‚æ›´æ–°**: 2025-12-08
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: Phase 43.2 è¨­è¨ˆå¤‰æ›´ä¸­

---

## Phase 43.2 å¤‰æ›´æ¦‚è¦

### å¤‰æ›´ç†ç”±

Phase 43ã®ã€Œãƒ‡ãƒ¢ç’°å¢ƒã§ã¯ä¿å­˜ã—ãªã„ã€è¨­è¨ˆã«ã‚ˆã‚Šã€ä»¥ä¸‹ã®å•é¡ŒãŒç™ºç”Ÿï¼š

- AIç”Ÿæˆã—ãŸã‚·ãƒ•ãƒˆãŒæœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆã«åæ˜ ã•ã‚Œãªã„
- ãƒ‡ãƒ¢ä½“é¨“ã®ä¸€è²«æ€§ãŒæãªã‚ã‚Œã‚‹ï¼ˆãƒ—ãƒ­ã®ä»•äº‹ã§ã¯ãªã„ï¼‰

### å¤‰æ›´æ–¹é‡

**ãƒ‡ãƒ¢ç’°å¢ƒã§ã‚‚æœ¬ç•ªç’°å¢ƒã¨åŒæ§˜ã«Firestoreã¸ä¿å­˜ã‚’è¨±å¯ã™ã‚‹**

æ—¢ã«å®Ÿè£…æ¸ˆã¿ã®æ’ä»–åˆ¶å¾¡ï¼ˆLockServiceï¼‰ã«ã‚ˆã‚Šã€è¤‡æ•°ãƒ‡ãƒ¢ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åŒæ™‚ã‚¢ã‚¯ã‚»ã‚¹ã¯é©åˆ‡ã«å‡¦ç†ã•ã‚Œã‚‹ã€‚

---

## 1. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦ï¼ˆPhase 43.2æ›´æ–°ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  AuthContext    â”‚    â”‚  LockService    â”‚    â”‚  DemoBanner    â”‚  â”‚
â”‚  â”‚  + isDemoUser   â”‚    â”‚  + acquireLock  â”‚    â”‚  (è¡¨ç¤ºã®ã¿)    â”‚  â”‚
â”‚  â”‚  + isDemoFacilityâ”‚   â”‚  + releaseLock  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  + checkLock    â”‚                        â”‚
â”‚           â”‚             â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚           â–¼                      â”‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         App.tsx                              â”‚   â”‚
â”‚  â”‚  Phase 43.2: ãƒ‡ãƒ¢ç’°å¢ƒã§ã‚‚æœ¬ç•ªåŒæ§˜ã«ä¿å­˜                        â”‚   â”‚
â”‚  â”‚  - AIç”Ÿæˆæ™‚: ãƒ­ãƒƒã‚¯å–å¾— â†’ ç”Ÿæˆ â†’ ä¿å­˜ï¼ˆãƒ‡ãƒ¢/æœ¬ç•ªå…±é€šï¼‰          â”‚   â”‚
â”‚  â”‚  - ä¿å­˜æ™‚: ãƒ­ãƒƒã‚¯å–å¾— â†’ ä¿å­˜ï¼ˆãƒ‡ãƒ¢/æœ¬ç•ªå…±é€šï¼‰                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           Firestore                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  /facilities/demo-facility-001/schedules/{yearMonth}  â† ä¿å­˜ã•ã‚Œã‚‹  â”‚
â”‚  /facilities/demo-facility-001/locks/{yearMonth}      â† æ’ä»–åˆ¶å¾¡    â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. Phase 43.2ã§ã®å¤‰æ›´ç‚¹

### 2.1 App.tsx ã®å¤‰æ›´

#### å‰Šé™¤ã™ã‚‹ã‚³ãƒ¼ãƒ‰

```typescript
// å‰Šé™¤: ãƒ‡ãƒ¢ç’°å¢ƒã§ã®ä¿å­˜ã‚¹ã‚­ãƒƒãƒ—
if (isDemoEnvironment) {
  showSuccess('ã‚·ãƒ•ãƒˆã‚’ç”Ÿæˆã—ã¾ã—ãŸï¼ˆãƒ‡ãƒ¢ç’°å¢ƒã®ãŸã‚ä¿å­˜ã•ã‚Œã¾ã›ã‚“ï¼‰');
  return;
}

// å‰Šé™¤: ä¿å­˜æ™‚ã®ãƒ‡ãƒ¢ç’°å¢ƒãƒã‚§ãƒƒã‚¯
if (isDemoEnvironment) {
  showInfo('ãƒ‡ãƒ¢ç’°å¢ƒã§ã¯ä¿å­˜ã•ã‚Œã¾ã›ã‚“ã€‚æœ¬ç•ªç’°å¢ƒã§ãŠè©¦ã—ãã ã•ã„ã€‚');
  return;
}

// å‰Šé™¤: ç¢ºå®šæ™‚ã®ãƒ‡ãƒ¢ç’°å¢ƒãƒã‚§ãƒƒã‚¯
if (isDemoEnvironment) {
  showInfo('ãƒ‡ãƒ¢ç’°å¢ƒã§ã¯ç¢ºå®šã§ãã¾ã›ã‚“ã€‚æœ¬ç•ªç’°å¢ƒã§ãŠè©¦ã—ãã ã•ã„ã€‚');
  return;
}
```

#### å¤‰æ›´å¾Œã®AIç”Ÿæˆãƒ•ãƒ­ãƒ¼

```typescript
const handleGenerateShift = async () => {
  if (!selectedFacilityId || !currentUser) {
    showError('æ–½è¨­ã¾ãŸã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“');
    return;
  }

  // 1. ãƒ­ãƒƒã‚¯å–å¾—ï¼ˆãƒ‡ãƒ¢/æœ¬ç•ªå…±é€šï¼‰
  const lockResult = await LockService.acquireLock(
    selectedFacilityId,
    requirements.targetMonth,
    currentUser.uid,
    'ai-generation'
  );

  if (!lockResult.success) {
    setCurrentLockInfo(lockResult.existingLock ?? null);
    setLockModalOpen(true);
    return;
  }

  setGeneratingSchedule(true);

  try {
    // 2. AIç”Ÿæˆå®Ÿè¡Œ
    const generationResult = await generateShiftSchedule(
      staffList,
      requirements,
      leaveRequests
    );

    // 3. çµæœã‚’ç”»é¢ã«è¡¨ç¤º
    setSchedule(generationResult.schedule);
    setEvaluation(generationResult.evaluation);

    // 4. Firestoreã«ä¿å­˜ï¼ˆãƒ‡ãƒ¢/æœ¬ç•ªå…±é€šï¼‰
    if (currentScheduleId) {
      await ScheduleService.updateSchedule(/* ... */);
    } else {
      await ScheduleService.saveSchedule(/* ... */);
    }

    showSuccess('ã‚·ãƒ•ãƒˆã‚’ç”Ÿæˆã—ã¾ã—ãŸ');
  } catch (error) {
    showError('ã‚·ãƒ•ãƒˆç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
  } finally {
    // 5. ãƒ­ãƒƒã‚¯è§£æ”¾
    await LockService.releaseLock(
      selectedFacilityId,
      requirements.targetMonth,
      currentUser.uid
    );
    setGeneratingSchedule(false);
  }
};
```

### 2.2 DemoBanner.tsx ã®å¤‰æ›´

#### å¤‰æ›´å‰

```typescript
export function DemoBanner({ className = '' }: DemoBannerProps) {
  return (
    <div className={`...`}>
      <span className="font-medium">ğŸ§ª ãƒ‡ãƒ¢ç’°å¢ƒ</span>
      <span className="ml-2 text-sm">
        æ“ä½œã‚’ä½“é¨“ã§ãã¾ã™ãŒã€å¤‰æ›´ã¯ä¿å­˜ã•ã‚Œã¾ã›ã‚“
      </span>
    </div>
  );
}
```

#### å¤‰æ›´å¾Œ

```typescript
export function DemoBanner({ className = '' }: DemoBannerProps) {
  return (
    <div className={`...`}>
      <span className="font-medium">ğŸ§ª ãƒ‡ãƒ¢ç’°å¢ƒ</span>
      <span className="ml-2 text-sm">
        ã‚µãƒ³ãƒ—ãƒ«æ–½è¨­ã§ã‚·ã‚¹ãƒ†ãƒ ã‚’ä½“é¨“ä¸­ã§ã™
      </span>
    </div>
  );
}
```

### 2.3 AuthContext.tsx ã®ç¢ºèªï¼ˆå¤‰æ›´ä¸è¦ï¼‰

`isDemoEnvironment`ãƒ•ãƒ©ã‚°ã¯å¼•ãç¶šããƒãƒŠãƒ¼è¡¨ç¤ºã«ä½¿ç”¨ã™ã‚‹ãŸã‚ã€å‰Šé™¤ã—ãªã„ã€‚

```typescript
// å¤‰æ›´ãªã—: ãƒ‡ãƒ¢ç’°å¢ƒåˆ¤å®šã¯ç¶­æŒ
const isDemoEnvironment = isDemoUser;

// ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§å…¬é–‹
value={{
  isDemoUser,
  isDemoFacility,
  isDemoEnvironment, // ãƒãƒŠãƒ¼è¡¨ç¤ºç”¨ã«ç¶­æŒ
}}
```

---

## 3. æ—¢å­˜å®Ÿè£…ï¼ˆå¤‰æ›´ãªã—ï¼‰

ä»¥ä¸‹ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯æ—¢ã«å®Ÿè£…æ¸ˆã¿ã§ã€å¤‰æ›´ä¸è¦ï¼š

### 3.1 LockService

æ’ä»–åˆ¶å¾¡ã¯æ—¢ã«å®Ÿè£…æ¸ˆã¿ã€‚ãƒ‡ãƒ¢ç’°å¢ƒã§ã‚‚æœ¬ç•ªç’°å¢ƒã¨åŒæ§˜ã«æ©Ÿèƒ½ã™ã‚‹ã€‚

### 3.2 LockStatusModal

ãƒ­ãƒƒã‚¯ç«¶åˆæ™‚ã®ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºã¯æ—¢ã«å®Ÿè£…æ¸ˆã¿ã€‚

### 3.3 Firestore Rules

ãƒ‡ãƒ¢ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã‚‹ãƒ‡ãƒ¢æ–½è¨­ã¸ã®æ›¸ãè¾¼ã¿ã¯æ—¢ã«è¨±å¯ã•ã‚Œã¦ã„ã‚‹ã€‚

---

## 4. å®Ÿè£…é †åºï¼ˆPhase 43.2ï¼‰

```mermaid
graph TD
    A[1. è¦ä»¶å®šç¾©æ›¸æ›´æ–°] --> B[2. æŠ€è¡“è¨­è¨ˆæ›¸æ›´æ–°]
    B --> C[3. CLAUDE.mdæ›´æ–°]
    C --> D[4. Serenaãƒ¡ãƒ¢ãƒªæ›´æ–°]
    D --> E[5. docs/demo.htmlæ›´æ–°]
    E --> F[6. docs/phase43-demo-improvements.htmlæ›´æ–°]
    F --> G[7. App.tsxå¤‰æ›´]
    G --> H[8. DemoBanner.tsxå¤‰æ›´]
    H --> I[9. ãƒ†ã‚¹ãƒˆãƒ»æ¤œè¨¼]
    I --> J[10. ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤]
```

---

## 5. ãƒ†ã‚¹ãƒˆè¨ˆç”»ï¼ˆPhase 43.2ï¼‰

### 5.1 æ‰‹å‹•ãƒ†ã‚¹ãƒˆ

| # | ãƒ†ã‚¹ãƒˆé …ç›® | æœŸå¾…çµæœ |
|---|-----------|----------|
| 1 | ãƒ‡ãƒ¢ãƒ­ã‚°ã‚¤ãƒ³ â†’ AIç”Ÿæˆ | ã‚·ãƒ•ãƒˆãŒç”Ÿæˆãƒ»ä¿å­˜ã•ã‚Œã‚‹ |
| 2 | ãƒ‡ãƒ¢ãƒ­ã‚°ã‚¤ãƒ³ â†’ ä¿å­˜ãƒœã‚¿ãƒ³ | ã‚·ãƒ•ãƒˆãŒä¿å­˜ã•ã‚Œã‚‹ |
| 3 | ãƒ‡ãƒ¢ãƒ­ã‚°ã‚¤ãƒ³ â†’ ç¢ºå®šãƒœã‚¿ãƒ³ | ã‚·ãƒ•ãƒˆãŒç¢ºå®šã•ã‚Œã‚‹ |
| 4 | ãƒ‡ãƒ¢ãƒ­ã‚°ã‚¤ãƒ³ â†’ ãƒ¬ãƒãƒ¼ãƒˆ | ä¿å­˜ã—ãŸã‚·ãƒ•ãƒˆãŒé›†è¨ˆè¡¨ç¤ºã•ã‚Œã‚‹ |
| 5 | è¤‡æ•°ã‚¿ãƒ–ã§åŒæ™‚AIç”Ÿæˆ | æ’ä»–åˆ¶å¾¡ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º |

### 5.2 E2Eãƒ†ã‚¹ãƒˆæ›´æ–°

æ—¢å­˜ã®ãƒ‡ãƒ¢ç’°å¢ƒãƒ†ã‚¹ãƒˆã‚’æ›´æ–°ï¼š
- ã€Œä¿å­˜ã•ã‚Œã¾ã›ã‚“ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤
- å®Ÿéš›ã«ä¿å­˜ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ã«å¤‰æ›´

---

## å¤‰æ›´å±¥æ­´

| æ—¥ä»˜ | å¤‰æ›´è€… | å†…å®¹ |
|------|--------|------|
| 2025-12-07 | Claude | åˆç‰ˆä½œæˆ |
| 2025-12-08 | Claude | Phase 43.2: ãƒ‡ãƒ¢ç’°å¢ƒã§ã®ä¿å­˜è¨±å¯ã«æ–¹é‡å¤‰æ›´ |
