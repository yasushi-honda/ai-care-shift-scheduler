# Phase 43: デモ環境改善・排他制御

**作成日**: 2025-12-07
**ステータス**: 設計中

---

## 1. 概要

### 1.1 背景

Phase 42.2でデモログイン機能を実装したが、以下の問題が発見された：

1. **デモ環境でのエラー**: AI生成後の保存処理で`Missing or insufficient permissions`エラーが発生
2. **不要なボタン**: ActionToolbarの「デモ」ボタンは開発用のランダムシフト生成機能であり、本番・デモ環境どちらにも不要
3. **排他制御の欠如**: 同じシフト（施設・月）に対して複数ユーザーが同時操作した場合、データ競合（last-write-wins）が発生する

### 1.2 目的

- デモ環境での適切なユーザー体験を提供
- 本番環境での安全なマルチユーザー操作を実現
- 不要な機能の削除によるUIのシンプル化

---

## 2. スコープ

### 2.1 対象範囲（In Scope）

| # | 項目 | 説明 |
|---|------|------|
| 1 | デモ環境改善 | AI生成可能、保存は無効化、明示的なUI表示 |
| 2 | 排他制御 | 同一シフトへの同時操作を防止（本番・デモ共通） |
| 3 | UIクリーンアップ | 「デモ」ボタン削除 |

### 2.2 対象外（Out of Scope）

| 項目 | 理由 |
|------|------|
| デモデータの自動リセット | 複雑性が高く、現時点では不要 |
| セッション別デモ施設 | 実装コスト大、メリット少 |
| デモ環境の完全分離 | 既存アーキテクチャで対応可能 |

---

## 3. 要件定義

### 3.1 デモ環境の動作要件

#### FR-1: デモ環境の識別

| ID | 要件 | 優先度 |
|----|------|--------|
| FR-1.1 | デモユーザーは `provider: 'demo'` または `uid === 'demo-user-fixed-uid'` で識別される | Must |
| FR-1.2 | デモ施設は `facilityId === 'demo-facility-001'` で識別される | Must |

#### FR-2: デモ環境でのAI生成

| ID | 要件 | 優先度 |
|----|------|--------|
| FR-2.1 | デモ環境でAI生成（シフト作成実行）を実行可能 | Must |
| FR-2.2 | AI生成結果は画面に表示される | Must |
| FR-2.3 | AI生成結果はFirestoreに**保存されない** | Must |
| FR-2.4 | AI生成完了時に「デモ環境では保存されません」メッセージを表示 | Must |

#### FR-3: デモ環境での手動編集

| ID | 要件 | 優先度 |
|----|------|--------|
| FR-3.1 | デモ環境でセルをクリックしてシフト変更可能（操作体験） | Must |
| FR-3.2 | 手動編集結果は画面に表示される | Must |
| FR-3.3 | 手動編集結果はFirestoreに**保存されない** | Must |

#### FR-4: デモ環境でのLocalStorage

| ID | 要件 | 優先度 |
|----|------|--------|
| FR-4.1 | デモ環境でもLocalStorageへの下書き自動保存は有効 | Should |
| FR-4.2 | 次回アクセス時にLocalStorageから復元される | Should |

#### FR-5: デモ環境のUI表示

| ID | 要件 | 優先度 |
|----|------|--------|
| FR-5.1 | 画面上に「デモ環境」バナー/ラベルを表示 | Must |
| FR-5.2 | 保存ボタン押下時に「デモ環境では保存されません」メッセージを表示 | Must |
| FR-5.3 | 確定ボタン押下時に「デモ環境では確定できません」メッセージを表示 | Must |

#### FR-6: デモ環境でのボタン状態

| ID | 要件 | 優先度 |
|----|------|--------|
| FR-6.1 | 「保存」ボタンは視覚的に無効化されない（押せるが保存しない） | Should |
| FR-6.2 | 「確定」ボタンは視覚的に無効化されない（押せるが確定しない） | Should |
| FR-6.3 | 「履歴」「CSV」ボタンは通常通り動作 | Must |

### 3.2 排他制御の要件

#### FR-7: ロック機構

| ID | 要件 | 優先度 |
|----|------|--------|
| FR-7.1 | AI生成開始時にロックを取得 | Must |
| FR-7.2 | 保存処理開始時にロックを取得 | Must |
| FR-7.3 | ロック取得失敗時は操作をブロック | Must |
| FR-7.4 | ロックは自動的にタイムアウト解放される | Must |

#### FR-8: ロックのタイムアウト

| ID | 要件 | 優先度 |
|----|------|--------|
| FR-8.1 | AI生成ロック: 5分でタイムアウト | Must |
| FR-8.2 | 保存ロック: 30秒でタイムアウト | Must |

#### FR-9: ロック競合時のUX

| ID | 要件 | 優先度 |
|----|------|--------|
| FR-9.1 | ロック取得失敗時に「他のユーザーが操作中です」メッセージを表示 | Must |
| FR-9.2 | 残り待機時間の目安を表示 | Should |
| FR-9.3 | ロック解放を待つか、キャンセルするかを選択可能 | Should |

### 3.3 UIクリーンアップ要件

#### FR-10: デモボタン削除

| ID | 要件 | 優先度 |
|----|------|--------|
| FR-10.1 | ActionToolbarから「デモ」ボタンを削除 | Must |
| FR-10.2 | `handleGenerateDemo`関数を削除 | Must |
| FR-10.3 | 関連するテストコードを更新 | Must |

---

## 4. 非機能要件

### NFR-1: パフォーマンス

| ID | 要件 |
|----|------|
| NFR-1.1 | ロック取得は100ms以内に完了すること |
| NFR-1.2 | ロック状態の確認は画面操作をブロックしないこと |

### NFR-2: セキュリティ

| ID | 要件 |
|----|------|
| NFR-2.1 | デモユーザーはFirestoreへの書き込みを行わないこと |
| NFR-2.2 | ロックの不正操作（他人のロック解除など）を防止すること |

### NFR-3: 可用性

| ID | 要件 |
|----|------|
| NFR-3.1 | ロック機構の障害がアプリ全体に影響しないこと |
| NFR-3.2 | タイムアウトによる自動解放で孤立ロックを防止すること |

---

## 5. 影響分析

### 5.1 変更対象ファイル

| ファイル | 変更内容 |
|----------|----------|
| `src/components/ActionToolbar.tsx` | デモボタン削除 |
| `App.tsx` | `handleGenerateDemo`削除、デモ環境判定追加 |
| `src/contexts/AuthContext.tsx` | `isDemoUser`フラグ追加 |
| `src/services/scheduleService.ts` | ロック取得・解放ロジック追加 |
| `src/services/lockService.ts` | 新規作成 |
| `src/components/DemoBanner.tsx` | 新規作成 |
| `src/components/LockStatusModal.tsx` | 新規作成 |
| `firestore.rules` | locksコレクションのルール追加 |

### 5.2 新規Firestoreコレクション

```
/facilities/{facilityId}/locks/{yearMonth}
{
  lockedBy: string,        // ロック取得者のUID
  lockedAt: Timestamp,     // ロック取得時刻
  operation: string,       // "ai-generation" | "saving"
  expiresAt: Timestamp,    // 自動解放時刻
}
```

---

## 6. テスト計画

### 6.1 ユニットテスト

- [ ] `lockService.ts` のロック取得・解放・タイムアウト
- [ ] `isDemoUser` 判定ロジック

### 6.2 統合テスト

- [ ] デモ環境でのAI生成→保存スキップフロー
- [ ] 排他制御の動作確認

### 6.3 E2Eテスト

- [ ] デモログイン→AI生成→メッセージ表示
- [ ] 複数タブでの同時操作→ロック競合

---

## 7. リスクと対策

| リスク | 影響 | 対策 |
|--------|------|------|
| ロック機構の複雑化 | 開発遅延 | シンプルな実装から開始、段階的に機能追加 |
| Firestoreコスト増 | 運用コスト | locksドキュメントは小さく保つ、TTL設定 |
| 既存機能への影響 | 回帰バグ | 十分なテストカバレッジ確保 |

---

## 8. 承認

- [ ] 要件レビュー完了
- [ ] 設計レビュー完了
- [ ] 実装開始承認

---

## 変更履歴

| 日付 | 変更者 | 内容 |
|------|--------|------|
| 2025-12-07 | Claude | 初版作成 |
