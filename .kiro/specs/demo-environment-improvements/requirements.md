# Phase 43: デモ環境改善・排他制御

**作成日**: 2025-12-07
**最終更新**: 2025-12-08
**ステータス**: Phase 43.2 設計変更中

---

## 1. 概要

### 1.1 背景

Phase 42.2でデモログイン機能を実装したが、以下の問題が発見された：

1. **デモ環境でのエラー**: AI生成後の保存処理で`Missing or insufficient permissions`エラーが発生
2. **不要なボタン**: ActionToolbarの「デモ」ボタンは開発用のランダムシフト生成機能であり、本番・デモ環境どちらにも不要
3. **排他制御の欠如**: 同じシフト（施設・月）に対して複数ユーザーが同時操作した場合、データ競合（last-write-wins）が発生する

### 1.2 Phase 43.2 追加背景（2025-12-08）

Phase 43実装後、以下の重大な問題が発覚：

4. **デモ体験の一貫性欠如**: デモ環境でAI生成したシフトが保存されないため、月次レポートに反映されない
   - ユーザーがAI生成 → 結果を確認 → レポートを見る → **無関係なサンプルデータが表示される**
   - これは「デモとして破綻している」状態

### 1.3 目的

- ~~デモ環境での適切なユーザー体験を提供~~
- **デモ環境での一貫したユーザー体験を提供（AI生成→保存→レポート連動）**
- 本番環境での安全なマルチユーザー操作を実現
- 不要な機能の削除によるUIのシンプル化

---

## 2. スコープ

### 2.1 対象範囲（In Scope）

| # | 項目 | 説明 |
|---|------|------|
| 1 | ~~デモ環境改善~~ デモ環境の完全動作 | AI生成・保存・レポート連動すべて有効化 |
| 2 | 排他制御 | 同一シフトへの同時操作を防止（本番・デモ共通） |
| 3 | UIクリーンアップ | 「デモ」ボタン削除 |

### 2.2 対象外（Out of Scope）

| 項目 | 理由 |
|------|------|
| デモデータの自動リセット | 複雑性が高く、現時点では不要 |
| セッション別デモ施設 | 実装コスト大、メリット少 |
| デモ環境の完全分離 | 既存アーキテクチャで対応可能 |

---

## 3. 要件定義

### 3.1 デモ環境の動作要件

#### FR-1: デモ環境の識別

| ID | 要件 | 優先度 |
|----|------|--------|
| FR-1.1 | デモユーザーは `provider: 'demo'` または `uid === 'demo-user-fixed-uid'` で識別される | Must |
| FR-1.2 | デモ施設は `facilityId === 'demo-facility-001'` で識別される | Must |

#### FR-2: デモ環境でのAI生成（Phase 43.2で変更）

| ID | 要件 | 優先度 | Phase 43.2変更 |
|----|------|--------|----------------|
| FR-2.1 | デモ環境でAI生成（シフト作成実行）を実行可能 | Must | 変更なし |
| FR-2.2 | AI生成結果は画面に表示される | Must | 変更なし |
| ~~FR-2.3~~ | ~~AI生成結果はFirestoreに**保存されない**~~ | ~~Must~~ | **削除** |
| FR-2.3 | AI生成結果はFirestoreに**保存される** | Must | **新規** |
| ~~FR-2.4~~ | ~~AI生成完了時に「デモ環境では保存されません」メッセージを表示~~ | ~~Must~~ | **削除** |
| FR-2.4 | AI生成完了時に通常の成功メッセージを表示 | Must | **新規** |

#### FR-3: デモ環境での手動編集（Phase 43.2で変更）

| ID | 要件 | 優先度 | Phase 43.2変更 |
|----|------|--------|----------------|
| FR-3.1 | デモ環境でセルをクリックしてシフト変更可能 | Must | 変更なし |
| FR-3.2 | 手動編集結果は画面に表示される | Must | 変更なし |
| ~~FR-3.3~~ | ~~手動編集結果はFirestoreに**保存されない**~~ | ~~Must~~ | **削除** |
| FR-3.3 | 手動編集結果はFirestoreに**保存される** | Must | **新規** |

#### FR-4: デモ環境でのLocalStorage（変更なし）

| ID | 要件 | 優先度 |
|----|------|--------|
| FR-4.1 | デモ環境でもLocalStorageへの下書き自動保存は有効 | Should |
| FR-4.2 | 次回アクセス時にLocalStorageから復元される | Should |

#### FR-5: デモ環境のUI表示（Phase 43.2で変更）

| ID | 要件 | 優先度 | Phase 43.2変更 |
|----|------|--------|----------------|
| FR-5.1 | 画面上に「デモ環境」バナー/ラベルを表示 | Must | 変更なし |
| ~~FR-5.2~~ | ~~保存ボタン押下時に「デモ環境では保存されません」メッセージを表示~~ | ~~Must~~ | **削除** |
| FR-5.2 | 保存ボタンは通常通り動作（保存される） | Must | **新規** |
| ~~FR-5.3~~ | ~~確定ボタン押下時に「デモ環境では確定できません」メッセージを表示~~ | ~~Must~~ | **削除** |
| FR-5.3 | 確定ボタンは通常通り動作（確定される） | Must | **新規** |

#### FR-6: デモ環境でのボタン状態（Phase 43.2で変更）

| ID | 要件 | 優先度 | Phase 43.2変更 |
|----|------|--------|----------------|
| ~~FR-6.1~~ | ~~「保存」ボタンは視覚的に無効化されない（押せるが保存しない）~~ | ~~Should~~ | **削除** |
| FR-6.1 | 「保存」ボタンは通常通り動作 | Must | **新規** |
| ~~FR-6.2~~ | ~~「確定」ボタンは視覚的に無効化されない（押せるが確定しない）~~ | ~~Should~~ | **削除** |
| FR-6.2 | 「確定」ボタンは通常通り動作 | Must | **新規** |
| FR-6.3 | 「履歴」「CSV」ボタンは通常通り動作 | Must | 変更なし |

#### FR-11: デモ環境での月次レポート連動（Phase 43.2で追加）

| ID | 要件 | 優先度 |
|----|------|--------|
| FR-11.1 | デモ環境でAI生成・保存したシフトが月次レポートに反映される | Must |
| FR-11.2 | レポートページで選択した年月のシフトデータが正しく集計される | Must |
| FR-11.3 | 勤務時間・シフト種別・休暇情報が正しく集計される | Must |

### 3.2 排他制御の要件（変更なし）

#### FR-7: ロック機構

| ID | 要件 | 優先度 |
|----|------|--------|
| FR-7.1 | AI生成開始時にロックを取得 | Must |
| FR-7.2 | 保存処理開始時にロックを取得 | Must |
| FR-7.3 | ロック取得失敗時は操作をブロック | Must |
| FR-7.4 | ロックは自動的にタイムアウト解放される | Must |

#### FR-8: ロックのタイムアウト

| ID | 要件 | 優先度 |
|----|------|--------|
| FR-8.1 | AI生成ロック: 5分でタイムアウト | Must |
| FR-8.2 | 保存ロック: 30秒でタイムアウト | Must |

#### FR-9: ロック競合時のUX

| ID | 要件 | 優先度 |
|----|------|--------|
| FR-9.1 | ロック取得失敗時に「他のユーザーが操作中です」メッセージを表示 | Must |
| FR-9.2 | 残り待機時間の目安を表示 | Should |
| FR-9.3 | ロック解放を待つか、キャンセルするかを選択可能 | Should |

### 3.3 UIクリーンアップ要件（変更なし）

#### FR-10: デモボタン削除

| ID | 要件 | 優先度 |
|----|------|--------|
| FR-10.1 | ActionToolbarから「デモ」ボタンを削除 | Must |
| FR-10.2 | `handleGenerateDemo`関数を削除 | Must |
| FR-10.3 | 関連するテストコードを更新 | Must |

---

## 4. 非機能要件

### NFR-1: パフォーマンス

| ID | 要件 |
|----|------|
| NFR-1.1 | ロック取得は100ms以内に完了すること |
| NFR-1.2 | ロック状態の確認は画面操作をブロックしないこと |

### NFR-2: セキュリティ（Phase 43.2で変更）

| ID | 要件 | Phase 43.2変更 |
|----|------|----------------|
| ~~NFR-2.1~~ | ~~デモユーザーはFirestoreへの書き込みを行わないこと~~ | **削除** |
| NFR-2.1 | デモユーザーはデモ施設（demo-facility-001）へのみ書き込み可能 | **新規** |
| NFR-2.2 | ロックの不正操作（他人のロック解除など）を防止すること | 変更なし |

### NFR-3: 可用性

| ID | 要件 |
|----|------|
| NFR-3.1 | ロック機構の障害がアプリ全体に影響しないこと |
| NFR-3.2 | タイムアウトによる自動解放で孤立ロックを防止すること |

---

## 5. 影響分析

### 5.1 Phase 43.2での変更対象ファイル

| ファイル | 変更内容 |
|----------|----------|
| `App.tsx` | `isDemoEnvironment`による保存スキップロジックを**削除** |
| `src/contexts/AuthContext.tsx` | `isDemoEnvironment`フラグの用途を変更（バナー表示のみに） |
| `src/components/DemoBanner.tsx` | メッセージ文言を変更（「保存されません」→「デモ環境です」） |

### 5.2 ドキュメント更新対象

| ドキュメント | 変更内容 |
|-------------|----------|
| `CLAUDE.md` | Phase 43 デモ環境設計ルールの更新 |
| `docs/demo.html` | デモ説明の更新（月次レポートの説明修正） |
| `docs/phase43-demo-improvements.html` | Phase 43.2変更点の追記 |
| Serenaメモリ `phase43_demo_improvements_2025-12-07` | 更新 |

### 5.3 既存Firestoreコレクション（変更なし）

```
/facilities/{facilityId}/locks/{yearMonth}
{
  lockedBy: string,        // ロック取得者のUID
  lockedAt: Timestamp,     // ロック取得時刻
  operation: string,       // "ai-generation" | "saving"
  expiresAt: Timestamp,    // 自動解放時刻
}
```

---

## 6. テスト計画

### 6.1 Phase 43.2での追加テスト

- [ ] デモ環境でAI生成 → シフトがFirestoreに保存される
- [ ] デモ環境で保存 → シフトがFirestoreに保存される
- [ ] デモ環境で月次レポート → 保存したシフトが集計される
- [ ] 複数デモユーザー同時アクセス → 排他制御が機能する

### 6.2 既存テスト（変更なし）

- [ ] `lockService.ts` のロック取得・解放・タイムアウト
- [ ] `isDemoUser` 判定ロジック

---

## 7. リスクと対策

| リスク | 影響 | 対策 |
|--------|------|------|
| ~~ロック機構の複雑化~~ | ~~開発遅延~~ | 実装済み |
| デモデータの汚染 | 不適切なデモデータが残る | 排他制御で競合防止、定期的なデモデータリセットスクリプト |
| 複数デモユーザーの混乱 | 他人の操作結果が見える | 排他制御で同時操作防止、バナーで明示 |

---

## 8. 承認

### Phase 43（完了）

- [x] 要件レビュー完了
- [x] 設計レビュー完了
- [x] 実装完了

### Phase 43.2

- [x] 要件定義書（requirements.md）更新済み
- [x] 技術設計書（design.md）更新済み
- [x] タスク一覧（tasks.md）更新済み
- [ ] **ユーザー承認待ち** ← 現在のステータス
- [ ] ドキュメント更新（docs/*.html）
- [ ] 実装変更
- [ ] テスト・デプロイ

---

## 変更履歴

| 日付 | 変更者 | 内容 |
|------|--------|------|
| 2025-12-07 | Claude | 初版作成 |
| 2025-12-08 | Claude | Phase 43.2: デモ環境での保存許可に方針変更 |
