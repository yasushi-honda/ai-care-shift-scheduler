# Phase 25: 介護報酬対応 - 予実管理機能 要件定義書

**作成日**: 2025-11-20
**仕様ID**: care-staff-schedule-compliance
**ステータス**: 承認済み
**優先度**: 最高（セキュリティ・コンプライアンス対応）

---

## 1. 背景と目的

### 1.1 ビジネス背景

**介護保険法 令和6年度（2024年度）介護報酬改定**に伴い、介護事業所における勤務形態一覧表の作成・提出方法が大幅に変更されました。

#### 主要な変更点

1. **標準様式の全国統一化**
   - 厚生労働省が定めた**「標準様式第1号（従業者の勤務の体制及び勤務形態一覧表）」**の使用が原則必須
   - 従来の自治体独自様式は廃止
   - 目的: 介護事業所の負担軽減、業務効率化、全国統一のデータ管理

2. **電子申請システムの導入**
   - 「介護事業所の指定申請等のウェブ入力・電子申請システム」を通じた提出が原則
   - GビズID（法人共通認証基盤）の利用
   - 目的: 行政手続きのデジタル化、申請処理の迅速化

3. **記載項目の標準化**
   - 人員配置基準の確認に必要な数値を明記
   - 常勤換算値の算出根拠を記載
   - サービス種別ごとに様式が異なる（訪問介護、訪問看護、通所介護など）

### 1.2 現場からの要望

**高知県の介護事業所（訪問・通所・施設等）**の現場スタッフから、以下の課題が報告されています：

#### 課題1: 予定のみの管理では不十分

**問題**:
- 行政提出用の様式は「予定シフト」のみを記載する設計
- 実際の現場では、急な欠勤、シフト変更、時間外労働などが頻繁に発生
- 予定と実績の差異を管理する仕組みがないため、月末の実績確認作業が膨大

**影響**:
- 運営指導（監査）時に「実際の勤務実績」を証明する資料が不足
- 勤務時間の集計ミス、労基法違反のリスク
- スタッフの労働時間管理が不透明

#### 課題2: 介護給付費明細書との不整合

**問題**:
- 介護給付費明細書（通称: 提供票）は「予定」と「実績」を2段書きで管理する形式
- 現場スタッフは提供票の形式に慣れている
- 勤務形態一覧表が「予定のみ」だと、提供票との突合作業が困難

**影響**:
- データ入力の二度手間
- 突合ミスによる返戻（請求差し戻し）

#### 課題3: 日々のシフト変更管理が煩雑

**問題**:
- 行政提出用の様式をそのまま日常管理に使うと、シフト変更のたびにExcelを編集
- 変更履歴の管理が困難
- 複数スタッフが同時編集できない

**影響**:
- 管理者の業務負荷増大
- リアルタイムなシフト確認ができない

### 1.3 プロジェクトの目的

本プロジェクト（Phase 25）では、以下を実現します：

1. **予実2段書き管理機能の実装**
   - 介護給付費明細書（提供票）と同じ形式で、スタッフ1名につき「予定行」と「実績行」を表示
   - 日々のシフト変更を柔軟に記録
   - 予定と実績の差異を視覚的にハイライト表示

2. **標準様式第1号への対応**
   - 厚生労働省の標準様式Excel形式で出力
   - 電子申請システムへのアップロードに対応
   - 行政提出用（予定のみ）と内部管理用（予実2段書き）の2種類を出力

3. **コンプライアンスチェック機能**
   - 人員配置基準（3:1、2:1など）の自動チェック
   - 常勤換算値の自動計算
   - 労基法遵守（休憩時間、連続勤務制限、勤務間インターバル）の自動チェック

4. **ユーザビリティの向上**
   - 直感的なシングルクリック編集
   - 確認モーダルによる誤操作防止
   - 既存のAIシフト生成機能との統合

---

## 2. ステークホルダー

### 2.1 主要ステークホルダー

| ステークホルダー | 役割 | 期待する価値 |
|----------------|------|-------------|
| **現場スタッフ** | シフト実績の入力 | 簡単に実績を記録できる、予定との差異が一目でわかる |
| **管理者** | シフト作成・管理 | 予実差異の把握、コンプライアンスチェック、Excel出力 |
| **施設長** | 行政提出 | 標準様式第1号での出力、電子申請システムへのアップロード |
| **行政（高知県・高知市）** | 指定申請・変更届の審査 | 標準様式第1号での提出、人員配置基準の確認 |

### 2.2 ステークホルダーのニーズ

#### 現場スタッフ
- シフト実績を「適宜」入力したい（前日/当日/別日いつでも可）
- 入力が簡単で、スマホでも操作可能
- 自分のシフト実績をすぐに確認できる

#### 管理者
- 予定と実績の差異を一目で把握したい
- 人員配置基準の充足状況をリアルタイムで確認したい
- 労基法違反のリスクを事前に検知したい
- Excel出力が簡単にできる

#### 施設長
- 行政提出用の標準様式第1号を簡単に作成したい
- 電子申請システムにアップロードできる形式で出力したい
- 運営指導（監査）時に実績資料をすぐに提示できる

#### 行政
- 標準様式第1号で提出されたデータを審査したい
- 人員配置基準、常勤換算値が正しく記載されているか確認したい
- 全国統一のデータ形式で管理したい

---

## 3. 機能要件

### 3.1 予実2段書き管理機能（Phase 25.1-25.2）

#### FR-01: 予実2段書き表示

**説明**: スタッフ1名につき「予定行」と「実績行」を2段で表示する。

**詳細要件**:
- テーブル形式で表示（横軸: 日付、縦軸: スタッフ名）
- スタッフ名の下に「[予定]」「[実績]」のラベル表示
- 予定行と実績行は視覚的に区別可能（背景色、罫線など）
- 横スクロール対応（月末31日まで表示）
- スタッフ名カラムはsticky表示（スクロール時も固定）

**受け入れ基準**:
- [ ] 予定行と実績行が2段で表示される
- [ ] 31日分のシフトが横スクロールで確認できる
- [ ] スタッフ名カラムがスクロール時も固定される

#### FR-02: シングルクリック編集

**説明**: 予定行または実績行のセルをシングルクリックすると、編集モーダルが表示される。

**詳細要件**:
- 予定行のセルクリック → 予定シフトの編集モーダル表示
- 実績行のセルクリック → 実績シフトの編集モーダル表示
- モーダル内容:
  - シフトタイプ選択（ドロップダウン: 早番/日勤/遅番/夜勤/休/明け休み）
  - 開始時刻入力（TimePicker: HH:mm形式）
  - 終了時刻入力（TimePicker: HH:mm形式）
  - 休憩時間入力（数値、労基法チェック付き）
  - 特記事項入力（textarea、任意）

**受け入れ基準**:
- [ ] 予定行のセルクリックで予定編集モーダルが表示される
- [ ] 実績行のセルクリックで実績編集モーダルが表示される
- [ ] モーダル内の全項目が入力可能

#### FR-03: 確認モーダル

**説明**: シフト編集時、変更内容を確認するモーダルを表示する。

**詳細要件**:
- 変更内容のサマリー表示
  - 「予定シフト」または「実績シフト」の明示
  - 日付、スタッフ名
  - 変更前 → 変更後の表示
- 確定ボタン、キャンセルボタン
- 確定ボタン押下 → Firestoreに保存 → シフト表に反映

**受け入れ基準**:
- [ ] 変更内容が正しく表示される
- [ ] 確定ボタンでFirestoreに保存される
- [ ] キャンセルボタンで変更が破棄される

#### FR-04: 差異ハイライト

**説明**: 予定と実績が異なる場合、視覚的にハイライト表示する。

**詳細要件**:
- 予定と実績のシフトタイプが異なる場合: オレンジ色のアウトライン
- 予定と実績の時刻が異なる場合: オレンジ色のアウトライン
- 実績未入力の場合: グレーアウト表示
- ホバー時: ツールチップで差異の詳細を表示

**受け入れ基準**:
- [ ] 予定と実績が異なるセルがハイライト表示される
- [ ] 実績未入力のセルがグレーアウト表示される
- [ ] ホバー時にツールチップが表示される

#### FR-05: データモデル拡張

**説明**: GeneratedShiftインターフェースを拡張し、予実管理に対応する。

**詳細要件**:
```typescript
export interface GeneratedShift {
  date: string;                    // YYYY-MM-DD

  // 予定シフト
  plannedShiftType: string;        // '早番', '日勤', '遅番', '夜勤', '休', '明け休み'
  plannedStartTime?: string;       // HH:mm（例: "08:30"）
  plannedEndTime?: string;         // HH:mm（例: "17:30"）

  // 実績シフト（任意）
  actualShiftType?: string;        // 実績のシフトタイプ
  actualStartTime?: string;        // HH:mm
  actualEndTime?: string;          // HH:mm
  breakMinutes?: number;           // 休憩時間（分）

  // 備考
  notes?: string;                  // 特記事項（欠勤理由、変更理由など）
}
```

- 既存のScheduleデータとの後方互換性を維持
- `plannedShiftType`は既存の`shiftType`から自動変換

**受け入れ基準**:
- [ ] GeneratedShiftインターフェースが拡張される
- [ ] 既存のScheduleデータが正常に読み込める
- [ ] 新しいフィールドがFirestoreに保存される

---

### 3.2 標準様式第1号Excel出力（Phase 25.3）

#### FR-06: 標準様式第1号（行政提出用）出力

**説明**: 厚生労働省の標準様式第1号に準拠したExcelファイルを出力する。

**詳細要件**:
- ライブラリ: ExcelJS
- 出力内容: 予定シフトのみ（実績は含めない）
- フォーマット: 標準様式第1号と完全一致
  - セル結合、罫線、書式設定
  - ヘッダー: 施設名、対象月、作成日時
  - 項目: 氏名、役職、資格、シフト（日付ごと）
- ファイル名: `勤務形態一覧表_YYYYMM.xlsx`

**受け入れ基準**:
- [ ] 標準様式第1号のExcelファイルが出力される
- [ ] 予定シフトが正しく出力される
- [ ] フォーマットが標準様式と一致する

#### FR-07: 内部管理用（予実2段書き）Excel出力

**説明**: 予定と実績を2段書きで表示したExcelファイルを出力する。

**詳細要件**:
- ライブラリ: ExcelJS
- 出力内容: 予定と実績の両方
- フォーマット: 独自フォーマット（標準様式ベース）
  - スタッフ1名につき2行（予定行、実績行）
  - 差異のあるセルをハイライト表示（オレンジ色）
- ファイル名: `勤務形態一覧表_予実_YYYYMM.xlsx`

**受け入れ基準**:
- [ ] 予実2段書きのExcelファイルが出力される
- [ ] 差異のあるセルがハイライト表示される
- [ ] フォーマットが読みやすい

---

### 3.3 コンプライアンスチェック機能（Phase 25.4）

#### FR-08: 人員配置基準チェック

**説明**: 介護報酬算定の人員配置基準（3:1、2:1など）を自動チェックする。

**詳細要件**:
- 設定UI: 事業所ごとの配置基準を設定
  - 例: 訪問介護 → 常勤換算2.5人以上
  - 例: 特別養護老人ホーム → 利用者3人に対して介護職員1人以上
- 日次チェック: 各シフトの必要人員充足率を計算
- 月次集計: 配置基準充足率の推移グラフ表示
- 警告表示: 基準未達成の日をハイライト表示

**受け入れ基準**:
- [ ] 事業所ごとの配置基準を設定できる
- [ ] 日次の充足率が計算される
- [ ] 基準未達成の日が警告表示される

#### FR-09: 常勤換算計算

**説明**: スタッフの常勤換算値を自動計算する。

**詳細要件**:
- 設定UI: 週所定労働時間を設定（例: 40時間）
- 計算ロジック: `常勤換算値 = 実績勤務時間 ÷ 週所定労働時間`
- 月次集計: スタッフ別常勤換算値一覧表示
- Excel出力: 常勤換算値を含める

**受け入れ基準**:
- [ ] 週所定労働時間を設定できる
- [ ] 常勤換算値が正しく計算される
- [ ] Excel出力に常勤換算値が含まれる

#### FR-10: 労基法チェック

**説明**: 労働基準法の遵守状況を自動チェックする。

**詳細要件**:
- 休憩時間チェック:
  - 6時間超 → 45分以上の休憩が必要
  - 8時間超 → 60分以上の休憩が必要
- 連続勤務制限チェック: 既存機能を活用
- 勤務間インターバルチェック: 既存機能を活用（最低8時間）
- 警告表示: 違反がある場合、ダッシュボードに警告バッジ表示

**受け入れ基準**:
- [ ] 休憩時間が正しくチェックされる
- [ ] 違反がある場合、警告が表示される
- [ ] ダッシュボードに警告バッジが表示される

---

### 3.4 AIシフト生成統合（Phase 25.5）

#### FR-11: AIプロンプト拡張

**説明**: Gemini AIのプロンプトを拡張し、コンプライアンスを考慮したシフト生成を行う。

**詳細要件**:
- プロンプトに追加する制約:
  - 人員配置基準を満たすシフト生成
  - 常勤換算を考慮した勤務時間配分
  - 労基法遵守（休憩時間、連続勤務制限、勤務間インターバル）
- Cloud Function: `generateShift`を更新

**受け入れ基準**:
- [ ] プロンプトに制約が追加される
- [ ] 生成されたシフトが制約を満たす

#### FR-12: 生成結果のバリデーション

**説明**: AIシフト生成後、コンプライアンスチェックを自動実行する。

**詳細要件**:
- ComplianceCheckerを活用
- 違反がある場合: 再生成提案UIを表示
- 違反内容の詳細表示

**受け入れ基準**:
- [ ] 生成後に自動バリデーションが実行される
- [ ] 違反がある場合、再生成提案が表示される

---

### 3.5 削除機能（Phase 25.1）

#### FR-13: WorkLogs機能の削除

**説明**: 不要なWorkLogs（作業記録）機能を完全に削除する。

**詳細要件**:
- 削除対象ファイル:
  - `src/components/WorkLogModal.tsx`
- 削除対象コード:
  - `src/App.tsx`: workLogs関連のstate、handler、props
  - `src/components/ShiftTable.tsx`: workLogs関連のprops、ツールチップ、モーダル呼び出し
  - `src/types.ts`: `WorkLogDetails`, `WorkLogs`インターフェース
- データ移行: 不要（Firestoreに保存されていないため）

**受け入れ基準**:
- [ ] WorkLogModal.tsxが削除される
- [ ] workLogs関連コードが完全に削除される
- [ ] TypeScriptエラーがゼロ
- [ ] E2Eテストが成功

---

## 4. 非機能要件

### 4.1 ユーザビリティ

- **NFR-01**: シングルクリックで即座に編集可能（2クリック以内）
- **NFR-02**: 確認モーダルによる誤操作防止
- **NFR-03**: 予定と実績の差異が一目でわかる（視覚的ハイライト）
- **NFR-04**: モバイル対応（レスポンシブデザイン）
- **NFR-05**: 日本語インターフェース

### 4.2 パフォーマンス

- **NFR-06**: シフト表の初期表示時間: 2秒以内
- **NFR-07**: シフト編集の保存時間: 1秒以内
- **NFR-08**: Excel出力時間: 5秒以内（100名分）

### 4.3 セキュリティ

- **NFR-09**: Firestore Security Rulesによるアクセス制御（RBAC）
- **NFR-10**: 監査ログの自動記録（シフト編集、Excel出力）
- **NFR-11**: マルチテナント対応（事業所単位のデータ分離）

### 4.4 互換性

- **NFR-12**: 既存のScheduleデータとの後方互換性を維持
- **NFR-13**: 既存のAIシフト生成機能を維持
- **NFR-14**: 既存の認証・マルチテナント機能を維持

### 4.5 保守性

- **NFR-15**: TypeScript型安全性100%
- **NFR-16**: E2Eテストカバレッジ80%以上
- **NFR-17**: コードコメント（JSDoc形式）

---

## 5. 制約条件

### 5.1 法令・規制

- **CON-01**: 介護保険法令和6年度改定に準拠
- **CON-02**: 労働基準法の遵守
- **CON-03**: 厚生労働省標準様式第1号の使用

### 5.2 技術制約

- **CON-04**: Firebase（Firestore、Cloud Functions）の制約
- **CON-05**: ExcelJSの機能制約（複雑なセル結合、マクロ不可）
- **CON-06**: Vertex AI Gemini APIのレート制限

### 5.3 データ移行

- **CON-07**: 既存のScheduleデータは移行不要（後方互換性あり）
- **CON-08**: WorkLogsデータは削除（Firestoreに未保存）

### 5.4 リソース

- **CON-09**: 推定工数: 30-46時間
- **CON-10**: 開発者: 1名（想定）

---

## 6. 参考資料

### 6.1 行政資料

| 資料名 | URL |
|--------|-----|
| 厚生労働省標準様式第1号 | https://www.mhlw.go.jp/content/001269336.xlsx |
| 高知県長寿社会課 | https://www.pref.kochi.lg.jp/doc/2017012300118/ |
| 高知市介護保険課 | https://www.city.kochi.kochi.jp/soshiki/24/zigyousyotodokede.html |
| 記入例・解説サイト | https://carez.jp/blog/?p=925 |

### 6.2 関連ドキュメント

- [技術設計書](./design.md)
- [実装タスク一覧](./tasks.md)
- [データモデル図](./diagrams/data-model-diagram.md)
- [UIフロー図](./diagrams/ui-flow-diagram.md)
- [介護報酬算定ガイドライン](../../steering/care-compliance.md)

---

## 7. 承認履歴

| 日付 | 承認者 | 承認内容 |
|------|--------|---------|
| 2025-11-20 | プロダクトオーナー | 要件定義全体を承認 |
| 2025-11-20 | 技術リード | データモデル拡張を承認 |
| 2025-11-20 | 現場スタッフ代表 | UI/UX仕様を承認 |

---

**次のステップ**: [技術設計書](./design.md)を確認してください。
