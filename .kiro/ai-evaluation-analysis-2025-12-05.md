# AI評価機能 分析記録

**作成日**: 2025-12-05
**関連テスト**: MT-001（AIシフト生成）
**関連機能**: Phase 40 AI評価・フィードバック機能

---

## テスト結果の分析

### 観測されたデータ

```
📊 AI評価結果: {
  overallScore: 0,
  fulfillmentRate: 0,
  violationCount: 218,
  recommendationCount: 3
}
```

### スコア計算ロジック

**計算式** ([evaluationLogic.ts:372-384](functions/src/evaluation/evaluationLogic.ts#L372-L384)):
```
基本スコア: 100点
error違反: -10点/件
warning違反: -5点/件
最低スコア: 0点
```

**今回の結果**:
- 218件の違反 × 最低5点 = 1,090点減点
- 結果: 0点（最低値）

---

## 違反が多い原因（推測）

### 1. デモデータの制約設定

| 要因 | 説明 |
|------|------|
| 人員要件 | 各シフトの必要人数がスタッフ数に対して多い |
| 資格要件 | 資格保有者の配置要件が厳しい |
| 連勤制限 | 連続勤務上限が厳しい |

### 2. AIプロンプトの改善余地

現在のプロンプトでは、制約の重要度や優先順位が明示されていない可能性。

### 3. 2フェーズ生成の限界

- Phase 1（骨子生成）で大枠を決定
- Phase 2（詳細生成）で埋め合わせ
- 制約チェックが生成後の事後評価のみ

---

## 既存のAI評価機能（Phase 40）

### 実装済み機能

| コンポーネント | ファイル | 機能 |
|--------------|---------|------|
| EvaluationPanel | `src/components/EvaluationPanel.tsx` | 評価UI |
| EvaluationService | `functions/src/evaluation/evaluationLogic.ts` | 評価ロジック |
| ShiftTable統合 | `components/ShiftTable.tsx` | 評価パネル表示 |

### 表示内容

1. **総合スコア・充足率** - 数値とプログレスバー
2. **制約違反リスト** - 違反の詳細と提案
3. **改善提案** - 優先度付きアクションリスト
4. **シミュレーション結果** - 残業時間予測、負荷バランス、リスク

### UI上の位置

**シフト表の下に折りたたみパネルとして表示**

```
┌─────────────────────────────────┐
│      シフト表（カレンダー）      │
└─────────────────────────────────┘
┌─────────────────────────────────┐
│ AI評価  [0点] [エラー 218] [▼]  │  ← クリックで展開
├─────────────────────────────────┤
│ 総合スコア: 0/100               │
│ 充足率: 0%                      │
│ エラー: 218件                   │
│ 警告: 0件                       │
├─────────────────────────────────┤
│ 制約違反 (218件)                │
│ • 人員不足: 2025-11-01の早番... │
│ • 人員不足: 2025-11-01の日勤... │
│ • ...                           │
├─────────────────────────────────┤
│ 改善提案 (3件)                  │
│ 🔴 複数日で人員不足が発生...    │
│ 🔴 複数スタッフで連勤超過...    │
│ ...                             │
└─────────────────────────────────┘
```

---

## 現状の課題と改善提案

### 課題1: AIからの総合コメントがない

**現状**: 構造化された違反リストと提案はあるが、自然言語での総合評価コメントがない

**期待**:
> 「このシフト案は人員配置に課題があります。特に早番と日勤の配置が不足しており、
> 10名のスタッフでは現在の要件を満たすことが困難です。
> 人員の増員、または要件の緩和を検討してください。」

**改善案**: Geminiに追加で「総合評価コメント」を生成させる

### 課題2: 「無理である」ことの明示

**現状**: 違反数が多くてもスコア0として表示されるのみ

**期待**:
- 「この要件では実現不可能です」の明示
- 実現可能にするための具体的な条件提示

**改善案**:
- スコア閾値による警告メッセージ
- 「実現可能性」指標の追加

### 課題3: パネルの視認性

**現状**: 折りたたみパネルで、見逃しやすい

**改善案**:
- スコアが低い場合は自動展開
- モーダルダイアログでの表示オプション
- 生成完了時のトースト通知

---

## 改善の優先度と工数

| 改善内容 | 優先度 | 工数 | 効果 |
|---------|-------|------|------|
| 総合コメント生成 | 高 | 中 | ユーザー体験向上 |
| 低スコア時の警告強化 | 中 | 小 | 問題の明確化 |
| パネル自動展開 | 中 | 小 | 視認性向上 |
| 実現可能性指標 | 中 | 中 | 判断支援 |
| プロンプト改善 | 高 | 中 | 品質向上 |
| デモデータ調整 | 低 | 小 | デモ品質向上 |

---

## 今後のアクション提案

### 短期（次のスプリント）

1. [ ] **EvaluationPanelの視認性改善**
   - スコアが60点未満の場合、自動展開
   - 生成完了時にスクロール

2. [ ] **低スコア時の警告メッセージ追加**
   - 「このシフト案には多くの問題があります」
   - 確定前の確認ダイアログ

### 中期（Phase 50+）

3. [ ] **AI総合コメント機能**
   - Geminiに評価コメントを生成させる
   - 自然言語での説明

4. [ ] **プロンプト改善**
   - 制約の重要度を明示
   - 「可能な限り」「必須」の区別

### 長期（将来）

5. [ ] **実現可能性判定**
   - 生成前にスタッフ数と要件の整合性チェック
   - 「この要件では○名以上必要」の提示

---

## 関連ドキュメント

- [Phase 40完了記録](phase40_completion_2025-11-26) - AI評価機能の実装詳細
- [EvaluationPanel.tsx](src/components/EvaluationPanel.tsx) - UI実装
- [evaluationLogic.ts](functions/src/evaluation/evaluationLogic.ts) - 評価ロジック
- [MT-001テスト結果](mt001-test-result-2025-12-05.md) - テスト記録

---

## まとめ

**現状**: AI評価機能は実装済み。ただし以下の改善余地がある：
1. 総合コメント（自然言語）がない
2. 「無理である」ことの明示が弱い
3. UIの視認性に課題

**結論**: 機能は動作しているが、ユーザー体験向上のための改善が望ましい。
デモ目的では現状で問題なし、本番運用時に改善検討。
