name: E2E Permission Check (Manual Trigger)

# æ‰‹å‹•ãƒˆãƒªã‚¬ãƒ¼ã®ã¿
# Phase 18.1: Permission errorè‡ªå‹•æ¤œå‡ºãƒ†ã‚¹ãƒˆ
# Phase 18.2: Firebase Emulatorç’°å¢ƒå¯¾å¿œ
# èƒŒæ™¯: Phase 17ã§5ã¤ã®Permission errorãŒæœ¬ç•ªç’°å¢ƒã§ç™ºè¦‹ã•ã‚ŒãŸ
# ç›®çš„: ãƒ‡ãƒ—ãƒ­ã‚¤å‰ã«Permission errorã‚’è‡ªå‹•æ¤œå‡ºã—ã€Phase 17ã®ã‚ˆã†ãªå•é¡Œã‚’ç¹°ã‚Šè¿”ã•ãªã„
on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'ãƒ†ã‚¹ãƒˆç’°å¢ƒ (emulator: Firebase Emulator, production: æœ¬ç•ªç’°å¢ƒ)'
        required: true
        type: choice
        options:
          - emulator
          - production
        default: emulator
      test_user_id:
        description: 'Test user ID (æœ¬ç•ªç’°å¢ƒã®ã¿å¿…è¦ã€super-admin)'
        required: false
        type: string

env:
  NODE_VERSION: '20'

jobs:
  e2e-permission-test:
    name: Permission errorè‡ªå‹•æ¤œå‡ºãƒ†ã‚¹ãƒˆ
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      # 1. ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      # 2. Node.jsã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Node.js ${{ env.NODE_VERSION }} ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      # 3. ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci

      # 4. Playwrightãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: Playwrightãƒ–ãƒ©ã‚¦ã‚¶ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npx playwright install --with-deps chromium

      # 5a. Firebase CLIã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆEmulatorç’°å¢ƒã®ã¿ï¼‰
      - name: Firebase CLIã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        if: inputs.environment == 'emulator'
        run: npm install -g firebase-tools

      # 5b. é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§èµ·å‹•ï¼ˆEmulatorç’°å¢ƒã®ã¿ï¼‰
      - name: é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•
        if: inputs.environment == 'emulator'
        run: npm run dev &

      # 5c. é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•ã‚’å¾…æ©Ÿ
      - name: é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•ã‚’å¾…æ©Ÿ
        if: inputs.environment == 'emulator'
        run: npx wait-on http://localhost:5173 --timeout 60000

      # 5d. Firebase Emulatorã§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆEmulatorç’°å¢ƒï¼‰
      - name: Permission errorãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆEmulatorç’°å¢ƒï¼‰
        if: inputs.environment == 'emulator'
        run: firebase emulators:exec --only auth,firestore "npm run test:e2e:permission"
        env:
          PLAYWRIGHT_BASE_URL: http://localhost:5173

      # 5c. æœ¬ç•ªç’°å¢ƒã§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰
      - name: Permission errorãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰
        if: inputs.environment == 'production'
        run: npm run test:e2e:permission
        env:
          PLAYWRIGHT_BASE_URL: https://ai-care-shift-scheduler.web.app
          TEST_USER_ID: ${{ inputs.test_user_id }}

      # 6. ãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      - name: ãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-permission
          path: playwright-report/
          retention-days: 7

      # 7. ãƒ†ã‚¹ãƒˆçµæžœã‚µãƒžãƒªãƒ¼
      - name: ãƒ†ã‚¹ãƒˆçµæžœã‚µãƒžãƒªãƒ¼
        if: always()
        run: |
          echo "## Permission errorãƒ†ã‚¹ãƒˆçµæžœ ðŸ”" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.environment }}" = "emulator" ]; then
            echo "**ãƒ†ã‚¹ãƒˆç’°å¢ƒ**: ðŸŸ¢ Firebase Emulatorï¼ˆlocalhostï¼‰" >> $GITHUB_STEP_SUMMARY
            echo "**èªè¨¼æ–¹å¼**: è‡ªå‹•èªè¨¼ï¼ˆEmail/Passwordï¼‰" >> $GITHUB_STEP_SUMMARY
          else
            echo "**ãƒ†ã‚¹ãƒˆç’°å¢ƒ**: ðŸŸ¡ æœ¬ç•ªç’°å¢ƒï¼ˆhttps://ai-care-shift-scheduler.web.appï¼‰" >> $GITHUB_STEP_SUMMARY
            echo "**ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ID**: ${{ inputs.test_user_id }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ï¼ˆPhase 18.1-18.2ï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "1. ãƒ¦ãƒ¼ã‚¶ãƒ¼è©³ç´°ãƒšãƒ¼ã‚¸ï¼ˆPhase 17.9å¯¾å¿œï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "2. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ©ãƒ¼ãƒˆãƒšãƒ¼ã‚¸ï¼ˆPhase 17.11å¯¾å¿œï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "3. ãƒãƒ¼ã‚¸ãƒ§ãƒ³å±¥æ­´è¡¨ç¤ºï¼ˆPhase 17.5å¯¾å¿œï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "4. ç®¡ç†ç”»é¢ä¸»è¦ãƒšãƒ¼ã‚¸ï¼ˆPhase 17.8å¯¾å¿œï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "5. ãƒ­ã‚°ã‚¤ãƒ³ç›´å¾Œï¼ˆPhase 17.8å¯¾å¿œï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "6. ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°åŽé›†ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "è©³ç´°ãªãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆã¯ **Artifacts** ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚" >> $GITHUB_STEP_SUMMARY
