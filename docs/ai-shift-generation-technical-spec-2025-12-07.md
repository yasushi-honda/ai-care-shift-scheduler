# AIã‚·ãƒ•ãƒˆç”Ÿæˆ æŠ€è¡“ä»•æ§˜æ›¸ v2.0

**ä½œæˆæ—¥**: 2025-12-07
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: Draft
**å‰æãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**: [ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¼šè­°è­°äº‹éŒ²](./ai-shift-generation-project-meeting-2025-12-07.md)

---

## 1. æ¦‚è¦

### 1.1 ç›®çš„

Gemini 2.5 Flashã‚’ä½¿ç”¨ã—ãŸAIã‚·ãƒ•ãƒˆè‡ªå‹•ç”Ÿæˆã«ãŠã„ã¦ã€äººå“¡é…ç½®ã®ä¸å‡ç­‰å•é¡Œã‚’è§£æ±ºã—ã€100%ã®åˆ¶ç´„å……è¶³ã‚’é”æˆã™ã‚‹ã€‚

### 1.2 ã‚¹ã‚³ãƒ¼ãƒ—

- å¯¾è±¡æ–½è¨­: ãƒ‡ã‚¤ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆé€šæ‰€ä»‹è­·ï¼‰
- ã‚¹ã‚¿ãƒƒãƒ•è¦æ¨¡: 5ã€œ20å
- ã‚·ãƒ•ãƒˆåŒºåˆ†: æ—©ç•ªãƒ»æ—¥å‹¤ãƒ»é…ç•ªï¼ˆå¤œå‹¤ãªã—ï¼‰

### 1.3 æˆåŠŸåŸºæº–

| æŒ‡æ¨™ | ç›®æ¨™å€¤ |
|------|--------|
| äººå“¡å……è¶³ç‡ | 100% |
| åˆ¶ç´„é•åä»¶æ•° | 0ä»¶ |
| å‡¦ç†æ™‚é–“ | 5åˆ†ä»¥å†… |
| APIå‘¼ã³å‡ºã—ã‚³ã‚¹ãƒˆ | ç¾è¡Œæ¯”150%ä»¥å†… |

---

## 2. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ

### 2.1 5æ®µéšãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    AI Shift Generation Pipeline                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ Phase 1  â”‚â”€â”€â–¶â”‚ Phase 2  â”‚â”€â”€â–¶â”‚ Phase 3  â”‚â”€â”€â–¶â”‚ Phase 4  â”‚     â”‚
â”‚  â”‚ è¦ä»¶åˆ†æ â”‚   â”‚ éª¨å­è¨­è¨ˆ â”‚   â”‚ é€±åˆ¥é…ç½® â”‚   â”‚ æ•´åˆæ¤œè¨¼ â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚       â”‚              â”‚              â”‚              â”‚            â”‚
â”‚       â–¼              â–¼              â–¼              â–¼            â”‚
â”‚  ConstraintMatrix  RestDays     WeeklyShifts   Violations      â”‚
â”‚                                                    â”‚            â”‚
â”‚                                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚                                          â”‚                 â”‚   â”‚
â”‚                                          â–¼                 â–¼   â”‚
â”‚                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚                                   â”‚Phase 4.1 â”‚      â”‚ Phase 5  â”‚â”‚
â”‚                                   â”‚   èª¿æ•´   â”‚      â”‚ æœ€çµ‚å‡ºåŠ› â”‚â”‚
â”‚                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 å„Phaseã®è²¬å‹™

#### Phase 1: è¦ä»¶åˆ†æï¼ˆãƒ­ãƒ¼ã‚«ãƒ«å‡¦ç†ï¼‰

**å…¥åŠ›**: staffList, requirements, leaveRequests
**å‡ºåŠ›**: ConstraintMatrix

```typescript
interface ConstraintMatrix {
  // å–¶æ¥­æ—¥ãƒªã‚¹ãƒˆ
  businessDays: string[];  // ['2026-01-05', '2026-01-06', ...]

  // æ—¥åˆ¥å¿…è¦äººå“¡
  dailyRequirements: {
    [shiftType: string]: {
      totalStaff: number;
      qualifications: { name: string; count: number }[];
    };
  };

  // ã‚¹ã‚¿ãƒƒãƒ•åˆ¥åˆ¶ç´„
  staffConstraints: {
    [staffId: string]: {
      availableDays: string[];      // å‹¤å‹™å¯èƒ½æ—¥
      unavailableDays: string[];    // å‹¤å‹™ä¸å¯æ—¥ï¼ˆä¼‘æš‡å¸Œæœ›å«ã‚€ï¼‰
      preferredShifts: string[];    // å¸Œæœ›ã‚·ãƒ•ãƒˆ
      qualifications: string[];     // ä¿æœ‰è³‡æ ¼
      weeklyWorkCount: { hope: number; must: number };
      maxConsecutiveDays: number;
    };
  };

  // å®Ÿç¾å¯èƒ½æ€§åˆ¤å®š
  feasibility: {
    isPossible: boolean;
    totalRequired: number;    // å¿…è¦äººæ—¥æ•°
    totalAvailable: number;   // å¯èƒ½äººæ—¥æ•°
    marginRate: number;       // ä½™è£•ç‡
  };
}
```

**å‡¦ç†å†…å®¹**:
1. å¯¾è±¡æœˆã®å–¶æ¥­æ—¥ã‚’æŠ½å‡ºï¼ˆãƒ‡ã‚¤ã‚µãƒ¼ãƒ“ã‚¹: æ—¥æ›œé™¤å¤–ï¼‰
2. ã‚¹ã‚¿ãƒƒãƒ•ã”ã¨ã®å‹¤å‹™å¯èƒ½æ—¥ã‚’è¨ˆç®—
3. å®Ÿç¾å¯èƒ½æ€§ã‚’äº‹å‰æ¤œè¨¼
4. ä¸å¯èƒ½ãªå ´åˆã¯æ—©æœŸã‚¨ãƒ©ãƒ¼è¿”å´

#### Phase 2: éª¨å­è¨­è¨ˆï¼ˆAIå‡¦ç†ï¼‰

**å…¥åŠ›**: ConstraintMatrix
**å‡ºåŠ›**: SkeletonSchedule

```typescript
interface SkeletonSchedule {
  staffSchedules: {
    staffId: string;
    staffName: string;
    restDays: number[];        // ä¼‘æ—¥ï¼ˆæ—¥ä»˜ã®ã¿ï¼‰
    workDays: number[];        // å‹¤å‹™æ—¥
    weeklyWorkCounts: number[]; // é€±ã”ã¨ã®å‹¤å‹™æ—¥æ•°
  }[];
}
```

**AIãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæˆ¦ç•¥**:
- é€±ã”ã¨ã®å‹¤å‹™å›æ•°ã‚’æ±ºå®š
- é€£å‹¤åˆ¶ç´„ã‚’è€ƒæ…®ã—ãŸä¼‘æ—¥é…ç½®
- ä¼‘æš‡å¸Œæœ›ã®åæ˜ 

#### Phase 3: é€±åˆ¥é…ç½®ï¼ˆAIå‡¦ç† Ã— é€±æ•°ï¼‰

**å…¥åŠ›**: ConstraintMatrix, SkeletonSchedule, å¯¾è±¡é€±
**å‡ºåŠ›**: WeeklyShifts

```typescript
interface WeeklyShifts {
  weekNumber: number;  // 1ã€œ5
  startDate: string;
  endDate: string;
  dailyAssignments: {
    date: string;
    assignments: {
      shiftType: string;  // 'æ—©ç•ª' | 'æ—¥å‹¤' | 'é…ç•ª'
      staffIds: string[];
    }[];
  }[];
}
```

**AIãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæˆ¦ç•¥**:
- 1é€±é–“ï¼ˆæœ€å¤§6å–¶æ¥­æ—¥ï¼‰Ã— å…¨ã‚¹ã‚¿ãƒƒãƒ•ã‚’ä¸€æ‹¬å‡¦ç†
- å„æ—¥ã®äººå“¡è¦ä»¶ã‚’æ˜ç¤ºçš„ã«è¨˜è¼‰
- è³‡æ ¼è¦ä»¶ï¼ˆçœ‹è­·å¸«é…ç½®ãªã©ï¼‰ã‚’å¿…é ˆæ¡ä»¶ã¨ã—ã¦æŒ‡å®š

#### Phase 4: æ•´åˆæ€§æ¤œè¨¼ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«å‡¦ç†ï¼‰

**å…¥åŠ›**: å…¨WeeklyShifts, ConstraintMatrix
**å‡ºåŠ›**: ValidationResult

```typescript
interface ValidationResult {
  isValid: boolean;
  violations: {
    type: 'staffShortage' | 'consecutiveWork' | 'qualificationMissing' | 'leaveIgnored';
    severity: 'error' | 'warning';
    date: string;
    shiftType?: string;
    staffId?: string;
    message: string;
  }[];
  score: number;
  fulfillmentRate: number;
}
```

**æ¤œè¨¼é …ç›®**:
1. æ—¥åˆ¥äººå“¡å……è¶³
2. è³‡æ ¼è¦ä»¶å……è¶³
3. é€£å‹¤åˆ¶ç´„
4. ä¼‘æš‡å¸Œæœ›åæ˜ 

#### Phase 4.1: èª¿æ•´ï¼ˆAIå‡¦ç†ã€æ¡ä»¶ä»˜ãï¼‰

**ãƒˆãƒªã‚¬ãƒ¼æ¡ä»¶**: ValidationResult.isValid === false ã‹ã¤ violations.severity === 'error'

**å‡¦ç†**:
- é•åç®‡æ‰€ã®ã¿ã‚’AIã«æ¸¡ã—ã¦ä¿®æ­£æ¡ˆã‚’ç”Ÿæˆ
- æœ€å¤§3å›ã¾ã§ãƒªãƒˆãƒ©ã‚¤
- 3å›å¤±æ•—ã—ãŸå ´åˆã¯æ‰‹å‹•èª¿æ•´ã‚’ä¿ƒã™ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨å…±ã«è¿”å´

#### Phase 5: æœ€çµ‚å‡ºåŠ›ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«å‡¦ç†ï¼‰

**å…¥åŠ›**: æ¤œè¨¼æ¸ˆã¿WeeklyShifts
**å‡ºåŠ›**: FinalSchedule

```typescript
interface FinalSchedule {
  schedule: {
    staffId: string;
    staffName: string;
    monthlyShifts: {
      date: string;
      shiftType: string;
    }[];
  }[];
}
```

---

## 3. è©³ç´°è¨­è¨ˆ

### 3.1 Phase 3 ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­è¨ˆï¼ˆæœ€é‡è¦ï¼‰

```typescript
function buildWeeklyAssignmentPrompt(
  week: { startDate: string; endDate: string; businessDays: string[] },
  availableStaff: StaffWithConstraints[],
  requirements: DailyRequirements,
  previousWeekEnd?: { lastWorkDay: Record<string, string> }
): string {
  return `
ã‚ãªãŸã¯ãƒ‡ã‚¤ã‚µãƒ¼ãƒ“ã‚¹ã®ã‚·ãƒ•ãƒˆç®¡ç†AIã§ã™ã€‚
ä»¥ä¸‹ã®æ¡ä»¶ã«åŸºã¥ã„ã¦ã€1é€±é–“åˆ†ã®ã‚·ãƒ•ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

# å¯¾è±¡æœŸé–“
${week.startDate} ã€œ ${week.endDate}ï¼ˆ${week.businessDays.length}å–¶æ¥­æ—¥ï¼‰

# å–¶æ¥­æ—¥
${week.businessDays.map(d => `- ${d}ï¼ˆ${getDayOfWeekJapanese(d)}ï¼‰`).join('\n')}

# å‹¤å‹™å¯èƒ½ã‚¹ã‚¿ãƒƒãƒ•ï¼ˆ${availableStaff.length}åï¼‰
${availableStaff.map(s => formatStaffInfo(s)).join('\n')}

# ã€çµ¶å¯¾æ¡ä»¶ã€‘å„æ—¥ã®å¿…è¦äººå“¡
| ã‚·ãƒ•ãƒˆ | å¿…è¦äººæ•° | è³‡æ ¼è¦ä»¶ |
|--------|----------|----------|
| æ—©ç•ª   | ${requirements.æ—©ç•ª.totalStaff}å | ${formatQualifications(requirements.æ—©ç•ª)} |
| æ—¥å‹¤   | ${requirements.æ—¥å‹¤.totalStaff}å | ${formatQualifications(requirements.æ—¥å‹¤)} |
| é…ç•ª   | ${requirements.é…ç•ª.totalStaff}å | ${formatQualifications(requirements.é…ç•ª)} |

# åˆ¶ç´„æ¡ä»¶
1. å„æ—¥ã€ä¸Šè¨˜ã®å¿…è¦äººå“¡ã‚’**å¿…ãš**æº€ãŸã™ã“ã¨
2. æ—¥å‹¤ã«ã¯çœ‹è­·å¸«ï¼ˆ${getNurseNames(availableStaff)}ï¼‰ã‚’1åä»¥ä¸Šé…ç½®ã™ã‚‹ã“ã¨
3. ä¼‘æ—¥ã«è¨­å®šã•ã‚ŒãŸã‚¹ã‚¿ãƒƒãƒ•ã¯ã€Œä¼‘ã€ã¨ã™ã‚‹ã“ã¨
4. ã€Œæ—¥å‹¤ã®ã¿å¸Œæœ›ã€ã®ã‚¹ã‚¿ãƒƒãƒ•ã¯æ—¥å‹¤ã«å„ªå…ˆé…ç½®
5. é€£å‹¤${MAX_CONSECUTIVE}æ—¥ã‚’è¶…ãˆãªã„ã“ã¨

# ä¼‘æ—¥è¨­å®šï¼ˆéª¨å­ã‚ˆã‚Šï¼‰
${formatRestDays(availableStaff, week)}

# å‡ºåŠ›å½¢å¼
ä»¥ä¸‹ã®JSONå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„:
{
  "dailyAssignments": [
    {
      "date": "2026-01-06",
      "æ—©ç•ª": ["staff-takahashi", "staff-ito"],
      "æ—¥å‹¤": ["staff-sato", "staff-tanaka"],
      "é…ç•ª": ["staff-watanabe"],
      "ä¼‘": ["staff-suzuki", "staff-yamamoto", "staff-kondo"]
    },
    ...
  ]
}

é‡è¦: å…¨${week.businessDays.length}æ—¥åˆ†ã‚’å‡ºåŠ›ã—ã€å„æ—¥ã®äººå“¡é…ç½®ã‚’å¿…ãšæº€ãŸã—ã¦ãã ã•ã„ã€‚
`;
}
```

### 3.2 å‡¦ç†ãƒ•ãƒ­ãƒ¼

```typescript
async function generateShiftWithPipeline(
  staffList: Staff[],
  requirements: ShiftRequirement,
  leaveRequests: LeaveRequest
): Promise<GenerationResult> {

  // Phase 1: è¦ä»¶åˆ†æï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰
  console.log('ğŸ“Š Phase 1: è¦ä»¶åˆ†æ');
  const constraintMatrix = analyzeConstraints(staffList, requirements, leaveRequests);

  if (!constraintMatrix.feasibility.isPossible) {
    return {
      success: false,
      error: `äººå“¡ä¸è¶³: å¿…è¦${constraintMatrix.feasibility.totalRequired}äººæ—¥ã€å¯èƒ½${constraintMatrix.feasibility.totalAvailable}äººæ—¥`,
    };
  }

  // Phase 2: éª¨å­è¨­è¨ˆï¼ˆAIï¼‰
  console.log('ğŸ¦´ Phase 2: éª¨å­è¨­è¨ˆ');
  const skeleton = await generateSkeleton(constraintMatrix);

  // Phase 3: é€±åˆ¥é…ç½®ï¼ˆAI Ã— é€±æ•°ï¼‰
  console.log('ğŸ“… Phase 3: é€±åˆ¥é…ç½®');
  const weeks = splitIntoWeeks(constraintMatrix.businessDays);
  const weeklyShifts: WeeklyShifts[] = [];

  for (const week of weeks) {
    console.log(`  - Week ${week.weekNumber}: ${week.startDate}ã€œ${week.endDate}`);
    const shifts = await generateWeeklyShifts(week, skeleton, constraintMatrix);
    weeklyShifts.push(shifts);
  }

  // Phase 4: æ•´åˆæ€§æ¤œè¨¼ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰
  console.log('âœ… Phase 4: æ•´åˆæ€§æ¤œè¨¼');
  let validation = validateSchedule(weeklyShifts, constraintMatrix);

  // Phase 4.1: èª¿æ•´ï¼ˆå¿…è¦ãªå ´åˆã®ã¿ï¼‰
  let retryCount = 0;
  while (!validation.isValid && validation.hasErrors && retryCount < 3) {
    console.log(`ğŸ”„ Phase 4.1: èª¿æ•´ï¼ˆãƒªãƒˆãƒ©ã‚¤ ${retryCount + 1}/3ï¼‰`);
    const adjustedShifts = await adjustViolations(weeklyShifts, validation.violations);
    weeklyShifts = mergeAdjustments(weeklyShifts, adjustedShifts);
    validation = validateSchedule(weeklyShifts, constraintMatrix);
    retryCount++;
  }

  // Phase 5: æœ€çµ‚å‡ºåŠ›
  console.log('ğŸ“¤ Phase 5: æœ€çµ‚å‡ºåŠ›');
  const finalSchedule = convertToFinalFormat(weeklyShifts, staffList);

  return {
    success: true,
    schedule: finalSchedule,
    validation: validation,
  };
}
```

---

## 4. APIè¨­è¨ˆ

### 4.1 ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

æ—¢å­˜ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ `/generateShift` ã‚’ç¶­æŒã—ã€å†…éƒ¨å®Ÿè£…ã‚’å¤‰æ›´ã€‚

### 4.2 ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼

```typescript
interface GenerateShiftResponse {
  success: boolean;
  schedule?: StaffSchedule[];
  evaluation?: AIEvaluationResult;
  metadata?: {
    generatedAt: string;
    model: string;
    pipeline: {
      phase1: { duration: number };
      phase2: { duration: number; tokensUsed: number };
      phase3: { duration: number; tokensUsed: number; weekCount: number };
      phase4: { duration: number; violations: number };
      phase5: { duration: number };
      totalDuration: number;
      totalTokensUsed: number;
    };
  };
  error?: string;
}
```

---

## 5. å®Ÿè£…è¨ˆç”»

### 5.1 ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

```
functions/src/
â”œâ”€â”€ shift-generation.ts          # ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆï¼ˆæ—¢å­˜ï¼‰
â”œâ”€â”€ pipeline/
â”‚   â”œâ”€â”€ index.ts                 # ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³çµ±åˆ
â”‚   â”œâ”€â”€ phase1-analyze.ts        # è¦ä»¶åˆ†æ
â”‚   â”œâ”€â”€ phase2-skeleton.ts       # éª¨å­è¨­è¨ˆ
â”‚   â”œâ”€â”€ phase3-weekly.ts         # é€±åˆ¥é…ç½®
â”‚   â”œâ”€â”€ phase4-validate.ts       # æ•´åˆæ€§æ¤œè¨¼
â”‚   â”œâ”€â”€ phase4-1-adjust.ts       # èª¿æ•´
â”‚   â””â”€â”€ phase5-output.ts         # æœ€çµ‚å‡ºåŠ›
â”œâ”€â”€ phased-generation.ts         # æ—§å®Ÿè£…ï¼ˆäº’æ›æ€§ã®ãŸã‚ç¶­æŒï¼‰
â””â”€â”€ evaluation/
    â””â”€â”€ evaluationLogic.ts       # è©•ä¾¡ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆæ—¢å­˜ï¼‰
```

### 5.2 ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³

| # | ã‚¿ã‚¹ã‚¯ | å„ªå…ˆåº¦ | è¦‹ç©ã‚‚ã‚Š |
|---|--------|--------|----------|
| 1 | Phase 1ï¼ˆè¦ä»¶åˆ†æï¼‰å®Ÿè£… | é«˜ | 2æ™‚é–“ |
| 2 | Phase 3ï¼ˆé€±åˆ¥é…ç½®ï¼‰ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ”¹å–„ | æœ€é«˜ | 1æ™‚é–“ |
| 3 | Phase 4ï¼ˆæ•´åˆæ€§æ¤œè¨¼ï¼‰å¼·åŒ– | é«˜ | 1æ™‚é–“ |
| 4 | çµ±åˆãƒ†ã‚¹ãƒˆ | é«˜ | 2æ™‚é–“ |
| 5 | Phase 4.1ï¼ˆèª¿æ•´ï¼‰å®Ÿè£… | ä¸­ | 2æ™‚é–“ |
| 6 | ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ– | ä½ | å¾Œæ—¥ |

### 5.3 å³æ™‚å®Ÿè£…ï¼ˆã‚¯ã‚¤ãƒƒã‚¯ã‚¦ã‚£ãƒ³ï¼‰

ç¾è¡Œã‚³ãƒ¼ãƒ‰ã¸ã®æœ€å°å¤‰æ›´ã§åŠ¹æœã‚’å¾—ã‚‹æ–¹æ³•:

1. `buildDetailedPrompt`ã«å¿…è¦äººå“¡ã®å…·ä½“çš„æ•°å€¤ã‚’è¿½åŠ 
2. ãƒãƒƒãƒã‚µã‚¤ã‚ºã‚’ã€Œ1é€±é–“åˆ†ã€ã«å¤‰æ›´
3. å„ãƒãƒƒãƒã«å‰ãƒãƒƒãƒã®çµæœã‚’å‚ç…§ã•ã›ã‚‹

---

## 6. ãƒªã‚¹ã‚¯ã¨å¯¾ç­–

| ãƒªã‚¹ã‚¯ | å½±éŸ¿åº¦ | å¯¾ç­– |
|--------|--------|------|
| APIå‘¼ã³å‡ºã—å¢—åŠ ã«ã‚ˆã‚‹ã‚³ã‚¹ãƒˆå¢— | ä¸­ | é€±å˜ä½å‡¦ç†ã§æŠ‘åˆ¶ï¼ˆæ—¥å˜ä½ã‚ˆã‚ŠåŠ¹ç‡çš„ï¼‰ |
| é€±é–“ã‚’ã¾ãŸãé€£å‹¤åˆ¶ç´„ã®è¦‹è½ã¨ã— | é«˜ | Phase 2ã§äº‹å‰ã«ä¼‘æ—¥ã‚’ç¢ºå®š |
| AIå‡ºåŠ›ã®JSONãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼ | ä¸­ | å°ã•ã„å‡ºåŠ›å˜ä½ã§å®‰å®šæ€§å‘ä¸Š |
| ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ | ä½ | ç¾è¡Œ5åˆ†ã§ååˆ†ï¼ˆé€±4å›å‘¼ã³å‡ºã—ç¨‹åº¦ï¼‰ |

---

## 7. æ¤œè¨¼è¨ˆç”»

### 7.1 ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹

| # | ã‚±ãƒ¼ã‚¹ | æœŸå¾…çµæœ |
|---|--------|----------|
| 1 | 8åã‚¹ã‚¿ãƒƒãƒ•ã€26å–¶æ¥­æ—¥ | äººå“¡å……è¶³ç‡100% |
| 2 | çœ‹è­·å¸«2åã€æ—¥å‹¤ã«1åå¿…é ˆ | æ¯æ—¥çœ‹è­·å¸«é…ç½® |
| 3 | ä¼‘æš‡å¸Œæœ›4ä»¶ | å…¨ä»¶åæ˜  |
| 4 | é€£å‹¤ä¸Šé™5æ—¥ | 6é€£å‹¤ãªã— |

### 7.2 æˆåŠŸåˆ¤å®š

```typescript
function isSuccess(result: GenerationResult): boolean {
  return (
    result.success &&
    result.evaluation.fulfillmentRate === 100 &&
    result.evaluation.constraintViolations.filter(v => v.severity === 'error').length === 0
  );
}
```

---

## ä»˜éŒ²A: ç”¨èªé›†

| ç”¨èª | å®šç¾© |
|------|------|
| éª¨å­ï¼ˆSkeletonï¼‰ | ä¼‘æ—¥ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ã¿ã‚’æ±ºå®šã—ãŸå¤§æ ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ« |
| äººå“¡å……è¶³ç‡ | å¿…è¦äººå“¡ã«å¯¾ã™ã‚‹å®Ÿé…ç½®äººå“¡ã®å‰²åˆ |
| åˆ¶ç´„å……è¶³å•é¡Œï¼ˆCSPï¼‰ | å¤‰æ•°ã«å€¤ã‚’å‰²ã‚Šå½“ã¦ã€ã™ã¹ã¦ã®åˆ¶ç´„ã‚’æº€ãŸã™è§£ã‚’æ±‚ã‚ã‚‹å•é¡Œ |

---

## ä»˜éŒ²B: å‚ç…§ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¼šè­°è­°äº‹éŒ²](./ai-shift-generation-project-meeting-2025-12-07.md)
- [Gemini 2.5 Flash API ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹](https://cloud.google.com/vertex-ai/docs/generative-ai/model-reference/gemini)
- [æ—¢å­˜å®Ÿè£…: phased-generation.ts](../functions/src/phased-generation.ts)
