<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>BUG-001: CORSエラー修正記録 - AIシフト自動作成システム</title>
    <meta name="description" content="Cloud Functions CORSエラー修正の詳細記録">

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,700&display=swap">
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
            font-size: 16px;
            line-height: 1.6;
            color: #333;
            background: #f9f9f9;
        }
        .page-header {
            color: #fff;
            text-align: center;
            background: linear-gradient(135deg, #c0392b 0%, #e74c3c 50%, #c0392b 100%);
            padding: 2rem 1rem;
        }
        .page-header h1 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }
        .page-header .subtitle {
            opacity: 0.9;
            font-size: 1rem;
        }
        .badge {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: bold;
            margin: 0.5rem 0.25rem;
        }
        .badge-critical { background: #e74c3c; color: #fff; }
        .badge-fixed { background: #27ae60; color: #fff; }
        .badge-date { background: #3498db; color: #fff; }
        .main-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }
        .nav-links {
            margin-bottom: 2rem;
        }
        .nav-links a {
            color: #3498db;
            text-decoration: none;
            margin-right: 1rem;
        }
        .nav-links a:hover {
            text-decoration: underline;
        }
        .section {
            background: #fff;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section h2 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }
        .section h3 {
            color: #34495e;
            margin: 1rem 0 0.5rem;
            font-size: 1.1rem;
        }
        .error-box {
            background: #fef0f0;
            border-left: 4px solid #e74c3c;
            padding: 1rem;
            margin: 1rem 0;
            font-family: monospace;
            font-size: 0.85rem;
            overflow-x: auto;
        }
        .success-box {
            background: #f0fef0;
            border-left: 4px solid #27ae60;
            padding: 1rem;
            margin: 1rem 0;
        }
        .warning-box {
            background: #fffbf0;
            border-left: 4px solid #f39c12;
            padding: 1rem;
            margin: 1rem 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 0.75rem;
            text-align: left;
        }
        th {
            background: #f5f5f5;
            font-weight: 600;
        }
        tr:nth-child(even) { background: #fafafa; }
        .mermaid-container {
            overflow-x: auto;
            margin: 1rem 0;
        }
        .code-block {
            background: #2d3436;
            color: #dfe6e9;
            padding: 1rem;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.85rem;
            overflow-x: auto;
            margin: 1rem 0;
        }
        .timeline-item {
            display: flex;
            margin: 0.5rem 0;
            padding: 0.5rem;
            border-left: 3px solid #3498db;
            background: #f8f9fa;
        }
        .timeline-date {
            font-weight: bold;
            min-width: 100px;
            color: #2980b9;
        }
        ul { margin-left: 1.5rem; margin-top: 0.5rem; }
        li { margin: 0.3rem 0; }
        @media (max-width: 768px) {
            .page-header h1 { font-size: 1.4rem; }
            .section { padding: 1rem; }
            table { font-size: 0.85rem; }
            th, td { padding: 0.5rem; }
        }
    </style>
</head>
<body>
    <header class="page-header">
        <h1>BUG-001: CORSエラー修正記録</h1>
        <p class="subtitle">Cloud Functions デプロイ問題の調査と解決</p>
        <div>
            <span class="badge badge-critical">Critical</span>
            <span class="badge badge-fixed">Fixed</span>
            <span class="badge badge-date">2025-12-05</span>
        </div>
    </header>

    <main class="main-content">
        <nav class="nav-links">
            <a href="index.html">← プロジェクト概要</a>
            <a href="technical.html">技術ドキュメント</a>
        </nav>

        <section class="section">
            <h2>概要</h2>
            <p>本番環境でAIシフト生成機能を実行するとCORSエラーが発生し、機能が完全に使用不能となっていた。調査の結果、<strong>Cloud Functionsのデプロイが約3週間失敗し続けていた</strong>ことが判明。</p>

            <div class="error-box">
Access to fetch at 'https://asia-northeast1-ai-care-shift-scheduler.cloudfunctions.net/generateShift'
from origin 'https://ai-care-shift-scheduler.web.app' has been blocked by CORS policy
            </div>

            <table>
                <tr><th>項目</th><th>内容</th></tr>
                <tr><td>発見日</td><td>2025-12-05</td></tr>
                <tr><td>影響期間</td><td>2025-11-14 〜 2025-12-05（約3週間）</td></tr>
                <tr><td>重要度</td><td>Critical（AIシフト生成が完全に動作不能）</td></tr>
                <tr><td>修正完了</td><td>2025-12-05</td></tr>
            </table>
        </section>

        <section class="section">
            <h2>問題発生タイムライン</h2>
            <div class="mermaid-container">
                <pre class="mermaid">
timeline
    title Cloud Functions デプロイ問題タイムライン

    section 正常期間
        2025-10-31 : 最後の正常デプロイ
                   : generateShift(us-central1)

    section 問題期間（3週間）
        2025-11-14 : cloudscheduler API権限エラー開始
        2025-11-26 : asia-northeast1移行コミット
        2025-12-05 : 手動テストでCORSエラー発見

    section 修正完了
        2025-12-05 : API有効化・再デプロイ
                </pre>
            </div>
        </section>

        <section class="section">
            <h2>根本原因分析</h2>

            <h3>直接原因</h3>
            <p><code>cloudscheduler.googleapis.com</code> APIが有効化されておらず、GitHub ActionsによるCloud Functionsデプロイがすべて失敗していた。</p>

            <div class="error-box">
⚠  functions: missing required API cloudscheduler.googleapis.com. Enabling now...
Error: Permissions denied enabling cloudscheduler.googleapis.com.
            </div>

            <h3>問題の因果関係</h3>
            <div class="mermaid-container">
                <pre class="mermaid">
flowchart TD
    subgraph 根本原因
        A[cloudscheduler API無効]
    end

    subgraph デプロイ失敗
        B[scheduledBackup関数が<br/>Cloud Schedulerを必要]
        C[Firebase CLIが<br/>API有効化を試行]
        D[権限エラーで失敗]
        E[Functionsデプロイ<br/>全体が中断]
    end

    subgraph 問題のマスキング
        F[CI/CDワークフロー設計]
        G["|| echo で<br/>エラーを無視"]
        H[Hosting/Rules<br/>デプロイは成功]
        I[ワークフロー全体<br/>成功表示]
    end

    subgraph 結果
        J[古いus-central1関数<br/>のみ稼働]
        K[フロントエンドは<br/>asia-northeast1を呼び出し]
        L[関数が存在しない<br/>CORSエラー発生]
    end

    A --> B --> C --> D --> E
    E --> F --> G --> H --> I
    E --> J --> K --> L

    style A fill:#f66,stroke:#333
    style L fill:#f66,stroke:#333
    style I fill:#ff9,stroke:#333
                </pre>
            </div>

            <h3>なぜ気づかなかったか（反省点）</h3>
            <div class="warning-box">
                <ul>
                    <li><strong>CI/CDワークフローの設計問題</strong>: Functionsデプロイ失敗時も<code>|| echo</code>でワークフロー全体は成功扱い</li>
                    <li><strong>監視体制の欠如</strong>: Cloud Functionsの実際のデプロイ状況を確認する習慣がなかった</li>
                    <li><strong>リージョン移行時のテスト不足</strong>: 移行後の動作確認が不十分</li>
                    <li><strong>エラーの誤認</strong>: CORSエラー＝CORS設定問題と思い込み、「関数が存在しない」可能性を見落とし</li>
                </ul>
            </div>
        </section>

        <section class="section">
            <h2>修正手順</h2>

            <div class="mermaid-container">
                <pre class="mermaid">
flowchart LR
    subgraph Step1[Step 1: API有効化]
        A1[gcloud auth login] --> A2[gcloud services enable<br/>cloudscheduler]
    end

    subgraph Step2[Step 2: 古い関数削除]
        B1[gcloud functions delete<br/>generateShift us-central1] --> B2[他3関数も削除]
    end

    subgraph Step3[Step 3: 再デプロイ]
        C1[git commit --allow-empty] --> C2[git push]
        C2 --> C3[GitHub Actions<br/>デプロイ成功]
    end

    Step1 --> Step2 --> Step3

    style C3 fill:#6f6
                </pre>
            </div>

            <h3>Step 1: Cloud Scheduler API有効化</h3>
            <div class="code-block">
gcloud auth login admin@fuku-no-tane.com
gcloud services enable cloudscheduler.googleapis.com --project=ai-care-shift-scheduler
            </div>

            <h3>Step 2: 古い関数の削除</h3>
            <div class="code-block">
gcloud functions delete generateShift --region=us-central1 --project=ai-care-shift-scheduler --quiet
gcloud functions delete assignSuperAdminOnFirstUser --region=us-central1 --project=ai-care-shift-scheduler --quiet
gcloud functions delete updateLastLogin --region=us-central1 --project=ai-care-shift-scheduler --quiet
gcloud functions delete archiveAuditLogs --region=us-central1 --project=ai-care-shift-scheduler --quiet
            </div>

            <h3>Step 3: 再デプロイ</h3>
            <div class="code-block">
git commit --allow-empty -m "fix: redeploy Cloud Functions after deleting legacy us-central1 functions"
git push origin main
            </div>
        </section>

        <section class="section">
            <h2>デプロイ結果</h2>

            <div class="success-box">
                <strong>全関数のデプロイに成功しました</strong>
            </div>

            <table>
                <tr><th>関数名</th><th>リージョン</th><th>状態</th></tr>
                <tr><td>generateShift</td><td>asia-northeast1</td><td style="color: green;">✓ Created</td></tr>
                <tr><td>assignSuperAdminOnFirstUser</td><td>asia-northeast1</td><td style="color: green;">✓ Created</td></tr>
                <tr><td>updateLastLogin</td><td>asia-northeast1</td><td style="color: green;">✓ Created</td></tr>
                <tr><td>archiveAuditLogs</td><td>asia-northeast1</td><td style="color: green;">✓ Created</td></tr>
                <tr><td>backupFacilityData</td><td>asia-northeast1</td><td style="color: green;">✓ Created</td></tr>
                <tr><td>restoreFacilityData</td><td>asia-northeast1</td><td style="color: green;">✓ Created</td></tr>
                <tr><td>scheduledBackup</td><td>asia-northeast1</td><td style="color: green;">✓ Created</td></tr>
                <tr><td>generateMonthlyReport</td><td>asia-northeast1</td><td style="color: green;">✓ Created</td></tr>
                <tr><td>scheduledMonthlyReport</td><td>asia-northeast1</td><td style="color: green;">✓ Created</td></tr>
                <tr><td>fixFirstUserRole</td><td>asia-northeast1</td><td style="color: green;">✓ Updated</td></tr>
                <tr><td>onUserDelete</td><td>us-central1</td><td style="color: green;">✓ Updated</td></tr>
            </table>
        </section>

        <section class="section">
            <h2>再発防止策</h2>

            <div class="mermaid-container">
                <pre class="mermaid">
flowchart TD
    subgraph デプロイ時
        D1{Functionsデプロイ<br/>成功?}
        D1 -->|Yes| D2[次ステップへ]
        D1 -->|No| D3[即時アラート]
        D3 --> D4[ワークフロー失敗]
    end

    subgraph 確認事項
        C1[デプロイログ詳細確認]
        C2[全関数の存在確認]
        C3[エンドポイント疎通確認]
    end

    subgraph 監視
        M1[Cloud Monitoring<br/>アラート設定]
        M2[週次手動テスト<br/>実施]
    end

    D2 --> C1 --> C2 --> C3 --> M1 --> M2
                </pre>
            </div>

            <ul>
                <li><strong>CI/CDワークフロー改善</strong>: Functionsデプロイ失敗時はワークフロー全体を失敗させる</li>
                <li><strong>デプロイ後の動作確認追加</strong>: Cloud Functionsエンドポイントへの疎通確認を自動化</li>
                <li><strong>定期的な本番環境テスト</strong>: 週次でAIシフト生成の動作確認を実施</li>
                <li><strong>Cloud Functions監視設定</strong>: Cloud Monitoringでデプロイ状況をアラート化</li>
            </ul>
        </section>

        <section class="section">
            <h2>学び・教訓</h2>
            <ol>
                <li><strong>「成功」表示を信じない</strong> - 詳細ログを確認する習慣が必要</li>
                <li><strong>リージョン移行は慎重に</strong> - 移行後は必ず実機テスト</li>
                <li><strong>CORSエラーの真因を疑う</strong> - 設定問題だけでなく「存在しない」可能性も</li>
                <li><strong>手動テストの重要性</strong> - 自動テストだけでは検出できない問題がある</li>
                <li><strong>エラーハンドリングの透明性</strong> - 失敗をマスクしない設計</li>
            </ol>
        </section>
    </main>

    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            securityLevel: 'loose',
            flowchart: { useMaxWidth: true, htmlLabels: true }
        });
    </script>
</body>
</html>
