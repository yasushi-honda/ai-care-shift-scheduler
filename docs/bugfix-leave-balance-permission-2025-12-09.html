<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>BUG-022: 休暇残高パーミッションエラー修正 - AIシフト自動作成システム</title>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
            font-size: 16px;
            line-height: 1.6;
            color: #606c71;
            max-width: 64rem;
            margin: 0 auto;
            padding: 2rem 1rem;
        }
        h1, h2, h3 { color: #0366d6; margin-top: 2rem; margin-bottom: 1rem; }
        h1 { font-size: 1.75rem; border-bottom: 2px solid #e74c3c; padding-bottom: 0.5rem; }
        h2 { font-size: 1.5rem; }
        h3 { font-size: 1.25rem; }
        a { color: #1e6bb8; }
        code { background: #f6f8fa; padding: 0.2rem 0.4rem; border-radius: 4px; font-size: 0.9rem; }
        pre { background: #f6f8fa; padding: 1rem; border-radius: 8px; overflow-x: auto; margin: 1rem 0; }
        pre code { background: none; padding: 0; }
        .badge { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.85rem; font-weight: 600; }
        .badge-resolved { background: #28a745; color: white; }
        .badge-high { background: #e74c3c; color: white; }
        .back-link { display: inline-block; margin-bottom: 1rem; padding: 0.5rem 1rem; background: #f6f8fa; border: 1px solid #d1d5da; border-radius: 4px; }
        table { width: 100%; border-collapse: collapse; margin: 1rem 0; }
        th, td { padding: 0.75rem; border: 1px solid #d1d5da; text-align: left; }
        th { background: #f6f8fa; }
        .error-box { background: #ffeaea; border: 1px solid #e74c3c; border-radius: 8px; padding: 1rem; margin: 1rem 0; }
        .solution-box { background: #e8f5e9; border: 1px solid #28a745; border-radius: 8px; padding: 1rem; margin: 1rem 0; }
        .warning-box { background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 1rem; margin: 1rem 0; }
        .timeline { border-left: 3px solid #d1d5da; padding-left: 1.5rem; margin: 1rem 0; }
        .timeline-item { margin-bottom: 1rem; }
        .timeline-date { font-size: 0.85rem; color: #6a737d; font-weight: 600; }
    </style>
</head>
<body>
    <a href="bugfix-index.html" class="back-link">&larr; バグ修正一覧に戻る</a>

    <h1>BUG-022: 休暇残高管理のFirestoreパーミッションエラー修正</h1>

    <p>
        <span class="badge badge-resolved">解決済み</span>
        <span class="badge badge-high">重要度: 高</span>
    </p>
    <p><strong>修正日</strong>: 2025-12-09</p>

    <h2>概要</h2>
    <p>「休暇残高管理」の「詳細」ボタンクリック時に、Firestoreのパーミッションエラーが発生する問題を修正。<strong>複合的な原因</strong>により3段階の修正が必要だった。</p>

    <h2>現象</h2>

    <div class="error-box">
        <strong>エラーメッセージ:</strong>
        <pre><code>Error fetching staff leave balance: FirebaseError: Missing or insufficient permissions.</code></pre>
    </div>

    <h2>問題の時系列</h2>

    <div class="timeline">
        <div class="timeline-item">
            <div class="timeline-date">修正1: demoSignIn.tsのrole変更</div>
            <p>Cloud Functionの<code>demoSignIn.ts</code>で<code>viewer</code>→<code>editor</code>に変更</p>
            <p style="color: #e74c3c;">→ デプロイ時に409エラーで失敗（CI/CDがマスク）</p>
        </div>
        <div class="timeline-item">
            <div class="timeline-date">修正2: 再デプロイ強制</div>
            <p>コメント追加で再デプロイをトリガー</p>
            <p style="color: #28a745;">→ デプロイ成功</p>
            <p style="color: #e74c3c;">→ しかし問題継続（ユーザーの再ログインタイミングがデプロイ完了より前）</p>
        </div>
        <div class="timeline-item">
            <div class="timeline-date">修正3: Firestore直接更新</div>
            <p>Firestoreの<code>users/{uid}.facilities[].role</code>を直接<code>editor</code>に更新</p>
            <p style="color: #28a745;">→ 問題解決</p>
        </div>
    </div>

    <h2>根本原因（複合的）</h2>

    <h3>1. demoSignIn.tsがviewer権限を設定</h3>
    <pre><code>// 問題のコード (functions/src/demoSignIn.ts:82-84)
facilities: [{
  facilityId: DEMO_FACILITY_ID,
  role: 'viewer',  // ❌ これが問題
  grantedAt: now,
}],</code></pre>

    <h3>2. Cloud Functionデプロイが409エラーで失敗</h3>
    <div class="warning-box">
        <p>CI/CDワークフローの<code>|| echo "⚠️ Functions deployment had warnings (non-critical)"</code>によりエラーがマスクされ、全体は成功扱いになっていた。</p>
        <pre><code>⚠ functions: Request to .../demoSignIn... had HTTP Error: 409, unable to queue the operation
⚠ functions: failed to update function projects/.../functions/demoSignIn</code></pre>
    </div>

    <h3>3. Firestoreの実データが古いまま</h3>
    <table>
        <tr>
            <th>コレクション</th>
            <th>role</th>
            <th>状態</th>
        </tr>
        <tr>
            <td><code>users/{uid}.facilities[0].role</code></td>
            <td><code>viewer</code></td>
            <td style="color: #e74c3c;">セキュリティルールが参照（問題）</td>
        </tr>
        <tr>
            <td><code>facilities/{id}.members[].role</code></td>
            <td><code>editor</code></td>
            <td>非正規化データ（参照されない）</td>
        </tr>
    </table>

    <h2>修正内容</h2>

    <div class="solution-box">
        <h3>最終解決: Firestore直接更新</h3>
        <pre><code>// スクリプトで直接更新
await userRef.update({
  facilities: [{
    facilityId: 'demo-facility-001',
    role: 'editor',  // viewer -> editor
    grantedAt: now,
  }],
});</code></pre>
    </div>

    <h2>教訓</h2>

    <div class="warning-box">
        <h4>教訓1: Cloud Functionデプロイログを必ず確認</h4>
        <p>409エラー等の失敗がCI/CDでマスクされる可能性がある。個別関数の<code>Successful update operation</code>を確認。</p>
    </div>

    <div class="warning-box">
        <h4>教訓2: 関数デプロイ後は再ログインのタイミングを確認</h4>
        <p>Cloud Functionの変更は、ユーザーが再ログインした時点で反映される。デプロイ完了前の再ログインでは古い関数が実行される。</p>
    </div>

    <div class="warning-box">
        <h4>教訓3: 問題継続時はFirestoreの実データを直接確認</h4>
        <p>コード修正が正しくても、既存のFirestoreデータが古いままの場合がある。</p>
        <pre><code>// 確認スクリプト例
const userDoc = await db.collection('users').doc(DEMO_USER_UID).get();
console.log('User facilities:', userDoc.data()?.facilities);</code></pre>
    </div>

    <h2>関連</h2>
    <ul>
        <li><a href="bugfix-leave-balance-detail-2025-12-09.html">BUG-021: 休暇残高詳細ボタンエラー</a>（同日発生、先に修正）</li>
        <li><a href="bugfix-demo-members-2025-12-08.html">BUG-009: デモユーザー権限消失</a>（同じパターンの問題）</li>
        <li><a href="postmortem-permission-sync-2025-12-08.html">ポストモーテム: 権限同期問題</a></li>
        <li><a href="bugfix-index.html">バグ修正一覧</a></li>
    </ul>

    <hr>
    <p style="text-align: center; color: #999; font-size: 0.9rem;">作成者: Claude Opus 4.5 | 最終更新: 2025-12-09</p>
</body>
</html>
