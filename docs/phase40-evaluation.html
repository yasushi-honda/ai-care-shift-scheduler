<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Phase 40: AIè©•ä¾¡ãƒ»ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯æ©Ÿèƒ½ | AI Care Shift Scheduler</title>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <style>
    :root {
      --primary: #3b82f6;
      --success: #22c55e;
      --warning: #f59e0b;
      --error: #ef4444;
      --bg: #f8fafc;
      --card-bg: #ffffff;
      --text: #1e293b;
      --text-muted: #64748b;
      --border: #e2e8f0;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      background: linear-gradient(135deg, var(--primary), #1d4ed8);
      color: white;
      padding: 40px 20px;
      text-align: center;
    }

    header h1 {
      font-size: 2rem;
      margin-bottom: 10px;
    }

    header p {
      opacity: 0.9;
      font-size: 1.1rem;
    }

    .nav {
      background: var(--card-bg);
      border-bottom: 1px solid var(--border);
      padding: 10px 20px;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .nav a {
      color: var(--text);
      text-decoration: none;
      margin-right: 20px;
      padding: 8px 12px;
      border-radius: 6px;
      transition: background 0.2s;
    }

    .nav a:hover {
      background: var(--bg);
    }

    .card {
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      padding: 24px;
      margin-bottom: 24px;
    }

    .card h2 {
      color: var(--primary);
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 2px solid var(--border);
    }

    .card h3 {
      margin: 20px 0 12px;
      color: var(--text);
    }

    .mermaid {
      background: #fafafa;
      padding: 20px;
      border-radius: 8px;
      overflow-x: auto;
    }

    .status-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin: 20px 0;
    }

    .status-item {
      padding: 16px;
      border-radius: 8px;
      text-align: center;
    }

    .status-item.completed {
      background: #dcfce7;
      border: 1px solid #22c55e;
    }

    .status-item.in-progress {
      background: #fef3c7;
      border: 1px solid #f59e0b;
    }

    .status-item h4 {
      font-size: 0.9rem;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .status-item .value {
      font-size: 1.5rem;
      font-weight: bold;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 16px 0;
    }

    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    th {
      background: var(--bg);
      font-weight: 600;
    }

    code {
      background: #f1f5f9;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.9em;
    }

    .file-list {
      list-style: none;
    }

    .file-list li {
      padding: 8px 12px;
      margin: 4px 0;
      background: var(--bg);
      border-radius: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .file-list .badge {
      font-size: 0.75rem;
      padding: 2px 8px;
      border-radius: 12px;
      background: var(--primary);
      color: white;
    }

    .file-list .badge.new {
      background: var(--success);
    }

    .file-list .badge.modified {
      background: var(--warning);
    }

    @media (max-width: 768px) {
      header h1 {
        font-size: 1.5rem;
      }

      .nav {
        overflow-x: auto;
        white-space: nowrap;
      }

      .card {
        padding: 16px;
      }

      .mermaid {
        font-size: 12px;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Phase 40: AIè©•ä¾¡ãƒ»ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯æ©Ÿèƒ½</h1>
    <p>ã‚·ãƒ•ãƒˆç”Ÿæˆçµæœã®è‡ªå‹•è©•ä¾¡ã¨æ”¹å–„ææ¡ˆã‚·ã‚¹ãƒ†ãƒ </p>
  </header>

  <nav class="nav">
    <a href="index.html">Home</a>
    <a href="technical.html">æŠ€è¡“ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ</a>
    <a href="handoff.html">å¼•ãç¶™ã</a>
    <a href="#wbs">WBS</a>
    <a href="#gantt">ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ</a>
    <a href="#architecture">ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£</a>
    <a href="#flow">å‡¦ç†ãƒ•ãƒ­ãƒ¼</a>
  </nav>

  <div class="container">
    <!-- é€²æ—ã‚µãƒãƒªãƒ¼ -->
    <div class="card">
      <h2>é€²æ—ã‚µãƒãƒªãƒ¼</h2>
      <div class="status-grid">
        <div class="status-item completed">
          <h4>å®Œäº†ã‚¿ã‚¹ã‚¯</h4>
          <div class="value">31/33</div>
        </div>
        <div class="status-item completed">
          <h4>ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰</h4>
          <div class="value">100%</div>
        </div>
        <div class="status-item completed">
          <h4>ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰</h4>
          <div class="value">100%</div>
        </div>
        <div class="status-item in-progress">
          <h4>E2Eãƒ†ã‚¹ãƒˆ</h4>
          <div class="value">é€²è¡Œä¸­</div>
        </div>
      </div>
    </div>

    <!-- WBS -->
    <div class="card" id="wbs">
      <h2>WBSï¼ˆä½œæ¥­åˆ†è§£æ§‹é€ ï¼‰</h2>
      <div class="mermaid">
graph TD
    P40[Phase 40: AIè©•ä¾¡ãƒ»ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯æ©Ÿèƒ½]

    P40 --> W1[Week 1: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰]
    P40 --> W2[Week 2: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰]
    P40 --> W3[Week 3: ãƒ†ã‚¹ãƒˆãƒ»æ¤œè¨¼]

    W1 --> T1[40.1 å‹å®šç¾©ãƒ»ã‚¹ã‚­ãƒ¼ãƒ]
    W1 --> T2[40.2 è©•ä¾¡ãƒ­ã‚¸ãƒƒã‚¯]
    W1 --> T3[40.3 generateShiftæ‹¡å¼µ]

    T1 --> T1_1[40.1.1 Cloud Functionså‹]
    T1 --> T1_2[40.1.2 Frontendå‹]
    T1 --> T1_3[40.1.3 ãƒ¬ã‚¹ãƒãƒ³ã‚¹å‹]

    T2 --> T2_1[40.2.1 evaluationLogic.ts]
    T2 --> T2_2[40.2.2 äººå“¡ä¸è¶³ãƒã‚§ãƒƒã‚¯]
    T2 --> T2_3[40.2.3 é€£å‹¤ãƒã‚§ãƒƒã‚¯]
    T2 --> T2_4[40.2.4 å¤œå‹¤ä¼‘æ¯ãƒã‚§ãƒƒã‚¯]
    T2 --> T2_5[40.2.5 è³‡æ ¼ãƒã‚§ãƒƒã‚¯]
    T2 --> T2_6[40.2.6 ä¼‘æš‡ãƒã‚§ãƒƒã‚¯]

    T3 --> T3_1[40.3.1 ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ‹¡å¼µ]
    T3 --> T3_2[40.3.2 è©•ä¾¡çµ±åˆ]
    T3 --> T3_3[40.3.3 ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ‹¡å¼µ]
    T3 --> T3_4[40.3.4 ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯]

    W2 --> T4[40.4 ã‚µãƒ¼ãƒ“ã‚¹æ‹¡å¼µ]
    W2 --> T5[40.5 è©•ä¾¡UI]
    W2 --> T6[40.6 ã‚·ãƒ•ãƒˆè¡¨çµ±åˆ]
    W2 --> T7[40.7 å±¥æ­´æ©Ÿèƒ½]

    T4 --> T4_1[40.4.1 å‹å®šç¾©æ›´æ–°]
    T4 --> T4_2[40.4.2 é–¢æ•°æ‹¡å¼µ]
    T4 --> T4_3[40.4.3 ã‚¨ãƒ©ãƒ¼å‡¦ç†]

    T5 --> T5_1[40.5.1 ã‚¹ã‚±ãƒ«ãƒˆãƒ³]
    T5 --> T5_2[40.5.2 ã‚µãƒãƒªãƒ¼è¡¨ç¤º]
    T5 --> T5_3[40.5.3 é•åãƒªã‚¹ãƒˆ]
    T5 --> T5_4[40.5.4 æ”¹å–„ææ¡ˆ]
    T5 --> T5_5[40.5.5 ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–]

    T6 --> T6_1[40.6.1 çŠ¶æ…‹ç®¡ç†]
    T6 --> T6_2[40.6.2 ãƒ‘ãƒãƒ«çµ±åˆ]
    T6 --> T6_3[40.6.3 ä¿å­˜ãƒœã‚¿ãƒ³]

    T7 --> T7_1[40.7.1 ã‚µãƒ¼ãƒ“ã‚¹ä½œæˆ]
    T7 --> T7_2[40.7.2 ä¿å­˜æ©Ÿèƒ½]
    T7 --> T7_3[40.7.3 å–å¾—æ©Ÿèƒ½]
    T7 --> T7_4[40.7.4 Rulesãƒ«ãƒ¼ãƒ«]

    W3 --> T8[40.8 ãƒ†ã‚¹ãƒˆ]
    T8 --> T8_1[40.8.1 ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ]
    T8 --> T8_2[40.8.2 çµ±åˆãƒ†ã‚¹ãƒˆ]
    T8 --> T8_3[40.8.3 E2Eãƒ†ã‚¹ãƒˆ]

    style P40 fill:#3b82f6,color:#fff
    style W1 fill:#22c55e,color:#fff
    style W2 fill:#22c55e,color:#fff
    style W3 fill:#f59e0b,color:#fff
      </div>
    </div>

    <!-- ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ -->
    <div class="card" id="gantt">
      <h2>ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ</h2>
      <div class="mermaid">
gantt
    title Phase 40: AIè©•ä¾¡ãƒ»ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯æ©Ÿèƒ½ å®Ÿè£…ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
    dateFormat YYYY-MM-DD

    section Week 1: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰
    40.1 å‹å®šç¾©ãƒ»ã‚¹ã‚­ãƒ¼ãƒæ‹¡å¼µ     :done, t1, 2025-11-26, 0.5d
    40.2 è©•ä¾¡ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè£…         :done, t2, after t1, 1d
    40.3 generateShiftæ‹¡å¼µ        :done, t3, after t2, 1d
    40.8.1 ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ         :done, t8_1, after t3, 0.5d

    section Week 2: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
    40.4 ã‚µãƒ¼ãƒ“ã‚¹æ‹¡å¼µ             :done, t4, 2025-11-26, 0.5d
    40.5 è©•ä¾¡UIå®Ÿè£…               :done, t5, after t4, 1.5d
    40.6 ã‚·ãƒ•ãƒˆè¡¨çµ±åˆ             :done, t6, after t5, 0.5d
    40.7 Firestoreå±¥æ­´æ©Ÿèƒ½        :done, t7, after t6, 0.5d

    section Week 3: ãƒ†ã‚¹ãƒˆãƒ»æ¤œè¨¼
    40.8.2 çµ±åˆãƒ†ã‚¹ãƒˆ             :active, t8_2, after t7, 0.5d
    40.8.3 E2Eãƒ†ã‚¹ãƒˆ              :t8_3, after t8_2, 0.5d
    CodeRabbitãƒ¬ãƒ“ãƒ¥ãƒ¼            :done, cr, after t7, 0.25d
    æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤                  :done, deploy, after cr, 0.25d
      </div>
    </div>

    <!-- ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ -->
    <div class="card" id="architecture">
      <h2>ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£</h2>
      <div class="mermaid">
flowchart TB
    subgraph Client["ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ (React)"]
        UI[ShiftTable.tsx]
        EP[EvaluationPanel.tsx]
        GS[geminiService.ts]
        EHS[evaluationHistoryService.ts]
    end

    subgraph CloudFunctions["Cloud Functions (asia-northeast1)"]
        GF[generateShift]
        EL[EvaluationService]
    end

    subgraph VertexAI["Vertex AI"]
        GM[Gemini 2.5 Flash]
    end

    subgraph Firestore["Firestore"]
        SC[schedules]
        AH[aiGenerationHistory]
    end

    UI --> EP
    UI --> GS
    GS -->|POST /generateShift| GF
    GF -->|ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ| GM
    GM -->|JSON Response| GF
    GF --> EL
    EL -->|è©•ä¾¡çµæœ| GF
    GF -->|schedule + evaluation| GS
    GS --> UI
    EP --> EHS
    EHS --> AH
    UI --> SC

    style Client fill:#e0f2fe
    style CloudFunctions fill:#dcfce7
    style VertexAI fill:#fef3c7
    style Firestore fill:#fce7f3
      </div>
    </div>

    <!-- å‡¦ç†ãƒ•ãƒ­ãƒ¼ -->
    <div class="card" id="flow">
      <h2>å‡¦ç†ãƒ•ãƒ­ãƒ¼</h2>
      <div class="mermaid">
sequenceDiagram
    participant U as ãƒ¦ãƒ¼ã‚¶ãƒ¼
    participant UI as ShiftTable
    participant GS as geminiService
    participant CF as Cloud Functions
    participant GM as Gemini AI
    participant EV as EvaluationService
    participant FS as Firestore

    U->>UI: ã‚·ãƒ•ãƒˆç”Ÿæˆãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
    UI->>GS: generateShiftSchedule()
    GS->>CF: POST /generateShift

    CF->>GM: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆé€ä¿¡
    GM-->>CF: ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«JSON

    CF->>EV: evaluateSchedule()
    Note over EV: 5ã¤ã®åˆ¶ç´„ãƒã‚§ãƒƒã‚¯<br/>- äººå“¡ä¸è¶³<br/>- é€£ç¶šå‹¤å‹™<br/>- å¤œå‹¤å¾Œä¼‘æ¯<br/>- å¿…è¦è³‡æ ¼<br/>- ä¼‘æš‡ç”³è«‹
    EV-->>CF: AIEvaluationResult

    CF-->>GS: schedule + evaluation
    GS-->>UI: ShiftGenerationResult

    UI->>UI: setSchedule()
    UI->>UI: setEvaluation()
    UI->>UI: EvaluationPanelè¡¨ç¤º

    U->>UI: å±¥æ­´ä¿å­˜ãƒœã‚¿ãƒ³
    UI->>FS: saveEvaluationHistory()
    FS-->>UI: historyId
      </div>
    </div>

    <!-- è©•ä¾¡ãƒ­ã‚¸ãƒƒã‚¯è©³ç´° -->
    <div class="card">
      <h2>è©•ä¾¡ãƒ­ã‚¸ãƒƒã‚¯è©³ç´°</h2>

      <h3>åˆ¶ç´„é•åãƒã‚§ãƒƒã‚¯ï¼ˆ5ç¨®é¡ï¼‰</h3>
      <table>
        <thead>
          <tr>
            <th>ã‚¿ã‚¤ãƒ—</th>
            <th>é‡è¦åº¦</th>
            <th>ãƒã‚§ãƒƒã‚¯å†…å®¹</th>
            <th>æ¸›ç‚¹</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><code>staffShortage</code></td>
            <td>error</td>
            <td>å¿…è¦äººå“¡æ•°ã‚’æº€ãŸã—ã¦ã„ã‚‹ã‹</td>
            <td>-10ç‚¹</td>
          </tr>
          <tr>
            <td><code>consecutiveWork</code></td>
            <td>warning</td>
            <td>é€£ç¶šå‹¤å‹™æ—¥æ•°ãŒä¸Šé™ä»¥å†…ã‹</td>
            <td>-5ç‚¹</td>
          </tr>
          <tr>
            <td><code>nightRestViolation</code></td>
            <td>warning</td>
            <td>å¤œå‹¤å¾Œã«ååˆ†ãªä¼‘æ¯ãŒã‚ã‚‹ã‹</td>
            <td>-5ç‚¹</td>
          </tr>
          <tr>
            <td><code>qualificationMissing</code></td>
            <td>error</td>
            <td>å¿…è¦è³‡æ ¼ã‚’æŒã¤ã‚¹ã‚¿ãƒƒãƒ•ãŒã„ã‚‹ã‹</td>
            <td>-10ç‚¹</td>
          </tr>
          <tr>
            <td><code>leaveRequestIgnored</code></td>
            <td>error</td>
            <td>ä¼‘æš‡ç”³è«‹ãŒå°Šé‡ã•ã‚Œã¦ã„ã‚‹ã‹</td>
            <td>-10ç‚¹</td>
          </tr>
        </tbody>
      </table>

      <h3>ã‚¹ã‚³ã‚¢è¨ˆç®—å¼</h3>
      <p><code>overallScore = 100 - (ã‚¨ãƒ©ãƒ¼æ•° Ã— 10) - (è­¦å‘Šæ•° Ã— 5)</code></p>
      <p>æœ€å°å€¤: 0ç‚¹ã€æœ€å¤§å€¤: 100ç‚¹</p>
    </div>

    <!-- å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ -->
    <div class="card">
      <h2>å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§</h2>

      <h3>ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰</h3>
      <ul class="file-list">
        <li>
          <span>functions/src/types.ts</span>
          <span class="badge modified">å¤‰æ›´</span>
        </li>
        <li>
          <span>functions/src/evaluation/evaluationLogic.ts</span>
          <span class="badge new">æ–°è¦</span>
        </li>
        <li>
          <span>functions/src/shift-generation.ts</span>
          <span class="badge modified">å¤‰æ›´</span>
        </li>
        <li>
          <span>functions/__tests__/unit/evaluationLogic.test.ts</span>
          <span class="badge new">æ–°è¦</span>
        </li>
      </ul>

      <h3>ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰</h3>
      <ul class="file-list">
        <li>
          <span>types.ts</span>
          <span class="badge modified">å¤‰æ›´</span>
        </li>
        <li>
          <span>services/geminiService.ts</span>
          <span class="badge modified">å¤‰æ›´</span>
        </li>
        <li>
          <span>src/components/EvaluationPanel.tsx</span>
          <span class="badge new">æ–°è¦</span>
        </li>
        <li>
          <span>components/ShiftTable.tsx</span>
          <span class="badge modified">å¤‰æ›´</span>
        </li>
        <li>
          <span>App.tsx</span>
          <span class="badge modified">å¤‰æ›´</span>
        </li>
        <li>
          <span>src/services/evaluationHistoryService.ts</span>
          <span class="badge new">æ–°è¦</span>
        </li>
      </ul>

      <h3>ã‚¤ãƒ³ãƒ•ãƒ©</h3>
      <ul class="file-list">
        <li>
          <span>firestore.rules</span>
          <span class="badge modified">å¤‰æ›´</span>
        </li>
        <li>
          <span>firestore.indexes.json</span>
          <span class="badge modified">å¤‰æ›´</span>
        </li>
      </ul>
    </div>

    <!-- ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ« -->
    <div class="card">
      <h2>ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«</h2>
      <div class="mermaid">
erDiagram
    FACILITIES ||--o{ AI_GENERATION_HISTORY : has
    FACILITIES ||--o{ SCHEDULES : has

    AI_GENERATION_HISTORY {
        string id PK
        string facilityId FK
        string targetMonth
        array schedule
        object evaluation
        string createdBy
        timestamp createdAt
        object metadata
    }

    EVALUATION_RESULT {
        number overallScore
        number fulfillmentRate
        array constraintViolations
        array recommendations
        object simulation
        timestamp generatedAt
    }

    CONSTRAINT_VIOLATION {
        string type
        string severity
        string description
        array affectedStaff
        array affectedDates
        string suggestion
    }

    RECOMMENDATION {
        string priority
        string category
        string description
        string action
    }

    SIMULATION_RESULT {
        number estimatedOvertimeHours
        string workloadBalance
        number paidLeaveUsageRate
        array risks
    }
      </div>
    </div>

    <!-- Phase 40æ‹¡å¼µï¼ˆ2025-12-06ï¼‰ -->
    <div class="card">
      <h2>Phase 40æ‹¡å¼µ: AIè©•ä¾¡æ©Ÿèƒ½æ”¹å–„ï¼ˆ2025-12-06ï¼‰</h2>

      <h3>è¿½åŠ æ©Ÿèƒ½</h3>
      <table>
        <thead>
          <tr>
            <th>æ©Ÿèƒ½</th>
            <th>èª¬æ˜</th>
            <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º</td>
            <td>ã‚¹ã‚³ã‚¢ã«å¿œã˜ãŸè¦–è¦šçš„ãªè­¦å‘Šï¼ˆcritical/severe/warningï¼‰</td>
            <td style="color: var(--success);">âœ… å®Œäº†</td>
          </tr>
          <tr>
            <td>è‡ªå‹•å±•é–‹æ©Ÿèƒ½</td>
            <td>ã‚¹ã‚³ã‚¢60æœªæº€ã¾ãŸã¯ã‚¨ãƒ©ãƒ¼5ä»¶ä»¥ä¸Šã§è‡ªå‹•å±•é–‹</td>
            <td style="color: var(--success);">âœ… å®Œäº†</td>
          </tr>
          <tr>
            <td>AIç·åˆã‚³ãƒ¡ãƒ³ãƒˆ</td>
            <td>è©•ä¾¡çµæœã«åŸºã¥ãè‡ªç„¶è¨€èªã‚³ãƒ¡ãƒ³ãƒˆï¼ˆ200æ–‡å­—ä»¥å†…ï¼‰</td>
            <td style="color: var(--success);">âœ… å®Œäº†</td>
          </tr>
          <tr>
            <td>ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½</td>
            <td>AIã‚³ãƒ¡ãƒ³ãƒˆã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼</td>
            <td style="color: var(--success);">âœ… å®Œäº†</td>
          </tr>
        </tbody>
      </table>

      <h3>è­¦å‘Šãƒ¬ãƒ™ãƒ«</h3>
      <table>
        <thead>
          <tr>
            <th>ãƒ¬ãƒ™ãƒ«</th>
            <th>ã‚¹ã‚³ã‚¢ç¯„å›²</th>
            <th>è¡¨ç¤º</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>ğŸš« Critical</td>
            <td>0ç‚¹</td>
            <td>ã€Œã“ã®è¦ä»¶ã§ã¯å®Ÿç¾ä¸å¯èƒ½ã§ã™ã€</td>
          </tr>
          <tr>
            <td>âš ï¸ Severe</td>
            <td>1-30ç‚¹</td>
            <td>ã€Œé‡å¤§ãªåˆ¶ç´„é•åãŒã‚ã‚Šã¾ã™ã€</td>
          </tr>
          <tr>
            <td>âš¡ Warning</td>
            <td>31-59ç‚¹</td>
            <td>ã€Œè¤‡æ•°ã®å•é¡ŒãŒã‚ã‚Šã¾ã™ã€</td>
          </tr>
          <tr>
            <td>-</td>
            <td>60ç‚¹ä»¥ä¸Š</td>
            <td>è­¦å‘Šãªã—ï¼ˆé€šå¸¸è¡¨ç¤ºï¼‰</td>
          </tr>
        </tbody>
      </table>

      <h3>å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«</h3>
      <ul style="list-style: none; padding: 0;">
        <li style="padding: 4px 0;">ğŸ“„ <code>src/components/EvaluationPanel.tsx</code> - UIæ”¹å–„</li>
        <li style="padding: 4px 0;">ğŸ“„ <code>functions/src/evaluation/evaluationLogic.ts</code> - AIã‚³ãƒ¡ãƒ³ãƒˆç”Ÿæˆ</li>
        <li style="padding: 4px 0;">ğŸ“„ <code>types.ts</code> / <code>functions/src/types.ts</code> - aiCommentè¿½åŠ </li>
        <li style="padding: 4px 0;">ğŸ“„ <code>e2e/ai-evaluation-panel.spec.ts</code> - E2Eãƒ†ã‚¹ãƒˆè¿½åŠ </li>
      </ul>
    </div>

    <!-- BUG-005: è©•ä¾¡ãƒ‘ãƒãƒ«éè¡¨ç¤ºãƒã‚°ä¿®æ­£ï¼ˆ2025-12-06ï¼‰ -->
    <div class="card">
      <h2>BUG-005: è©•ä¾¡ãƒ‘ãƒãƒ«éè¡¨ç¤ºãƒã‚°ä¿®æ­£ï¼ˆ2025-12-06ï¼‰</h2>

      <h3>ç—‡çŠ¶</h3>
      <p>AIç”Ÿæˆå®Œäº†å¾Œã€è©•ä¾¡çµæœã¯æ­£å¸¸ã«å–å¾—ã•ã‚Œã‚‹ãŒã€UIã«è©•ä¾¡ãƒ‘ãƒãƒ«ãŒè¡¨ç¤ºã•ã‚Œãªã„ã€‚</p>

      <h3>åŸå› </h3>
      <p>Firestoreã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è³¼èª­ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å†…ã§ã€ç”Ÿæˆç›´å¾Œã§ã‚‚<code>setEvaluation(null)</code>ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ãŸã€‚</p>
      <p><strong>é‡è¦:</strong> Firestoreãƒªã‚¹ãƒŠãƒ¼ã¯1å›ã®writeæ“ä½œã«å¯¾ã—ã¦è¤‡æ•°å›ç™ºç«ã™ã‚‹ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã€ã‚µãƒ¼ãƒãƒ¼ã€æ›´æ–°é€šçŸ¥ï¼‰ã€‚</p>

      <div class="mermaid">
sequenceDiagram
    participant U as ãƒ¦ãƒ¼ã‚¶ãƒ¼
    participant UI as App
    participant GS as geminiService
    participant FS as Firestore

    U->>UI: ã‚·ãƒ•ãƒˆç”Ÿæˆ
    UI->>GS: generateShiftSchedule()
    GS-->>UI: evaluationçµæœ
    UI->>UI: setEvaluation(result) âœ…
    UI->>UI: skipCount = 3 âœ…
    UI->>FS: saveSchedule()
    FS-->>UI: ãƒªã‚¹ãƒŠãƒ¼ç™ºç«(1å›ç›®)
    UI->>UI: skipCount > 0 â†’ ã‚¹ã‚­ãƒƒãƒ— (3â†’2)
    FS-->>UI: ãƒªã‚¹ãƒŠãƒ¼ç™ºç«(2å›ç›®)
    UI->>UI: skipCount > 0 â†’ ã‚¹ã‚­ãƒƒãƒ— (2â†’1)
    Note over UI: è©•ä¾¡ãŒä¿æŒã•ã‚Œã‚‹ âœ…
      </div>

      <h3>ä¿®æ­£å±¥æ­´</h3>
      <table>
        <thead>
          <tr><th>è©¦è¡Œ</th><th>æ–¹å¼</th><th>çµæœ</th><th>å¤±æ•—ç†ç”±</th></tr>
        </thead>
        <tbody>
          <tr><td>1</td><td>generatingSchedule state</td><td>âŒ å¤±æ•—</td><td>useEffectä¾å­˜é…åˆ—å•é¡Œã€ã‚¿ã‚¤ãƒŸãƒ³ã‚°ä¸ç¢ºå®š</td></tr>
          <tr><td>2</td><td>boolean useRef</td><td>âŒ å¤±æ•—</td><td>ãƒªã‚¹ãƒŠãƒ¼è¤‡æ•°å›ç™ºç«ã«å¯¾å¿œã§ããš</td></tr>
          <tr><td>3</td><td>ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ useRef</td><td>âœ… æˆåŠŸ</td><td>-</td></tr>
        </tbody>
      </table>

      <h3>æœ€çµ‚ä¿®æ­£å†…å®¹</h3>
      <p><code>skipEvaluationClearCountRef</code>ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’ä½¿ç”¨ã—ã¦ã€è¤‡æ•°å›ã®ãƒªã‚¹ãƒŠãƒ¼ç™ºç«ã«å¯¾å¿œã€‚</p>
      <pre style="background: #f8fafc; padding: 16px; border-radius: 8px; overflow-x: auto;"><code>// App.tsx - ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼å®£è¨€
const skipEvaluationClearCountRef = useRef(0);

// ç”Ÿæˆå®Œäº†æ™‚
setEvaluation(generationResult.evaluation);
skipEvaluationClearCountRef.current = 3; // 3å›ã‚¹ã‚­ãƒƒãƒ—

// ãƒªã‚¹ãƒŠãƒ¼å†…
if (skipEvaluationClearCountRef.current > 0) {
  skipEvaluationClearCountRef.current -= 1;
} else {
  setEvaluation(null);
}</code></pre>

      <h3>æ•™è¨“</h3>
      <ul>
        <li><strong>Firestoreãƒªã‚¹ãƒŠãƒ¼ã¯è¤‡æ•°å›ç™ºç«ã™ã‚‹</strong>: å˜ç´”ãªbooleanãƒ•ãƒ©ã‚°ã§ã¯å¯¾å¿œä¸å¯</li>
        <li><strong>ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼æ–¹å¼ãŒæœ‰åŠ¹</strong>: è¦³æ¸¬ã—ãŸç™ºç«å›æ•°ï¼ˆ2-3å›ï¼‰+ ä½™è£•ã§å¯¾å¿œ</li>
        <li><strong>ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã®é‡è¦æ€§</strong>: ãƒªã‚¹ãƒŠãƒ¼ç™ºç«å›æ•°ã®è¦³æ¸¬ã§åŸå› ç‰¹å®š</li>
        <li><strong>æ®µéšçš„ãƒ‡ãƒãƒƒã‚°</strong>: ä»®èª¬â†’æ¤œè¨¼â†’å¤±æ•—â†’è¦³æ¸¬â†’æ–°ä»®èª¬ã®ã‚µã‚¤ã‚¯ãƒ«</li>
      </ul>
    </div>

    <!-- æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ— -->
    <div class="card">
      <h2>æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—</h2>
      <table>
        <thead>
          <tr>
            <th>ã‚¿ã‚¹ã‚¯</th>
            <th>å„ªå…ˆåº¦</th>
            <th>èª¬æ˜</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><s>E2Eãƒ†ã‚¹ãƒˆæ‹¡å¼µ</s></td>
            <td><s>é«˜</s></td>
            <td style="color: var(--success);">âœ… å®Œäº†ï¼ˆ2025-12-06ï¼‰</td>
          </tr>
          <tr>
            <td><s>æ‰‹å‹•æ¤œè¨¼</s></td>
            <td><s>é«˜</s></td>
            <td style="color: var(--success);">âœ… å®Œäº†ï¼ˆ2025-12-06ï¼‰- BUG-005ä¿®æ­£å¾Œã«æ­£å¸¸å‹•ä½œç¢ºèª</td>
          </tr>
          <tr>
            <td>å±¥æ­´UI</td>
            <td>ä¸­</td>
            <td>éå»ã®è©•ä¾¡å±¥æ­´ä¸€è¦§è¡¨ç¤ºæ©Ÿèƒ½</td>
          </tr>
          <tr>
            <td><s>Geminiè©•ä¾¡çµ±åˆ</s></td>
            <td><s>ä½</s></td>
            <td style="color: var(--success);">âœ… AIã‚³ãƒ¡ãƒ³ãƒˆæ©Ÿèƒ½ã¨ã—ã¦å®Ÿè£…ï¼ˆ2025-12-06ï¼‰</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <footer style="text-align: center; padding: 40px 20px; color: var(--text-muted);">
    <p>AI Care Shift Scheduler - Phase 40 Documentation</p>
    <p>Generated: 2025-11-26</p>
  </footer>

  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: 'default',
      securityLevel: 'loose',
      flowchart: {
        useMaxWidth: true,
        htmlLabels: true,
        curve: 'basis'
      },
      gantt: {
        useMaxWidth: true,
        barHeight: 30,
        barGap: 6,
        topPadding: 50
      }
    });
  </script>
</body>
</html>
