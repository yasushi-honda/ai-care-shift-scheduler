# Phase 44: AIシフト生成パイプライン改善 - テストレポート

**実施日時**: 2025-12-07 21:05:57 - 21:07:35
**テスト担当**: 自動化テスト（curl）
**対象環境**: 本番環境（Cloud Functions）

---

## 1. テスト概要

### 1.1 テスト条件

| 項目 | 値 |
|------|-----|
| エンドポイント | `https://asia-northeast1-ai-care-shift-scheduler.cloudfunctions.net/generateShift` |
| スタッフ数 | 8名 |
| 対象月 | 2026-01（31日間） |
| 営業日数 | 26日（日曜5日除く） |
| 必要人員/日 | 早番2名、日勤2名（看護師1名以上）、遅番1名 = 計5名 |
| 休暇申請 | 4件（田中1/15、佐藤1/22-23、高橋1/10） |

### 1.2 テスト方法

```bash
curl -X POST \
  -H "Content-Type: application/json" \
  -d '{"staffList": [...], "requirements": {...}, "leaveRequests": {...}}' \
  $FUNCTION_URL
```

---

## 2. テスト結果サマリー

| 指標 | 結果 | 目標 | 判定 |
|------|------|------|------|
| HTTPステータス | 200 | 200 | ✅ |
| 処理時間 | 98秒 | 180秒以内 | ✅ |
| 総合スコア | **0点** | 80点以上 | ❌ |
| 充足率 | **85%** | 100% | ❌ |
| 制約違反 | **21件** | 0件 | ❌ |

### 総合判定: ❌ 改善必要

---

## 3. 詳細分析

### 3.1 日別人員配置

```
| 日付       | 曜日 | 早番 | 日勤 | 遅番 | 判定     |
|------------|------|------|------|------|----------|
| 2026-01-01 | 木   | 2    | 2    | 1    | ✅       |
| 2026-01-02 | 金   | 1    | 2    | 1    | ❌早番   |
| 2026-01-03 | 土   | 1    | 3    | 1    | ❌早番   |
| 2026-01-04 | 日   | -    | -    | -    | 🔵休業   |
| 2026-01-05 | 月   | 2    | 2    | 1    | ✅       |
| 2026-01-06 | 火   | 2    | 3    | 1    | ✅       |
| 2026-01-07 | 水   | 1    | 3    | 1    | ❌早番   |
| 2026-01-08 | 木   | 2    | 3    | 1    | ✅       |
| 2026-01-09 | 金   | 2    | 2    | 1    | ✅       |
| 2026-01-10 | 土   | 2    | 3    | 0    | ❌遅番   |
| ...        |      |      |      |      |          |
| 2026-01-30 | 金   | 2    | 2    | 1    | ⚠️看護師 |
| 2026-01-31 | 土   | 1    | 1    | 1    | ❌早日   |
```

### 3.2 問題パターン分析

| 問題タイプ | 発生件数 | 割合 |
|------------|----------|------|
| 早番不足（1名） | 17件 | 81% |
| 遅番不足（1名） | 3件 | 14% |
| 日勤不足（1名） | 2件 | 10% |
| 看護師未配置 | 1件 | 5% |

**観察**: 早番への配置が大幅に不足している。AIが日勤に偏った配置をしている傾向。

### 3.3 看護師配置状況

| 日付 | 日勤看護師 | 判定 |
|------|------------|------|
| 2026-01-01 | 佐藤花子 | ✅ |
| 2026-01-02 | 鈴木美咲 | ✅ |
| ... | ... | ... |
| 2026-01-30 | なし | ❌ |

**観察**: 1/30に看護師が日勤に配置されていない。資格要件の制約が守られていない。

---

## 4. ログ詳細

### 4.1 Cloud Functionsログ

```
📊 Phase 1: 要件分析
🦴 Phase 2: 骨子設計
📅 Phase 3: 週別配置
  - Week 1: 2026-01-01〜2026-01-04
  - Week 2: 2026-01-05〜2026-01-11
  - Week 3: 2026-01-12〜2026-01-18
  - Week 4: 2026-01-19〜2026-01-25
  - Week 5: 2026-01-26〜2026-01-31
✅ Phase 4: 整合性検証
📤 Phase 5: 最終出力
```

### 4.2 評価結果

```json
{
  "overallScore": 0,
  "fulfillmentRate": 85,
  "constraintViolations": [
    {"type": "staffShortage", "severity": "error", "description": "2026-01-02の早番で1名の人員不足"},
    {"type": "staffShortage", "severity": "error", "description": "2026-01-03の早番で1名の人員不足"},
    // ... 19件省略
  ],
  "aiComment": "現在の要件ではすべての制約を満たすシフトを作成できません。主な問題: 20件の人員不足。人員充足率85%です。"
}
```

---

## 5. 原因分析

### 5.1 Step 1 プロンプト改善の効果

| 項目 | 改善前（推定） | 改善後 | 変化 |
|------|----------------|--------|------|
| 日曜日スキップ | ✅ | ✅ | 維持 |
| 看護師配置 | 不明 | 25/26日 ✅ | 改善 |
| 人員バランス | 偏り大 | 偏り中 | やや改善 |
| 早番配置 | 過剰 | **不足** | 悪化？ |

### 5.2 残存問題の原因

1. **バッチ処理の限界**
   - 現行のスタッフ軸バッチ処理（5名×31日）では、日単位の人員最適化が困難
   - バッチ1とバッチ2で情報が分断され、全体最適化ができない

2. **プロンプトの指示が不十分**
   - 「早番2名」と明示したが、AIが日勤を優先している
   - シフト間のバランス指示が弱い

3. **骨子→詳細の情報伝達**
   - 骨子で決まった休日以外の情報が詳細生成に渡っていない

---

## 6. 次のアクション（Step 2への提案）

### 6.1 即時改善案

1. **プロンプトにシフト優先順位を追加**
   ```
   シフト配分の優先順位:
   1. まず早番2名を確保
   2. 次に遅番1名を確保
   3. 残りのスタッフを日勤に配置
   ```

2. **日別の配置検証を追加**
   - 詳細生成後に各日の人員をチェック
   - 不足がある場合は再生成

### 6.2 Step 2: 週単位処理への移行

- 処理単位を「1週間 × 全8名」に変更
- 各週で人員要件を確実に満たす
- 週間の連勤制約も同時に検証

---

## 7. 添付資料

- `/tmp/test-result.log` - テスト実行ログ
- `/tmp/shift-generation-response.json` - 完全なレスポンスJSON
- `/tmp/detailed-analysis.log` - 詳細分析ログ

---

**レポート作成日時**: 2025-12-07 21:10
**レポート作成者**: 自動テストシステム
