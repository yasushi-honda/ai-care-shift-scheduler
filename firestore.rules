rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ==================== Helper Functions ====================

    // 認証済みユーザーかチェック
    function isAuthenticated() {
      return request.auth != null;
    }

    // ユーザープロファイルを取得
    function getUserProfile() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    // 指定施設に対して指定ロール以上の権限を持つかチェック
    function hasRole(facilityId, requiredRole) {
      let userProfile = getUserProfile();
      let facilities = userProfile.facilities;

      // 最大10施設までサポート（実用上は1-3施設が一般的）
      return (facilities.size() > 0 && checkFacilityRole(facilities, 0, facilityId, requiredRole)) ||
             (facilities.size() > 1 && checkFacilityRole(facilities, 1, facilityId, requiredRole)) ||
             (facilities.size() > 2 && checkFacilityRole(facilities, 2, facilityId, requiredRole)) ||
             (facilities.size() > 3 && checkFacilityRole(facilities, 3, facilityId, requiredRole)) ||
             (facilities.size() > 4 && checkFacilityRole(facilities, 4, facilityId, requiredRole)) ||
             (facilities.size() > 5 && checkFacilityRole(facilities, 5, facilityId, requiredRole)) ||
             (facilities.size() > 6 && checkFacilityRole(facilities, 6, facilityId, requiredRole)) ||
             (facilities.size() > 7 && checkFacilityRole(facilities, 7, facilityId, requiredRole)) ||
             (facilities.size() > 8 && checkFacilityRole(facilities, 8, facilityId, requiredRole)) ||
             (facilities.size() > 9 && checkFacilityRole(facilities, 9, facilityId, requiredRole));
    }

    // 配列の指定インデックスの施設をチェック
    function checkFacilityRole(facilities, index, facilityId, requiredRole) {
      return facilities[index].facilityId == facilityId &&
             checkRolePermission(facilities[index].role, requiredRole);
    }

    // ロール階層チェック
    function checkRolePermission(userRole, requiredRole) {
      // super-adminは全権限を持つ
      return userRole == 'super-admin' ||
             (requiredRole == 'admin' && userRole == 'admin') ||
             (requiredRole == 'editor' && (userRole == 'admin' || userRole == 'editor')) ||
             (requiredRole == 'viewer' && (userRole == 'admin' || userRole == 'editor' || userRole == 'viewer'));
    }

    // super-admin権限を持つかチェック
    function isSuperAdmin() {
      let userProfile = getUserProfile();
      let facilities = userProfile.facilities;

      // 最大10施設までサポート
      return (facilities.size() > 0 && facilities[0].role == 'super-admin') ||
             (facilities.size() > 1 && facilities[1].role == 'super-admin') ||
             (facilities.size() > 2 && facilities[2].role == 'super-admin') ||
             (facilities.size() > 3 && facilities[3].role == 'super-admin') ||
             (facilities.size() > 4 && facilities[4].role == 'super-admin') ||
             (facilities.size() > 5 && facilities[5].role == 'super-admin') ||
             (facilities.size() > 6 && facilities[6].role == 'super-admin') ||
             (facilities.size() > 7 && facilities[7].role == 'super-admin') ||
             (facilities.size() > 8 && facilities[8].role == 'super-admin') ||
             (facilities.size() > 9 && facilities[9].role == 'super-admin');
    }

    // ==================== Collections ====================

    // system collection (super-admin only, Cloud Functionからの書き込みのみ)
    match /system/{document} {
      allow read: if isSuperAdmin();
      allow write: if false; // Cloud Functionのみ
    }

    // users collection
    match /users/{userId} {
      // super-adminは全ユーザーをリスト可能（getAllUsers用）
      allow list: if isAuthenticated() && isSuperAdmin();
      // 自分のドキュメント または super-adminは個別読み取り可能
      allow get: if isAuthenticated() && (request.auth.uid == userId || isSuperAdmin());

      // 初回作成: 認証済みユーザーが自分のドキュメントのみ作成可能（facilitiesは空配列のみ許可）
      allow create: if isAuthenticated()
        && request.auth.uid == userId
        && request.resource.data.userId == userId
        && request.resource.data.email == request.auth.token.email
        && request.resource.data.provider == 'google'
        && request.resource.data.facilities is list
        && request.resource.data.facilities.size() == 0; // facilitiesは空配列のみ（Cloud Functionが後で設定）

      // 更新: lastLoginAtのみ更新可能（facilitiesの変更は禁止）、またはCloud Functionからの更新
      allow update: if isAuthenticated()
        && request.auth.uid == userId
        && (
          // ケース1: ユーザー自身がlastLoginAtのみ更新
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['lastLoginAt'])
          // ケース2: facilitiesフィールドのみ変更（Cloud Functionによる権限付与）
          || request.resource.data.diff(resource.data).affectedKeys().hasOnly(['facilities'])
        );
    }

    // facilities collection
    match /facilities/{facilityId} {
      // super-adminは全施設をリスト可能（getAllFacilities用）
      allow list: if isAuthenticated() && isSuperAdmin();
      // super-adminまたはviewer以上の権限で個別ドキュメント読み取り可能
      allow get: if isAuthenticated() && (isSuperAdmin() || hasRole(facilityId, 'viewer'));
      // super-adminのみ作成・削除可能
      allow create, delete: if isAuthenticated() && isSuperAdmin();
      // super-adminまたはadmin権限で更新可能
      allow update: if isAuthenticated() && (isSuperAdmin() || hasRole(facilityId, 'admin'));

      // staff subcollection
      match /staff/{staffId} {
        // super-adminまたはviewer以上で読み取り、editor以上で書き込み
        allow read: if isAuthenticated() && (isSuperAdmin() || hasRole(facilityId, 'viewer'));
        allow write: if isAuthenticated() && hasRole(facilityId, 'editor');
      }

      // schedules subcollection
      match /schedules/{scheduleId} {
        // super-adminまたはviewer以上で読み取り、editor以上で書き込み
        allow read: if isAuthenticated() && (isSuperAdmin() || hasRole(facilityId, 'viewer'));
        allow write: if isAuthenticated() && hasRole(facilityId, 'editor');

        // versions サブコレクション
        match /versions/{versionId} {
          // viewer以上で読み取り、editor以上で書き込み（scheduleと同じ権限）
          allow read: if isAuthenticated() && (isSuperAdmin() || hasRole(facilityId, 'viewer'));
          allow write: if isAuthenticated() && hasRole(facilityId, 'editor');
        }
      }

      // leaveRequests subcollection
      match /leaveRequests/{requestId} {
        // viewer以上で読み取り、editor以上で書き込み
        allow read: if isAuthenticated() && hasRole(facilityId, 'viewer');
        allow write: if isAuthenticated() && hasRole(facilityId, 'editor');
      }

      // requirements subcollection
      match /requirements/{requirementId} {
        // viewer以上で読み取り、editor以上で書き込み
        allow read: if isAuthenticated() && hasRole(facilityId, 'viewer');
        allow write: if isAuthenticated() && hasRole(facilityId, 'editor');
      }

      // invitations subcollection (Phase 2-3で実装予定)
      match /invitations/{invitationId} {
        // super-adminまたはadmin以上で読み取り・作成
        allow read, create: if isAuthenticated() && (isSuperAdmin() || hasRole(facilityId, 'admin'));
        // 招待されたユーザー本人のみ、自分の招待ステータスを 'accepted' に更新可能
        allow update: if isAuthenticated()
          && request.auth.token.email == resource.data.email
          && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status'])
          && request.resource.data.status == 'accepted';
        // 削除はCloud Functionのみ
        allow delete: if false;
      }
    }

    // auditLogs collection (Phase 13で実装)
    match /auditLogs/{logId} {
      // super-adminのみ読み取り可能
      allow read: if isAuthenticated() && isSuperAdmin();

      // Phase 13.1: 認証済みユーザーが自分のログのみ作成可能（開発時）
      // セキュリティ: userIdが認証ユーザーのuidと一致することを検証
      // TODO: Phase 13.2で Cloud Function のみに制限（allow create: if false;）
      allow create: if isAuthenticated()
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.userId is string
        && request.resource.data.action is string
        && request.resource.data.resourceType is string
        && request.resource.data.result is string
        && (request.resource.data.result == 'success' || request.resource.data.result == 'failure');

      // 更新・削除は禁止（不変ログ）
      allow update, delete: if false;
    }

    // securityAlerts collection (Phase 13.3で実装、Phase 17.11でRules追加)
    match /securityAlerts/{alertId} {
      // super-adminのみ読み取り可能
      allow read: if isAuthenticated() && isSuperAdmin();

      // 認証済みユーザーがアラートを作成可能（不審なアクセス検出時）
      // セキュリティ: 必須フィールドのバリデーション
      allow create: if isAuthenticated()
        && request.resource.data.type is string
        && request.resource.data.severity is string
        && request.resource.data.status is string
        && request.resource.data.title is string
        && request.resource.data.description is string;

      // super-adminのみ更新可能（ステータス変更、確認、解決）
      allow update: if isAuthenticated() && isSuperAdmin();

      // 削除は禁止（不変・監査証跡として保持）
      allow delete: if false;
    }

    // デフォルトルール: 上記以外のコレクションはアクセス拒否
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
