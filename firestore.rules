rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ==================== Helper Functions ====================

    // 認証済みユーザーかチェック
    function isAuthenticated() {
      return request.auth != null;
    }

    // ユーザープロファイルを取得
    function getUserProfile() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    // 指定施設に対して指定ロール以上の権限を持つかチェック
    function hasRole(facilityId, requiredRole) {
      let userProfile = getUserProfile();
      let facilities = userProfile.facilities;

      // 最大10施設までサポート（実用上は1-3施設が一般的）
      return (facilities.size() > 0 && checkFacilityRole(facilities, 0, facilityId, requiredRole)) ||
             (facilities.size() > 1 && checkFacilityRole(facilities, 1, facilityId, requiredRole)) ||
             (facilities.size() > 2 && checkFacilityRole(facilities, 2, facilityId, requiredRole)) ||
             (facilities.size() > 3 && checkFacilityRole(facilities, 3, facilityId, requiredRole)) ||
             (facilities.size() > 4 && checkFacilityRole(facilities, 4, facilityId, requiredRole)) ||
             (facilities.size() > 5 && checkFacilityRole(facilities, 5, facilityId, requiredRole)) ||
             (facilities.size() > 6 && checkFacilityRole(facilities, 6, facilityId, requiredRole)) ||
             (facilities.size() > 7 && checkFacilityRole(facilities, 7, facilityId, requiredRole)) ||
             (facilities.size() > 8 && checkFacilityRole(facilities, 8, facilityId, requiredRole)) ||
             (facilities.size() > 9 && checkFacilityRole(facilities, 9, facilityId, requiredRole));
    }

    // 配列の指定インデックスの施設をチェック
    function checkFacilityRole(facilities, index, facilityId, requiredRole) {
      return facilities[index].facilityId == facilityId &&
             checkRolePermission(facilities[index].role, requiredRole);
    }

    // ロール階層チェック
    function checkRolePermission(userRole, requiredRole) {
      // super-adminは全権限を持つ
      return userRole == 'super-admin' ||
             (requiredRole == 'admin' && userRole == 'admin') ||
             (requiredRole == 'editor' && (userRole == 'admin' || userRole == 'editor')) ||
             (requiredRole == 'viewer' && (userRole == 'admin' || userRole == 'editor' || userRole == 'viewer'));
    }

    // super-admin権限を持つかチェック
    function isSuperAdmin() {
      let userProfile = getUserProfile();
      let facilities = userProfile.facilities;

      // 最大10施設までサポート
      return (facilities.size() > 0 && facilities[0].role == 'super-admin') ||
             (facilities.size() > 1 && facilities[1].role == 'super-admin') ||
             (facilities.size() > 2 && facilities[2].role == 'super-admin') ||
             (facilities.size() > 3 && facilities[3].role == 'super-admin') ||
             (facilities.size() > 4 && facilities[4].role == 'super-admin') ||
             (facilities.size() > 5 && facilities[5].role == 'super-admin') ||
             (facilities.size() > 6 && facilities[6].role == 'super-admin') ||
             (facilities.size() > 7 && facilities[7].role == 'super-admin') ||
             (facilities.size() > 8 && facilities[8].role == 'super-admin') ||
             (facilities.size() > 9 && facilities[9].role == 'super-admin');
    }

    // ==================== Collections ====================

    // system collection (super-admin only, Cloud Functionからの書き込みのみ)
    match /system/{document} {
      allow read: if isSuperAdmin();
      allow write: if false; // Cloud Functionのみ
    }

    // users collection
    match /users/{userId} {
      // 自分のドキュメントのみ読み取り可能
      allow read: if isAuthenticated() && request.auth.uid == userId;

      // 初回作成: 認証済みユーザーが自分のドキュメントのみ作成可能（facilitiesは空配列のみ許可）
      allow create: if isAuthenticated()
        && request.auth.uid == userId
        && request.resource.data.userId == userId
        && request.resource.data.email == request.auth.token.email
        && request.resource.data.provider == 'google'
        && request.resource.data.facilities is list
        && request.resource.data.facilities.size() == 0; // facilitiesは空配列のみ（Cloud Functionが後で設定）

      // 更新: lastLoginAtのみ更新可能（facilitiesの変更は禁止）、またはCloud Functionからの更新
      allow update: if isAuthenticated()
        && request.auth.uid == userId
        && (
          // ケース1: ユーザー自身がlastLoginAtのみ更新
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['lastLoginAt'])
          // ケース2: facilitiesフィールドのみ変更（Cloud Functionによる権限付与）
          || request.resource.data.diff(resource.data).affectedKeys().hasOnly(['facilities'])
        );
    }

    // facilities collection
    match /facilities/{facilityId} {
      // super-adminは全施設をリスト可能（getAllFacilities用）
      allow list: if isAuthenticated() && isSuperAdmin();
      // viewer以上の権限で個別ドキュメント読み取り可能
      allow get: if isAuthenticated() && hasRole(facilityId, 'viewer');
      // super-adminのみ作成・削除可能
      allow create, delete: if isAuthenticated() && isSuperAdmin();
      // admin権限で更新可能
      allow update: if isAuthenticated() && hasRole(facilityId, 'admin');

      // staff subcollection
      match /staff/{staffId} {
        // super-adminまたはviewer以上で読み取り、editor以上で書き込み
        allow read: if isAuthenticated() && (isSuperAdmin() || hasRole(facilityId, 'viewer'));
        allow write: if isAuthenticated() && hasRole(facilityId, 'editor');
      }

      // schedules subcollection
      match /schedules/{scheduleId} {
        // super-adminまたはviewer以上で読み取り、editor以上で書き込み
        allow read: if isAuthenticated() && (isSuperAdmin() || hasRole(facilityId, 'viewer'));
        allow write: if isAuthenticated() && hasRole(facilityId, 'editor');
      }

      // leaveRequests subcollection
      match /leaveRequests/{requestId} {
        // viewer以上で読み取り、editor以上で書き込み
        allow read: if isAuthenticated() && hasRole(facilityId, 'viewer');
        allow write: if isAuthenticated() && hasRole(facilityId, 'editor');
      }

      // requirements subcollection
      match /requirements/{requirementId} {
        // viewer以上で読み取り、admin以上で書き込み
        allow read: if isAuthenticated() && hasRole(facilityId, 'viewer');
        allow write: if isAuthenticated() && hasRole(facilityId, 'admin');
      }

      // invitations subcollection (Phase 2-3で実装予定)
      match /invitations/{invitationId} {
        // admin以上で読み取り・作成、更新・削除はCloud Functionのみ
        allow read, create: if isAuthenticated() && hasRole(facilityId, 'admin');
        allow update, delete: if false; // Cloud Functionのみ
      }
    }

    // auditLogs collection (super-admin only, Phase 2-4で実装予定)
    match /auditLogs/{logId} {
      allow read: if isAuthenticated() && isSuperAdmin();
      allow write: if false; // Cloud Functionのみ
    }

    // デフォルトルール: 上記以外のコレクションはアクセス拒否
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
